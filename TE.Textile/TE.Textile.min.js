/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 0.0.9
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function d(e){return"undefined"!=typeof e}function $(e){return"string"==typeof e}function b(e){return"object"==typeof e}function v(e,t){return new RegExp(e,t)}function k(e){return e.replace(/^\s*|\s*$/g,"")}function y(e){return e.replace(/\s+$/,"")}function w(e,t,n){return t>e?t:e>n?n:e}function _(e){return q(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function T(e){return q(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function q(e){return k(e.replace(/\s+/g," "))}function z(e){var c,t=i.$(),n=t.value,r=t.before,l=t.after,a=s(e),f=v("(^|\\n)"+a+"(.*)$"),o=v("^"+a,"gm"),u=R[""];return i[0](),n?v(a+"$").test(r)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),o.test(n)?i.replace(o,""):i.replace(/(^|\n{2})/g,"$1"+e)):r&&l?(c=f.test(r)?r.replace(f,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(c+l).select(c.length)):i.tidy("\n\n").insert(e,-1).insert(u),i[1](),!1}var i=(window,document,new TE.HTML(e)),l=i.ui,a=i._.extend,s=i._.x,f=i._.format;i.update(a({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],ul:["*"],ol:["#"],hr:["---","***"]}},t),0),i.type="Textile";var S=i.config,E=S.states,I=S.languages,L=S.formats,R=(S.tab,I.placeholders);return i.mark=function(e,t,n,r){b(e)||(e=[e]),d(n)||(n=" "),d(r)||(r="");var l=i[0]().$(),a=e[0]+r,f=r+(d(e[1])?e[1]:e[0]),o=l.value,u=s(a),c=s(f),p=v("^"+u+"([\\s\\S]*?)"+c+"$"),h=v(u+"$"),$=v("^"+c),g=l.before,m=l.after;return o?n=!1:i.insert(R[""]),i.toggle(t?!p.test(o):!h.test(g)&&!$.test(m),[function(e){e.unwrap(a,f,1).tidy(/<[^\/<>]+?>$/.test(g)?"":n,/^<\/[^<>]+?>/.test(m)?"":n).wrap(a,f,t)[1]()},function(e){e.unwrap(a,f,t)[1]()}])},a(l.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(L.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(L.i[0]),!1}},u:0,s:{i:"strikethrough",click:function(e,t){return t.i().mark("-"),!1}},a:{i:"link",click:function(e,t){var c,p,d,h,$,g,b,n=t.$(),r=n.before,i=n.value,l=n.after,a=t.get(),s=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^\[\S+?\]/gm)||[],o=I.modals.a,u=o.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(b in f)b=" "+k(f[b]).replace(/^\[|\]$/g,""),E.a[b]=1;return c=E.a,t.record().ui.prompt(["a[href]",o.title[0]],u,0,function(e,t,a){a=T(a),t[0](),c[a]?(t.trim(k(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+a],0,!1),h=f.indexOf("["+a+"]"),-1===h&&1!==c[a]&&(n=t.$(),r=n.before,$=n.start,g=n.end,t.set(r+n.value+y(n.after)+s+"["+(a||k(i)||R[""])+"]"+c[a][0]).select($,g))):(p=a,t.blur().ui.prompt(["a[title]",o.title[1]],o.placeholder[1],0,function(e,t,n){d=_(n),i||t.insert(R[""]),t.i().trim(k(r)?" ":"",k(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p)})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var i,l,r=(t.$(),I.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=T(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){l=_(n),t.tidy("\n\n","").insert("!"+i+(l?"("+l+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,n=t.$(),i=(n.before,n.after),l=I.modals.sup,a=t.get(),s=/^fn\d+\^?\. /.test(k(a).split("\n").pop())?"\n":"\n\n",f=a.match(/^fn\d+\^?\. /gm)||[],o=0;return o=f.length+1,t.ui.prompt(["sup[id]",l.title],n.value||l.placeholder||o,0,function(e,t,n){n=k(n)||o,u=f.indexOf("fn"+n+". "),-1!==u?(o=a.indexOf(f[u])+2,t.select(o,o+n.length)):t.trim("",!k(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+n+"]").set(y(t.get())+s+"fn"+n+". ").focus(!0).insert(R[""])}),!1}},abbr:{i:"question",click:function(e,t){var c,n=t.$(),r=k(n.value),i=I.modals.abbr,l=t.get(),a=q(r||R[""]),s=l.match(/\b[A-Z\d]+\(.*?\)/g)||[],f=E.abbr,o=/\(.*?\)/,u=0;for(u in s)c=s[u].match(/^(.*?)\((.*?)\)$/),E.abbr[c[1]]=k(c[2]);return f=E.abbr,r&&f[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+f[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],f[a]||i.placeholder,!f[r],function(e,t,n,i){n=_(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in f)if(_(f[u])===n){t.insert(u);break}t.unwrap("",o).unwrap("",o,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{i:"paragraph",click:function(e,t){return z("p. ")}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){var i,l,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),l=+(i[1]||0),t[0]().i(),n.value||t.insert(R[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>l?"h"+(l+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){return z("bq. ")}},"pre,code":{i:"code",click:function(e,t){return v("(^|\\n)$").test(t.$().before)?z("bc..\n"):(t.mark("@"),!1)}},ul:{i:"list-ul",click:function(e,t){var g,n=t.$(),r=n.value,i=n.before,l=n.after,a=L.ul[0],f=L.ol[0],o=s(a),u=s(f),c=v("(^|\\n)([\\t ]*)"+o+" (.*)$"),p=v("^(.*)"+o+" ","gm"),d=v("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=v("^(.*)"+u+" ","gm"),$=R[""];return r?(r===$?t.select():h.test(r)?t.replace(h,"$1"+a+" "):p.test(r)?t.replace(p,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+a+" $2"),!1):i&&l?(g=d.test(i)?i.replace(d,"$1$2"+a+" $3"):c.test(i)?i.replace(c,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+a+" $3"),t.set(g+l).select(g.length),!1):(t[0]().tidy("\n\n").insert(a+" ",-1).insert($)[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var g,n=t.$(),r=n.value,i=n.before,l=n.after,a=L.ul[0],f=L.ol[0],o=s(a),u=s(f),c=v("(^|\\n)([\\t ]*)"+o+" (.*)$"),p=v("^(.*)"+o+" ","gm"),d=v("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=v("^(.*)"+u+" ","gm"),$=R[""];return r?(r===$?t.select():p.test(r)?t.replace(p,function(e,t,n){return t+f+" "}):h.test(r)?t.replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+f+" "+n}),!1):i&&l?(g=c.test(i)?i.replace(c,"$1$2"+f+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+f+" $3"),t.set(g+l).select(g.length),!1):(t[0]().tidy("\n\n").insert(f+" ",-1).insert($)[1](),!1)}},table:function(e,t){var o,u,c,n=E.tr,r=E.td,i=I.modals.table,l=I.placeholders.table,a=f(l[0],[1,1]),s=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){u=w(parseInt(p,10)||d,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=w(parseInt(r,10)||i,n[0],n[1]);var p,d,h,$,g,b;for(p=0;c>p;++p){for(o="|",d=0;u>d;++d)o+=" "+f(l[1],[p+1,d+1])+" |";s.push(o)}for(s=s.join("\n"),o="|",h=0;u>h;++h)o+=" "+f(l[0],[h+1,h+1]).replace(/./g,"-")+" |";for(s=o+"\n"+s,o="|",$=0;u>$;++$)o+=" "+f(l[0],[1,$+1])+" |";s=o+"\n"+s,S.close_tr||(s=s.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(s),g=t.$(),b=g.start+g.value.indexOf(a),t.select(b,b+a.length)[1]()})}),!1)},hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(L.hr[0]+"\n\n",-1),!1}}}),a(l.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=S.advance_br;return!$(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=L.ul[0],i=L.ol[0],l=s(r),a=s(i),f="((?:"+l+"|"+a+")+ )",o=v("^"+f+".*$","gm").exec(n.before.split("\n").pop());return o?o[0]===o[1]?(t.outdent(v(f)),!1):(t.insert("\n"+o[1],-1).scroll("+1"),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,i=n.before,a=L.ul[0],f=L.ol[0],o=s(a),u=s(f),c="(^|\\n)("+o+")+",p="(^|\\n)("+u+")+";return r===R[""]?(t.select(),!1):v(c+" $").test(i)||v(c).test(r)?(t[0]().outdent(v(o+" *")),!r&&v(c+"$").test(t.$().before)&&t.insert(" ",-1),t[1](),!1):v(p+" $").test(i)||v(p).test(r)?(t[0]().outdent(v(u+" *")),!r&&v(p+"$").test(t.$().before)&&t.insert(" ",-1),t[1](),!1):l.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,i=n.before,a=L.ul[0],f=L.ol[0],o=s(a),u=s(f),c="(^|\\n)("+o+")+",p="(^|\\n)("+u+")+",d=r?"":" ";return r===R[""]?(t.select(),!1):v(c+" $").test(i)||v(c).test(r)?(t.trim("",!1).indent(a+d),!1):v(p+" $").test(i)||v(p).test(r)?(t.trim("",!1).indent(f+d),!1):l.tools.indent.click(e,t)}}),i.update({},0)};
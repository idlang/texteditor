/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 0.0.9
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function d(e){return"undefined"!=typeof e}function v(e){return"string"==typeof e}function g(e){return"object"==typeof e}function y(e,t){return new RegExp(e,t)}function w(e){return e.replace(/^\s*|\s*$/g,"")}function k(e){return e.replace(/\s+$/,"")}function x(e,t,n){return t>e?t:e>n?n:e}function $(e){return E(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function T(e){return E(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function E(e){return w(e.replace(/\s+/g," "))}var i=(window,document,new TE.HTML(e)),o=i.ui,f=i._.extend,l=i._.x,u=i._.format,p="	";i.update(f({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],p:"",hr:["---","***"]}},t),0),i.type="Textile";var _=i.config,L=_.states,C=_.languages,O=_.formats,M=_.tab,H=C.placeholders,z=0;return i.mark=function(e,t,n,r){g(e)||(e=[e]),d(n)||(n=" "),d(r)||(r="");var o=i[0]().$(),f=e[0]+r,u=r+(d(e[1])?e[1]:e[0]),a=o.value,s=l(f),c=l(u),p=y("^"+s+"([\\s\\S]*?)"+c+"$"),h=y(s+"$"),v=y("^"+c),b=o.before,m=o.after;return a?n=!1:i.insert(H[""]),i.toggle(t?!p.test(a):!h.test(b)&&!v.test(m),[function(e){e.unwrap(f,u,1).tidy(/<[^\/<>]+?>$/.test(b)?"":n,/^<\/[^<>]+?>/.test(m)?"":n).wrap(f,u,t)[1]()},function(e){e.unwrap(f,u,t)[1]()}])},f(o.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(O.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(O.i[0]),!1}},u:0,s:{i:"strikethrough",click:function(e,t){return t.i().mark("-"),!1}},a:{i:"link",click:function(e,t){var c,p,d,h,v,b,g,n=t.$(),r=n.before,i=n.value,o=n.after,f=t.get(),l=/^\[\S+?\]/.test(f.split("\n").pop())?"\n":"\n\n",u=f.match(/^\[\S+?\]/gm)||[],a=C.modals.a,s=a.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(g in u)g=" "+w(u[g]).replace(/^\[|\]$/g,""),L.a[g]=1;return c=L.a,t.record().ui.prompt(["a[href]",a.title[0]],s,0,function(e,t,f){f=T(f),t[0](),c[f]?(t.trim(w(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+f],0,!1),h=u.indexOf("["+f+"]"),-1===h&&1!==c[f]&&(n=t.$(),r=n.before,v=n.start,b=n.end,t.set(r+n.value+k(n.after)+l+"["+(f||w(i)||H[""])+"]"+c[f][0]).select(v,b))):(p=f,t.blur().ui.prompt(["a[title]",a.title[1]],a.placeholder[1],0,function(e,t,n){d=$(n),i||t.insert(H[""]),t.i().trim(w(r)?" ":"",w(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p)})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var i,o,r=(t.$(),C.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=T(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){o=$(n),t.tidy("\n\n","").insert("!"+i+(o?"("+o+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var s,n=t.$(),i=(n.before,n.after),o=C.modals.sup,f=t.get(),l=/^fn\d+\^?\. /.test(f.split("\n").pop())?"\n":"\n\n",u=f.match(/^fn\d+\^?\. /gm)||[],a=0;return a=u.length+1,t.ui.prompt(["sup[id]",o.title],n.value||o.placeholder||a,0,function(e,t,n){n=w(n)||a,s=u.indexOf("fn"+n+". "),-1!==s?(a=f.indexOf(u[s])+2,t.select(a,a+n.length)):t.trim("",!w(i)||/^\n+(fn\d+\^?\. |\[)/.test(i)?"\n\n ":" ").insert("["+n+"]").set(k(t.get())+l+"fn"+n+". ").focus(!0).insert(H[""])}),!1}},abbr:{i:"question",click:function(e,t){var c,n=t.$(),r=w(n.value),i=C.modals.abbr,o=t.get(),f=E(r||H[""]),l=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],u=L.abbr,a=/\(.*?\)/,s=0;for(s in l)c=l[s].match(/^(.*?)\((.*?)\)$/),L.abbr[c[1]]=w(c[2]);return u=L.abbr,r&&u[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+u[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],u[f]||i.placeholder,!u[r],function(e,t,n,r){n=$(n||r),t[0]();for(s in u)if($(u[s])===n){t.insert(s);break}t.unwrap("",a).unwrap("",a,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(H[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){z>5?z=0:z++;var n=t.$(),r=_["advance_h1,h2"],i="\\s?["+l(O.h1[0]+O.h2[0])+"]+\\s*",o=l(O.h1[1]),f=n.before.replace(y("["+o+"\\s]+$"),""),u=E(n.value).replace(y("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(y(i+"$"),"")||H[""],a=n.after.replace(y("^["+o+"\\s]+"),"").replace(y("^"+i),""),s=["",O.h1[r?0:1],O.h2[r?0:1],O.h3,O.h4,O.h5,O.h6];return t[0]().set(f+u+a).select(f.length,(f+u).length).tidy("\n\n"),0===z||(3>z&&r?t.wrap("","\n"+u.replace(/./g,s[z])):t.wrap(s[z]+" ",_["close_h1,h2,h3,h4,h5,h6"]?" "+s[z]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,i=O.blockquote;return r===H[""]?(t.select(),!1):r?(t.tidy(y(i+" $").test(n.before)?!1:"\n\n")[y("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(H[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),r=n.before,i=n.value,o=_["advance_pre,code"],f=O.code,a=f[1]||f[0];a=a+a+a,!v(o)&&o?o=a:v(o)&&-1!==o.indexOf("%1")&&(o=u(o,[a]));var s="( {4,}|\\t"+(v(o)?"|"+l(o):"")+")";if(y("(^|\\n)"+s+"?$").test(r)){if(o)return t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(o=M===p?p:"    ",!i){t[0]().tidy("\n\n");var c=t.$().start,d=o+H[""];return t.insert(d).select(c+o.length,c+d.length)[1](),!1}return i===H[""]&&y(s+"$").test(r)?(t.select(n.start-o.length,n.end),!1):(t.tidy("\n\n")[y("^"+s).test(i)?"outdent":"indent"](o),!1)}return t.mark(f[0]),!1}},ul:{i:"list-ul",click:function(e,t){var o,n=t.$(),r=n.value,i=n.before,f=n.after,a=O.ul[0],s=O.ol,c=l(a),p=u(l(s),["\\d+"]),d=y("(^|\\n)([\\t ]*) "+c+" (.*)$"),h=y("^(.*) "+c+" ","gm"),v=y("(^|\\n)([\\t ]*) "+p+" (.*)$"),b=y("^(.*) "+p+" ","gm");return r?(r===H[""]?t.select():b.test(r)?t.replace(b,"$1 "+a+" "):h.test(r)?t[0]().replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&f?(o=v.test(i)?i.replace(v,"$1$2 "+a+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(o+f).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert(H[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var o,n=t.$(),r=n.value,i=n.before,f=n.after,a=O.ul[0],s=O.ol,c=u(s,[1]),p=l(a),d=u(l(s),["\\d+"]),h=y("(^|\\n)([\\t ]*) "+p+" (.*)$"),v=y("^(.*) "+p+" ","gm"),b=y("(^|\\n)([\\t ]*) "+d+" (.*)$"),g=y("^(.*) "+d+" ","gm"),m=0;return r?(r===H[""]?t.select():v.test(r)?t.replace(v,function(e,t,n){return++m,t+" "+u(s,[m])+" "}):g.test(r)?t[0]().replace(g,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++m,t+" "+u(s,[m])+" "+n}),!1):i&&f?(o=h.test(i)?i.replace(h,"$1$2 "+c+" $3"):b.test(i)?i.replace(b,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+c+" $3"),t.set(o+f).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+c+" ",-1).insert(H[""])[1](),!1)}},table:function(e,t){var a,s,c,n=L.tr,r=L.td,i=C.modals.table,o=C.placeholders.table,f=u(o[0],[1,1]),l=[];return t.$().value===f?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){s=x(parseInt(p,10)||d,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=x(parseInt(r,10)||i,n[0],n[1]);var p,d,h,v,b,g;for(p=0;c>p;++p){for(a="|",d=0;s>d;++d)a+=" "+u(o[1],[p+1,d+1])+" |";l.push(a)}for(l=l.join("\n"),a="|",h=0;s>h;++h)a+=" "+u(o[0],[h+1,h+1]).replace(/./g,"-")+" |";for(l=a+"\n"+l,a="|",v=0;s>v;++v)a+=" "+u(o[0],[1,v+1])+" |";l=a+"\n"+l,_.close_tr||(l=l.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(l),b=t.$(),g=b.start+b.value.indexOf(f),t.select(g,g+f.length)[1]()})}),!1)},hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(O.hr[0]+"\n\n",-1),!1}}}),f(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=_.advance_br;return!v(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=O.blockquote,o=(O.ul[0],O.ol),f=u(l(o),["\\d+"]),a="(("+l(r)+" )+|"+bullet_any+"| +("+f+") )",s=y("^"+a+".*$","gm").exec(n.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(y(a)),!1;if(y("\\s*"+f+"\\s*").test(s[1])){var c=parseInt(w(s[1]),10);return t.insert("\n"+s[1].replace(/\d+/,c+1),-1).scroll("+1"),!1}return t.insert("\n"+s[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var b,n=t.$(),r=n.before,i=n.value,f=n.after,a=O.ol,s=l(a),c=u(s,["\\d+"]),p=l(O.blockquote),d=y("  "+bullet_any+"$"),h=y("   ( ?"+c+" )$"),v="("+p+" |"+bullet_any+"| +"+c+" )";if(i){if(i&&(b=i.match(y("(^|\\n)"+v,"g"))))return t.outdent(y(v)),!1}else{if(b=r.match(y(p+" $")))return t.outdent(b[0]),!1;if(b=r.match(d))return r=r.replace(d,"$1"),t.set(r+f).select(r.length),!1;if(b=r.match(h))return r=r.replace(h,"$1"),t.set(r+f).select(r.length),!1}return o.tools.outdent.click(e,t)},tab:function(e,t){var d,n=t.$(),r=n.before,i=n.value,f=n.after,a=O.ol,s=l(a),c=y(bullet_any+"$"),p=y(" ?"+u(s,["\\d+"])+" $");if(!i){if(d=r.match(y(l(O.blockquote)+" $")))return t.insert(d[0],-1),!1;if(d=r.match(c))return r=r.replace(c,"  $1"),t.set(r+f).select(r.length),!1;if(d=r.match(p))return r=r.replace(p,"    "+u(a,[1])+" "),t.set(r+f).select(r.length),!1}return o.tools.indent.click(e,t)}}),i.update({},0)};
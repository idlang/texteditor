/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.0.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function o(e){return"undefined"!=typeof e}function d(e){return"object"==typeof e}function $(e,t){return new RegExp(e,t)}function g(e){return e.replace(/^\s*|\s*$/g,"")}function m(e){return e.replace(/\s+$/,"")}function b(e,t,n){return t>e?t:e>n?n:e}function v(e){return parseInt(e,10)}function k(e){return w(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function y(e){return w(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function w(e){return g(e.replace(/\s+/g," "))}function I(e){var c,t=i.$(),n=t.value,r=t.before,l=t.after,a=s(e),f=$("(^|\\n)"+a+"(.*)$"),o=$("^"+a,"gm"),u=E[""];return i[0](),n?$(a+"$").test(r)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),o.test(n)?i.replace(o,""):i.replace(/(^|\n{2})/g,"$1"+e)):r&&l?(c=f.test(r)?r.replace(f,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(c+l).select(c.length)):i.tidy("\n\n").insert(e,-1).insert(u),i[1](),!1}var i=(window,document,new TE.HTML(e)),l=i.ui,a=i._.extend,s=i._.x,f=i._.format;i.update(a({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],ul:["*"],ol:["#"],hr:["---","***"]}},t),0),i.type="Textile";var x=i.config,_=x.states,T=x.languages,S=x.formats,E=(x.tab,T.placeholders);return i.mark=function(e,t,n,r){d(e)||(e=[e]),o(n)||(n=" "),o(r)||(r="");var l=i[0]().$(),a=e[0]+r,f=r+(o(e[1])?e[1]:e[0]),u=l.value,c=s(a),p=s(f),h=$("^"+c+"([\\s\\S]*?)"+p+"$"),g=$(c+"$"),m=$("^"+p),b=l.before,v=l.after;return u?n=!1:i.insert(E[""]),i.toggle(t?!h.test(u):!g.test(b)&&!m.test(v),[function(e){e.unwrap(a,f,1).tidy(/<[^\/<>]+?>$/.test(b)?"":n,/^<\/[^<>]+?>/.test(v)?"":n).wrap(a,f,t)[1]()},function(e){e.unwrap(a,f,t)[1]()}])},a(l.tools,{b:{click:function(e,t){return t.i().mark(S.b[0]),!1}},i:{click:function(e,t){return t.i().mark(S.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var c,p,d,h,$,b,v,n=t.$(),r=n.before,i=n.value,l=n.after,a=t.get(),s=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^\[\S+?\]/gm)||[],o=T.modals.a,u=o.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in f)v=" "+g(f[v]).replace(/^\[|\]$/g,""),_.a[v]=1;return c=_.a,t.record().ui.prompt(["a[href]",o.title[0]],u,1,function(e,t,a){a=y(a),t[0](),c[a]?(t.trim(g(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+a],0,!1),h=f.indexOf("["+a+"]"),-1===h&&1!==c[a]&&(n=t.$(),r=n.before,$=n.start,b=n.end,t.set(r+n.value+m(n.after)+s+"["+(a||g(i)||E[""])+"]"+c[a][0]).select($,b))):(p=a,t.blur().ui.prompt(["a[title]",o.title[1]],o.placeholder[1],0,function(e,t,n){d=k(n),/^\![^\s]+?\!$/.test(i)?(d&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+d+")!"),t.insert(":"+p,1)):(i||t.insert(E[""]),t.i().trim(g(r)?" ":"",g(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,l,r=(t.$(),T.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=y(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){l=k(n),t.tidy("\n\n","").insert("!"+i+(l?"("+l+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,n=t.$(),i=(n.before,n.after),l=T.modals.sup,a=t.get(),s=/^fn\d+\^?\. /.test(g(a).split("\n").pop())?"\n":"\n\n",f=a.match(/^fn\d+\^?\. /gm)||[],o=0;return o=f.length+1,t.ui.prompt(["sup[id]",l.title],n.value||l.placeholder||o,0,function(e,t,n){n=g(n)||o,u=f.indexOf("fn"+n+". "),-1!==u?(o=a.indexOf(f[u])+2,t.select(o,o+n.length)):t.trim("",!g(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+n+"]").set(m(t.get())+s+"fn"+n+". ").focus(!0).insert(E[""])}),!1}},abbr:{click:function(e,t){var c,n=t.$(),r=g(n.value),i=T.modals.abbr,l=t.get(),a=w(r||E[""]),s=l.match(/\b[A-Z\d]+\(.*?\)/g)||[],f=_.abbr,o=/\(.*?\)/,u=0;for(u in s)c=s[u].match(/^(.*?)\((.*?)\)$/),_.abbr[c[1]]=g(c[2]);return f=_.abbr,r&&f[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+f[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],f[a]||i.placeholder,!f[r],function(e,t,n,i){n=k(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in f)if(k(f[u])===n){t.insert(u);break}t.unwrap("",o).unwrap("",o,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{click:function(e,t){return I("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,l,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),l=+(i[1]||0),t[0]().i(),n.value||t.insert(E[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>l?"h"+(l+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return I("bq. ")}},"pre,code":{click:function(e,t){return $("(^|\\n)$").test(t.$().before)?I("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var m,n=t.$(),r=n.value,i=n.before,l=n.after,a=S.ul[0],f=S.ol[0],o=s(a),u=s(f),c=$("(^|\\n)([\\t ]*)"+o+" (.*)$"),p=$("^(.*)"+o+" ","gm"),d=$("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=$("^(.*)"+u+" ","gm"),g=E[""];return r?(r===g?t.select():h.test(r)?t.replace(h,"$1"+a+" "):p.test(r)?t.replace(p,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+a+" $2"),!1):i&&l?(m=d.test(i)?i.replace(d,"$1$2"+a+" $3"):c.test(i)?i.replace(c,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+a+" $3"),t.set(m+l).select(m.length),!1):(t[0]().tidy("\n\n").insert(a+" ",-1).insert(g)[1](),!1)}},ol:{click:function(e,t){var m,n=t.$(),r=n.value,i=n.before,l=n.after,a=S.ul[0],f=S.ol[0],o=s(a),u=s(f),c=$("(^|\\n)([\\t ]*)"+o+" (.*)$"),p=$("^(.*)"+o+" ","gm"),d=$("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=$("^(.*)"+u+" ","gm"),g=E[""];return r?(r===g?t.select():p.test(r)?t.replace(p,function(e,t,n){return t+f+" "}):h.test(r)?t.replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+f+" "+n}),!1):i&&l?(m=c.test(i)?i.replace(c,"$1$2"+f+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+f+" $3"),t.set(m+l).select(m.length),!1):(t[0]().tidy("\n\n").insert(f+" ",-1).insert(g)[1](),!1)}},table:function(e,t){var u,c,p,n=_.tr,r=_.td,i=T.modals.table,l=T.placeholders.table,a=f(l[0],[1,1]),s=x.advance_table,o=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,d,h){c=b(v(d)||h,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){p=b(v(r)||i,n[0],n[1]);var d,h,g,m,k;for(d=0;p>d;++d){for(u="|",h=0;c>h;++h)u+="   "+f(l[1],[d+1,h+1])+" |";o.push(u)}for(o=o.join("\n"),u="|",g=0;c>g;++g)u+="_. "+f(l[0],[1,g+1])+" |";if(s){for(u+="\n|~.\n|",g=0;c>g;++g)u+="   "+f(l[2],[1,g+1])+" |";u+="\n|-."}o=u+"\n"+o,s&&(o="|^.\n"+o),t.tidy("\n\n").insert(o),m=t.$(),k=m.start+m.value.indexOf(a),t.select(k,k+a.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(S.hr[0]+"\n\n",-1),!1}}}),a(l.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),r=S.ul[0],i=S.ol[0],l=s(r),a=s(i),f="((?:"+l+"|"+a+")+ )",o=$("^"+f+".*$","gm").exec(n.before.split("\n").pop());return o?o[0]===o[1]?(t.outdent($(f)),!1):(t.insert("\n"+o[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,i=n.before,a=S.ul[0],f=S.ol[0],o=s(a),u=s(f),c="(^|\\n)("+o+"){2,}",p="(^|\\n)("+u+"){2,}";return r===E[""]?(t.select(),!1):$(c+" $").test(i)?(t.replace($(o+" $")," ",-1),!1):$(c).test(r)?(t.replace($("^"+o+" *","gm"),""),!1):$(p+" $").test(i)?(t.replace($(u+" $")," ",-1),!1):$(p).test(r)?(t.replace($("^"+u+" *","gm"),""),!1):l.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,i=n.before,a=S.ul[0],f=S.ol[0],o=s(a),u=s(f),c="(^|\\n)("+o+")+",p="(^|\\n)("+u+")+";return r===E[""]?(t.select(),!1):$(c+" $").test(i)?(t.replace(/ $/,a+" ",-1),!1):$(c).test(r)?(t.replace(/^(?!$)/gm,a),!1):$(p+" $").test(i)?(t.replace(/ $/,f+" ",-1),!1):$(p).test(r)?(t.replace(/^(?!$)/gm,f),!1):l.tools.indent.click(e,t)}}),i.update({},0)};
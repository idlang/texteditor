/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 0.0.9
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function d(e){return"undefined"!=typeof e}function b(e){return"string"==typeof e}function g(e){return"object"==typeof e}function y(e,t){return new RegExp(e,t)}function k(e){return e.replace(/^\s*|\s*$/g,"")}function w(e){return e.replace(/\s+$/,"")}function $(e,t,n){return t>e?t:e>n?n:e}function x(e){return E(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function T(e){return E(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function E(e){return k(e.replace(/\s+/g," "))}var i=(window,document,new TE.HTML(e)),o=i.ui,l=i._.extend,f=i._.x,a=i._.format,p="	";i.update(l({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],p:"",hr:["---","***"]}},t),0),i.type="Textile";var _=i.config,L=_.states,C=_.languages,O=_.formats,M=_.tab,H=C.placeholders,z=0;return i.mark=function(e,t,n,r){g(e)||(e=[e]),d(n)||(n=" "),d(r)||(r="");var o=i[0]().$(),l=e[0]+r,a=r+(d(e[1])?e[1]:e[0]),u=o.value,s=f(l),c=f(a),p=y("^"+s+"([\\s\\S]*?)"+c+"$"),h=y(s+"$"),b=y("^"+c),v=o.before,m=o.after;return u?n=!1:i.insert(H[""]),i.toggle(t?!p.test(u):!h.test(v)&&!b.test(m),[function(e){e.unwrap(l,a,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(m)?"":n).wrap(l,a,t)[1]()},function(e){e.unwrap(l,a,t)[1]()}])},l(o.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(O.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(O.i[0]),!1}},u:0,s:{i:"strikethrough",click:function(e,t){return t.i().mark("-"),!1}},a:{i:"link",click:function(e,t){var c,p,d,h,b,v,g,n=t.$(),r=n.before,i=n.value,o=n.after,l=t.get(),f=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",a=l.match(/^\[\S+?\]/gm)||[],u=C.modals.a,s=u.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(g in a)g=" "+k(a[g]).replace(/^\[|\]$/g,""),L.a[g]=1;return c=L.a,t.record().ui.prompt(["a[href]",u.title[0]],s,0,function(e,t,l){l=T(l),t[0](),c[l]?(t.trim(k(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+l],0,!1),h=a.indexOf("["+l+"]"),-1===h&&1!==c[l]&&(n=t.$(),r=n.before,b=n.start,v=n.end,t.set(r+n.value+w(n.after)+f+"["+(l||k(i)||H[""])+"]"+c[l][0]).select(b,v))):(p=l,t.blur().ui.prompt(["a[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){d=x(n),i||t.insert(H[""]),t.i().trim(k(r)?" ":"",k(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p)})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var i,o,r=(t.$(),C.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=T(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){o=x(n),t.tidy("\n\n","").insert("!"+i+(o?"("+o+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var s,n=t.$(),i=(n.before,n.after),o=C.modals.sup,l=t.get(),f=/^fn\d+\^?\. /.test(k(l).split("\n").pop())?"\n":"\n\n",a=l.match(/^fn\d+\^?\. /gm)||[],u=0;return u=a.length+1,t.ui.prompt(["sup[id]",o.title],n.value||o.placeholder||u,0,function(e,t,n){n=k(n)||u,s=a.indexOf("fn"+n+". "),-1!==s?(u=l.indexOf(a[s])+2,t.select(u,u+n.length)):t.trim("",!k(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+n+"]").set(w(t.get())+f+"fn"+n+". ").focus(!0).insert(H[""])}),!1}},abbr:{i:"question",click:function(e,t){var c,n=t.$(),r=k(n.value),i=C.modals.abbr,o=t.get(),l=E(r||H[""]),f=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],a=L.abbr,u=/\(.*?\)/,s=0;for(s in f)c=f[s].match(/^(.*?)\((.*?)\)$/),L.abbr[c[1]]=k(c[2]);return a=L.abbr,r&&a[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+a[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],a[l]||i.placeholder,!a[r],function(e,t,n,r){n=x(n||r),t[0]();for(s in a)if(x(a[s])===n){t.insert(s);break}t.unwrap("",u).unwrap("",u,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(H[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){z>5?z=0:z++;var n=t.$(),r=_["advance_h1,h2"],i="\\s?["+f(O.h1[0]+O.h2[0])+"]+\\s*",o=f(O.h1[1]),l=n.before.replace(y("["+o+"\\s]+$"),""),a=E(n.value).replace(y("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(y(i+"$"),"")||H[""],u=n.after.replace(y("^["+o+"\\s]+"),"").replace(y("^"+i),""),s=["",O.h1[r?0:1],O.h2[r?0:1],O.h3,O.h4,O.h5,O.h6];return t[0]().set(l+a+u).select(l.length,(l+a).length).tidy("\n\n"),0===z||(3>z&&r?t.wrap("","\n"+a.replace(/./g,s[z])):t.wrap(s[z]+" ",_["close_h1,h2,h3,h4,h5,h6"]?" "+s[z]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,i=O.blockquote;return r===H[""]?(t.select(),!1):r?(t.tidy(y(i+" $").test(n.before)?!1:"\n\n")[y("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(H[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),r=n.before,i=n.value,o=_["advance_pre,code"],l=O.code,u=l[1]||l[0];u=u+u+u,!b(o)&&o?o=u:b(o)&&-1!==o.indexOf("%1")&&(o=a(o,[u]));var s="( {4,}|\\t"+(b(o)?"|"+f(o):"")+")";if(y("(^|\\n)"+s+"?$").test(r)){if(o)return t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(o=M===p?p:"    ",!i){t[0]().tidy("\n\n");var c=t.$().start,d=o+H[""];return t.insert(d).select(c+o.length,c+d.length)[1](),!1}return i===H[""]&&y(s+"$").test(r)?(t.select(n.start-o.length,n.end),!1):(t.tidy("\n\n")[y("^"+s).test(i)?"outdent":"indent"](o),!1)}return t.mark(l[0]),!1}},ul:{i:"list-ul",click:function(e,t){var o,n=t.$(),r=n.value,i=n.before,l=n.after,u=O.ul[0],s=O.ol,c=f(u),p=a(f(s),["\\d+"]),d=y("(^|\\n)([\\t ]*) "+c+" (.*)$"),h=y("^(.*) "+c+" ","gm"),b=y("(^|\\n)([\\t ]*) "+p+" (.*)$"),v=y("^(.*) "+p+" ","gm");return r?(r===H[""]?t.select():v.test(r)?t.replace(v,"$1 "+u+" "):h.test(r)?t[0]().replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+u+" $2"),!1):i&&l?(o=b.test(i)?i.replace(b,"$1$2 "+u+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+u+" $3"),t.set(o+l).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+u+" ",-1).insert(H[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var o,n=t.$(),r=n.value,i=n.before,l=n.after,u=O.ul[0],s=O.ol,c=a(s,[1]),p=f(u),d=a(f(s),["\\d+"]),h=y("(^|\\n)([\\t ]*) "+p+" (.*)$"),b=y("^(.*) "+p+" ","gm"),v=y("(^|\\n)([\\t ]*) "+d+" (.*)$"),g=y("^(.*) "+d+" ","gm"),m=0;return r?(r===H[""]?t.select():b.test(r)?t.replace(b,function(e,t,n){return++m,t+" "+a(s,[m])+" "}):g.test(r)?t[0]().replace(g,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++m,t+" "+a(s,[m])+" "+n}),!1):i&&l?(o=h.test(i)?i.replace(h,"$1$2 "+c+" $3"):v.test(i)?i.replace(v,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+c+" $3"),t.set(o+l).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+c+" ",-1).insert(H[""])[1](),!1)}},table:function(e,t){var u,s,c,n=L.tr,r=L.td,i=C.modals.table,o=C.placeholders.table,l=a(o[0],[1,1]),f=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){s=$(parseInt(p,10)||d,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=$(parseInt(r,10)||i,n[0],n[1]);var p,d,h,b,v,g;for(p=0;c>p;++p){for(u="|",d=0;s>d;++d)u+=" "+a(o[1],[p+1,d+1])+" |";f.push(u)}for(f=f.join("\n"),u="|",h=0;s>h;++h)u+=" "+a(o[0],[h+1,h+1]).replace(/./g,"-")+" |";for(f=u+"\n"+f,u="|",b=0;s>b;++b)u+=" "+a(o[0],[1,b+1])+" |";f=u+"\n"+f,_.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f),v=t.$(),g=v.start+v.value.indexOf(l),t.select(g,g+l.length)[1]()})}),!1)},hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(O.hr[0]+"\n\n",-1),!1}}}),l(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=_.advance_br;return!b(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=O.blockquote,o=(O.ul[0],O.ol),l=a(f(o),["\\d+"]),u="(("+f(r)+" )+|"+bullet_any+"| +("+l+") )",s=y("^"+u+".*$","gm").exec(n.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(y(u)),!1;if(y("\\s*"+l+"\\s*").test(s[1])){var c=parseInt(k(s[1]),10);return t.insert("\n"+s[1].replace(/\d+/,c+1),-1).scroll("+1"),!1}return t.insert("\n"+s[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var v,n=t.$(),r=n.before,i=n.value,l=n.after,u=O.ol,s=f(u),c=a(s,["\\d+"]),p=f(O.blockquote),d=y("  "+bullet_any+"$"),h=y("   ( ?"+c+" )$"),b="("+p+" |"+bullet_any+"| +"+c+" )";if(i){if(i&&(v=i.match(y("(^|\\n)"+b,"g"))))return t.outdent(y(b)),!1}else{if(v=r.match(y(p+" $")))return t.outdent(v[0]),!1;if(v=r.match(d))return r=r.replace(d,"$1"),t.set(r+l).select(r.length),!1;if(v=r.match(h))return r=r.replace(h,"$1"),t.set(r+l).select(r.length),!1}return o.tools.outdent.click(e,t)},tab:function(e,t){var d,n=t.$(),r=n.before,i=n.value,l=n.after,u=O.ol,s=f(u),c=y(bullet_any+"$"),p=y(" ?"+a(s,["\\d+"])+" $");if(!i){if(d=r.match(y(f(O.blockquote)+" $")))return t.insert(d[0],-1),!1;if(d=r.match(c))return r=r.replace(c,"  $1"),t.set(r+l).select(r.length),!1;if(d=r.match(p))return r=r.replace(p,"    "+a(u,[1])+" "),t.set(r+l).select(r.length),!1}return o.tools.indent.click(e,t)}}),i.update({},0)};
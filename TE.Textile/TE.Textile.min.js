/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.0.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function m(e){return $(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function y(e){return $(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function $(e){return d(e.replace(/\s+/g," "))}function C(e){var s,t=i.$(),r=t.value,n=t.before,o=t.after,l=p(e),a=g("(^|\\n)"+l+"(.*)$"),f=g("^"+l,"gm"),u=T[""];return i[0](),r?g(l+"$").test(n)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),f.test(r)?i.replace(f,""):i.replace(/(^|\n{2})/g,"$1"+e)):n&&o?(s=a.test(n)?n.replace(a,"$1$2"):n.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(s+o).select(s.length)):i.tidy("\n\n").insert(e,-1).insert(u),i[1](),!1}var i=(window,document,new TE.HTML(e)),o=i.ui,l=i.is,a=l.o,f=function(e){return!l.x(e)},s=(l.s,i._),c=s.extend,p=s.x,d=s.trim,h=s.edge,g=s.pattern,v=s.format,b=s.i;i.update(c({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],ul:["*"],ol:["#"],hr:["---","***"]}},t),0),i.type="Textile";var w=i.config,k=w.states,x=w.languages,_=w.formats,T=(w.tab,x.placeholders);return i.mark=function(e,t,r,n){a(e)||(e=[e]),f(r)||(r=" "),f(n)||(n="");var o=i[0]().$(),l=e[0]+n,u=n+(f(e[1])?e[1]:e[0]),s=o.value,c=p(l),d=p(u),h=g("^"+c+"([\\s\\S]*?)"+d+"$"),v=g(c+"$"),b=g("^"+d),m=o.before,y=o.after;return s?r=!1:i.insert(T[""]),i.toggle(t?!h.test(s):!v.test(m)&&!b.test(y),[function(e){e.unwrap(l,u,1).tidy(/<[^\/<>]+?>$/.test(m)?"":r,/^<\/[^<>]+?>/.test(y)?"":r).wrap(l,u,t)[1]()},function(e){e.unwrap(l,u,t)[1]()}])},c(o.tools,{b:{click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var c,p,h,g,v,b,$,r=t.$(),n=r.before,i=r.value,o=r.after,l=t.get(),a=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",f=l.match(/^\[\S+?\]/gm)||[],u=x.modals.a,s=u.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for($ in f)$=" "+d(f[$]).replace(/^\[|\]$/g,""),k.a[$]=1;return c=k.a,t.record().ui.prompt(["a[href]",u.title[0]],s,1,function(e,t,l){l=y(l),t[0](),c[l]?(t.trim(d(n)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+l],0,!1),g=f.indexOf("["+l+"]"),-1===g&&1!==c[l]&&(r=t.$(),n=r.before,v=r.start,b=r.end,t.set(n+r.value+d(r.after,1)+a+"["+(l||d(i)||T[""])+"]"+c[l][0]).select(v,b))):(p=l,t.blur().ui.prompt(["a[title]",u.title[1]],u.placeholder[1],0,function(e,t,r){h=m(r),/^\![^\s]+?\!$/.test(i)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+p,1)):(i||t.insert(T[""]),t.i().trim(d(n)?" ":"",d(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n ":" ":"").wrap('"',(h?"("+h+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,o,n=(t.$(),x.modals.img);return t.ui.prompt(["img[src]",n.title[0]],n.placeholder[0],1,function(e,t,r){i=y(r),t.blur().ui.prompt(["img[title]",n.title[1]],n.placeholder[1],0,function(e,t,r){o=m(r),t.tidy("\n\n","").insert("!"+i+(o?"("+o+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var s,r=t.$(),i=(r.before,r.after),o=x.modals.sup,l=t.get(),a=/^fn\d+\^?\. /.test(d(l).split("\n").pop())?"\n":"\n\n",f=l.match(/^fn\d+\^?\. /gm)||[],u=0;return u=f.length+1,t.ui.prompt(["sup[id]",o.title],r.value||o.placeholder||u,0,function(e,t,r){r=d(r)||u,s=f.indexOf("fn"+r+". "),-1!==s?(u=l.indexOf(f[s])+2,t.select(u,u+r.length)):t.trim("",!d(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+r+"]").set(d(t.get(),1)+a+"fn"+r+". ").focus(!0).insert(T[""])}),!1}},abbr:{click:function(e,t){var c,r=t.$(),n=d(r.value),i=x.modals.abbr,o=t.get(),l=$(n||T[""]),a=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],f=k.abbr,u=/\(.*?\)/,s=0;for(s in a)c=a[s].match(/^(.*?)\((.*?)\)$/),k.abbr[c[1]]=d(c[2]);return f=k.abbr,n&&f[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+f[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],f[l]||i.placeholder,!f[n],function(e,t,r,i){r=m(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(s in f)if(m(f[s])===r){t.insert(s);break}t.unwrap("",u).unwrap("",u,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return C("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,r=t.$(),n=/(?:p|h\d+)\. +/;return(i=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=r.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),r.value||t.insert(T[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return C("bq. ")}},"pre,code":{click:function(e,t){return g("(^|\\n)$").test(t.$().before)?C("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var b,r=t.$(),n=r.value,i=r.before,o=r.after,l=_.ul[0],a=_.ol[0],f=p(l),u=p(a),s=g("(^|\\n)([\\t ]*)"+f+" (.*)$"),c=g("^(.*)"+f+" ","gm"),d=g("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=g("^(.*)"+u+" ","gm"),v=T[""];return n?(n===v?t.select():h.test(n)?t.replace(h,"$1"+l+" "):c.test(n)?t.replace(c,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+l+" $2"),!1):i&&o?(b=d.test(i)?i.replace(d,"$1$2"+l+" $3"):s.test(i)?i.replace(s,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+l+" $3"),t.set(b+o).select(b.length),!1):(t[0]().tidy("\n\n").insert(l+" ",-1).insert(v)[1](),!1)}},ol:{click:function(e,t){var b,r=t.$(),n=r.value,i=r.before,o=r.after,l=_.ul[0],a=_.ol[0],f=p(l),u=p(a),s=g("(^|\\n)([\\t ]*)"+f+" (.*)$"),c=g("^(.*)"+f+" ","gm"),d=g("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=g("^(.*)"+u+" ","gm"),v=T[""];return n?(n===v?t.select():c.test(n)?t.replace(c,function(e,t,r){return t+a+" "}):h.test(n)?t.replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+a+" "+r}),!1):i&&o?(b=s.test(i)?i.replace(s,"$1$2"+a+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+a+" $3"),t.set(b+o).select(b.length),!1):(t[0]().tidy("\n\n").insert(a+" ",-1).insert(v)[1](),!1)}},table:function(e,t){var u,s,c,r=k.tr,n=k.td,i=x.modals.table,o=x.placeholders.table,l=v(o[0],[1,1]),a=w.advance_table,f=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){s=h(b(p)||d,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,i){c=h(b(n)||i,r[0],r[1]);var p,d,m,y,$;for(p=0;c>p;++p){for(u="|",d=0;s>d;++d)u+="   "+v(o[1],[p+1,d+1])+" |";f.push(u)}for(f=f.join("\n"),u="|",m=0;s>m;++m)u+="_. "+v(o[0],[1,m+1])+" |";if(a){for(u+="\n|~.\n|",m=0;s>m;++m)u+="   "+v(o[2],[1,m+1])+" |";u+="\n|-."}f=u+"\n"+f,a&&(f="|^.\n"+f),t.tidy("\n\n").insert(f),y=t.$(),$=y.start+y.value.indexOf(l),t.select($,$+l.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",-1),!1}}}),c(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n=_.ul[0],i=_.ol[0],o=p(n),l=p(i),a="((?:"+o+"|"+l+")+ )",f=g("^"+a+".*$","gm").exec(r.before.split("\n").pop());return f?f[0]===f[1]?(t.outdent(g(a)),!1):(t.insert("\n"+f[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),n=r.value,i=r.before,l=_.ul[0],a=_.ol[0],f=p(l),u=p(a),s="(^|\\n)("+f+"){2,}",c="(^|\\n)("+u+"){2,}";return n===T[""]?(t.select(),!1):g(s+" $").test(i)?(t.replace(g(f+" $")," ",-1),!1):g(s).test(n)?(t.replace(g("^"+f+" *","gm"),""),!1):g(c+" $").test(i)?(t.replace(g(u+" $")," ",-1),!1):g(c).test(n)?(t.replace(g("^"+u+" *","gm"),""),!1):o.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),n=r.value,i=r.before,l=_.ul[0],a=_.ol[0],f=p(l),u=p(a),s="(^|\\n)("+f+")+",c="(^|\\n)("+u+")+";return n===T[""]?(t.select(),!1):g(s+" $").test(i)?(t.replace(/ $/,l+" ",-1),!1):g(s).test(n)?(t.replace(/^(?!$)/gm,l),!1):g(c+" $").test(i)?(t.replace(/ $/,a+" ",-1),!1):g(c).test(n)?(t.replace(/^(?!$)/gm,a),!1):o.tools.indent.click(e,t)}}),i.update({},0)};
/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.0.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function p(e){return"undefined"!=typeof e}function g(e){return"object"==typeof e}function b(e,t){return new RegExp(e,t)}function v(e){return e.replace(/^\s*|\s*$/g,"")}function k(e){return e.replace(/\s+$/,"")}function y(e,t,n){return t>e?t:e>n?n:e}function w(e){return parseInt(e,10)}function x(e){return T(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function _(e){return T(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function T(e){return v(e.replace(/\s+/g," "))}function R(e){var c,t=i.$(),n=t.value,r=t.before,l=t.after,a=s(e),f=b("(^|\\n)"+a+"(.*)$"),o=b("^"+a,"gm"),u=O[""];return i[0](),n?b(a+"$").test(r)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),o.test(n)?i.replace(o,""):i.replace(/(^|\n{2})/g,"$1"+e)):r&&l?(c=f.test(r)?r.replace(f,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(c+l).select(c.length)):i.tidy("\n\n").insert(e,-1).insert(u),i[1](),!1}var i=(window,document,new TE.HTML(e)),l=i.ui,a=i._.extend,s=i._.x,f=i._.format;i.update(a({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],ul:["*"],ol:["#"],hr:["---","***"]}},t),0),i.type="Textile";var S=i.config,q=S.states,E=S.languages,I=S.formats,O=(S.tab,E.placeholders);return i.mark=function(e,t,n,r){g(e)||(e=[e]),p(n)||(n=" "),p(r)||(r="");var l=i[0]().$(),a=e[0]+r,f=r+(p(e[1])?e[1]:e[0]),o=l.value,u=s(a),c=s(f),d=b("^"+u+"([\\s\\S]*?)"+c+"$"),h=b(u+"$"),$=b("^"+c),m=l.before,v=l.after;return o?n=!1:i.insert(O[""]),i.toggle(t?!d.test(o):!h.test(m)&&!$.test(v),[function(e){e.unwrap(a,f,1).tidy(/<[^\/<>]+?>$/.test(m)?"":n,/^<\/[^<>]+?>/.test(v)?"":n).wrap(a,f,t)[1]()},function(e){e.unwrap(a,f,t)[1]()}])},a(l.tools,{b:{click:function(e,t){return t.i().mark(I.b[0]),!1}},i:{click:function(e,t){return t.i().mark(I.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var c,p,d,h,$,g,m,n=t.$(),r=n.before,i=n.value,l=n.after,a=t.get(),s=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^\[\S+?\]/gm)||[],o=E.modals.a,u=o.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(m in f)m=" "+v(f[m]).replace(/^\[|\]$/g,""),q.a[m]=1;return c=q.a,t.record().ui.prompt(["a[href]",o.title[0]],u,0,function(e,t,a){a=_(a),t[0](),c[a]?(t.trim(v(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+a],0,!1),h=f.indexOf("["+a+"]"),-1===h&&1!==c[a]&&(n=t.$(),r=n.before,$=n.start,g=n.end,t.set(r+n.value+k(n.after)+s+"["+(a||v(i)||O[""])+"]"+c[a][0]).select($,g))):(p=a,t.blur().ui.prompt(["a[title]",o.title[1]],o.placeholder[1],0,function(e,t,n){d=x(n),/^\![^\s]+?\!$/.test(i)?(d&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+d+")!"),t.insert(":"+p,1)):(i||t.insert(O[""]),t.i().trim(v(r)?" ":"",v(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,l,r=(t.$(),E.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=_(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){l=x(n),t.tidy("\n\n","").insert("!"+i+(l?"("+l+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,n=t.$(),i=(n.before,n.after),l=E.modals.sup,a=t.get(),s=/^fn\d+\^?\. /.test(v(a).split("\n").pop())?"\n":"\n\n",f=a.match(/^fn\d+\^?\. /gm)||[],o=0;return o=f.length+1,t.ui.prompt(["sup[id]",l.title],n.value||l.placeholder||o,0,function(e,t,n){n=v(n)||o,u=f.indexOf("fn"+n+". "),-1!==u?(o=a.indexOf(f[u])+2,t.select(o,o+n.length)):t.trim("",!v(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+n+"]").set(k(t.get())+s+"fn"+n+". ").focus(!0).insert(O[""])}),!1}},abbr:{click:function(e,t){var c,n=t.$(),r=v(n.value),i=E.modals.abbr,l=t.get(),a=T(r||O[""]),s=l.match(/\b[A-Z\d]+\(.*?\)/g)||[],f=q.abbr,o=/\(.*?\)/,u=0;for(u in s)c=s[u].match(/^(.*?)\((.*?)\)$/),q.abbr[c[1]]=v(c[2]);return f=q.abbr,r&&f[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+f[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],f[a]||i.placeholder,!f[r],function(e,t,n,i){n=x(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in f)if(x(f[u])===n){t.insert(u);break}t.unwrap("",o).unwrap("",o,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{click:function(e,t){return R("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,l,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),l=+(i[1]||0),t[0]().i(),n.value||t.insert(O[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>l?"h"+(l+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return R("bq. ")}},"pre,code":{click:function(e,t){return b("(^|\\n)$").test(t.$().before)?R("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var g,n=t.$(),r=n.value,i=n.before,l=n.after,a=I.ul[0],f=I.ol[0],o=s(a),u=s(f),c=b("(^|\\n)([\\t ]*)"+o+" (.*)$"),p=b("^(.*)"+o+" ","gm"),d=b("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=b("^(.*)"+u+" ","gm"),$=O[""];return r?(r===$?t.select():h.test(r)?t.replace(h,"$1"+a+" "):p.test(r)?t.replace(p,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+a+" $2"),!1):i&&l?(g=d.test(i)?i.replace(d,"$1$2"+a+" $3"):c.test(i)?i.replace(c,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+a+" $3"),t.set(g+l).select(g.length),!1):(t[0]().tidy("\n\n").insert(a+" ",-1).insert($)[1](),!1)}},ol:{click:function(e,t){var g,n=t.$(),r=n.value,i=n.before,l=n.after,a=I.ul[0],f=I.ol[0],o=s(a),u=s(f),c=b("(^|\\n)([\\t ]*)"+o+" (.*)$"),p=b("^(.*)"+o+" ","gm"),d=b("(^|\\n)([\\t ]*)"+u+" (.*)$"),h=b("^(.*)"+u+" ","gm"),$=O[""];return r?(r===$?t.select():p.test(r)?t.replace(p,function(e,t,n){return t+f+" "}):h.test(r)?t.replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+f+" "+n}),!1):i&&l?(g=c.test(i)?i.replace(c,"$1$2"+f+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+f+" $3"),t.set(g+l).select(g.length),!1):(t[0]().tidy("\n\n").insert(f+" ",-1).insert($)[1](),!1)}},table:function(e,t){var u,c,p,n=q.tr,r=q.td,i=E.modals.table,l=E.placeholders.table,a=f(l[0],[1,1]),s=S.advance_table,o=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,d,h){c=y(w(d)||h,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){p=y(w(r)||i,n[0],n[1]);var d,h,g,m,b;for(d=0;p>d;++d){for(u="|",h=0;c>h;++h)u+="   "+f(l[1],[d+1,h+1])+" |";o.push(u)}for(o=o.join("\n"),u="|",g=0;c>g;++g)u+="_. "+f(l[0],[1,g+1])+" |";if(s){for(u+="\n|~.\n|",g=0;c>g;++g)u+="   "+f(l[2],[1,g+1])+" |";u+="\n|-."}o=u+"\n"+o,s&&(o="|^.\n"+o),t.tidy("\n\n").insert(o),m=t.$(),b=m.start+m.value.indexOf(a),t.select(b,b+a.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(I.hr[0]+"\n\n",-1),!1}}}),a(l.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),r=I.ul[0],i=I.ol[0],l=s(r),a=s(i),f="((?:"+l+"|"+a+")+ )",o=b("^"+f+".*$","gm").exec(n.before.split("\n").pop());return o?o[0]===o[1]?(t.outdent(b(f)),!1):(t.insert("\n"+o[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,i=n.before,a=I.ul[0],f=I.ol[0],o=s(a),u=s(f),c="(^|\\n)("+o+"){2,}",p="(^|\\n)("+u+"){2,}";return r===O[""]?(t.select(),!1):b(c+" $").test(i)?(t.replace(b(o+" $")," ",-1),!1):b(c).test(r)?(t.replace(b("^"+o+" *","gm"),""),!1):b(p+" $").test(i)?(t.replace(b(u+" $")," ",-1),!1):b(p).test(r)?(t.replace(b("^"+u+" *","gm"),""),!1):l.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,i=n.before,a=I.ul[0],f=I.ol[0],o=s(a),u=s(f),c="(^|\\n)("+o+")+",p="(^|\\n)("+u+")+";return r===O[""]?(t.select(),!1):b(c+" $").test(i)?(t.replace(/ $/,a+" ",-1),!1):b(c).test(r)?(t.replace(/^(?!$)/gm,a),!1):b(p+" $").test(i)?(t.replace(/ $/,f+" ",-1),!1):b(p).test(r)?(t.replace(/^(?!$)/gm,f),!1):l.tools.indent.click(e,t)}}),i.update({},0)};
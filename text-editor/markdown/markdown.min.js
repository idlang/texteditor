TE.Markdown=TE.markdown=function(e,t){function $(e){return y(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function k(e){return y(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function y(e){return d(e.replace(/\s+/g," "))}var i=(window,document,new TE.HTML(e)),a=i.ui,l=i.is,o=l.o,s=function(e){return!l.x(e)},c=l.s,u=i._,f=u.extend,p=u.x,h=u.pattern,d=u.trim,g=u.edge,b=u.format,m=u.i,v="	";i.update(f({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}},t),0),i.type="markdown";var w=i.config,x=w.states,E=w.languages,_=w.formats,T=w.tab,C=E.placeholders,O=0,S=w.extra,A="( +["+p(_.ul).join("")+"] )";return S||(w["advance_pre,code"]=0),i.mark=function(e,t,r,n){o(e)||(e=[e]),s(r)||(r=" "),s(n)||(n="");var a=i[0]().$(),l=e[0]+n,c=n+(s(e[1])?e[1]:e[0]),u=a.value,f=p(l),d=p(c),g=h("^"+f+"([\\s\\S]*?)"+d+"$"),b=h(f+"$"),m=h("^"+d),v=a.before,$=a.after;return u?r=!1:i.insert(C[""]),i.toggle(t?!g.test(u):!b.test(v)&&!m.test($),[function(e){e.unwrap(l,c,1).tidy(/<[^\/<>]+?>$/.test(v)?"":r,/^<\/[^<>]+?>/.test($)?"":r).wrap(l,c,t)[1]()},function(e){e.unwrap(l,c,t)[1]()}])},f(a.tools,{b:{click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:S?{click:function(e,t){return t.i().mark(_.s),!1}}:0,a:{click:function(e,t){var f,p,h,g,b,m,v,r=t.$(),n=r.before,i=r.value,a=r.after,l=t.get(),o=/^ {0,3}\[[^\^]+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",s=l.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=E.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(v in s)v=" "+d(s[v]).replace(/^\[|\]:$/g,""),x.a[v]=1;return f=x.a,t.record().ui.prompt(["a[href]",c.title[0]],u,0,function(e,t,l){var v=""===l;l=k(l),t[0](),f[l]?(t.trim(d(n)?" ":"",/^\n+ {0,3}\*?\[/.test(a)?!1:" ").mark(["[","]["+l+"]"],0,!1),g=s.indexOf(" ["+l+"]:"),-1===g&&1!==f[l]&&(r=t.$(),n=r.before,b=r.start,m=r.end,t.set(n+r.value+d(r.after,1)+o+" ["+(l||d(i)||C[""])+"]: "+(v?"":f[l][0]+(f[l][1]?' "'+f[l][1]+'"':""))).select(b,m),v&&t.focus(!0).insert(u))):(p=l,t.blur().ui.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,r){h=$(r),i||t.insert(C[""]),t.i().trim(d(n)?" ":"",d(a)?/^\n+ {0,3}\*?\[/.test(a)?"\n\n ":" ":"").wrap("[","]("+p+(h?' "'+h+'"':"")+")")})),t[1]()}),!1}},img:{click:function(e,t){var p,h,g,b,m,v,y,r=t.$(),n=r.value,i=r.before,a=r.after,l=t.get(),o=/^ {0,3}\[[^\^]+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",s=l.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=E.modals.img,u=/^\n* {0,3}\[.+?\]:/.test(a)?" ":"",f=d(a);for(y in s)y=" "+d(s[y]).replace(/^\[|\]:$/g,""),!x.img[y]&&(x.img[y]=1);return p=x.img,t.ui.prompt(["img[src]",c.title[0]],c.placeholder[0],1,function(e,t,a){a=k(a),h=a,n||(n=h.split(/[\/\\\\]/).pop()),n=$(n),t[0]().trim(d(i)?"\n\n":"",u),p[a]?(t.insert("!["+n+"]["+a+"]\n\n",-1,1),u&&t.select(t.$().start),b=s.indexOf(" ["+a+"]:"),-1===b&&(r=t.$(),i=r.before,m=r.start,v=r.end,t.set(i+r.value+r.after+(f?o:"")+" ["+a+"]: "+p[a][0]+(p[a][1]?' "'+p[a][1]+'"':"")).select(m,v))):t.blur().ui.prompt(["img[title]",c.title[1]],c.placeholder[1],0,function(e,t,r){g=$(r),t.insert("!["+n+"]("+h+(g?' "'+g+'"':"")+")\n\n",-1,1),u&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:S?{i:"thumb-tack",click:function(e,t){var u,r=t.$(),n=r.before,i=r.after,a=E.modals.sup,l=t.get(),o=/^ {0,3}\[\^.+?\]:/.test(d(l).split("\n").pop())?"\n":"\n\n",s=l.match(/^ {0,3}\[\^.+?\]:/gm)||[],c=0;for(c in s)s[c]=" "+d(s[c]);return c=s.length+1,t.ui.prompt(["sup[id]",a.title],r.value||a.placeholder||c,0,function(e,t,r,a){r=d(r||a)||c,u=s.indexOf(" [^"+r+"]:"),-1!==u?(c=l.indexOf(s[u])+3,t.select(c,c+r.length)):t.trim(d(n)?" ":"",!d(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("[^"+r+"]").set(d(t.get(),1)+o+" [^"+r+"]: ").focus(!0).insert(C[""])}),!1}}:0,abbr:S?{click:function(e,t){var r=t.$(),n=d(r.value),i=E.modals.abbr,a=t.get(),l=y(n||C[""]),o=/^ {0,3}\*\[.+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",s=a.match(/^ {0,3}\*\[.+?\]:/gm)||[],c=x.abbr,u=0;for(u in s)s[u]=" "+d(s[u]);return u=s.indexOf(" *["+l+"]:"),n&&-1!==u?(u=a.indexOf(s[u])+3,t.select(u,u+l.length),!1):(t.record().ui.prompt(["abbr[title]",i.title],c[l]||i.placeholder,!c[n],function(e,t,i,a){if(i=$(i),t[0]().set(d(t.get(),1)+(r.before||n?o:"")+" *["+l+"]: ").focus(!0).insert(i||a),l===C[""]){var s=t.$().start;t.select(s-3-l.length,s-3)}t[1]()}),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(C[""]),!1)}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){O>5?O=0:O++;var r=t.$(),n=w["advance_h1,h2"],i="\\s?["+p(_.h1[0]+_.h2[0])+"]+\\s*",a=p(_.h1[1]),l=r.before.replace(h("["+a+"\\s]+$"),""),o=y(r.value).replace(h("^["+a+"\\s]+|["+a+"\\s]+$","g"),"").replace(h(i+"$"),"")||C[""],s=r.after.replace(h("^["+a+"\\s]+"),"").replace(h("^"+i),""),c=["",_.h1[n?0:1],_.h2[n?0:1],_.h3,_.h4,_.h5,_.h6];return t[0]().set(l+o+s).select(l.length,(l+o).length).tidy("\n\n"),0===O||(3>O&&n?t.wrap("","\n"+o.replace(/./g,c[O])):t.wrap(c[O]+" ",w["close_h1,h2,h3,h4,h5,h6"]?" "+c[O]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var r=t.$(),n=r.value,i=_.blockquote;return n===C[""]?(t.select(),!1):n?(t.tidy(h(i+" $").test(r.before)?!1:"\n\n")[h("^"+i).test(n)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(C[""])[1](),!1)}},"pre,code":{click:function(e,t){var r=t.$(),n=r.before,i=r.value,a=w["advance_pre,code"],l=_.code,o=l[1]||l[0];o=o+o+o,!c(a)&&a?a=o:c(a)&&-1!==a.indexOf("%1")&&(a=b(a,[o]));var s="( {4,}|\\t"+(c(a)?"|"+p(a):"")+")";if(h("(^|\\n)"+s+"?$").test(n)){if(a)return t.mark([a,a.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(a=T===v?v:"    ",!i){t[0]().tidy("\n\n");var u=t.$().start,f=a+C[""];return t.insert(f).select(u+a.length,u+f.length)[1](),!1}return i===C[""]&&h(s+"$").test(n)?(t.select(r.start-a.length,r.end),!1):(t.tidy("\n\n")[h("^"+s).test(i)?"outdent":"indent"](a),!1)}return t.mark(l[0]),!1}},ul:{click:function(e,t){var v,r=t.$(),n=r.value,i=r.before,a=r.after,l=_.ul[0],o=_.ol[0],s=p(l),c=b(p(o),["\\d+"]),u=h("(^|\\n)([\\t ]*) "+s+" (.*)$"),f=h("^(.*) "+s+" ","gm"),d=h("(^|\\n)([\\t ]*) "+c+" (.*)$"),g=h("^(.*) "+c+" ","gm"),m=C[""];return n?(n===m?t.select():g.test(n)?t.replace(g,"$1 "+l+" "):f.test(n)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+l+" $2"),!1):i&&a?(v=d.test(i)?i.replace(d,"$1$2 "+l+" $3"):u.test(i)?i.replace(u,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(v+a).select(v.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",-1).insert(m)[1](),!1)}},ol:{click:function(e,t){var k,r=t.$(),n=r.value,i=r.before,a=r.after,l=_.ul[0],o=_.ol[0],s=b(o,[1]),c=p(l),u=b(p(o),["\\d+"]),f=h("(^|\\n)([\\t ]*) "+c+" (.*)$"),d=h("^(.*) "+c+" ","gm"),g=h("(^|\\n)([\\t ]*) "+u+" (.*)$"),m=h("^(.*) "+u+" ","gm"),v=C[""],$=0;return n?(n===v?t.select():d.test(n)?t.replace(d,function(e,t,r){return++$,t+" "+b(o,[$])+" "}):m.test(n)?t.replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return++$,t+" "+b(o,[$])+" "+r}),!1):i&&a?(k=f.test(i)?i.replace(f,"$1$2 "+s+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(k+a).select(k.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(v)[1](),!1)}},table:S?function(e,t){var s,c,u,r=x.tr,n=x.td,i=E.modals.table,a=E.placeholders.table,l=b(a[0],[1,1]),o=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,f,p){c=g(m(f)||p,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,i){u=g(m(n)||i,r[0],r[1]);var f,p,h,d,v,$;for(f=0;u>f;++f){for(s="|",p=0;c>p;++p)s+=" "+b(a[1],[f+1,p+1])+" |";o.push(s)}for(o=o.join("\n"),s="|",h=0;c>h;++h)s+=" "+b(a[0],[h+1,h+1]).replace(/./g,"-")+" |";for(o=s+"\n"+o,s="|",d=0;c>d;++d)s+=" "+b(a[0],[1,d+1])+" |";o=s+"\n"+o,w.close_tr||(o=o.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(o),v=t.$(),$=v.start+v.value.indexOf(l),t.select($,$+l.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",-1),!1}}}),f(a.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var r=w.advance_br;return!c(r)&&r&&(r="  \n"),t.trim().insert(r||"\n",-1).scroll(!0),!1},enter:function(e,t){var r=t.$(),n=_.blockquote,a=(_.ul[0],_.ol[0]),l=b(p(a),["\\d+"]),o="(("+p(n)+" )+|"+A+"| +("+l+") )",s=h("^"+o+".*$","gm").exec(r.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(h(o)),!1;if(h("\\s*"+l+"\\s*").test(s[1])){var c=m(d(s[1]));return t.insert("\n"+s[1].replace(/\d+/,c+1),-1).scroll(!0),!1}return t.insert("\n"+s[1],-1).scroll(!0),!1}},"shift+tab":function(e,t){var m,r=t.$(),n=r.before,i=r.value,l=r.after,o=_.ol[0],s=p(o),c=b(s,["\\d+"]),u=p(_.blockquote),f=h("  "+A+"$"),d=h("   ( ?"+c+" )$"),g="("+u+" |"+A+"| +"+c+" )";if(i){if(i&&(m=i.match(h("(^|\\n)"+g,"g"))))return t.outdent(h(g)),!1}else{if(m=n.match(h(u+" $")))return t.outdent(m[0]),!1;if(m=n.match(f))return n=n.replace(f,"$1"),t.set(n+l).select(n.length),!1;if(m=n.match(d))return n=n.replace(d,"$1"),t.set(n+l).select(n.length),!1}return a.tools.outdent.click(e,t)},tab:function(e,t){var g,r=t.$(),n=r.before,i=r.value,l=r.after,o=_.ol[0],s=_.blockquote,c=p(o),u=p(s),f=h(A+"$"),d=h(" ?"+b(c,["\\d+"])+" $");if(i){if(h("^"+u+" ").test(i))return t.indent(s+" "),!1}else{if(g=n.match(h(u+" $")))return t.insert(g[0],-1),!1;if(g=n.match(f))return n=n.replace(f,"  $1"),t.set(n+l).select(n.length),!1;if(g=n.match(d))return n=n.replace(d,"    "+b(o,[1])+" "),t.set(n+l).select(n.length),!1}return a.tools.indent.click(e,t)}}),i.update({},0)};
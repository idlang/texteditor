TE.Markdown=function(e,t){function m(e){return p(e.replace(/\s+/g," "))}function y(e){return d(m(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function w(e){return d(m(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}var n=new TE.HTML(e,{extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}}),r=n.ui,i=n.is,o=i.o,f=function(e){return!i.x(e)},u=i.s,l=n._,a=l.extend,s=l.x,c=l.pattern,d=l.replace,p=l.trim,h=l.edge,v=l.format,b=l.i,g="	";n.update(a({languages:{tools:{sup:["Footnote",n.config.languages.tools.sub[1]]}}},t),0),n.type="Markdown";var x=n.config,k=x.states,$=x.languages,E=x.formats,T=x.tab,_=$.placeholders,z=0,L=x.extra,C="( +["+s(E.ul).join("")+"] )";return L||(x["advance_pre,code"]=0),n.mark=function(e,t,r,i){o(e)||(e=[e]),f(r)||(r=" "),f(i)||(i="");var u=n[0]().$(),l=e[0]+i,a=i+(f(e[1])?e[1]:e[0]),d=u.value,p=s(l),h=s(a),v=c("^"+p+"([\\s\\S]*?)"+h+"$"),b=c(p+"$"),g=c("^"+h),m=u.before,y=u.after;return d?r=!1:n.insert(_[""]),n.toggle(t?!v.test(d):!b.test(m)&&!g.test(y),[function(e){e.unwrap(l,a,1).tidy(/<[^\/<>]+?>$/.test(m)?"":r,/^<\/[^<>]+?>/.test(y)?"":r).wrap(l,a,t)[1]()},function(e){e.unwrap(l,a,t)[1]()}])},a(r.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:L?{click:function(e,t){return t.i().mark(E.s),!1}}:0,a:{click:function(e,t){var d,h,v,b,g,m,x,n=t.$(),i=n.before,o=n.value,f=n.after,u=t.get(),l=/^ {0,3}\[[^\^]+?\]:/.test(u.split("\n").pop())?"\n":"\n\n",a=u.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],s=$.modals.a,c=s.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(o))return t.tidy(" ").mark(["<",">"],1),!1;for(x in a)x=" "+p(a[x]).replace(/^\[|\]:$/g,""),k.a[x]=1;return d=k.a,t.record().ui.prompt(["a[href]",s.title[0]],c,0,function(e,t,u){var x=""===u;u=w(u),t[0](),d[u]?(t.trim(p(i)?" ":"",/^\n+ {0,3}\*?\[/.test(f)?!1:" ").mark(["[","]["+u+"]"],0,!1),b=a.indexOf(" ["+u+"]:"),-1===b&&1!==d[u]&&(n=t.$(),i=n.before,g=n.start,m=n.end,t.set(i+o+p(n.after,1)+l+" ["+(u||p(o)||_[""])+"]: "+(x?"":d[u][0]+(d[u][1]?' "'+d[u][1]+'"':""))).select(g,m),x&&t.focus(!0).insert(c))):(h=u,r.prompt(["a[title]",s.title[1]],s.placeholder[1],0,function(e,t,n){v=y(n),o||t.insert(_[""]),t.i().trim(p(i)?" ":"",p(f)?/^\n+ {0,3}\*?\[/.test(f)?"\n\n ":" ":"").wrap("[","]("+h+(v?' "'+v+'"':"")+")")})),t[1]()}),!1}},img:{click:function(e,t){var v,b,g,m,x,E,T,n=t.$(),i=n.value,o=i,f=n.before,u=n.after,l=t.get(),a=/^ {0,3}\[[^\^]+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",s=l.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=$.modals.img,d=/^\n* {0,3}\[.+?\]:/.test(u)?" ":"",h=p(u);for(T in s)T=" "+p(s[T]).replace(/^\[|\]:$/g,""),!k.img[T]&&(k.img[T]=1);return v=k.img,r.prompt(["img[src]",c.title[0]],c.placeholder[0],1,function(e,t,u){u=w(u),b=u,o||(o=b.split(/[\/\\\\]/).pop()),o=y(o),t[0]().trim(p(f)?"\n\n":"",d),v[u]?(t.insert("!["+o+"]["+u+"]\n\n",0,1),d&&t.select(t.$().start),m=s.indexOf(" ["+u+"]:"),-1===m&&(n=t.$(),f=n.before,x=n.start,E=n.end,t.set(f+i+n.after+(h?a:"")+" ["+u+"]: "+v[u][0]+(v[u][1]?' "'+v[u][1]+'"':"")).select(x,E))):r.prompt(["img[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){g=y(n),t.insert("!["+o+"]("+b+(g?' "'+g+'"':"")+")\n\n",0,1),d&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:L?{i:"thumb-tack",click:function(t,n){var d,i=n.$(),o=i.before,f=i.after,u=$.modals.sup,l=n.get(),a=/^ {0,3}\[\^.+?\]:/.test(p(l).split("\n").pop())?"\n":"\n\n",s=l.match(/^ {0,3}\[\^.+?\]:/gm)||[],c=0;for(c in s)s[c]=" "+p(s[c]);return c=s.length+1,r.prompt(["sup[id]",u.title],i.value||u.placeholder||c,0,function(t,n,r,i){r=p(r||i)||c,d=s.indexOf(" [^"+r+"]:"),-1!==d?(c=l.indexOf(s[d])+3,n.select(c,c+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim(p(o)?" ":"",!p(f)||/^[\t ]*\n+[\t ]*/.test(f)?"\n\n":" ").insert("[^"+r+"]").set(p(n.get(),1)+a+" [^"+r+"]: ").focus(!0).insert(_[""])}),!1}}:0,abbr:L?{click:function(t,n){var r=n.$(),i=p(r.value),o=$.modals.abbr,f=n.get(),u=m(i||_[""]),l=/^ {0,3}\*\[.+?\]:/.test(f.split("\n").pop())?"\n":"\n\n",a=f.match(/^ {0,3}\*\[.+?\]:/gm)||[],s=k.abbr,c=0;for(c in a)a[c]=" "+p(a[c]);return c=a.indexOf(" *["+u+"]:"),i&&-1!==c?(c=f.indexOf(a[c])+3,n.select(c,c+u.length),e.scrollTop=n.$(1).caret[0].y,!1):(n.record().ui.prompt(["abbr[title]",o.title],s[u]||o.placeholder,!s[i],function(e,t,n,o){if(n=y(n),t[0]().set(p(t.get(),1)+(r.before||i?l:"")+" *["+u+"]: ").focus(!0).insert(n||o),u===_[""]){var f=t.$().start;t.select(f-3-u.length,f-3)}t[1]()}),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(_[""]),!1)}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){z>5?z=0:z++;var n=t.$(),r=x["advance_h1,h2"],i="\\s?["+s(E.h1[0]+E.h2[0])+"]+\\s*",o=s(E.h1[1]),f=n.before.replace(c("["+o+"\\s]+$"),""),u=m(n.value).replace(c("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(c(i+"$"),"")||_[""],l=n.after.replace(c("^["+o+"\\s]+"),"").replace(c("^"+i),""),a=["",E.h1[r?0:1],E.h2[r?0:1],E.h3,E.h4,E.h5,E.h6];return t[0]().set(f+u+l).select(f.length,(f+u).length).tidy("\n\n"),0===z||(3>z&&r?t.wrap("","\n"+u.replace(/./g,a[z])):t.wrap(a[z]+" ",x["close_h1,h2,h3,h4,h5,h6"]?" "+a[z]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,i=E.blockquote;return r===_[""]?(t.select(),!1):r?(t.tidy(c(i+" $").test(n.before)?!1:"\n\n")[c("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",0).insert(_[""])[1](),!1)}},"pre,code":{click:function(e,t){var n=t.$(),r=n.before,i=n.value,o=x["advance_pre,code"],f=E.code,l=f[1]||f[0];l=l+l+l,!u(o)&&o?o=l:u(o)&&-1!==o.indexOf("%1")&&(o=v(o,[l]));var a="( {4,}|\\t"+(u(o)?"|"+s(o):"")+")";if(c("(^|\\n)"+a+"?$").test(r)){if(o)return t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(o=T===g?g:"    ",!i){t[0]().tidy("\n\n");var d=t.$().start,p=o+_[""];return t.insert(p).select(d+o.length,d+p.length)[1](),!1}return i===_[""]&&c(a+"$").test(r)?(t.select(n.start-o.length,n.end),!1):(t.tidy("\n\n")[c("^"+a).test(i)?"outdent":"indent"](o),!1)}return t.mark(f[0]),!1}},ul:{click:function(e,t){var m,n=t.$(),r=n.value,i=n.before,o=n.after,f=E.ul[0],u=E.ol[0],l=s(f),a=v(s(u),["\\d+"]),d=c("(^|\\n)([\\t ]*) "+l+" (.*)$"),p=c("^(.*) "+l+" ","gm"),h=c("(^|\\n)([\\t ]*) "+a+" (.*)$"),b=c("^(.*) "+a+" ","gm"),g=_[""];return r?(r===g?t.select():b.test(r)?t.replace(b,"$1 "+f+" "):p.test(r)?t.replace(p,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+f+" $2"),!1):i&&o?(m=h.test(i)?i.replace(h,"$1$2 "+f+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+f+" $3"),t.set(m+o).select(m.length),!1):(t[0]().tidy("\n\n").insert(" "+f+" ",0).insert(g)[1](),!1)}},ol:{click:function(e,t){var w,n=t.$(),r=n.value,i=n.before,o=n.after,f=E.ul[0],u=E.ol[0],l=v(u,[1]),a=s(f),d=v(s(u),["\\d+"]),p=c("(^|\\n)([\\t ]*) "+a+" (.*)$"),h=c("^(.*) "+a+" ","gm"),b=c("(^|\\n)([\\t ]*) "+d+" (.*)$"),g=c("^(.*) "+d+" ","gm"),m=_[""],y=0;return r?(r===m?t.select():h.test(r)?t.replace(h,function(e,t,n){return++y,t+" "+v(u,[y])+" "}):g.test(r)?t.replace(g,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++y,t+" "+v(u,[y])+" "+n}),!1):i&&o?(w=p.test(i)?i.replace(p,"$1$2 "+l+" $3"):b.test(i)?i.replace(b,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(w+o).select(w.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",0).insert(m)[1](),!1)}},table:L?function(e,t){var a,s,c,n=k.tr,i=k.td,o=$.modals.table,f=$.placeholders.table,u=v(f[0],[1,1]),l=[];return t.$().value===u?(t.select(),!1):(t[0]().ui.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,d,p){s=h(b(d)||p,i[0],i[1]),r.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,r,i){c=h(b(r)||i,n[0],n[1]);var o,d,p,g,m,y;for(o=0;c>o;++o){for(a="|",d=0;s>d;++d)a+=" "+v(f[1],[o+1,d+1])+" |";l.push(a)}for(l=l.join("\n"),a="|",p=0;s>p;++p)a+=" "+v(f[0],[p+1,p+1]).replace(/./g,"-")+" |";for(l=a+"\n"+l,a="|",g=0;s>g;++g)a+=" "+v(f[0],[1,g+1])+" |";l=a+"\n"+l,x.close_tr||(l=l.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(l),m=t.$(),y=m.start+m.value.indexOf(u),t.select(y,y+u.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",0),!1}}}),a(r.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=x.advance_br;return!u(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",0).scroll(!0),!1},enter:function(e,t){var n=t.$(),r=E.blockquote,o=(E.ul[0],E.ol[0]),f=v(s(o),["\\d+"]),u="(("+s(r)+" )+|"+C+"| +("+f+") )",l=c("^"+u+".*$","gm").exec(n.before.split("\n").pop());if(l){if(l[0]===l[1])return t.outdent(c(u)),!1;if(c("\\s*"+f+"\\s*").test(l[1])){var a=b(p(l[1]));return t.insert("\n"+l[1].replace(/\d+/,a+1),0).scroll(!0),!1}return t.insert("\n"+l[1],0).scroll(!0),!1}},"shift+tab":function(e,t){var g,n=t.$(),i=n.before,o=n.value,f=n.after,u=E.ol[0],l=s(u),a=v(l,["\\d+"]),d=s(E.blockquote),p=c("  "+C+"$"),h=c("   ( ?"+a+" )$"),b="("+d+" |"+C+"| +"+a+" )";if(o){if(o&&(g=o.match(c("(^|\\n)"+b,"g"))))return t.outdent(c(b)),!1}else{if(g=i.match(c(d+" $")))return t.outdent(g[0]),!1;if(g=i.match(p))return i=i.replace(p,"$1"),t.set(i+f).select(i.length),!1;if(g=i.match(h))return i=i.replace(h,"$1"),t.set(i+f).select(i.length),!1}return r.tools.outdent.click(e,t)},tab:function(e,t){var b,n=t.$(),i=n.before,o=n.value,f=n.after,u=E.ol[0],l=E.blockquote,a=s(u),d=s(l),p=c(C+"$"),h=c(" ?"+v(a,["\\d+"])+" $");if(o){if(c("^"+d+" ").test(o))return t.indent(l+" "),!1}else{if(b=i.match(c(d+" $")))return t.insert(b[0],0),!1;if(b=i.match(p))return i=i.replace(p,"  $1"),t.set(i+f).select(i.length),!1;if(b=i.match(h))return i=i.replace(h,"    "+v(u,[1])+" "),t.set(i+f).select(i.length),!1}return r.tools.indent.click(e,t)}}),n.update({},0)};
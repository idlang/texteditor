/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.2.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function y(e){return $(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function k(e){return $(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function $(e){return d(e.replace(/\s+/g," "))}var i=(window,document,new TE.HTML(e)),o=i.ui,a=i.is,s=a.o,f=function(e){return!a.x(e)},l=a.s,u=i._,c=u.extend,p=u.x,h=u.pattern,d=u.trim,g=u.edge,v=u.format,b=u.i,m="\t";i.update(c({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}},t),0),i.type="Markdown";var w=i.config,x=w.states,E=w.languages,_=w.formats,C=w.tab,T=E.placeholders,H=0,S=w.extra,O="( +["+p(_.ul).join("")+"] )";return S||(w["advance_pre,code"]=0),i.mark=function(e,t,n,r){s(e)||(e=[e]),f(n)||(n=" "),f(r)||(r="");var o=i[0]().$(),a=e[0]+r,l=r+(f(e[1])?e[1]:e[0]),u=o.value,c=p(a),d=p(l),g=h("^"+c+"([\\s\\S]*?)"+d+"$"),v=h(c+"$"),b=h("^"+d),m=o.before,y=o.after;return u?n=!1:i.insert(T[""]),i.toggle(t?!g.test(u):!v.test(m)&&!b.test(y),[function(e){e.unwrap(a,l,1).tidy(/<[^\/<>]+?>$/.test(m)?"":n,/^<\/[^<>]+?>/.test(y)?"":n).wrap(a,l,t)[1]()},function(e){e.unwrap(a,l,t)[1]()}])},c(o.tools,{b:{click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:S?{click:function(e,t){return t.i().mark(_.s),!1}}:0,a:{click:function(e,t){var c,p,h,g,v,b,m,n=t.$(),r=n.before,i=n.value,o=n.after,a=t.get(),s=/^ {0,3}\[[^\^]+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],l=E.modals.a,u=l.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(m in f)m=" "+d(f[m]).replace(/^\[|\]:$/g,""),x.a[m]=1;return c=x.a,t.record().ui.prompt(["a[href]",l.title[0]],u,0,function(e,t,a){var m=""===a;a=k(a),t[0](),c[a]?(t.trim(d(r)?" ":"",/^\n+ {0,3}\*?\[/.test(o)?!1:" ").mark(["[","]["+a+"]"],0,!1),g=f.indexOf(" ["+a+"]:"),-1===g&&1!==c[a]&&(n=t.$(),r=n.before,v=n.start,b=n.end,t.set(r+n.value+d(n.after,1)+s+" ["+(a||d(i)||T[""])+"]: "+(m?"":c[a][0]+(c[a][1]?' "'+c[a][1]+'"':""))).select(v,b),m&&t.focus(!0).insert(u))):(p=a,t.blur().ui.prompt(["a[title]",l.title[1]],l.placeholder[1],0,function(e,t,n){h=y(n),i||t.insert(T[""]),t.i().trim(d(r)?" ":"",d(o)?/^\n+ {0,3}\*?\[/.test(o)?"\n\n ":" ":"").wrap("[","]("+p+(h?' "'+h+'"':"")+")")})),t[1]()}),!1}},img:{click:function(e,t){var p,h,g,v,b,m,$,n=t.$(),r=n.value,i=n.before,o=n.after,a=t.get(),s=/^ {0,3}\[[^\^]+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],l=E.modals.img,u=/^\n* {0,3}\[.+?\]:/.test(o)?" ":"",c=d(o);for($ in f)$=" "+d(f[$]).replace(/^\[|\]:$/g,""),!x.img[$]&&(x.img[$]=1);return p=x.img,t.ui.prompt(["img[src]",l.title[0]],l.placeholder[0],1,function(e,t,o){o=k(o),h=o,r||(r=h.split(/[\/\\\\]/).pop()),r=y(r),t[0]().trim(d(i)?"\n\n":"",u),p[o]?(t.insert("!["+r+"]["+o+"]\n\n",-1,1),u&&t.select(t.$().start),v=f.indexOf(" ["+o+"]:"),-1===v&&(n=t.$(),i=n.before,b=n.start,m=n.end,t.set(i+n.value+n.after+(c?s:"")+" ["+o+"]: "+p[o][0]+(p[o][1]?' "'+p[o][1]+'"':"")).select(b,m))):t.blur().ui.prompt(["img[title]",l.title[1]],l.placeholder[1],0,function(e,t,n){g=y(n),t.insert("!["+r+"]("+h+(g?' "'+g+'"':"")+")\n\n",-1,1),u&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:S?{i:"thumb-tack",click:function(e,t){var u,n=t.$(),r=n.before,i=n.after,o=E.modals.sup,a=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(d(a).split("\n").pop())?"\n":"\n\n",f=a.match(/^ {0,3}\[\^.+?\]:/gm)||[],l=0;for(l in f)f[l]=" "+d(f[l]);return l=f.length+1,t.ui.prompt(["sup[id]",o.title],n.value||o.placeholder||l,0,function(e,t,n,o){n=d(n||o)||l,u=f.indexOf(" [^"+n+"]:"),-1!==u?(l=a.indexOf(f[u])+3,t.select(l,l+n.length)):t.trim(d(r)?" ":"",!d(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("[^"+n+"]").set(d(t.get(),1)+s+" [^"+n+"]: ").focus(!0).insert(T[""])}),!1}}:0,abbr:S?{click:function(e,t){var n=t.$(),r=d(n.value),i=E.modals.abbr,o=t.get(),a=$(r||T[""]),s=/^ {0,3}\*\[.+?\]:/.test(o.split("\n").pop())?"\n":"\n\n",f=o.match(/^ {0,3}\*\[.+?\]:/gm)||[],l=x.abbr,u=0;for(u in f)f[u]=" "+d(f[u]);return u=f.indexOf(" *["+a+"]:"),r&&-1!==u?(u=o.indexOf(f[u])+3,t.select(u,u+a.length),!1):(t.record().ui.prompt(["abbr[title]",i.title],l[a]||i.placeholder,!l[r],function(e,t,i,o){if(i=y(i),t[0]().set(d(t.get(),1)+(n.before||r?s:"")+" *["+a+"]: ").focus(!0).insert(i||o),a===T[""]){var f=t.$().start;t.select(f-3-a.length,f-3)}t[1]()}),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(T[""]),!1)}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){H>5?H=0:H++;var n=t.$(),r=w["advance_h1,h2"],i="\\s?["+p(_.h1[0]+_.h2[0])+"]+\\s*",o=p(_.h1[1]),a=n.before.replace(h("["+o+"\\s]+$"),""),s=$(n.value).replace(h("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(h(i+"$"),"")||T[""],f=n.after.replace(h("^["+o+"\\s]+"),"").replace(h("^"+i),""),l=["",_.h1[r?0:1],_.h2[r?0:1],_.h3,_.h4,_.h5,_.h6];return t[0]().set(a+s+f).select(a.length,(a+s).length).tidy("\n\n"),0===H||(3>H&&r?t.wrap("","\n"+s.replace(/./g,l[H])):t.wrap(l[H]+" ",w["close_h1,h2,h3,h4,h5,h6"]?" "+l[H]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,i=_.blockquote;return r===T[""]?(t.select(),!1):r?(t.tidy(h(i+" $").test(n.before)?!1:"\n\n")[h("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(T[""])[1](),!1)}},"pre,code":{click:function(e,t){var n=t.$(),r=n.before,i=n.value,o=w["advance_pre,code"],a=_.code,s=a[1]||a[0];s=s+s+s,!l(o)&&o?o=s:l(o)&&-1!==o.indexOf("%1")&&(o=v(o,[s]));var f="( {4,}|\\t"+(l(o)?"|"+p(o):"")+")";if(h("(^|\\n)"+f+"?$").test(r)){if(o)return t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(o=C===m?m:"    ",!i){t[0]().tidy("\n\n");var u=t.$().start,c=o+T[""];return t.insert(c).select(u+o.length,u+c.length)[1](),!1}return i===T[""]&&h(f+"$").test(r)?(t.select(n.start-o.length,n.end),!1):(t.tidy("\n\n")[h("^"+f).test(i)?"outdent":"indent"](o),!1)}return t.mark(a[0]),!1}},ul:{click:function(e,t){var m,n=t.$(),r=n.value,i=n.before,o=n.after,a=_.ul[0],s=_.ol[0],f=p(a),l=v(p(s),["\\d+"]),u=h("(^|\\n)([\\t ]*) "+f+" (.*)$"),c=h("^(.*) "+f+" ","gm"),d=h("(^|\\n)([\\t ]*) "+l+" (.*)$"),g=h("^(.*) "+l+" ","gm"),b=T[""];return r?(r===b?t.select():g.test(r)?t.replace(g,"$1 "+a+" "):c.test(r)?t.replace(c,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&o?(m=d.test(i)?i.replace(d,"$1$2 "+a+" $3"):u.test(i)?i.replace(u,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(m+o).select(m.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert(b)[1](),!1)}},ol:{click:function(e,t){var k,n=t.$(),r=n.value,i=n.before,o=n.after,a=_.ul[0],s=_.ol[0],f=v(s,[1]),l=p(a),u=v(p(s),["\\d+"]),c=h("(^|\\n)([\\t ]*) "+l+" (.*)$"),d=h("^(.*) "+l+" ","gm"),g=h("(^|\\n)([\\t ]*) "+u+" (.*)$"),b=h("^(.*) "+u+" ","gm"),m=T[""],y=0;return r?(r===m?t.select():d.test(r)?t.replace(d,function(e,t,n){return++y,t+" "+v(s,[y])+" "}):b.test(r)?t.replace(b,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++y,t+" "+v(s,[y])+" "+n}),!1):i&&o?(k=c.test(i)?i.replace(c,"$1$2 "+f+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+f+" $3"),t.set(k+o).select(k.length),!1):(t[0]().tidy("\n\n").insert(" "+f+" ",-1).insert(m)[1](),!1)}},table:S?function(e,t){var f,l,u,n=x.tr,r=x.td,i=E.modals.table,o=E.placeholders.table,a=v(o[0],[1,1]),s=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,c,p){l=g(b(c)||p,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){u=g(b(r)||i,n[0],n[1]);var c,p,h,d,m,y;for(c=0;u>c;++c){for(f="|",p=0;l>p;++p)f+=" "+v(o[1],[c+1,p+1])+" |";s.push(f)}for(s=s.join("\n"),f="|",h=0;l>h;++h)f+=" "+v(o[0],[h+1,h+1]).replace(/./g,"-")+" |";for(s=f+"\n"+s,f="|",d=0;l>d;++d)f+=" "+v(o[0],[1,d+1])+" |";s=f+"\n"+s,w.close_tr||(s=s.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(s),m=t.$(),y=m.start+m.value.indexOf(a),t.select(y,y+a.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",-1),!1}}}),c(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=w.advance_br;return!l(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1).scroll(!0),!1},enter:function(e,t){var n=t.$(),r=_.blockquote,o=(_.ul[0],_.ol[0]),a=v(p(o),["\\d+"]),s="(("+p(r)+" )+|"+O+"| +("+a+") )",f=h("^"+s+".*$","gm").exec(n.before.split("\n").pop());if(f){if(f[0]===f[1])return t.outdent(h(s)),!1;if(h("\\s*"+a+"\\s*").test(f[1])){var l=b(d(f[1]));return t.insert("\n"+f[1].replace(/\d+/,l+1),-1).scroll(!0),!1}return t.insert("\n"+f[1],-1).scroll(!0),!1}},"shift+tab":function(e,t){var b,n=t.$(),r=n.before,i=n.value,a=n.after,s=_.ol[0],f=p(s),l=v(f,["\\d+"]),u=p(_.blockquote),c=h("  "+O+"$"),d=h("   ( ?"+l+" )$"),g="("+u+" |"+O+"| +"+l+" )";if(i){if(i&&(b=i.match(h("(^|\\n)"+g,"g"))))return t.outdent(h(g)),!1}else{if(b=r.match(h(u+" $")))return t.outdent(b[0]),!1;if(b=r.match(c))return r=r.replace(c,"$1"),t.set(r+a).select(r.length),!1;if(b=r.match(d))return r=r.replace(d,"$1"),t.set(r+a).select(r.length),!1}return o.tools.outdent.click(e,t)},tab:function(e,t){var g,n=t.$(),r=n.before,i=n.value,a=n.after,s=_.ol[0],f=_.blockquote,l=p(s),u=p(f),c=h(O+"$"),d=h(" ?"+v(l,["\\d+"])+" $");if(i){if(h("^"+u+" ").test(i))return t.indent(f+" "),!1}else{if(g=r.match(h(u+" $")))return t.insert(g[0],-1),!1;if(g=r.match(c))return r=r.replace(c,"  $1"),t.set(r+a).select(r.length),!1;if(g=r.match(d))return r=r.replace(d,"    "+v(s,[1])+" "),t.set(r+a).select(r.length),!1}return o.tools.indent.click(e,t)}}),i.update({},0)};
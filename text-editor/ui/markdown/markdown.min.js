/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.3.2
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Markdown=function(e,t){function k(e){return v(e.replace(/\s+/g," "))}function y(e){return m(k(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function $(e){return m(k(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}var n=TE.ui.HTML||TE.ui,i=n(e,{extra:0,auto_p:0,auto_close:{"`":"`","*":"*",_:"_","~":"~"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},note:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:["~~"],h1:["=","#"],h2:["-","##"],h3:["###"],h4:["####"],h5:["#####"],h6:["######"],blockquote:[">"],code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}}),l=i.ui,a="	",r=TE.is,s=r.o,f=function(e){return!r.x(e)},o=r.s,c=i._,u=c.edge,d=c.x,p=c.extend,g=c.format,h=c.i,b=c.pattern,m=c.replace,v=c.trim;i.update(t,0),i.type="Markdown";var w=i.config,x=w.extra,T=w.formats,E=w.languages,_=w.states,M=w.tab,C=E.placeholders,F="( +["+d(T.ul).join("")+"] )",O=0;return x||(w["advance_pre,code"]=0),i.mark=function(e,t,n,l){s(e)||(e=[e]),f(n)||(n=" "),f(l)||(l="");var a=i.h,r=i[0]().$(),o=e[0]+l,c=l+(f(e[1])?e[1]:e[0]),u=r.value,p=d(o),g=d(c),h=b("^"+p+"([\\s\\S]*?)"+g+"$"),m=b(p+"$"),v=b("^"+g),k=r.before,y=r.after;return u?n=!1:i.insert(C[""]),i.toggle(t?!h.test(u):!m.test(k)&&!v.test(y),[function(e){e.unwrap(o,c,1).tidy(/<[^\/<>]+?>$/.test(k)?"":n,/^<\/[^<>]+?>/.test(y)?"":n).wrap(o,c,t)},function(e){e.unwrap(o,c,t)}])[a]()},p(l.tools,{b:{click:function(e,t){return t.i().mark(T.b[0]),!1}},i:{click:function(e,t){return t.i().mark(T.i[0]),!1}},u:0,s:x?{click:function(e,t){return t.i().mark(T.s[0]),!1}}:0,a:{click:function(e,t){var d,p,g,h,b,m,k,n=t.$(),i=n.before,a=n.value,r=n.after,s=t.get(),f=/^ {0,3}\[[^\^]+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",o=s.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=E.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(a))return t.tidy(" ").mark(["<",">"],1),!1;for(k in o)k=" "+v(o[k]).replace(/^\[|\]:$/g,""),_.a[k]=1;return d=_.a,l.prompt(["a[href]",c.title[0]],u,0,function(e,t,s){var k=""===s;s=$(s),t[0](),d[s]?(t.trim(v(i)?" ":"",/^\n+ {0,3}\*?\[/.test(r)?!1:" ").mark(["[","]["+s+"]"],0,!1),h=o.indexOf(" ["+s+"]:"),-1===h&&1!==d[s]&&(n=t.$(),i=n.before,b=n.start,m=n.end,t.set(i+a+v(n.after,1)+f+" ["+(s||v(a)||C[""])+"]: "+(k?"":d[s][0]+(d[s][1]?' "'+d[s][1]+'"':""))).select(b,m),k&&t.focus(1).insert(u))):(p=s,l.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){g=y(n),a||t.insert(C[""]),t.i().trim(v(i)?" ":"",v(r)?/^\n+ {0,3}\*?\[/.test(r)?"\n\n ":" ":"").wrap("[","]("+p+(g?' "'+g+'"':"")+")")})),t[1]()}).record(),!1}},img:{click:function(e,t){var g,h,b,m,k,w,x,n=t.$(),i=n.value,a=i,r=n.before,s=n.after,f=t.get(),o=/^ {0,3}\[[^\^]+?\]:/.test(f.split("\n").pop())?"\n":"\n\n",c=f.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=E.modals.img,d=/^\n* {0,3}\[.+?\]:/.test(s)?" ":"",p=v(s);for(x in c)x=" "+v(c[x]).replace(/^\[|\]:$/g,""),!_.img[x]&&(_.img[x]=1);return g=_.img,l.prompt(["img[src]",u.title[0]],u.placeholder[0],1,function(e,t,s){s=$(s),h=s,a||(a=h.split(/[\/\\\\]/).pop()),a=y(a),t[0]().trim(v(r)?"\n\n":"",d),g[s]?(t.insert("!["+a+"]["+s+"]\n\n",0,1),d&&t.select(t.$().start),m=c.indexOf(" ["+s+"]:"),-1===m&&(n=t.$(),r=n.before,k=n.start,w=n.end,t.set(r+i+n.after+(p?o:"")+" ["+s+"]: "+g[s][0]+(g[s][1]?' "'+g[s][1]+'"':"")).select(k,w))):l.prompt(["img[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){b=y(n),t.insert("!["+a+"]("+h+(b?' "'+b+'"':"")+")\n\n",0,1),d&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:0,abbr:x?{click:function(t,n){var i=n.$(),a=v(i.value),r=E.modals.abbr,s=n.get(),f=k(a||C[""]),o=/^ {0,3}\*\[.+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",c=s.match(/^ {0,3}\*\[.+?\]:/gm)||[],u=_.abbr,d=0;for(d in c)c[d]=" "+v(c[d]);return d=c.indexOf(" *["+f+"]:"),a&&-1!==d?(d=s.indexOf(c[d])+3,n.select(d,d+f.length),e.scrollTop=n.$(1).caret[0].y,!1):(l.prompt(["abbr[title]",r.title],u[f]||r.placeholder,!u[a],function(e,t,n,l){if(n=y(n),t[0]().set(v(t.get(),1)+(i.before||a?o:"")+" *["+f+"]: ").focus(1).insert(n||l),f===C[""]){var r=t.$().start;t.select(r-3-f.length,r-3)}t[1]()}).record(),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(C[""]).scroll(2),!1)}},br:{click:function(e,t){var n=w.advance_br;return!o(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",0).scroll(1),!1}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){O>5?O=0:O++;var n=t.$(),i=w["advance_h1,h2"],l="\\s?["+d(T.h1[0]+T.h2[0])+"]+\\s*",a=d(T.h1[1]),r=n.before.replace(b("["+a+"\\s]+$"),""),s=k(n.value).replace(b("^["+a+"\\s]+|["+a+"\\s]+$","g"),"").replace(b(l+"$"),"")||C[""],f=n.after.replace(b("^["+a+"\\s]+"),"").replace(b("^"+l),""),o=["",T.h1[i?0:1],T.h2[i?0:1],T.h3[0],T.h4[0],T.h5[0],T.h6[0]];return t[0]().set(r+s+f).select(r.length,(r+s).length).tidy("\n\n"),0===O||(3>O&&i?t.wrap("","\n"+s.replace(/./g,o[O])):t.wrap(o[O]+" ",w["close_h1,h2,h3,h4,h5,h6"]?" "+o[O]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),i=n.value,l=T.blockquote[0];return i===C[""]?(t.select(),!1):i?(t.tidy(b(l+" $").test(n.before)?!1:"\n\n")[b("^"+l).test(i)?"outdent":"indent"](l+" "),!1):(t[0]().tidy("\n\n").insert(l+" ",0).insert(C[""])[1](),!1)}},"pre,code":{click:function(e,t){var c,u,p,n=t.$(),i=n.before,l=n.value,r=w["advance_pre,code"],s=T.code,f=s[1]||s[0];return f=f+f+f,!o(r)&&r?r=f:o(r)&&-1!==r.indexOf("%")&&(r=g(r,[f])),c="( {4,}|\\t"+(o(r)?"|"+d(r):"")+")",b("(^|\\n)"+c+"?$").test(i)?r?(t.mark([r,r.split(/\s+/)[0]],0,"\n\n","\n"),!1):(r=M===a?a:"    ",l?l===C[""]&&b(c+"$").test(i)?(t.select(n.start-r.length,n.end),!1):(t.tidy("\n\n")[b("^"+c).test(l)?"outdent":"indent"](r),!1):(t[0]().tidy("\n\n"),u=t.$().start,p=r+C[""],t.insert(p).select(u+r.length,u+p.length)[1](),!1)):(t.mark(s[0]),!1)}},ul:{click:function(e,t){var v,n=t.$(),i=n.value,l=n.before,a=n.after,r=T.ul[0],s=T.ol[0],f=d(r),o=g(d(s),["\\d+"]),c=b("(^|\\n)([\\t ]*) "+f+" (.*)$"),u=b("^(.*) "+f+" ","gm"),p=b("(^|\\n)([\\t ]*) "+o+" (.*)$"),h=b("^(.*) "+o+" ","gm"),m=C[""];return i?(i===m?t.select():h.test(i)?t.replace(h,"$1 "+r+" "):u.test(i)?t.replace(u,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+r+" $2"),!1):a&&l&&("\n"!==a[0]||"\n"!==l.slice(-1))?(v=p.test(l)?l.replace(p,"$1$2 "+r+" $3"):c.test(l)?l.replace(c,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+r+" $3"),t.set(v+a).select(v.length),!1):(t[0]().tidy("\n\n").insert(" "+r+" ",0).insert(m)[1](),!1)}},ol:{click:function(e,t){var y,n=t.$(),i=n.value,l=n.before,a=n.after,r=T.ul[0],s=T.ol[0],f=g(s,[1]),o=d(r),c=g(d(s),["\\d+"]),u=b("(^|\\n)([\\t ]*) "+o+" (.*)$"),p=b("^(.*) "+o+" ","gm"),h=b("(^|\\n)([\\t ]*) "+c+" (.*)$"),m=b("^(.*) "+c+" ","gm"),v=C[""],k=0;return i?(i===v?t.select():p.test(i)?t.replace(p,function(e,t,n){return++k,t+" "+g(s,[k])+" "}):m.test(i)?t.replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++k,t+" "+g(s,[k])+" "+n}),!1):a&&l&&("\n"!==a[0]||"\n"!==l.slice(-1))?(y=u.test(l)?l.replace(u,"$1$2 "+f+" $3"):h.test(l)?l.replace(h,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+f+" $3"),t.set(y+a).select(y.length),!1):(t[0]().tidy("\n\n").insert(" "+f+" ",0).insert(v)[1](),!1)}},table:x?function(e,t){var o,c,d,n=_.tr,i=_.td,a=E.modals.table,r=E.placeholders.table,s=g(r[0],[1,1]),f=[];return t[0]().$().value===s?(t.select(),!1):(l.prompt(["table>td",a.title[0]],a.placeholder[0],0,function(e,t,p,b){c=u(h(p)||b,i[0],i[1]),l.prompt(["table>tr",a.title[1]],a.placeholder[1],0,function(e,t,i,l){d=u(h(i)||l,n[0],n[1]);var a,p,b,m,v,k;for(a=0;d>a;++a){for(o="|",p=0;c>p;++p)o+=" "+g(r[1],[a+1,p+1])+" |";f.push(o)}for(f=f.join("\n"),o="|",b=0;c>b;++b)o+=" "+g(r[0],[b+1,b+1]).replace(/./g,"-")+" |";for(f=o+"\n"+f,o="|",m=0;c>m;++m)o+=" "+g(r[0],[1,m+1])+" |";f=o+"\n"+f,w.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f),v=t.$(),k=v.start+v.value.indexOf(s),t.select(k,k+s.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(T.hr[0]+"\n\n",0).scroll(2),!1}},note:x?{i:"thumb-tack",click:function(t,n){var d,i=n.$(),a=i.before,r=i.after,s=E.modals.note,f=n.get(),o=/^ {0,3}\[\^.+?\]:/.test(v(f).split("\n").pop())?"\n":"\n\n",c=f.match(/^ {0,3}\[\^.+?\]:/gm)||[],u=0;for(u in c)c[u]=" "+v(c[u]);return u=c.length+1,l.prompt(["sup[id]",s.title],i.value||u,0,function(t,n,i,l){i=v(i||l)||u,d=c.indexOf(" [^"+i+"]:"),-1!==d?(u=f.indexOf(c[d])+3,n.select(u,u+i.length),e.scrollTop=n.$(1).caret[0].y):n.trim(v(a)?" ":"",!v(r)||/^[\t ]*\n+[\t ]*/.test(r)?"\n\n":" ").insert("[^"+i+"]").set(v(n.get(),1)+o+" [^"+i+"]: ").focus(1).insert(C[""])}),!1}}:0}),p(l.keys,{"control+u":0,enter:function(e,t){var n=t.$(),i=T.blockquote[0],a=(T.ul[0],T.ol[0]),r=g(d(a),["\\d+"]),s="(("+d(i)+" )+|"+F+"| +("+r+") )",f=b("^"+s+".*$","gm").exec(n.before.split("\n").pop());if(f){if(f[0]===f[1])return t.outdent(b(s)),!1;if(b("\\s*"+r+"\\s*").test(f[1])){var o=h(v(f[1]));return t.insert("\n"+f[1].replace(/\d+/,o+1),0),!1}return t.insert("\n"+f[1],0),!1}},"shift+tab":function(e,t){var m,n=t.$(),i=n.before,a=n.value,r=n.after,s=T.ol[0],f=d(s),o=g(f,["\\d+"]),c=d(T.blockquote[0]),u=b("  "+F+"$"),p=b("   ( ?"+o+" )$"),h="("+c+" |"+F+"| +"+o+" )";if(a){if(a&&(m=a.match(b("(^|\\n)"+h,"g"))))return t.outdent(b(h)),!1}else{if(m=i.match(b(c+" $")))return t.outdent(m[0]),!1;if(m=i.match(u))return i=i.replace(u,"$1"),t.set(i+r).select(i.length),!1;if(m=i.match(p))return i=i.replace(p,"$1"),t.set(i+r).select(i.length),!1}return l.tools.outdent.click(e,t)},tab:function(e,t){var h,n=t.$(),i=n.before,a=n.value,r=n.after,s=T.ol[0],f=T.blockquote[0],o=d(s),c=d(f),u=b(F+"$"),p=b(" ?"+g(o,["\\d+"])+" $");if(a){if(b("^"+c+" ").test(a))return t.indent(f+" "),!1}else{if(h=i.match(b(c+" $")))return t.insert(h[0],0),!1;if(h=i.match(u))return i=i.replace(u,"  $1"),t.set(i+r).select(i.length),!1;if(h=i.match(p))return i=i.replace(p,"    "+g(s,[1])+" "),t.set(i+r).select(i.length),!1}return l.tools.indent.click(e,t)},"control+arrowdown":"note","control+arrowup":"note"}),i.update({},0)};
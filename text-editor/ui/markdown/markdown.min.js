/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.3.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Markdown=function(e,t){function y(e){return v(e.replace(/\s+/g," "))}function w(e){return m(y(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function k(e){return m(y(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}var n=TE.ui.HTML||TE.ui,r=n(e,{extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:["~~"],h1:["=","#"],h2:["-","##"],h3:["###"],h4:["####"],h5:["#####"],h6:["######"],blockquote:[">"],code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}}),i=r.ui,o="	",f=TE.is,u=f.o,l=function(e){return!f.x(e)},s=f.s,a=r._,c=a.edge,d=a.x,p=a.extend,h=a.format,b=a.i,g=a.pattern,m=a.replace,v=a.trim;r.update(p({languages:{tools:{sup:["Footnote",r.config.languages.tools.sub[1]]}}},t),0),r.type="Markdown";var x=r.config,$=x.extra,E=x.formats,T=x.languages,L=x.states,_=x.tab,z=T.placeholders,C="( +["+d(E.ul).join("")+"] )",S=0;return $||(x["advance_pre,code"]=0),r.mark=function(e,t,n,i){u(e)||(e=[e]),l(n)||(n=" "),l(i)||(i="");var o=r.h,f=r[0]().$(),s=e[0]+i,a=i+(l(e[1])?e[1]:e[0]),c=f.value,p=d(s),h=d(a),b=g("^"+p+"([\\s\\S]*?)"+h+"$"),m=g(p+"$"),v=g("^"+h),y=f.before,w=f.after;return c?n=!1:r.insert(z[""]),r.toggle(t?!b.test(c):!m.test(y)&&!v.test(w),[function(e){e.unwrap(s,a,1).tidy(/<[^\/<>]+?>$/.test(y)?"":n,/^<\/[^<>]+?>/.test(w)?"":n).wrap(s,a,t)},function(e){e.unwrap(s,a,t)}])[o]()},p(i.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:$?{click:function(e,t){return t.i().mark(E.s[0]),!1}}:0,a:{click:function(e,t){var d,p,h,b,g,m,y,n=t.$(),r=n.before,o=n.value,f=n.after,u=t.get(),l=/^ {0,3}\[[^\^]+?\]:/.test(u.split("\n").pop())?"\n":"\n\n",s=u.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],a=T.modals.a,c=a.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(o))return t.tidy(" ").mark(["<",">"],1),!1;for(y in s)y=" "+v(s[y]).replace(/^\[|\]:$/g,""),L.a[y]=1;return d=L.a,i.prompt(["a[href]",a.title[0]],c,0,function(e,t,u){var y=""===u;u=k(u),t[0](),d[u]?(t.trim(v(r)?" ":"",/^\n+ {0,3}\*?\[/.test(f)?!1:" ").mark(["[","]["+u+"]"],0,!1),b=s.indexOf(" ["+u+"]:"),-1===b&&1!==d[u]&&(n=t.$(),r=n.before,g=n.start,m=n.end,t.set(r+o+v(n.after,1)+l+" ["+(u||v(o)||z[""])+"]: "+(y?"":d[u][0]+(d[u][1]?' "'+d[u][1]+'"':""))).select(g,m),y&&t.focus(!0).insert(c))):(p=u,i.prompt(["a[title]",a.title[1]],a.placeholder[1],0,function(e,t,n){h=w(n),o||t.insert(z[""]),t.i().trim(v(r)?" ":"",v(f)?/^\n+ {0,3}\*?\[/.test(f)?"\n\n ":" ":"").wrap("[","]("+p+(h?' "'+h+'"':"")+")")})),t[1]()}).record(),!1}},img:{click:function(e,t){var h,b,g,m,y,x,$,n=t.$(),r=n.value,o=r,f=n.before,u=n.after,l=t.get(),s=/^ {0,3}\[[^\^]+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",a=l.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=T.modals.img,d=/^\n* {0,3}\[.+?\]:/.test(u)?" ":"",p=v(u);for($ in a)$=" "+v(a[$]).replace(/^\[|\]:$/g,""),!L.img[$]&&(L.img[$]=1);return h=L.img,i.prompt(["img[src]",c.title[0]],c.placeholder[0],1,function(e,t,u){u=k(u),b=u,o||(o=b.split(/[\/\\\\]/).pop()),o=w(o),t[0]().trim(v(f)?"\n\n":"",d),h[u]?(t.insert("!["+o+"]["+u+"]\n\n",0,1),d&&t.select(t.$().start),m=a.indexOf(" ["+u+"]:"),-1===m&&(n=t.$(),f=n.before,y=n.start,x=n.end,t.set(f+r+n.after+(p?s:"")+" ["+u+"]: "+h[u][0]+(h[u][1]?' "'+h[u][1]+'"':"")).select(y,x))):i.prompt(["img[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){g=w(n),t.insert("!["+o+"]("+b+(g?' "'+g+'"':"")+")\n\n",0,1),d&&t.select(t.$().start)}),t[1]()}),!1}},sup:$?{i:"thumb-tack",click:function(t,n){var d,r=n.$(),o=r.before,f=r.after,u=T.modals.sup,l=n.get(),s=/^ {0,3}\[\^.+?\]:/.test(v(l).split("\n").pop())?"\n":"\n\n",a=l.match(/^ {0,3}\[\^.+?\]:/gm)||[],c=0;for(c in a)a[c]=" "+v(a[c]);return c=a.length+1,i.prompt(["sup[id]",u.title],r.value||u.placeholder||c,0,function(t,n,r,i){r=v(r||i)||c,d=a.indexOf(" [^"+r+"]:"),-1!==d?(c=l.indexOf(a[d])+3,n.select(c,c+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim(v(o)?" ":"",!v(f)||/^[\t ]*\n+[\t ]*/.test(f)?"\n\n":" ").insert("[^"+r+"]").set(v(n.get(),1)+s+" [^"+r+"]: ").focus(!0).insert(z[""])}),!1}}:0,abbr:$?{click:function(t,n){var r=n.$(),o=v(r.value),f=T.modals.abbr,u=n.get(),l=y(o||z[""]),s=/^ {0,3}\*\[.+?\]:/.test(u.split("\n").pop())?"\n":"\n\n",a=u.match(/^ {0,3}\*\[.+?\]:/gm)||[],c=L.abbr,d=0;for(d in a)a[d]=" "+v(a[d]);return d=a.indexOf(" *["+l+"]:"),o&&-1!==d?(d=u.indexOf(a[d])+3,n.select(d,d+l.length),e.scrollTop=n.$(1).caret[0].y,!1):(i.prompt(["abbr[title]",f.title],c[l]||f.placeholder,!c[o],function(e,t,n,i){if(n=w(n),t[0]().set(v(t.get(),1)+(r.before||o?s:"")+" *["+l+"]: ").focus(!0).insert(n||i),l===z[""]){var f=t.$().start;t.select(f-3-l.length,f-3)}t[1]()}).record(),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(z[""]),!1)}},br:{click:function(e,t){var n=x.advance_br;return!s(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",0),!1}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){S>5?S=0:S++;var n=t.$(),r=x["advance_h1,h2"],i="\\s?["+d(E.h1[0]+E.h2[0])+"]+\\s*",o=d(E.h1[1]),f=n.before.replace(g("["+o+"\\s]+$"),""),u=y(n.value).replace(g("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(g(i+"$"),"")||z[""],l=n.after.replace(g("^["+o+"\\s]+"),"").replace(g("^"+i),""),s=["",E.h1[r?0:1],E.h2[r?0:1],E.h3[0],E.h4[0],E.h5[0],E.h6[0]];return t[0]().set(f+u+l).select(f.length,(f+u).length).tidy("\n\n"),0===S||(3>S&&r?t.wrap("","\n"+u.replace(/./g,s[S])):t.wrap(s[S]+" ",x["close_h1,h2,h3,h4,h5,h6"]?" "+s[S]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,i=E.blockquote[0];return r===z[""]?(t.select(),!1):r?(t.tidy(g(i+" $").test(n.before)?!1:"\n\n")[g("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",0).insert(z[""])[1](),!1)}},"pre,code":{click:function(e,t){var a,c,p,n=t.$(),r=n.before,i=n.value,f=x["advance_pre,code"],u=E.code,l=u[1]||u[0];return l=l+l+l,!s(f)&&f?f=l:s(f)&&-1!==f.indexOf("%")&&(f=h(f,[l])),a="( {4,}|\\t"+(s(f)?"|"+d(f):"")+")",g("(^|\\n)"+a+"?$").test(r)?f?(t.mark([f,f.split(/\s+/)[0]],0,"\n\n","\n"),!1):(f=_===o?o:"    ",i?i===z[""]&&g(a+"$").test(r)?(t.select(n.start-f.length,n.end),!1):(t.tidy("\n\n")[g("^"+a).test(i)?"outdent":"indent"](f),!1):(t[0]().tidy("\n\n"),c=t.$().start,p=f+z[""],t.insert(p).select(c+f.length,c+p.length)[1](),!1)):(t.mark(u[0]),!1)}},ul:{click:function(e,t){var v,n=t.$(),r=n.value,i=n.before,o=n.after,f=E.ul[0],u=E.ol[0],l=d(f),s=h(d(u),["\\d+"]),a=g("(^|\\n)([\\t ]*) "+l+" (.*)$"),c=g("^(.*) "+l+" ","gm"),p=g("(^|\\n)([\\t ]*) "+s+" (.*)$"),b=g("^(.*) "+s+" ","gm"),m=z[""];return r?(r===m?t.select():b.test(r)?t.replace(b,"$1 "+f+" "):c.test(r)?t.replace(c,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+f+" $2"),!1):o&&i&&("\n"!==o[0]||"\n"!==i.slice(-1))?(v=p.test(i)?i.replace(p,"$1$2 "+f+" $3"):a.test(i)?i.replace(a,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+f+" $3"),t.set(v+o).select(v.length),!1):(t[0]().tidy("\n\n").insert(" "+f+" ",0).insert(m)[1](),!1)}},ol:{click:function(e,t){var w,n=t.$(),r=n.value,i=n.before,o=n.after,f=E.ul[0],u=E.ol[0],l=h(u,[1]),s=d(f),a=h(d(u),["\\d+"]),c=g("(^|\\n)([\\t ]*) "+s+" (.*)$"),p=g("^(.*) "+s+" ","gm"),b=g("(^|\\n)([\\t ]*) "+a+" (.*)$"),m=g("^(.*) "+a+" ","gm"),v=z[""],y=0;return r?(r===v?t.select():p.test(r)?t.replace(p,function(e,t,n){return++y,t+" "+h(u,[y])+" "}):m.test(r)?t.replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++y,t+" "+h(u,[y])+" "+n}),!1):o&&i&&("\n"!==o[0]||"\n"!==i.slice(-1))?(w=c.test(i)?i.replace(c,"$1$2 "+l+" $3"):b.test(i)?i.replace(b,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(w+o).select(w.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",0).insert(v)[1](),!1)}},table:$?function(e,t){var s,a,d,n=L.tr,r=L.td,o=T.modals.table,f=T.placeholders.table,u=h(f[0],[1,1]),l=[];return t[0]().$().value===u?(t.select(),!1):(i.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,p,g){a=c(b(p)||g,r[0],r[1]),i.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,r,i){d=c(b(r)||i,n[0],n[1]);var o,p,g,m,v,y;for(o=0;d>o;++o){for(s="|",p=0;a>p;++p)s+=" "+h(f[1],[o+1,p+1])+" |";l.push(s)}for(l=l.join("\n"),s="|",g=0;a>g;++g)s+=" "+h(f[0],[g+1,g+1]).replace(/./g,"-")+" |";for(l=s+"\n"+l,s="|",m=0;a>m;++m)s+=" "+h(f[0],[1,m+1])+" |";l=s+"\n"+l,x.close_tr||(l=l.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(l),v=t.$(),y=v.start+v.value.indexOf(u),t.select(y,y+u.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",0),!1}}}),i.tools.sub=i.tools.sup,p(i.keys,{"control+u":0,enter:function(e,t){var n=t.$(),r=E.blockquote[0],o=(E.ul[0],E.ol[0]),f=h(d(o),["\\d+"]),u="(("+d(r)+" )+|"+C+"| +("+f+") )",l=g("^"+u+".*$","gm").exec(n.before.split("\n").pop());if(l){if(l[0]===l[1])return t.outdent(g(u)),!1;if(g("\\s*"+f+"\\s*").test(l[1])){var s=b(v(l[1]));return t.insert("\n"+l[1].replace(/\d+/,s+1),0),!1}return t.insert("\n"+l[1],0),!1}},"shift+tab":function(e,t){var m,n=t.$(),r=n.before,o=n.value,f=n.after,u=E.ol[0],l=d(u),s=h(l,["\\d+"]),a=d(E.blockquote[0]),c=g("  "+C+"$"),p=g("   ( ?"+s+" )$"),b="("+a+" |"+C+"| +"+s+" )";if(o){if(o&&(m=o.match(g("(^|\\n)"+b,"g"))))return t.outdent(g(b)),!1}else{if(m=r.match(g(a+" $")))return t.outdent(m[0]),!1;if(m=r.match(c))return r=r.replace(c,"$1"),t.set(r+f).select(r.length),!1;if(m=r.match(p))return r=r.replace(p,"$1"),t.set(r+f).select(r.length),!1}return i.tools.outdent.click(e,t)},tab:function(e,t){var b,n=t.$(),r=n.before,o=n.value,f=n.after,u=E.ol[0],l=E.blockquote[0],s=d(u),a=d(l),c=g(C+"$"),p=g(" ?"+h(s,["\\d+"])+" $");if(o){if(g("^"+a+" ").test(o))return t.indent(l+" "),!1}else{if(b=r.match(g(a+" $")))return t.insert(b[0],0),!1;if(b=r.match(c))return r=r.replace(c,"  $1"),t.set(r+f).select(r.length),!1;if(b=r.match(p))return r=r.replace(p,"    "+h(u,[1])+" "),t.set(r+f).select(r.length),!1}return i.tools.indent.click(e,t)}}),r.update({},0)};
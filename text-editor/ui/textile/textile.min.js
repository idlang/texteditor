/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.3.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Textile=function(e,t){function k(e){return b(e.replace(/\s+/g," "))}function x(e){return m(k(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function E(e){return m(k(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function O(e){var c,t=r.$(),n=t.value,i=t.before,u=t.after,o=l(e),f=g("(^|\\n)"+o+"(.*)$"),a=g("^"+o,"gm"),s=L[""];return r[0](),n?g(o+"$").test(i)?r.unwrap(e,""):(r.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),a.test(n)?r.replace(a,""):r.replace(/(^|\n{2})/g,"$1"+e)):u&&i&&("\n"!==u[0]||"\n"!==i.slice(-1))?(c=f.test(i)?i.replace(f,"$1$2"):i.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),r.set(c+u).select(c.length)):r.tidy("\n\n").insert(e,0).insert(s),r[1](),!1}var n=TE.ui.HTML||TE.ui,r=n(e,{auto_close:{"@":"@","*":"*",_:"_","-":"-"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),i=r.ui,u=TE.is,o=u.o,f=function(e){return!u.x(e)},s=(u.s,r._),c=s.edge,l=s.x,p=s.extend,d=s.format,h=s.i,g=s.pattern,m=s.replace,b=s.trim,v="*",y="#",$=l(v),w=l(y);r.update(p({languages:{tools:{sup:["Footnote",r.config.languages.tools.sub[1]]}}},t),0),r.type="Textile";var T=r.config,_=T.formats,C=T.languages,S=T.states,L=(T.tab,C.placeholders);return r.mark=function(e,t,n,i){o(e)||(e=[e]),f(n)||(n=" "),f(i)||(i="");var u=r.h,a=r[0]().$(),s=e[0]+i,c=i+(f(e[1])?e[1]:e[0]),p=a.value,d=l(s),h=l(c),m=g("^"+d+"([\\s\\S]*?)"+h+"$"),b=g(d+"$"),v=g("^"+h),y=a.before,$=a.after;return p?n=!1:r.insert(L[""]),r.toggle(t?!m.test(p):!b.test(y)&&!v.test($),[function(e){e.unwrap(s,c,1).tidy(/<[^\/<>]+?>$/.test(y)?"":n,/^<\/[^<>]+?>/.test($)?"":n).wrap(s,c,t)},function(e){e.unwrap(s,c,t)}])[u]()},p(i.tools,{b:{click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var p,d,h,g,m,v,y,n=t.$(),r=n.before,u=n.value,o=n.after,f=t.get(),a=/^\[\S+?\]/.test(f.split("\n").pop())?"\n":"\n\n",s=f.match(/^\[\S+?\]/gm)||[],c=C.modals.a,l=c.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(u))return t.tidy(" ").mark(['"$":',""],1),!1;for(y in s)y=" "+b(s[y]).replace(/^\[|\]$/g,""),S.a[y]=1;return p=S.a,i.prompt(["a[href]",c.title[0]],l,1,function(e,t,f){f=E(f),t[0](),p[f]?(t.trim(b(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+f],0,!1),g=s.indexOf("["+f+"]"),-1===g&&1!==p[f]&&(n=t.$(),r=n.before,m=n.start,v=n.end,t.set(r+n.value+b(n.after,1)+a+"["+(f||b(u)||L[""])+"]"+p[f][0]).select(m,v))):(d=f,i.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){h=x(n),/^\![^\s]+?\!$/.test(u)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+d,1)):(u||t.insert(L[""]),t.i().trim(b(r)?" ":"",b(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n":" ":"").wrap('"',(h?"("+h+")":"")+'":'+d))})),t[1]()}).record(),!1}},img:{click:function(e,t){var u,o,r=(t.$(),C.modals.img);return i.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){u=E(n),i.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){o=x(n),t.tidy("\n\n","").insert("!"+u+(o?"("+o+")":"")+"!\n\n",0)})}),!1}},sup:{i:"thumb-tack",click:function(t,n){var p,r=n.$(),o=(r.before,r.after),f=C.modals.sup,a=n.get(),s=/^fn\d+\^?\. /.test(b(a).split("\n").pop())?"\n":"\n\n",c=a.match(/^fn\d+\^?\. /gm)||[],l=0;return l=c.length+1,i.prompt(["sup[id]",f.title],r.value||f.placeholder||l,0,function(t,n,r,i){r=b(r)||b(i)||l,p=c.indexOf("fn"+h(r)+". "),-1!==p?(l=a.indexOf(c[p])+2,n.select(l,l+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!b(o)||/^[\t ]*\n+[\t ]*/.test(o)?"\n\n":" ").insert("["+r+"]").set(b(n.get(),1)+s+"fn"+r+". ").focus(1).insert(L[""])}),!1}},abbr:{click:function(e,t){var p,n=t.$(),r=b(n.value),u=C.modals.abbr,o=t.get(),f=k(r||L[""]),a=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],s=S.abbr,c=/\(.*?\)/,l=0;for(l in a)p=a[l].match(/^(.*?)\((.*?)\)$/),S.abbr[p[1]]=b(p[2]);return s=S.abbr,r&&s[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+s[r]+")",1),!1):(i.prompt(["abbr[title]",u.title],s[f]||u.placeholder,!s[r],function(e,t,n,i){n=x(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(l in s)if(x(s[l])===n){t.insert(l);break}t.unwrap("",c).unwrap("",c,1).i().tidy(" ").insert("("+n+")",1)[1]()}).record(),!1)}},p:{click:function(e,t){return O("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,u,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),u=+(i[1]||0),t[0]().i(),n.value||t.insert(L[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>u?"h"+(u+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return O("bq. ")}},"pre,code":{click:function(e,t){return g("(^|\\n)$").test(t.$().before)?O("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var l,n=t.$(),r=n.value,i=n.before,u=n.after,o=g("(^|\\n)([\\t ]*)"+$+" (.*)$"),f=g("^(.*)"+$+" ","gm"),a=g("(^|\\n)([\\t ]*)"+w+" (.*)$"),s=g("^(.*)"+w+" ","gm"),c=L[""];return r?(r===c?t.select():s.test(r)?t.replace(s,"$1"+v+" "):f.test(r)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+v+" $2"),!1):i&&u?(l=a.test(i)?i.replace(a,"$1$2"+v+" $3"):o.test(i)?i.replace(o,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(l+u).select(l.length),!1):(t[0]().tidy("\n\n").insert(v+" ",0).insert(c)[1](),!1)}},ol:{click:function(e,t){var l,n=t.$(),r=n.value,i=n.before,u=n.after,o=g("(^|\\n)([\\t ]*)"+$+" (.*)$"),f=g("^(.*)"+$+" ","gm"),a=g("(^|\\n)([\\t ]*)"+w+" (.*)$"),s=g("^(.*)"+w+" ","gm"),c=L[""];return r?(r===c?t.select():f.test(r)?t.replace(f,function(e,t,n){return t+y+" "}):s.test(r)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+y+" "+n}),!1):i&&u?(l=o.test(i)?i.replace(o,"$1$2"+y+" $3"):a.test(i)?i.replace(a,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+y+" $3"),t.set(l+u).select(l.length),!1):(t[0]().tidy("\n\n").insert(y+" ",0).insert(c)[1](),!1)}},table:function(e,t){var l,p,g,n=S.tr,r=S.td,u=C.modals.table,o=C.placeholders.table,f=d(o[0],[1,1]),a=T.advance_table,s=[];return t[0]().$().value===f?(t.select(),!1):(i.prompt(["table>td",u.title[0]],u.placeholder[0],0,function(e,t,m,b){p=c(h(m)||b,r[0],r[1]),i.prompt(["table>tr",u.title[1]],u.placeholder[1],0,function(e,t,r,i){g=c(h(r)||i,n[0],n[1]);var u,m,v,y,$;for(u=0;g>u;++u){for(l="|",m=0;p>m;++m)l+="   "+d(o[1],[u+1,m+1])+" |";s.push(l)}for(s=s.join("\n"),l="|",v=0;p>v;++v)l+="_. "+d(o[0],[1,v+1])+" |";if(a){for(l+="\n|~.\n|",v=0;p>v;++v)l+="   "+d(o[2],[1,v+1])+" |";l+="\n|-."}s=l+"\n"+s,a&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),y=t.$(),$=y.start+y.value.indexOf(f),t.select($,$+f.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",0),!1}}}),i.tools.sub=i.tools.sup,p(i.keys,{"control+u":0,"shift+enter":0,enter:function(e,t){var n=t.$(),r="((?:"+$+"|"+w+")+ )",i=g("^"+r+".*$","gm").exec(n.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(g(r)),!1):(t.insert("\n"+i[1],0).scroll(1),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,u=n.before,o="(^|\\n)("+$+"){2,}",f="(^|\\n)("+w+"){2,}";return r===L[""]?(t.select(),!1):g(o+" $").test(u)?(t.replace(g($+" $")," ",0),!1):g(o).test(r)?(t.replace(g("^"+$+" *","gm"),""),!1):g(f+" $").test(u)?(t.replace(g(w+" $")," ",0),!1):g(f).test(r)?(t.replace(g("^"+w+" *","gm"),""),!1):i.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,u=n.before,o="(^|\\n)("+$+")+",f="(^|\\n)("+w+")+";return r===L[""]?(t.select(),!1):g(o+" $").test(u)?(t.replace(/ $/,v+" ",0),!1):g(o).test(r)?(t.replace(/^(?!$)/gm,v),!1):g(f+" $").test(u)?(t.replace(/ $/,y+" ",0),!1):g(f).test(r)?(t.replace(/^(?!$)/gm,y),!1):i.tools.indent.click(e,t)}}),r.update({},0)};
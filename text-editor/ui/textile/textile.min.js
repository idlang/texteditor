/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.3.2
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Textile=function(e,t){function w(e){return m(e.replace(/\s+/g," "))}function x(e){return b(w(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function T(e){return b(w(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function P(e){var c,t=i.$(),n=t.value,l=t.before,a=t.after,r=u(e),s=h("(^|\\n)"+r+"(.*)$"),f=h("^"+r,"gm"),o=O[""];return i[0](),n?h(r+"$").test(l)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),f.test(n)?i.replace(f,""):i.replace(/(^|\n{2})/g,"$1"+e)):a&&l&&("\n"!==a[0]||"\n"!==l.slice(-1))?(c=s.test(l)?l.replace(s,"$1$2"):l.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(c+a).select(c.length)):i.tidy("\n\n").insert(e,0).insert(o),i[1](),!1}var n=TE.ui.HTML||TE.ui,i=n(e,{auto_close:{"@":"@","*":"*",_:"_","-":"-"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},note:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),l=i.ui,a=TE.is,r=a.o,s=function(e){return!a.x(e)},o=(a.s,i._),c=o.edge,u=o.x,d=o.extend,p=o.format,g=o.i,h=o.pattern,b=o.replace,m=o.trim,v="*",k="#",y=u(v),$=u(k);i.update(t,0),i.type="Textile";var E=i.config,_=E.formats,M=E.languages,C=E.states,O=(E.tab,M.placeholders);return i.mark=function(e,t,n,l){r(e)||(e=[e]),s(n)||(n=" "),s(l)||(l="");var a=i.h,f=i[0]().$(),o=e[0]+l,c=l+(s(e[1])?e[1]:e[0]),d=f.value,p=u(o),g=u(c),b=h("^"+p+"([\\s\\S]*?)"+g+"$"),m=h(p+"$"),v=h("^"+g),k=f.before,y=f.after;return d?n=!1:i.insert(O[""]),i.toggle(t?!b.test(d):!m.test(k)&&!v.test(y),[function(e){e.unwrap(o,c,1).tidy(/<[^\/<>]+?>$/.test(k)?"":n,/^<\/[^<>]+?>/.test(y)?"":n).wrap(o,c,t)},function(e){e.unwrap(o,c,t)}])[a]()},d(l.tools,{b:{click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var d,p,g,h,b,v,k,n=t.$(),i=n.before,a=n.value,r=n.after,s=t.get(),f=/^\[\S+?\]/.test(s.split("\n").pop())?"\n":"\n\n",o=s.match(/^\[\S+?\]/gm)||[],c=M.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(a))return t.tidy(" ").mark(['"$":',""],1),!1;for(k in o)k=" "+m(o[k]).replace(/^\[|\]$/g,""),C.a[k]=1;return d=C.a,l.prompt(["a[href]",c.title[0]],u,1,function(e,t,s){s=T(s),t[0](),d[s]?(t.trim(m(i)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(r)?!1:" ").mark(['"','":'+s],0,!1),h=o.indexOf("["+s+"]"),-1===h&&1!==d[s]&&(n=t.$(),i=n.before,b=n.start,v=n.end,t.set(i+n.value+m(n.after,1)+f+"["+(s||m(a)||O[""])+"]"+d[s][0]).select(b,v))):(p=s,l.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){g=x(n),/^\![^\s]+?\!$/.test(a)?(g&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+g+")!"),t.insert(":"+p,1)):(a||t.insert(O[""]),t.i().trim(m(i)?" ":"",m(r)?/^\n+(fn\d+\^?\. |\[)/.test(r)?"\n\n":" ":"").wrap('"',(g?"("+g+")":"")+'":'+p))})),t[1]()}).record(),!1}},img:{click:function(e,t){var a,r,i=(t.$(),M.modals.img);return l.prompt(["img[src]",i.title[0]],i.placeholder[0],1,function(e,t,n){a=T(n),l.prompt(["img[title]",i.title[1]],i.placeholder[1],0,function(e,t,n){r=x(n),t.tidy("\n\n","").insert("!"+a+(r?"("+r+")":"")+"!\n\n",0)})}),!1}},abbr:{click:function(e,t){var d,n=t.$(),i=m(n.value),a=M.modals.abbr,r=t.get(),s=w(i||O[""]),f=r.match(/\b[A-Z\d]+\(.*?\)/g)||[],o=C.abbr,c=/\(.*?\)/,u=0;for(u in f)d=f[u].match(/^(.*?)\((.*?)\)$/),C.abbr[d[1]]=m(d[2]);return o=C.abbr,i&&o[i]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+o[i]+")",1),!1):(l.prompt(["abbr[title]",a.title],o[s]||a.placeholder,!o[i],function(e,t,n,l){n=x(n||l),t[0](),i||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in o)if(x(o[u])===n){t.insert(u);break}t.unwrap("",c).unwrap("",c,1).i().tidy(" ").insert("("+n+")",1)[1]()}).record(),!1)}},p:{click:function(e,t){return P("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var l,a,n=t.$(),i=/(?:p|h\d+)\. +/;return(l=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(l=n.value.match(/^(?:p|h([1-6]))\. /)||[]),a=+(l[1]||0),t[0]().i(),n.value||t.insert(O[""]),t.unwrap(i,"").unwrap(i,"",1).tidy("\n\n").wrap(6>a?"h"+(a+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return P("bq. ")}},"pre,code":{click:function(e,t){return h("(^|\\n)$").test(t.$().before)?P("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var u,n=t.$(),i=n.value,l=n.before,a=n.after,r=h("(^|\\n)([\\t ]*)"+y+" (.*)$"),s=h("^(.*)"+y+" ","gm"),f=h("(^|\\n)([\\t ]*)"+$+" (.*)$"),o=h("^(.*)"+$+" ","gm"),c=O[""];return i?(i===c?t.select():o.test(i)?t.replace(o,"$1"+v+" "):s.test(i)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+v+" $2"),!1):l&&a?(u=f.test(l)?l.replace(f,"$1$2"+v+" $3"):r.test(l)?l.replace(r,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(u+a).select(u.length),!1):(t[0]().tidy("\n\n").insert(v+" ",0).insert(c)[1](),!1)}},ol:{click:function(e,t){var u,n=t.$(),i=n.value,l=n.before,a=n.after,r=h("(^|\\n)([\\t ]*)"+y+" (.*)$"),s=h("^(.*)"+y+" ","gm"),f=h("(^|\\n)([\\t ]*)"+$+" (.*)$"),o=h("^(.*)"+$+" ","gm"),c=O[""];return i?(i===c?t.select():s.test(i)?t.replace(s,function(e,t,n){return t+k+" "}):o.test(i)?t.replace(o,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+k+" "+n}),!1):l&&a?(u=r.test(l)?l.replace(r,"$1$2"+k+" $3"):f.test(l)?l.replace(f,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+k+" $3"),t.set(u+a).select(u.length),!1):(t[0]().tidy("\n\n").insert(k+" ",0).insert(c)[1](),!1)}},table:function(e,t){var u,d,h,n=C.tr,i=C.td,a=M.modals.table,r=M.placeholders.table,s=p(r[0],[1,1]),f=E.advance_table,o=[];return t[0]().$().value===s?(t.select(),!1):(l.prompt(["table>td",a.title[0]],a.placeholder[0],0,function(e,t,b,m){d=c(g(b)||m,i[0],i[1]),l.prompt(["table>tr",a.title[1]],a.placeholder[1],0,function(e,t,i,l){h=c(g(i)||l,n[0],n[1]);var a,b,v,k,y;for(a=0;h>a;++a){for(u="|",b=0;d>b;++b)u+="   "+p(r[1],[a+1,b+1])+" |";o.push(u)}for(o=o.join("\n"),u="|",v=0;d>v;++v)u+="_. "+p(r[0],[1,v+1])+" |";if(f){for(u+="\n|~.\n|",v=0;d>v;++v)u+="   "+p(r[2],[1,v+1])+" |";u+="\n|-."}o=u+"\n"+o,f&&(o="|^.\n"+o),t.tidy("\n\n").insert(o),k=t.$(),y=k.start+k.value.indexOf(s),t.select(y,y+s.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",0).scroll(2),!1}},note:{i:"thumb-tack",click:function(t,n){var d,i=n.$(),r=(i.before,i.after),s=M.modals.note,f=n.get(),o=/^fn\d+\^?\. /.test(m(f).split("\n").pop())?"\n":"\n\n",c=f.match(/^fn\d+\^?\. /gm)||[],u=0;return u=c.length+1,l.prompt(["note[id]",s.title],u,0,function(t,n,i,l){i=m(i)||m(l)||u,d=c.indexOf("fn"+g(i)+". "),-1!==d?(u=f.indexOf(c[d])+2,n.select(u,u+i.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!m(r)||/^[\t ]*\n+[\t ]*/.test(r)?"\n\n":" ").insert("["+i+"]").set(m(n.get(),1)+o+"fn"+i+". ").focus(1).insert(O[""])}),!1}}}),d(l.keys,{"control+u":0,"shift+enter":0,enter:function(e,t){var n=t.$(),i="((?:"+y+"|"+$+")+ )",l=h("^"+i+".*$","gm").exec(n.before.split("\n").pop());return l?l[0]===l[1]?(t.outdent(h(i)),!1):(t.insert("\n"+l[1],0).scroll(1),!1):void 0},"shift+tab":function(e,t){var n=t.$(),i=n.value,a=n.before,r="(^|\\n)("+y+"){2,}",s="(^|\\n)("+$+"){2,}";return i===O[""]?(t.select(),!1):h(r+" $").test(a)?(t.replace(h(y+" $")," ",0),!1):h(r).test(i)?(t.replace(h("^"+y+" *","gm"),""),!1):h(s+" $").test(a)?(t.replace(h($+" $")," ",0),!1):h(s).test(i)?(t.replace(h("^"+$+" *","gm"),""),!1):l.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),i=n.value,a=n.before,r="(^|\\n)("+y+")+",s="(^|\\n)("+$+")+";return i===O[""]?(t.select(),!1):h(r+" $").test(a)?(t.replace(/ $/,v+" ",0),!1):h(r).test(i)?(t.replace(/^(?!$)/gm,v),!1):h(s+" $").test(a)?(t.replace(/ $/,k+" ",0),!1):h(s).test(i)?(t.replace(/^(?!$)/gm,k),!1):l.tools.indent.click(e,t)},"control+arrowdown":"note","control+arrowup":"note"}),i.update({},0)};
/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.3.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Textile=function(e,t){function x(e){return m(e.replace(/\s+/g," "))}function $(e){return g(x(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function E(e){return g(x(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function O(e){var a,t=r.$(),n=t.value,i=t.before,o=t.after,f=c(e),u=b("(^|\\n)"+f+"(.*)$"),l=b("^"+f,"gm"),s=S[""];return r[0](),n?b(f+"$").test(i)?r.unwrap(e,""):(r.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),l.test(n)?r.replace(l,""):r.replace(/(^|\n{2})/g,"$1"+e)):o&&i&&("\n"!==o[0]||"\n"!==i.slice(-1))?(a=u.test(i)?i.replace(u,"$1$2"):i.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),r.set(a+o).select(a.length)):r.tidy("\n\n").insert(e,0).insert(s),r[1](),!1}var n=TE.ui.HTML||TE.ui,r=n(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),i=r.ui,o=TE.is,f=o.o,u=function(e){return!o.x(e)},s=(o.s,r._),a=s.edge,c=s.x,d=s.extend,p=s.format,h=s.i,b=s.pattern,g=s.replace,m=s.trim,v="*",y="#",w=c(v),k=c(y);r.update(d({languages:{tools:{sup:["Footnote",r.config.languages.tools.sub[1]]}}},t),0),r.type="Textile";var T=r.config,L=T.formats,_=T.languages,z=T.states,S=(T.tab,_.placeholders);return r.mark=function(e,t,n,i){f(e)||(e=[e]),u(n)||(n=" "),u(i)||(i="");var o=r.h,l=r[0]().$(),s=e[0]+i,a=i+(u(e[1])?e[1]:e[0]),d=l.value,p=c(s),h=c(a),g=b("^"+p+"([\\s\\S]*?)"+h+"$"),m=b(p+"$"),v=b("^"+h),y=l.before,w=l.after;return d?n=!1:r.insert(S[""]),r.toggle(t?!g.test(d):!m.test(y)&&!v.test(w),[function(e){e.unwrap(s,a,1).tidy(/<[^\/<>]+?>$/.test(y)?"":n,/^<\/[^<>]+?>/.test(w)?"":n).wrap(s,a,t)},function(e){e.unwrap(s,a,t)}])[o]()},d(i.tools,{b:{click:function(e,t){return t.i().mark(L.b[0]),!1}},i:{click:function(e,t){return t.i().mark(L.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var d,p,h,b,g,v,y,n=t.$(),r=n.before,o=n.value,f=n.after,u=t.get(),l=/^\[\S+?\]/.test(u.split("\n").pop())?"\n":"\n\n",s=u.match(/^\[\S+?\]/gm)||[],a=_.modals.a,c=a.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(o))return t.tidy(" ").mark(['"$":',""],1),!1;for(y in s)y=" "+m(s[y]).replace(/^\[|\]$/g,""),z.a[y]=1;return d=z.a,i.prompt(["a[href]",a.title[0]],c,1,function(e,t,u){u=E(u),t[0](),d[u]?(t.trim(m(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(f)?!1:" ").mark(['"','":'+u],0,!1),b=s.indexOf("["+u+"]"),-1===b&&1!==d[u]&&(n=t.$(),r=n.before,g=n.start,v=n.end,t.set(r+n.value+m(n.after,1)+l+"["+(u||m(o)||S[""])+"]"+d[u][0]).select(g,v))):(p=u,i.prompt(["a[title]",a.title[1]],a.placeholder[1],0,function(e,t,n){h=$(n),/^\![^\s]+?\!$/.test(o)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+p,1)):(o||t.insert(S[""]),t.i().trim(m(r)?" ":"",m(f)?/^\n+(fn\d+\^?\. |\[)/.test(f)?"\n\n ":" ":"").wrap('"',(h?"("+h+")":"")+'":'+p))})),t[1]()}).record(),!1}},img:{click:function(e,t){var o,f,r=(t.$(),_.modals.img);return i.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){o=E(n),i.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){f=$(n),t.tidy("\n\n","").insert("!"+o+(f?"("+f+")":"")+"!\n\n",0)})}),!1}},sup:{i:"thumb-tack",click:function(t,n){var d,r=n.$(),f=(r.before,r.after),u=_.modals.sup,l=n.get(),s=/^fn\d+\^?\. /.test(m(l).split("\n").pop())?"\n":"\n\n",a=l.match(/^fn\d+\^?\. /gm)||[],c=0;return c=a.length+1,i.prompt(["sup[id]",u.title],r.value||u.placeholder||c,0,function(t,n,r,i){r=m(r)||m(i)||c,d=a.indexOf("fn"+h(r)+". "),-1!==d?(c=l.indexOf(a[d])+2,n.select(c,c+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!m(f)||/^[\t ]*\n+[\t ]*/.test(f)?"\n\n":" ").insert("["+r+"]").set(m(n.get(),1)+s+"fn"+r+". ").focus(!0).insert(S[""])}),!1}},abbr:{click:function(e,t){var d,n=t.$(),r=m(n.value),o=_.modals.abbr,f=t.get(),u=x(r||S[""]),l=f.match(/\b[A-Z\d]+\(.*?\)/g)||[],s=z.abbr,a=/\(.*?\)/,c=0;for(c in l)d=l[c].match(/^(.*?)\((.*?)\)$/),z.abbr[d[1]]=m(d[2]);return s=z.abbr,r&&s[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+s[r]+")",1),!1):(i.prompt(["abbr[title]",o.title],s[u]||o.placeholder,!s[r],function(e,t,n,i){n=$(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(c in s)if($(s[c])===n){t.insert(c);break}t.unwrap("",a).unwrap("",a,1).i().tidy(" ").insert("("+n+")",1)[1]()}).record(),!1)}},p:{click:function(e,t){return O("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),n.value||t.insert(S[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return O("bq. ")}},"pre,code":{click:function(e,t){return b("(^|\\n)$").test(t.$().before)?O("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,f=b("(^|\\n)([\\t ]*)"+w+" (.*)$"),u=b("^(.*)"+w+" ","gm"),l=b("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=b("^(.*)"+k+" ","gm"),a=S[""];return r?(r===a?t.select():s.test(r)?t.replace(s,"$1"+v+" "):u.test(r)?t.replace(u,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+v+" $2"),!1):i&&o?(c=l.test(i)?i.replace(l,"$1$2"+v+" $3"):f.test(i)?i.replace(f,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(v+" ",0).insert(a)[1](),!1)}},ol:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,f=b("(^|\\n)([\\t ]*)"+w+" (.*)$"),u=b("^(.*)"+w+" ","gm"),l=b("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=b("^(.*)"+k+" ","gm"),a=S[""];return r?(r===a?t.select():u.test(r)?t.replace(u,function(e,t,n){return t+y+" "}):s.test(r)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+y+" "+n}),!1):i&&o?(c=f.test(i)?i.replace(f,"$1$2"+y+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+y+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(y+" ",0).insert(a)[1](),!1)}},table:function(e,t){var c,d,b,n=z.tr,r=z.td,o=_.modals.table,f=_.placeholders.table,u=p(f[0],[1,1]),l=T.advance_table,s=[];return t[0]().$().value===u?(t.select(),!1):(i.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,g,m){d=a(h(g)||m,r[0],r[1]),i.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,r,i){b=a(h(r)||i,n[0],n[1]);var o,g,v,y,w;for(o=0;b>o;++o){for(c="|",g=0;d>g;++g)c+="   "+p(f[1],[o+1,g+1])+" |";s.push(c)}for(s=s.join("\n"),c="|",v=0;d>v;++v)c+="_. "+p(f[0],[1,v+1])+" |";if(l){for(c+="\n|~.\n|",v=0;d>v;++v)c+="   "+p(f[2],[1,v+1])+" |";c+="\n|-."}s=c+"\n"+s,l&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),y=t.$(),w=y.start+y.value.indexOf(u),t.select(w,w+u.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(L.hr[0]+"\n\n",0),!1}}}),i.tools.sub=i.tools.sup,d(i.keys,{"control+u":0,"shift+enter":0,enter:function(e,t){var n=t.$(),r="((?:"+w+"|"+k+")+ )",i=b("^"+r+".*$","gm").exec(n.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(b(r)),!1):(t.insert("\n"+i[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,o=n.before,f="(^|\\n)("+w+"){2,}",u="(^|\\n)("+k+"){2,}";return r===S[""]?(t.select(),!1):b(f+" $").test(o)?(t.replace(b(w+" $")," ",0),!1):b(f).test(r)?(t.replace(b("^"+w+" *","gm"),""),!1):b(u+" $").test(o)?(t.replace(b(k+" $")," ",0),!1):b(u).test(r)?(t.replace(b("^"+k+" *","gm"),""),!1):i.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,o=n.before,f="(^|\\n)("+w+")+",u="(^|\\n)("+k+")+";return r===S[""]?(t.select(),!1):b(f+" $").test(o)?(t.replace(/ $/,v+" ",0),!1):b(f).test(r)?(t.replace(/^(?!$)/gm,v),!1):b(u+" $").test(o)?(t.replace(/ $/,y+" ",0),!1):b(u).test(r)?(t.replace(/^(?!$)/gm,y),!1):i.tools.indent.click(e,t)}}),r.update({},0)};
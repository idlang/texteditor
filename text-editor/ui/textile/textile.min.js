TE.ui.Textile=function(e,t){function w(e){return m(e.replace(/\s+/g," "))}function $(e){return g(w(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function E(e){return g(w(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function C(e){var u,t=i.$(),n=t.value,r=t.before,o=t.after,f=c(e),l=h("(^|\\n)"+f+"(.*)$"),s=h("^"+f,"gm"),a=S[""];return i[0](),n?h(f+"$").test(r)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),s.test(n)?i.replace(s,""):i.replace(/(^|\n{2})/g,"$1"+e)):o&&r&&("\n"!==o[0]||"\n"!==r.slice(-1))?(u=l.test(r)?r.replace(l,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(u+o).select(u.length)):i.tidy("\n\n").insert(e,0).insert(a),i[1](),!1}var n=TE.ui.HTML||TE.ui,i=n(e,{auto_close:{"@":"@","*":"*",_:"_","-":"-"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},note:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),r=i.ui,o=TE.is,f=o.o,l=function(e){return!o.x(e)},a=(o.s,i._),u=a.edge,c=a.x,d=a.extend,p=a.format,b=a.i,h=a.pattern,g=a.replace,m=a.trim,y="*",v="#",x=c(y),k=c(v);i.update(t,0),i.type="Textile";var T=i.config,_=T.formats,L=T.languages,z=T.states,S=(T.tab,L.placeholders);return i.mark=function(e,t,n,r){f(e)||(e=[e]),l(n)||(n=" "),l(r)||(r="");var o=i.h,s=i[0]().$(),a=e[0]+r,u=r+(l(e[1])?e[1]:e[0]),d=s.value,p=c(a),b=c(u),g=h("^"+p+"([\\s\\S]*?)"+b+"$"),m=h(p+"$"),y=h("^"+b),v=s.before,x=s.after;return d?n=!1:i.insert(S[""]),i.toggle(t?!g.test(d):!m.test(v)&&!y.test(x),[function(e){e.unwrap(a,u,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(x)?"":n).wrap(a,u,t)},function(e){e.unwrap(a,u,t)}])[o]()},d(r.tools,{b:{click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var d,p,b,h,g,y,v,n=t.$(),i=n.before,o=n.value,f=n.after,l=t.get(),s=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",a=l.match(/^\[\S+?\]/gm)||[],u=L.modals.a,c=u.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(o))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in a)v=" "+m(a[v]).replace(/^\[|\]$/g,""),z.a[v]=1;return d=z.a,r.prompt(u.title[0],c,1,function(e,t,l){l=E(l),t[0](),d[l]?(t.trim(m(i)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(f)?!1:" ").mark(['"','":'+l],0,!1),h=a.indexOf("["+l+"]"),-1===h&&1!==d[l]&&(n=t.$(),i=n.before,g=n.start,y=n.end,t.set(i+n.value+m(n.after,1)+s+"["+(l||m(o)||S[""])+"]"+d[l][0]).select(g,y))):(p=l,r.prompt(u.title[1],u.placeholder[1],0,function(e,t,n){b=$(n),/^\![^\s]+?\!$/.test(o)?(b&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+b+")!"),t.insert(":"+p,1)):(o||t.insert(S[""]),t.i().trim(m(i)?" ":"",m(f)?/^\n+(fn\d+\^?\. |\[)/.test(f)?"\n\n":" ":"").wrap('"',(b?"("+b+")":"")+'":'+p))},0,0,"a[title]")),t[1]()},0,0,"a[href]").record(),!1}},img:{click:function(e,t){var o,f,i=(t.$(),L.modals.img);return r.prompt(i.title[0],i.placeholder[0],1,function(e,t,n){o=E(n),r.prompt(i.title[1],i.placeholder[1],0,function(e,t,n){f=$(n),t.tidy("\n\n","").insert("!"+o+(f?"("+f+")":"")+"!\n\n",0)},0,0,"img[title]")},0,0,"img[src]"),!1}},abbr:{click:function(e,t){var d,n=t.$(),i=m(n.value),o=L.modals.abbr,f=t.get(),l=w(i||S[""]),s=f.match(/\b[A-Z\d]+\(.*?\)/g)||[],a=z.abbr,u=/\(.*?\)/,c=0;for(c in s)d=s[c].match(/^(.*?)\((.*?)\)$/),z.abbr[d[1]]=m(d[2]);return a=z.abbr,i&&a[i]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+a[i]+")",1),!1):(r.prompt(o.title,a[l]||o.placeholder,!a[i],function(e,t,n,r){n=$(n||r),t[0](),i||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(c in a)if($(a[c])===n){t.insert(c);break}t.unwrap("",u).unwrap("",u,1).i().tidy(" ").insert("("+n+")",1)[1]()},0,0,"abbr[title]").record(),!1)}},p:{click:function(e,t){return C("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var r,o,n=t.$(),i=/(?:p|h\d+)\. +/;return(r=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(r=n.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(r[1]||0),t[0]().i(),n.value||t.insert(S[""]),t.unwrap(i,"").unwrap(i,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return C("bq. ")}},"pre,code":{click:function(e,t){return h("(^|\\n)$").test(t.$().before)?C("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,n=t.$(),i=n.value,r=n.before,o=n.after,f=h("(^|\\n)([\\t ]*)"+x+" (.*)$"),l=h("^(.*)"+x+" ","gm"),s=h("(^|\\n)([\\t ]*)"+k+" (.*)$"),a=h("^(.*)"+k+" ","gm"),u=S[""];return i?(i===u?t.select():a.test(i)?t.replace(a,"$1"+y+" "):l.test(i)?t.replace(l,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+y+" $2"),!1):r&&o?(c=s.test(r)?r.replace(s,"$1$2"+y+" $3"):f.test(r)?r.replace(f,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+y+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(y+" ",0).insert(u)[1](),!1)}},ol:{click:function(e,t){var c,n=t.$(),i=n.value,r=n.before,o=n.after,f=h("(^|\\n)([\\t ]*)"+x+" (.*)$"),l=h("^(.*)"+x+" ","gm"),s=h("(^|\\n)([\\t ]*)"+k+" (.*)$"),a=h("^(.*)"+k+" ","gm"),u=S[""];return i?(i===u?t.select():l.test(i)?t.replace(l,function(e,t,n){return t+v+" "}):a.test(i)?t.replace(a,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+v+" "+n}),!1):r&&o?(c=f.test(r)?r.replace(f,"$1$2"+v+" $3"):s.test(r)?r.replace(s,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(v+" ",0).insert(u)[1](),!1)}},table:function(e,t){var c,d,h,n=z.tr,i=z.td,o=L.modals.table,f=L.placeholders.table,l=p(f[0],[1,1]),s=T.advance_table,a=[];return t[0]().$().value===l?(t.select(),!1):(r.prompt(o.title[0],o.placeholder[0],0,function(e,t,g,m){d=u(b(g)||m,i[0],i[1]),r.prompt(o.title[1],o.placeholder[1],0,function(e,t,i,r){h=u(b(i)||r,n[0],n[1]);var o,g,y,v,x;for(o=0;h>o;++o){for(c="|",g=0;d>g;++g)c+="   "+p(f[1],[o+1,g+1])+" |";a.push(c)}for(a=a.join("\n"),c="|",y=0;d>y;++y)c+="_. "+p(f[0],[1,y+1])+" |";if(s){for(c+="\n|~.\n|",y=0;d>y;++y)c+="   "+p(f[2],[1,y+1])+" |";c+="\n|-."}a=c+"\n"+a,s&&(a="|^.\n"+a),t.tidy("\n\n").insert(a),v=t.$(),x=v.start+v.value.indexOf(l),t.select(x,x+l.length)[1]()},0,0,"table>tr")},0,0,"table>td"),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",0).scroll(2),!1}},note:{i:"thumb-tack",click:function(t,n){var d,i=n.$(),f=(i.before,i.after),l=L.modals.note,s=n.get(),a=/^fn\d+\^?\. /.test(m(s).split("\n").pop())?"\n":"\n\n",u=s.match(/^fn\d+\^?\. /gm)||[],c=0;return c=u.length+1,r.prompt(l.title,c,0,function(t,n,i,r){i=m(i)||m(r)||c,d=u.indexOf("fn"+b(i)+". "),-1!==d?(c=s.indexOf(u[d])+2,n.select(c,c+i.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!m(f)||/^[\t ]*\n+[\t ]*/.test(f)?"\n\n":" ").insert("["+i+"]").set(m(n.get(),1)+a+"fn"+i+". ").focus(1).insert(S[""])},0,0,"note[id]"),!1}}}),d(r.keys,{"control+u":0,"shift+enter":0,enter:function(e,t){var n=t.$(),i="((?:"+x+"|"+k+")+ )",r=h("^"+i+".*$","gm").exec(n.before.split("\n").pop());return r?r[0]===r[1]?(t.outdent(h(i)),!1):(t.insert("\n"+r[1],0).scroll(1),!1):void 0},"shift+tab":function(e,t){var n=t.$(),i=n.value,o=n.before,f="(^|\\n)("+x+"){2,}",l="(^|\\n)("+k+"){2,}";return i===S[""]?(t.select(),!1):h(f+" $").test(o)?(t.replace(h(x+" $")," ",0),!1):h(f).test(i)?(t.replace(h("^"+x+" *","gm"),""),!1):h(l+" $").test(o)?(t.replace(h(k+" $")," ",0),!1):h(l).test(i)?(t.replace(h("^"+k+" *","gm"),""),!1):r.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),i=n.value,o=n.before,f="(^|\\n)("+x+")+",l="(^|\\n)("+k+")+";return i===S[""]?(t.select(),!1):h(f+" $").test(o)?(t.replace(/ $/,y+" ",0),!1):h(f).test(i)?(t.replace(/^(?!$)/gm,y),!1):h(l+" $").test(o)?(t.replace(/ $/,v+" ",0),!1):h(l).test(i)?(t.replace(/^(?!$)/gm,v),!1):r.tools.indent.click(e,t)},"control+arrowdown":"note","control+arrowup":"note"}),i.update({},0)};
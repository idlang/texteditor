TE.HTML=TE.html=function(e,t){function q(e){return e.split(/\s+/)[0]}function j(e){var t=e.match(/(?:^|\n)([\t ]*).*$/);return t&&t[1]||""}function K(e,t,r){var h,n=p.$(),i=n.value,a=n.before,l=T[t],o=T[r]||r,s=q(l),u=q(o),c=j(a),f=I[""];return R=l,p[0](),i&&i!==f?(p.tidy("\n\n","").replace(/[\t ]*\n[\t ]*/g,"</"+u+">\n"+O+"<"+o+">").wrap("<"+l+">\n"+O+"<"+o+">","</"+u+">\n</"+s+">\n\n",1).replace($("\\n"+O+"<"+o+">\\s*<\\/"+u+">\\n","g"),"\n</"+s+">\n\n<"+l+">\n").select(p.$().end),L&&y.tools.p.click(e,p),p[1](),!1):void((h=a.match($("(?:^|\\n)[\\t ]+<(\\/?)(?:"+q(T.ul)+"|"+q(T.ol)+")"+A+">\\s*$")))?p.insert("\n"+c+(h[1]?"":O),-1):(h=a.match($("<"+u+U+">.*?$")))?$("<\\/"+u+">\\s*$").test(a)?p.tidy("\n"+c,!1).insert(f).wrap("<"+u+h[1]+">","</"+u+">"):/>\s*$/.test(a)?p.insert(f).wrap("\n"+c+O+"<"+l+">\n"+c+O+O+"<"+u+h[1]+">","</"+u+">\n"+c+O+"</"+s+">\n"+c):p.insert("</"+u+">\n"+c+"<"+u+h[1]+">",-1).insert(f):$("<\\/"+u+">\\s*$").test(a)?p.insert(f).wrap("\n"+c+"<"+o+">","</"+u+">"):p.tidy("\n\n").insert(f).wrap("<"+l+">\n"+O+"<"+o+">","</"+u+">\n</"+s+">"))}function Y(e,t){return!t.get(0)&&L&&y.tools.p.click(e,t),t}function H(e){return B(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function G(e){return B(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function B(e){return m(e.replace(/\s+/g," "))}var R,r="–",n="…",i="↑",a="↓",l="↵",o="⌘",s="✘",u="⇧",c=window,p=(document,new TE(e)),h=p._,d=h.extend,g=h.each,b=h.x,m=h.trim,v=h.edge,$=h.pattern,k=h.i,y=p.ui(d({suffix:">",auto_encode_html:1,auto_p:1,tools:"clear | b i u s | sub sup | abbr | a img | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{tr:[1,20],td:[1,20],abbr:{}},languages:{tools:{clear:["Clear Format",s],b:["Bold",o+"+B"],i:["Italic",o+"+I"],u:["Underline",o+"+U"],s:["Strike",o+"+"+s],a:["Link",o+"+L"],img:["Image",o+"+G"],sub:["Subscript",o+"+"+a],sup:["Superscript",o+"+"+i],abbr:["Abbreviation",o+"+"+u+"+?"],p:["Paragraph",o+"+"+l],"p,h1,h2,h3,h4,h5,h6":["H1 "+r+" H6",o+"+H"],"blockquote,q":["Quote",o+"+Q"],"pre,code":["Code",o+"+K"],ul:["Unordered List",o+"+-"],ol:["Ordered List",o+"++"],table:["Table",o+"+T"],hr:["Horizontal Rule",o+"+R"]},modals:{a:{title:["Link URL","Link Title"],placeholder:["http://","link title here"+n]},img:{title:["Image URL","Image Title","Image Caption"],placeholder:["http://","image title here"+n,"image caption here"+n]},abbr:{title:"Abbreviation",placeholder:"meaning here"+n},table:{title:["Number of Columns","Number of Rows","Table Caption"],placeholder:["3","3","table caption here"+n]}},placeholders:{table:["Table Head %1.%2","Table Data %1.%2","Table Foot %1.%2"]}},classes:{},advance_a:1,advance_img:1,advance_table:1,formats:{b:"strong",i:"em",u:"u",s:'del datetime="%1-%2-%3"',a:"a",figure:"figure",figcaption:"figcaption",img:"img",sub:"sub",sup:"sup",abbr:"abbr",p:"p",br:"br",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",blockquote:"blockquote",q:"q",pre:"pre",code:"code",ul:"ul",ol:"ol",li:"li",table:'table border="1"',caption:"caption",thead:"thead",tbody:"tbody",tfoot:"tfoot",tr:"tr",th:"th",td:"td",hr:"hr"}},t)),w=h.format,x=p.config,E=x.states,_=x.languages,T=x.formats,O=(x.classes,x.tab),S=x.suffix,A="(?:\\s[^<>]*?)?",U="(|\\s[^<>]*?)",z="([\\s\\S]*?)",I=_.placeholders,L=x.auto_p;return p.type="html",d(y.tools,{clear:{i:"eraser",click:function(e,t){var r=t[0]().$(),n=r.value;return/<[^<>]+?>/.test(n)||">"===r.before.slice(-1)||"<"===r.after[0]?t.replace(/<[^<>]+?>/g,"").unwrap(/<[^\/<>]+?>/,/<\/[^<>]+?>/):t.insert(""),t[1](),!!r.after}},b:{i:"bold",click:function(e,t){return Y(e,t).i().format(T.b),!1}},i:{i:"italic",click:function(e,t){return Y(e,t).i().format(T.i),!1}},u:{i:"underline",click:function(e,t){return Y(e,t).i().format(T.u),!1}},s:{i:"strikethrough",click:function(e,t){return Y(e,t).i().format(w(T.s,t._.time())),!1}},a:{i:"link",click:function(e,t){var i,a,r=T.a,n=_.modals.a;return t.record().ui.prompt(["a[href]",n.title[0]],n.placeholder[0],1,function(e,t,l){l=G(l),i=l;var s,u,o=c.location.host;-1!==i.indexOf("://")&&(s=1),""!==o&&-1!==i.indexOf("://"+o)&&(s=0),/^([.\/?&#]|javascript:)/.test(i)&&(s=0),t.blur().ui.prompt(["a[title]",n.title[1]],n.placeholder[1],0,function(e,t,n){a=H(n),Y(e,t).$().length||t.insert(I[""]),u=x.advance_a&&s?' rel="nofollow" target="_blank"':"",t.i().format(r+' href="'+i+'"'+(a?' title="'+a+'"':"")+u)})}),!1}},img:{i:"image",click:function(e,t){var u,c,r=t.$(),n=T.img,i=T.figure,a=T.figcaption,l=r.value,o=_.modals.img,s=x.advance_img;return t.ui.prompt(["img[src]",o.title[0]],o.placeholder[0],1,function(e,t,r){r=G(r),u=r,t.blur().ui.prompt(["img[title]",o.title[s?2:1]],o.placeholder[s?2:1],0,function(e,t,r){c=H(r),l||(l=u.split(/[\/\\\\]/).pop()),l=H(l),t[0](),s&&c?(t.tidy("\n\n","").insert("<"+i+">\n"+O+"<"+n+' alt="'+l+'" src="'+u+'"'+S+"\n"+O+"<"+a+">"+c+"</"+q(a)+">\n</"+q(i)+">\n\n",-1,1),L&&y.tools.p.click(e,t)):Y(e,t).tidy(/<[^\/<>]+?>\s*$/.test(t.$().before)?"":" ","").insert("<"+n+' alt="'+l+'" src="'+u+'"'+(c?' title="'+c+'"':"")+S+" ",-1,1),t[1]()})}),!1}},sub:{i:"subscript",click:function(e,t){var r=T.sub,n=T.sup,i=q(n);return Y(e,t)[0]().unwrap($("<"+i+A+">"),"</"+i+">").i().format(r)[1](),!1}},sup:{i:"superscript",click:function(e,t){var r=T.sub,n=T.sup,i=q(r);return Y(e,t)[0]().unwrap($("<"+i+A+">"),"</"+i+">").i().format(n)[1](),!1}},abbr:{i:"question",click:function(e,t){var h,d,r=t.$(),n=m(r.value),i=_.modals.abbr,a=t.get(),l=m(n||I[""]),o=T.abbr,s=q(o),u="<"+b(o)+U+">",c="<"+b(o)+A+">",f="<\\/"+s+">",p=$(u+z+f);return a.replace(p,function(e,t,r){(r=m(r))&&(E.abbr[r]=(t.match(/\s+title="\s*(.*?)\s*"/i)||["",""])[1])}),h=E.abbr,n&&h[n]?(t.i().format(o+' title="'+h[n]+'"'),!1):(t.record().ui.prompt(["abbr[title]",i.title],h[l]||i.placeholder,!h[n],function(e,t,r,i){r=H(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(d in h)if(H(h[d])===r){t.insert(d);break}Y(e,t).unwrap($(c),$(f)).unwrap($(c),$(f),1).i().format(o+' title="'+r+'"')[1]()}),!1)}},p:{i:"paragraph",click:function(e,t){var r=t.$(),n=r.value,i=T.p,a=T.br,l=q(i),o=q(a),s=r.before,u=r.after,c=j(s),f=I[""];if(t[0](),n&&-1!==n.indexOf("\n")){var p=$("^(?:\\s*<"+l+A+">\\s*)+"+z+"(?:\\s*<\\/"+l+">\\s*)+$");p.test(r.value)?t.replace(p,"$1").replace($("\\s*<\\/"+l+">\\s*<"+l+A+">\\s*","g"),"\n\n").replace($("\\s*<"+o+A+">\\s*","g"),"\n"):t.replace(/\n/g,"\n<"+a+S+"\n").replace($("(\\s*<"+o+A+S+"\\s*){2,}","g"),"</"+l+">\n<"+i+">").wrap("<"+i+">","</"+l+">",1).replace($("(<"+l+A+">)+","g"),"$1").replace($("(<\\/"+l+">)+","g"),"$1").tidy("\n")}else $("^\\s*<\\/"+l+">").test(u)?$("<"+l+A+">\\s*$").test(s)?t.unwrap($("\\s*<"+l+A+">\\s*"),$("\\s*<\\/"+l+">")).replace(f,"").tidy("\n","\n"+c):(match=s.match($("<"+l+U+">.*?$")))&&t.wrap("</"+l+">\n"+c+"<"+l+match[1]+">","").insert(f):t.format(i,0,"\n\n");return t[1](),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){var r=t.$(),n=[T.p,T.h1,T.h2,T.h3,T.h4,T.h5,T.h6],i=[];g(n,function(e,t){i[t]=q(e)});var l=(b(n).join("|"),b(i).join("|")),o="\\s*<("+l+")"+U+">\\s*",s=$("\\s*<(?:"+l+")"+A+">\\s*"),u=$("\\s*<\\/(?:"+l+")>\\s*"),c=r.value.match($("^"+o));c||(c=r.before.match($(o+"$"))||[]);var f=c[2]||"",p=+(c[1]||"h0").slice(1);return t[0]().unwrap(s,u).unwrap(s,u,1).i().tidy("\n\n").format(p>5?i[0]+f:i[p+1]+f,0,"\n\n")[1](),!1}},"blockquote,q":{i:"quote-right",click:function(e,t){var r=t.$(),n=r.value,i=T.blockquote,a=T.q,l=T.p,o=q(l),s="<"+o+A+">";if($("(^|\\n|"+s+")$").test(r.before)){if(L&&(r.value===I[""]||$("("+s+")$").test(r.before)))return t.select(),!1;t[0]().format(i,0,"\n\n","\n"),L&&(!n||t.match(/^[^<\n]*?[^>]$/)?t.wrap(O+"<"+l+">","</"+o+">"):t[$("((^|\\n)"+O+")+").test(r.value)?"outdent":"indent"](O)),t[1]()}else t.i().format(a);return!1}},"pre,code":{i:"code",click:function(e,t){function d(e){return i?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}function g(e){return i?e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"):e}var r=t.$(),n=r.value,i=x.auto_encode_html,a=T.pre,l=T.code,o=q(a),s=q(l),u="<"+o+A+">\\s*<"+s+A+">\\s*",c="\\s*<\\/"+s+">\\s*<\\/"+o+">",f=$(u+"\\s*$"),p=$("^\\s*"+c),h=$("^"+z+"$");return $("(^|\\n|"+u+")$").test(r.before)?f.test(r.before)&&p.test(r.after)?t[0]().unwrap($(f),$(p)).replace(h,g)[1]():t[0]().tidy("\n\n").wrap("<"+a+"><"+l+">","</"+s+"></"+o+">").insert(n||I[""]).replace(h,d)[1]():t[0]().format(l).loss().replace(h,function(e){return B($("^<\\/"+s+">").test(t.$().after)?d(e):g(e))})[1](),!1}},ul:{i:"list-ul",click:function(e,t){var r=T.ol,n=T.ul,i=q(r),a=q(n),l="("+b(a)+"|"+b(i)+")";return t.match($("<"+l+A+">"+z+"<\\/"+l+">"))?t[0]().replace($("<"+i+U+">","g"),"<"+a+"$1>").replace($("</"+i+">","g"),"</"+a+">")[1]():K(e,n,T.li),!1}},ol:{i:"list-ol",click:function(e,t){var r=T.ol,n=T.ul,i=q(r),a=q(n),l="("+b(a)+"|"+b(i)+")";return t.match($("<"+l+A+">"+z+"<\\/"+l+">"))?t[0]().replace($("<"+a+U+">","g"),"<"+i+"$1>").replace($("</"+a+">","g"),"</"+i+">")[1]():K(e,r,T.li),!1}},table:function(e,t){var L,R,j,K,r=E.tr,n=E.td,i=_.modals.table,a=_.placeholders.table,l=m(w(a[0],[1,1])),o=x.advance_table?O:"",s=T.table,u=T.caption,c=T.thead,f=T.tbody,p=T.tfoot,h=T.tr,d=T.th,g=T.td,b=q(s),$=q(u),y=q(c),C=q(f),S=q(p),A=q(h),U=q(d),z=q(g),I=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,x,E){R=v(k(x)||E,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,x){j=v(k(n)||x,r[0],r[1]),t.blur().ui.prompt(["table>caption",i.title[2]],i.placeholder[2],0,function(e,t,r){var i,v,k,E,_,n="";for(K=B(r),i=0;j>i;++i){for(L=o+O+"<"+h+">\n",v=0;R>v;++v)L+=o+O+O+"<"+g+">"+m(w(a[1],[i+1,v+1]))+"</"+z+">\n";L+=o+O+"</"+A+">",I.push(L)}for(I=I.join("\n"),L=O+(o?"<"+c+">\n"+O+O+"<"+h+">":"<"+A+">")+"\n",k=0;R>k;++k)L+=o+O+O+"<"+d+">"+m(w(a[0],[1,k+1]))+"</"+U+">\n";if(o){for(n+=O+"<"+p+">\n",n+=O+O+"<"+h+">\n",k=0;R>k;++k)n+=O+O+O+"<"+g+">"+m(w(a[2],[1,k+1]))+"</"+z+">\n";n+=O+O+"</"+h+">\n",n+=O+"</"+S+">\n"}L+=o+O+"</"+A+">"+(o?"\n"+O+"</"+y+">\n"+n+O+"<"+f+">":"")+"\n",I=L+I+(o?"\n"+O+"</"+C+">":"")+"\n",t.tidy("\n\n").insert("<"+s+">\n"+(K?O+"<"+u+">"+K+"</"+$+">\n":"")+I+"</"+b+">",0),E=t.$(),_=E.start+E.value.indexOf(l),t.select(_,_+l.length)[1]()})})}),!1)},hr:{i:"ellipsis-h",click:function(e,t){var r=j(t.$().before);return t.tidy("\n\n","").insert(r+"<"+T.hr+S+"\n\n",-1),!1}}}),x.keys&&d(y.keys,{"delete":"clear","control+delete":"s","control+b":"b","control+i":"i","control+u":"u","control+l":"a","control+g":"img","control+arrowdown":"sub","control+arrowup":"sup","control+shift+?":"abbr","control+enter":"p","shift+enter":function(e,t){var r=j(t.$().before);return t.tidy("\n","").insert(r+"<"+T.br+S+"\n",-1),!1},enter:function(e,t){var f,p,r=t.$(),n=r.value,i=t.get(),a=T.p,l=T.li,o=q(a),s=q(l),c=(j(r.before),I[""]);if(!n||n===c){if(match=r.after.match($("^\\s*<\\/("+o+"|"+s+")>")))f=match[1],y.tools["li"===f?R:f].click(e,t);else{if(!(L&&m(i)&&r.end===i.length&&/^\s*[^<\n]*?[^>]\s*$/.test(i)))return;i="<"+a+">"+i+"</"+o+">\n<"+a+">",p=c+"</"+o+">",t.set(i+p).select(i.length,(i+c).length)}return!1}},tab:function(e,t){var r=t.$(),n=T.li,i=q(n),a=j(r.before);return $("<\\/"+n+">").test(r.after)?(t[0]().wrap("\n"+a+O+"<"+(T[R]||R)+">\n"+a+O+O+"<"+n+">","</"+i+">\n"+a+O+"</"+R+">\n"+a).insert(I[""])[1](),!1):t.ui.tools.indent.click(e,t)},backspace:function(e,t){var i,r=t.$(),n=r.value,a=r.before,l=r.after,o="<[^<>]+?>";return!n&&$(o+"$").test(a)?(i=a.split("<").pop().match(/^([^\/\s]+).*?>$/),i=i&&i[1]||0,i&&$("^\\s*<\\/"+i+">").test(l)?t.unwrap($("<"+i+A+">"),$("\\s*<\\/"+i+">")):t.outdent($(o)),!1):void 0},"control+h":"p,h1,h2,h3,h4,h5,h6","control+q":"blockquote,q","control+k":"pre,code","control+-":"ul","control++":"ol","control+=":"ol","control+shift++":"ol","control+t":"table","control+r":"hr"}),p.update({},0)};
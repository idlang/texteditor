/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.3
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function q(e){return d(e.replace(/\s+/g," "))}function _(e){return g(q(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function x(e){return g(q(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function z(e){var u,t=i.$(),r=t.value,n=t.before,l=t.after,a=p(e),o=b("(^|\\n)"+a+"(.*)$"),s=b("^"+a,"gm"),c=H[""];return i[0](),r?b(a+"$").test(n)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),s.test(r)?i.replace(s,""):i.replace(/(^|\n{2})/g,"$1"+e)):n&&l?(u=o.test(n)?n.replace(o,"$1$2"):n.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(u+l).select(u.length)):i.tidy("\n\n").insert(e,0).insert(c),i[1](),!1}var i=(window,document,new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}})),l=i.ui,a=i.is,o=a.o,s=function(e){return!a.x(e)},u=(a.s,i._),f=u.extend,p=u.x,d=u.trim,h=u.edge,b=u.pattern,m=u.format,g=u.replace,v=u.i,k="*",$="#",w=p(k),y=p($);i.update(f({languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]}}},t),0),i.type="Textile";var T=i.config,L=T.states,C=T.languages,E=T.formats,H=(T.tab,C.placeholders);return i.mark=function(e,t,r,n){o(e)||(e=[e]),s(r)||(r=" "),s(n)||(n="");var l=i[0]().$(),a=e[0]+n,c=n+(s(e[1])?e[1]:e[0]),u=l.value,f=p(a),d=p(c),h=b("^"+f+"([\\s\\S]*?)"+d+"$"),m=b(f+"$"),g=b("^"+d),v=l.before,k=l.after;return u?r=!1:i.insert(H[""]),i.toggle(t?!h.test(u):!m.test(v)&&!g.test(k),[function(e){e.unwrap(a,c,1).tidy(/<[^\/<>]+?>$/.test(v)?"":r,/^<\/[^<>]+?>/.test(k)?"":r).wrap(a,c,t)[1]()},function(e){e.unwrap(a,c,t)[1]()}])},f(l.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var f,p,h,b,m,g,v,r=t.$(),n=r.before,i=r.value,l=r.after,a=t.get(),o=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",s=a.match(/^\[\S+?\]/gm)||[],c=C.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in s)v=" "+d(s[v]).replace(/^\[|\]$/g,""),L.a[v]=1;return f=L.a,t.record().ui.prompt(["a[href]",c.title[0]],u,1,function(e,t,a){a=x(a),t[0](),f[a]?(t.trim(d(n)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+a],0,!1),b=s.indexOf("["+a+"]"),-1===b&&1!==f[a]&&(r=t.$(),n=r.before,m=r.start,g=r.end,t.set(n+r.value+d(r.after,1)+o+"["+(a||d(i)||H[""])+"]"+f[a][0]).select(m,g))):(p=a,t.blur().ui.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,r){h=_(r),/^\![^\s]+?\!$/.test(i)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+p,1)):(i||t.insert(H[""]),t.i().trim(d(n)?" ":"",d(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(h?"("+h+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,a,n=(t.$(),C.modals.img);return l.prompt(["img[src]",n.title[0]],n.placeholder[0],1,function(e,t,r){i=x(r),t.blur().ui.prompt(["img[title]",n.title[1]],n.placeholder[1],0,function(e,t,r){a=_(r),t.tidy("\n\n","").insert("!"+i+(a?"("+a+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var f,r=t.$(),i=(r.before,r.after),a=C.modals.sup,o=t.get(),s=/^fn\d+\^?\. /.test(d(o).split("\n").pop())?"\n":"\n\n",c=o.match(/^fn\d+\^?\. /gm)||[],u=0;return u=c.length+1,l.prompt(["sup[id]",a.title],r.value||a.placeholder||u,0,function(e,t,r){r=d(r)||u,f=c.indexOf("fn"+r+". "),-1!==f?(u=o.indexOf(c[f])+2,t.select(u,u+r.length)):t.trim("",!d(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+r+"]").set(d(t.get(),1)+s+"fn"+r+". ").focus(!0).insert(H[""])}),!1}},abbr:{click:function(e,t){var f,r=t.$(),n=d(r.value),i=C.modals.abbr,l=t.get(),a=q(n||H[""]),o=l.match(/\b[A-Z\d]+\(.*?\)/g)||[],s=L.abbr,c=/\(.*?\)/,u=0;for(u in o)f=o[u].match(/^(.*?)\((.*?)\)$/),L.abbr[f[1]]=d(f[2]);return s=L.abbr,n&&s[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+s[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],s[a]||i.placeholder,!s[n],function(e,t,r,i){r=_(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in s)if(_(s[u])===r){t.insert(u);break}t.unwrap("",c).unwrap("",c,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return z("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,l,r=t.$(),n=/(?:p|h\d+)\. +/;return(i=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=r.value.match(/^(?:p|h([1-6]))\. /)||[]),l=+(i[1]||0),t[0]().i(),r.value||t.insert(H[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>l?"h"+(l+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return z("bq. ")}},"pre,code":{click:function(e,t){return b("(^|\\n)$").test(t.$().before)?z("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var f,r=t.$(),n=r.value,i=r.before,l=r.after,a=b("(^|\\n)([\\t ]*)"+w+" (.*)$"),o=b("^(.*)"+w+" ","gm"),s=b("(^|\\n)([\\t ]*)"+y+" (.*)$"),c=b("^(.*)"+y+" ","gm"),u=H[""];return n?(n===u?t.select():c.test(n)?t.replace(c,"$1"+k+" "):o.test(n)?t.replace(o,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+k+" $2"),!1):i&&l?(f=s.test(i)?i.replace(s,"$1$2"+k+" $3"):a.test(i)?i.replace(a,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+k+" $3"),t.set(f+l).select(f.length),!1):(t[0]().tidy("\n\n").insert(k+" ",0).insert(u)[1](),!1)}},ol:{click:function(e,t){var f,r=t.$(),n=r.value,i=r.before,l=r.after,a=b("(^|\\n)([\\t ]*)"+w+" (.*)$"),o=b("^(.*)"+w+" ","gm"),s=b("(^|\\n)([\\t ]*)"+y+" (.*)$"),c=b("^(.*)"+y+" ","gm"),u=H[""];return n?(n===u?t.select():o.test(n)?t.replace(o,function(e,t,r){return t+$+" "}):c.test(n)?t.replace(c,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+$+" "+r}),!1):i&&l?(f=a.test(i)?i.replace(a,"$1$2"+$+" $3"):s.test(i)?i.replace(s,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+$+" $3"),t.set(f+l).select(f.length),!1):(t[0]().tidy("\n\n").insert($+" ",0).insert(u)[1](),!1)}},table:function(e,t){var c,u,f,r=L.tr,n=L.td,i=C.modals.table,l=C.placeholders.table,a=m(l[0],[1,1]),o=T.advance_table,s=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){u=h(v(p)||d,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,i){f=h(v(n)||i,r[0],r[1]);var p,d,g,k,$;for(p=0;f>p;++p){for(c="|",d=0;u>d;++d)c+="   "+m(l[1],[p+1,d+1])+" |";s.push(c)}for(s=s.join("\n"),c="|",g=0;u>g;++g)c+="_. "+m(l[0],[1,g+1])+" |";if(o){for(c+="\n|~.\n|",g=0;u>g;++g)c+="   "+m(l[2],[1,g+1])+" |";c+="\n|-."}s=c+"\n"+s,o&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),k=t.$(),$=k.start+k.value.indexOf(a),t.select($,$+a.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",0),!1}}}),f(l.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n="((?:"+w+"|"+y+")+ )",i=b("^"+n+".*$","gm").exec(r.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(b(n)),!1):(t.insert("\n"+i[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),n=r.value,i=r.before,a="(^|\\n)("+w+"){2,}",o="(^|\\n)("+y+"){2,}";return n===H[""]?(t.select(),!1):b(a+" $").test(i)?(t.replace(b(w+" $")," ",0),!1):b(a).test(n)?(t.replace(b("^"+w+" *","gm"),""),!1):b(o+" $").test(i)?(t.replace(b(y+" $")," ",0),!1):b(o).test(n)?(t.replace(b("^"+y+" *","gm"),""),!1):l.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),n=r.value,i=r.before,a="(^|\\n)("+w+")+",o="(^|\\n)("+y+")+";return n===H[""]?(t.select(),!1):b(a+" $").test(i)?(t.replace(/ $/,k+" ",0),!1):b(a).test(n)?(t.replace(/^(?!$)/gm,k),!1):b(o+" $").test(i)?(t.replace(/ $/,$+" ",0),!1):b(o).test(n)?(t.replace(/^(?!$)/gm,$),!1):l.tools.indent.click(e,t)}}),i.update({},0)};
/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function w(e){return E(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function x(e){return E(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function E(e){return h(e.replace(/\s+/g," "))}function A(e){var u,t=i.$(),n=t.value,r=t.before,o=t.after,a=p(e),s=g("(^|\\n)"+a+"(.*)$"),l=g("^"+a,"gm"),f=O[""];return i[0](),n?g(a+"$").test(r)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),l.test(n)?i.replace(l,""):i.replace(/(^|\n{2})/g,"$1"+e)):r&&o?(u=s.test(r)?r.replace(s,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(u+o).select(u.length)):i.tidy("\n\n").insert(e,-1).insert(f),i[1](),!1}var i=(window,document,new TE.HTML(e)),o=i.ui,a=i.is,s=a.o,l=function(e){return!a.x(e)},u=(a.s,i._),c=u.extend,p=u.x,h=u.trim,d=u.edge,g=u.pattern,v=u.format,b=u.i,m="*",y="#",k=p(m),$=p(y);i.update(c({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}},t),0),i.type="Textile";var _=i.config,C=_.states,T=_.languages,H=_.formats,O=(_.tab,T.placeholders);return i.mark=function(e,t,n,r){s(e)||(e=[e]),l(n)||(n=" "),l(r)||(r="");var o=i[0]().$(),a=e[0]+r,f=r+(l(e[1])?e[1]:e[0]),u=o.value,c=p(a),h=p(f),d=g("^"+c+"([\\s\\S]*?)"+h+"$"),v=g(c+"$"),b=g("^"+h),m=o.before,y=o.after;return u?n=!1:i.insert(O[""]),i.toggle(t?!d.test(u):!v.test(m)&&!b.test(y),[function(e){e.unwrap(a,f,1).tidy(/<[^\/<>]+?>$/.test(m)?"":n,/^<\/[^<>]+?>/.test(y)?"":n).wrap(a,f,t)[1]()},function(e){e.unwrap(a,f,t)[1]()}])},c(o.tools,{b:{click:function(e,t){return t.i().mark(H.b[0]),!1}},i:{click:function(e,t){return t.i().mark(H.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var c,p,d,g,v,b,m,n=t.$(),r=n.before,i=n.value,o=n.after,a=t.get(),s=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",l=a.match(/^\[\S+?\]/gm)||[],f=T.modals.a,u=f.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(m in l)m=" "+h(l[m]).replace(/^\[|\]$/g,""),C.a[m]=1;return c=C.a,t.record().ui.prompt(["a[href]",f.title[0]],u,1,function(e,t,a){a=x(a),t[0](),c[a]?(t.trim(h(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+a],0,!1),g=l.indexOf("["+a+"]"),-1===g&&1!==c[a]&&(n=t.$(),r=n.before,v=n.start,b=n.end,t.set(r+n.value+h(n.after,1)+s+"["+(a||h(i)||O[""])+"]"+c[a][0]).select(v,b))):(p=a,t.blur().ui.prompt(["a[title]",f.title[1]],f.placeholder[1],0,function(e,t,n){d=w(n),/^\![^\s]+?\!$/.test(i)?(d&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+d+")!"),t.insert(":"+p,1)):(i||t.insert(O[""]),t.i().trim(h(r)?" ":"",h(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,o,r=(t.$(),T.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=x(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){o=w(n),t.tidy("\n\n","").insert("!"+i+(o?"("+o+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,n=t.$(),i=(n.before,n.after),o=T.modals.sup,a=t.get(),s=/^fn\d+\^?\. /.test(h(a).split("\n").pop())?"\n":"\n\n",l=a.match(/^fn\d+\^?\. /gm)||[],f=0;return f=l.length+1,t.ui.prompt(["sup[id]",o.title],n.value||o.placeholder||f,0,function(e,t,n){n=h(n)||f,u=l.indexOf("fn"+n+". "),-1!==u?(f=a.indexOf(l[u])+2,t.select(f,f+n.length)):t.trim("",!h(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+n+"]").set(h(t.get(),1)+s+"fn"+n+". ").focus(!0).insert(O[""])}),!1}},abbr:{click:function(e,t){var c,n=t.$(),r=h(n.value),i=T.modals.abbr,o=t.get(),a=E(r||O[""]),s=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],l=C.abbr,f=/\(.*?\)/,u=0;for(u in s)c=s[u].match(/^(.*?)\((.*?)\)$/),C.abbr[c[1]]=h(c[2]);return l=C.abbr,r&&l[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+l[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],l[a]||i.placeholder,!l[r],function(e,t,n,i){n=w(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in l)if(w(l[u])===n){t.insert(u);break}t.unwrap("",f).unwrap("",f,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{click:function(e,t){return A("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),n.value||t.insert(O[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return A("bq. ")}},"pre,code":{click:function(e,t){return g("(^|\\n)$").test(t.$().before)?A("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,a=g("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=g("^(.*)"+k+" ","gm"),l=g("(^|\\n)([\\t ]*)"+$+" (.*)$"),f=g("^(.*)"+$+" ","gm"),u=O[""];return r?(r===u?t.select():f.test(r)?t.replace(f,"$1"+m+" "):s.test(r)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+m+" $2"),!1):i&&o?(c=l.test(i)?i.replace(l,"$1$2"+m+" $3"):a.test(i)?i.replace(a,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+m+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(m+" ",-1).insert(u)[1](),!1)}},ol:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,a=g("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=g("^(.*)"+k+" ","gm"),l=g("(^|\\n)([\\t ]*)"+$+" (.*)$"),f=g("^(.*)"+$+" ","gm"),u=O[""];return r?(r===u?t.select():s.test(r)?t.replace(s,function(e,t,n){return t+y+" "}):f.test(r)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+y+" "+n}),!1):i&&o?(c=a.test(i)?i.replace(a,"$1$2"+y+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+y+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(y+" ",-1).insert(u)[1](),!1)}},table:function(e,t){var f,u,c,n=C.tr,r=C.td,i=T.modals.table,o=T.placeholders.table,a=v(o[0],[1,1]),s=_.advance_table,l=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,h){u=d(b(p)||h,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=d(b(r)||i,n[0],n[1]);var p,h,m,y,k;for(p=0;c>p;++p){for(f="|",h=0;u>h;++h)f+="   "+v(o[1],[p+1,h+1])+" |";l.push(f)}for(l=l.join("\n"),f="|",m=0;u>m;++m)f+="_. "+v(o[0],[1,m+1])+" |";if(s){for(f+="\n|~.\n|",m=0;u>m;++m)f+="   "+v(o[2],[1,m+1])+" |";f+="\n|-."}l=f+"\n"+l,s&&(l="|^.\n"+l),t.tidy("\n\n").insert(l),y=t.$(),k=y.start+y.value.indexOf(a),t.select(k,k+a.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(H.hr[0]+"\n\n",-1),!1}}}),c(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),r="((?:"+k+"|"+$+")+ )",i=g("^"+r+".*$","gm").exec(n.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(g(r)),!1):(t.insert("\n"+i[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,i=n.before,a="(^|\\n)("+k+"){2,}",s="(^|\\n)("+$+"){2,}";return r===O[""]?(t.select(),!1):g(a+" $").test(i)?(t.replace(g(k+" $")," ",-1),!1):g(a).test(r)?(t.replace(g("^"+k+" *","gm"),""),!1):g(s+" $").test(i)?(t.replace(g($+" $")," ",-1),!1):g(s).test(r)?(t.replace(g("^"+$+" *","gm"),""),!1):o.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,i=n.before,a="(^|\\n)("+k+")+",s="(^|\\n)("+$+")+";return r===O[""]?(t.select(),!1):g(a+" $").test(i)?(t.replace(/ $/,m+" ",-1),!1):g(a).test(r)?(t.replace(/^(?!$)/gm,m),!1):g(s+" $").test(i)?(t.replace(/ $/,y+" ",-1),!1):g(s).test(r)?(t.replace(/^(?!$)/gm,y),!1):o.tools.indent.click(e,t)}}),i.update({},0)};
/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.4
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function y(e){return u(e.replace(/\s+/g," "))}function x(e){return h(y(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function w(e){return h(y(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function S(e){var u,t=n.$(),o=t.value,r=t.before,i=t.after,l=a(e),s=d("(^|\\n)"+l+"(.*)$"),c=d("^"+l,"gm"),f=z[""];return n[0](),o?d(l+"$").test(r)?n.unwrap(e,""):(n.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),c.test(o)?n.replace(c,""):n.replace(/(^|\n{2})/g,"$1"+e)):r&&i?(u=s.test(r)?r.replace(s,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),n.set(u+i).select(u.length)):n.tidy("\n\n").insert(e,0).insert(f),n[1](),!1}var n=new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),o=n.ui,r=n.is,i=r.o,l=function(e){return!r.x(e)},c=(r.s,n._),f=c.extend,a=c.x,u=c.trim,p=c.edge,d=c.pattern,b=c.format,h=c.replace,g=c.i,m="*",$="#",k=a(m),v=a($);n.update(f({languages:{tools:{sup:["Footnote",n.config.languages.tools.sub[1]]}}},t),0),n.type="Textile";var T=n.config,_=T.states,q=T.languages,E=T.formats,z=(T.tab,q.placeholders);return n.mark=function(e,t,o,r){i(e)||(e=[e]),l(o)||(o=" "),l(r)||(r="");var s=n.$(),c=e[0]+r,f=r+(l(e[1])?e[1]:e[0]),u=s.value,p=a(c),b=a(f),h=d("^"+p+"([\\s\\S]*?)"+b+"$"),g=d(p+"$"),m=d("^"+b),$=s.before,k=s.after;return u?o=!1:n.insert(z[""]).loss(),n.toggle(t?!h.test(u):!g.test($)&&!m.test(k),[function(e){e.unwrap(c,f,1).tidy(/<[^\/<>]+?>$/.test($)?"":o,/^<\/[^<>]+?>/.test(k)?"":o).loss().wrap(c,f,t)},function(e){e.unwrap(c,f,t)}])},f(o.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var d,b,h,g,m,$,k,n=t.$(),r=n.before,i=n.value,l=n.after,s=t.get(),c=/^\[\S+?\]/.test(s.split("\n").pop())?"\n":"\n\n",f=s.match(/^\[\S+?\]/gm)||[],a=q.modals.a,p=a.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(k in f)k=" "+u(f[k]).replace(/^\[|\]$/g,""),_.a[k]=1;return d=_.a,t.record().ui.prompt(["a[href]",a.title[0]],p,1,function(e,t,s){s=w(s),t[0](),d[s]?(t.trim(u(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+s],0,!1),g=f.indexOf("["+s+"]"),-1===g&&1!==d[s]&&(n=t.$(),r=n.before,m=n.start,$=n.end,t.set(r+n.value+u(n.after,1)+c+"["+(s||u(i)||z[""])+"]"+d[s][0]).select(m,$))):(b=s,o.prompt(["a[title]",a.title[1]],a.placeholder[1],0,function(e,t,n){h=x(n),/^\![^\s]+?\!$/.test(i)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+b,1)):(i||t.insert(z[""]),t.i().trim(u(r)?" ":"",u(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(h?"("+h+")":"")+'":'+b))})),t[1]()}),!1}},img:{click:function(e,t){var i,l,r=(t.$(),q.modals.img);return o.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){i=w(n),o.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){l=x(n),t.tidy("\n\n","").insert("!"+i+(l?"("+l+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(t,n){var d,r=n.$(),l=(r.before,r.after),s=q.modals.sup,c=n.get(),f=/^fn\d+\^?\. /.test(u(c).split("\n").pop())?"\n":"\n\n",a=c.match(/^fn\d+\^?\. /gm)||[],p=0;return p=a.length+1,o.prompt(["sup[id]",s.title],r.value||s.placeholder||p,0,function(t,n,o,r){o=u(o)||u(r)||p,d=a.indexOf("fn"+g(o)+". "),-1!==d?(p=c.indexOf(a[d])+2,n.select(p,p+o.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!u(l)||/^[\t ]*\n+[\t ]*/.test(l)?"\n\n":" ").insert("["+o+"]").set(u(n.get(),1)+f+"fn"+o+". ").focus(!0).insert(z[""])}),!1}},abbr:{click:function(e,t){var p,n=t.$(),o=u(n.value),r=q.modals.abbr,i=t.get(),l=y(o||z[""]),s=i.match(/\b[A-Z\d]+\(.*?\)/g)||[],c=_.abbr,f=/\(.*?\)/,a=0;for(a in s)p=s[a].match(/^(.*?)\((.*?)\)$/),_.abbr[p[1]]=u(p[2]);return c=_.abbr,o&&c[o]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+c[o]+")",1),!1):(t.record().ui.prompt(["abbr[title]",r.title],c[l]||r.placeholder,!c[o],function(e,t,n,r){n=x(n||r),t[0](),o||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(a in c)if(x(c[a])===n){t.insert(a);break}t.unwrap("",f).unwrap("",f,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{click:function(e,t){return S("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var r,i,n=t.$(),o=/(?:p|h\d+)\. +/;return(r=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(r=n.value.match(/^(?:p|h([1-6]))\. /)||[]),i=+(r[1]||0),t[0]().i(),n.value||t.insert(z[""]),t.unwrap(o,"").unwrap(o,"",1).tidy("\n\n").wrap(6>i?"h"+(i+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return S("bq. ")}},"pre,code":{click:function(e,t){return d("(^|\\n)$").test(t.$().before)?S("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var u,n=t.$(),o=n.value,r=n.before,i=n.after,l=d("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=d("^(.*)"+k+" ","gm"),c=d("(^|\\n)([\\t ]*)"+v+" (.*)$"),f=d("^(.*)"+v+" ","gm"),a=z[""];return o?(o===a?t.select():f.test(o)?t.replace(f,"$1"+m+" "):s.test(o)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+m+" $2"),!1):r&&i?(u=c.test(r)?r.replace(c,"$1$2"+m+" $3"):l.test(r)?r.replace(l,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+m+" $3"),t.set(u+i).select(u.length),!1):(t[0]().tidy("\n\n").insert(m+" ",0).insert(a)[1](),!1)}},ol:{click:function(e,t){var u,n=t.$(),o=n.value,r=n.before,i=n.after,l=d("(^|\\n)([\\t ]*)"+k+" (.*)$"),s=d("^(.*)"+k+" ","gm"),c=d("(^|\\n)([\\t ]*)"+v+" (.*)$"),f=d("^(.*)"+v+" ","gm"),a=z[""];return o?(o===a?t.select():s.test(o)?t.replace(s,function(e,t,n){return t+$+" "}):f.test(o)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+$+" "+n}),!1):r&&i?(u=l.test(r)?r.replace(l,"$1$2"+$+" $3"):c.test(r)?r.replace(c,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+$+" $3"),t.set(u+i).select(u.length),!1):(t[0]().tidy("\n\n").insert($+" ",0).insert(a)[1](),!1)}},table:function(e,t){var a,u,d,n=_.tr,r=_.td,i=q.modals.table,l=q.placeholders.table,s=b(l[0],[1,1]),c=T.advance_table,f=[];return t[0]().$().value===s?(t.select(),!1):(o.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,h,m){u=p(g(h)||m,r[0],r[1]),o.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,o,r){d=p(g(o)||r,n[0],n[1]);var i,h,$,k,v;for(i=0;d>i;++i){for(a="|",h=0;u>h;++h)a+="   "+b(l[1],[i+1,h+1])+" |";f.push(a)}for(f=f.join("\n"),a="|",$=0;u>$;++$)a+="_. "+b(l[0],[1,$+1])+" |";if(c){for(a+="\n|~.\n|",$=0;u>$;++$)a+="   "+b(l[2],[1,$+1])+" |";a+="\n|-."}f=a+"\n"+f,c&&(f="|^.\n"+f),t.tidy("\n\n").insert(f),k=t.$(),v=k.start+k.value.indexOf(s),t.select(v,v+s.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",0),!1}}}),f(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),o="((?:"+k+"|"+v+")+ )",r=d("^"+o+".*$","gm").exec(n.before.split("\n").pop());return r?r[0]===r[1]?(t.outdent(d(o)),!1):(t.insert("\n"+r[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,i=n.before,l="(^|\\n)("+k+"){2,}",s="(^|\\n)("+v+"){2,}";return r===z[""]?(t.select(),!1):d(l+" $").test(i)?(t.replace(d(k+" $")," ",0),!1):d(l).test(r)?(t.replace(d("^"+k+" *","gm"),""),!1):d(s+" $").test(i)?(t.replace(d(v+" $")," ",0),!1):d(s).test(r)?(t.replace(d("^"+v+" *","gm"),""),!1):o.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,i=n.before,l="(^|\\n)("+k+")+",s="(^|\\n)("+v+")+";return r===z[""]?(t.select(),!1):d(l+" $").test(i)?(t.replace(/ $/,m+" ",0),!1):d(l).test(r)?(t.replace(/^(?!$)/gm,m),!1):d(s+" $").test(i)?(t.replace(/ $/,$+" ",0),!1):d(s).test(r)?(t.replace(/^(?!$)/gm,$),!1):o.tools.indent.click(e,t)}}),n.update({},0)};
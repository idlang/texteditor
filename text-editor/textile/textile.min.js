/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.4
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(A,e){function c(A){return a(A.replace(/\s+/g," "))}function f(A){return F(c(A),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function D(A){return F(c(A),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function p(A){var T,e=E.$(),O=e.value,t=e.before,R=e.after,I=r(A),L=l("(^|\\n)"+I+"(.*)$"),N=l("^"+I,"gm"),n=P[""];return E[0](),O?l(I+"$").test(t)?E.unwrap(A,""):(E.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),N.test(O)?E.replace(N,""):E.replace(/(^|\n{2})/g,"$1"+A)):t&&R?(T=L.test(t)?t.replace(L,"$1$2"):t.replace(/(^|\n)([^\n]*)$/,"$1"+A+"$2"),E.set(T+R).select(T.length)):E.tidy("\n\n").insert(A,0).insert(n),E[1](),!1}var E=new TE.HTML(A,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),O=E.ui,t=E.is,R=t.o,I=function(A){return!t.x(A)},N=(t.s,E._),n=N.edge,r=N.x,T=N.extend,S=N.format,i=N.i,l=N.pattern,F=N.replace,a=N.trim,o="*",C="#",s=r(o),G=r(C);E.update(T({languages:{tools:{sup:["Footnote",E.config.languages.tools.sub[1]]}}},e),0),E.type="Textile";var H=E.config,u=H.formats,M=H.languages,U=H.states,P=(H.tab,M.placeholders);return E.mark=function(A,e,O,t){R(A)||(A=[A]),I(O)||(O=" "),I(t)||(t="");var L=E.$(),N=A[0]+t,n=t+(I(A[1])?A[1]:A[0]),T=L.value,S=r(N),i=r(n),F=l("^"+S+"([\\s\\S]*?)"+i+"$"),a=l(S+"$"),o=l("^"+i),C=L.before,s=L.after;return T?O=!1:E.insert(P[""]).loss(),E.toggle(e?!F.test(T):!a.test(C)&&!o.test(s),[function(A){A.unwrap(N,n,1).tidy(/<[^\/<>]+?>$/.test(C)?"":O,/^<\/[^<>]+?>/.test(s)?"":O).loss().wrap(N,n,e)},function(A){A.unwrap(N,n,e)}])},T(O.tools,{b:{click:function(A,e){return e.i().mark(u.b[0]),!1}},i:{click:function(A,e){return e.i().mark(u.i[0]),!1}},u:0,s:{click:function(A,e){return e.i().mark("-"),!1}},a:{click:function(A,e){var S,i,l,F,o,C,s,E=e.$(),t=E.before,R=E.value,I=E.after,L=e.get(),N=/^\[\S+?\]/.test(L.split("\n").pop())?"\n":"\n\n",n=L.match(/^\[\S+?\]/gm)||[],r=M.modals.a,T=r.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(R))return e.tidy(" ").mark(['"$":',""],1),!1;for(s in n)s=" "+a(n[s]).replace(/^\[|\]$/g,""),U.a[s]=1;return S=U.a,O.prompt(["a[href]",r.title[0]],T,1,function(A,e,L){L=D(L),e[0](),S[L]?(e.trim(a(t)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(I)?!1:" ").mark(['"','":'+L],0,!1),F=n.indexOf("["+L+"]"),-1===F&&1!==S[L]&&(E=e.$(),t=E.before,o=E.start,C=E.end,e.set(t+E.value+a(E.after,1)+N+"["+(L||a(R)||P[""])+"]"+S[L][0]).select(o,C))):(i=L,O.prompt(["a[title]",r.title[1]],r.placeholder[1],0,function(A,e,E){l=f(E),/^\![^\s]+?\!$/.test(R)?(l&&e.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+l+")!"),e.insert(":"+i,1)):(R||e.insert(P[""]),e.i().trim(a(t)?" ":"",a(I)?/^\n+(fn\d+\^?\. |\[)/.test(I)?"\n\n ":" ":"").wrap('"',(l?"("+l+")":"")+'":'+i))})),e[1]()}).record(),!1}},img:{click:function(A,e){var R,I,t=(e.$(),M.modals.img);return O.prompt(["img[src]",t.title[0]],t.placeholder[0],1,function(A,e,E){R=D(E),O.prompt(["img[title]",t.title[1]],t.placeholder[1],0,function(A,e,E){I=f(E),e.tidy("\n\n","").insert("!"+R+(I?"("+I+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,E){var S,t=E.$(),I=(t.before,t.after),L=M.modals.sup,N=E.get(),n=/^fn\d+\^?\. /.test(a(N).split("\n").pop())?"\n":"\n\n",r=N.match(/^fn\d+\^?\. /gm)||[],T=0;return T=r.length+1,O.prompt(["sup[id]",L.title],t.value||L.placeholder||T,0,function(e,E,O,t){O=a(O)||a(t)||T,S=r.indexOf("fn"+i(O)+". "),-1!==S?(T=N.indexOf(r[S])+2,E.select(T,T+O.length),A.scrollTop=E.$(1).caret[0].y):E.trim("",!a(I)||/^[\t ]*\n+[\t ]*/.test(I)?"\n\n":" ").insert("["+O+"]").set(a(E.get(),1)+n+"fn"+O+". ").focus(!0).insert(P[""])}),!1}},abbr:{click:function(A,e){var S,E=e.$(),t=a(E.value),R=M.modals.abbr,I=e.get(),L=c(t||P[""]),N=I.match(/\b[A-Z\d]+\(.*?\)/g)||[],n=U.abbr,r=/\(.*?\)/,T=0;for(T in N)S=N[T].match(/^(.*?)\((.*?)\)$/),U.abbr[S[1]]=a(S[2]);return n=U.abbr,t&&n[t]&&"("!==E.after[0]?(e.i().tidy(" ").insert("("+n[t]+")",1),!1):(O.prompt(["abbr[title]",R.title],n[L]||R.placeholder,!n[t],function(A,e,E,O){E=f(E||O),e[0](),t||e.insert(E.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(T in n)if(f(n[T])===E){e.insert(T);break}e.unwrap("",r).unwrap("",r,1).i().tidy(" ").insert("("+E+")",1)[1]()}).record(),!1)}},p:{click:function(A,e){return p("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(A,e){var t,R,E=e.$(),O=/(?:p|h\d+)\. +/;return(t=E.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(t=E.value.match(/^(?:p|h([1-6]))\. /)||[]),R=+(t[1]||0),e[0]().i(),E.value||e.insert(P[""]),e.unwrap(O,"").unwrap(O,"",1).tidy("\n\n").wrap(6>R?"h"+(R+1)+". ":"p. ","",0,"\n\n"),e[1](),!1}},"blockquote,q":{click:function(A,e){return p("bq. ")}},"pre,code":{click:function(A,e){return l("(^|\\n)$").test(e.$().before)?p("bc..\n"):(e.mark("@"),!1)}},ul:{click:function(A,e){var T,E=e.$(),O=E.value,t=E.before,R=E.after,I=l("(^|\\n)([\\t ]*)"+s+" (.*)$"),L=l("^(.*)"+s+" ","gm"),N=l("(^|\\n)([\\t ]*)"+G+" (.*)$"),n=l("^(.*)"+G+" ","gm"),r=P[""];return O?(O===r?e.select():n.test(O)?e.replace(n,"$1"+o+" "):L.test(O)?e.replace(L,"$1"):e.replace(/^(\s*)(\S.*)$/gm,"$1"+o+" $2"),!1):t&&R?(T=N.test(t)?t.replace(N,"$1$2"+o+" $3"):I.test(t)?t.replace(I,"$1$2$3"):t.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+o+" $3"),e.set(T+R).select(T.length),!1):(e[0]().tidy("\n\n").insert(o+" ",0).insert(r)[1](),!1)}},ol:{click:function(A,e){var T,E=e.$(),O=E.value,t=E.before,R=E.after,I=l("(^|\\n)([\\t ]*)"+s+" (.*)$"),L=l("^(.*)"+s+" ","gm"),N=l("(^|\\n)([\\t ]*)"+G+" (.*)$"),n=l("^(.*)"+G+" ","gm"),r=P[""];return O?(O===r?e.select():L.test(O)?e.replace(L,function(A,e,E){return e+C+" "}):n.test(O)?e.replace(n,"$1"):e.replace(/^(\s*)(\S.*)$/gm,function(A,e,E){return e+C+" "+E}),!1):t&&R?(T=I.test(t)?t.replace(I,"$1$2"+C+" $3"):N.test(t)?t.replace(N,"$1$2$3"):t.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+C+" $3"),e.set(T+R).select(T.length),!1):(e[0]().tidy("\n\n").insert(C+" ",0).insert(r)[1](),!1)}},table:function(A,e){var T,l,F,E=U.tr,t=U.td,R=M.modals.table,I=M.placeholders.table,L=S(I[0],[1,1]),N=H.advance_table,r=[];return e[0]().$().value===L?(e.select(),!1):(O.prompt(["table>td",R.title[0]],R.placeholder[0],0,function(A,e,a,o){l=n(i(a)||o,t[0],t[1]),O.prompt(["table>tr",R.title[1]],R.placeholder[1],0,function(A,e,O,t){F=n(i(O)||t,E[0],E[1]);var R,a,C,s,G;for(R=0;F>R;++R){for(T="|",a=0;l>a;++a)T+="   "+S(I[1],[R+1,a+1])+" |";r.push(T)}for(r=r.join("\n"),T="|",C=0;l>C;++C)T+="_. "+S(I[0],[1,C+1])+" |";if(N){for(T+="\n|~.\n|",C=0;l>C;++C)T+="   "+S(I[2],[1,C+1])+" |";T+="\n|-."}r=T+"\n"+r,N&&(r="|^.\n"+r),e.tidy("\n\n").insert(r),s=e.$(),G=s.start+s.value.indexOf(L),e.select(G,G+L.length)[1]()})}),!1)},hr:{click:function(A,e){return e.tidy("\n\n","").insert(u.hr[0]+"\n\n",0),!1}}}),T(O.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(A,e){var E=e.$(),O="((?:"+s+"|"+G+")+ )",t=l("^"+O+".*$","gm").exec(E.before.split("\n").pop());return t?t[0]===t[1]?(e.outdent(l(O)),!1):(e.insert("\n"+t[1],0).scroll(!0),!1):void 0},"shift+tab":function(A,e){var E=e.$(),t=E.value,R=E.before,I="(^|\\n)("+s+"){2,}",L="(^|\\n)("+G+"){2,}";return t===P[""]?(e.select(),!1):l(I+" $").test(R)?(e.replace(l(s+" $")," ",0),!1):l(I).test(t)?(e.replace(l("^"+s+" *","gm"),""),!1):l(L+" $").test(R)?(e.replace(l(G+" $")," ",0),!1):l(L).test(t)?(e.replace(l("^"+G+" *","gm"),""),!1):O.tools.outdent.click(A,e)},tab:function(A,e){var E=e.$(),t=E.value,R=E.before,I="(^|\\n)("+s+")+",L="(^|\\n)("+G+")+";return t===P[""]?(e.select(),!1):l(I+" $").test(R)?(e.replace(/ $/,o+" ",0),!1):l(I).test(t)?(e.replace(/^(?!$)/gm,o),!1):l(L+" $").test(R)?(e.replace(/ $/,C+" ",0),!1):l(L).test(t)?(e.replace(/^(?!$)/gm,C),!1):O.tools.indent.click(A,e)}}),E.update({},0)};
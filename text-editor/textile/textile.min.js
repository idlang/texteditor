/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.2
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function x(e){return d(e.replace(/\s+/g," "))}function T(e){return m(x(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function _(e){return m(x(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function z(e){var u,t=i.$(),r=t.value,n=t.before,o=t.after,l=p(e),a=b("(^|\\n)"+l+"(.*)$"),s=b("^"+l,"gm"),f=O[""];return i[0](),r?b(l+"$").test(n)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),s.test(r)?i.replace(s,""):i.replace(/(^|\n{2})/g,"$1"+e)):n&&o?(u=a.test(n)?n.replace(a,"$1$2"):n.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(u+o).select(u.length)):i.tidy("\n\n").insert(e,-1).insert(f),i[1](),!1}var i=(window,document,new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}})),o=i.ui,l=i.is,a=l.o,s=function(e){return!l.x(e)},u=(l.s,i._),c=u.extend,p=u.x,d=u.trim,h=u.edge,b=u.pattern,g=u.format,m=u.replace,v=u.i,k="*",y="#",w=p(k),$=p(y);i.update(c({languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]}}},t),0),i.type="Textile";var E=i.config,q=E.states,L=E.languages,C=E.formats,O=(E.tab,L.placeholders);return i.mark=function(e,t,r,n){a(e)||(e=[e]),s(r)||(r=" "),s(n)||(n="");var o=i[0]().$(),l=e[0]+n,f=n+(s(e[1])?e[1]:e[0]),u=o.value,c=p(l),d=p(f),h=b("^"+c+"([\\s\\S]*?)"+d+"$"),g=b(c+"$"),m=b("^"+d),v=o.before,k=o.after;return u?r=!1:i.insert(O[""]),i.toggle(t?!h.test(u):!g.test(v)&&!m.test(k),[function(e){e.unwrap(l,f,1).tidy(/<[^\/<>]+?>$/.test(v)?"":r,/^<\/[^<>]+?>/.test(k)?"":r).wrap(l,f,t)[1]()},function(e){e.unwrap(l,f,t)[1]()}])},c(o.tools,{b:{click:function(e,t){return t.i().mark(C.b[0]),!1}},i:{click:function(e,t){return t.i().mark(C.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var c,p,h,b,g,m,v,r=t.$(),n=r.before,i=r.value,o=r.after,l=t.get(),a=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",s=l.match(/^\[\S+?\]/gm)||[],f=L.modals.a,u=f.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in s)v=" "+d(s[v]).replace(/^\[|\]$/g,""),q.a[v]=1;return c=q.a,t.record().ui.prompt(["a[href]",f.title[0]],u,1,function(e,t,l){l=_(l),t[0](),c[l]?(t.trim(d(n)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+l],0,!1),b=s.indexOf("["+l+"]"),-1===b&&1!==c[l]&&(r=t.$(),n=r.before,g=r.start,m=r.end,t.set(n+r.value+d(r.after,1)+a+"["+(l||d(i)||O[""])+"]"+c[l][0]).select(g,m))):(p=l,t.blur().ui.prompt(["a[title]",f.title[1]],f.placeholder[1],0,function(e,t,r){h=T(r),/^\![^\s]+?\!$/.test(i)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+p,1)):(i||t.insert(O[""]),t.i().trim(d(n)?" ":"",d(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n ":" ":"").wrap('"',(h?"("+h+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,o,n=(t.$(),L.modals.img);return t.ui.prompt(["img[src]",n.title[0]],n.placeholder[0],1,function(e,t,r){i=_(r),t.blur().ui.prompt(["img[title]",n.title[1]],n.placeholder[1],0,function(e,t,r){o=T(r),t.tidy("\n\n","").insert("!"+i+(o?"("+o+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,r=t.$(),i=(r.before,r.after),o=L.modals.sup,l=t.get(),a=/^fn\d+\^?\. /.test(d(l).split("\n").pop())?"\n":"\n\n",s=l.match(/^fn\d+\^?\. /gm)||[],f=0;return f=s.length+1,t.ui.prompt(["sup[id]",o.title],r.value||o.placeholder||f,0,function(e,t,r){r=d(r)||f,u=s.indexOf("fn"+r+". "),-1!==u?(f=l.indexOf(s[u])+2,t.select(f,f+r.length)):t.trim("",!d(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+r+"]").set(d(t.get(),1)+a+"fn"+r+". ").focus(!0).insert(O[""])}),!1}},abbr:{click:function(e,t){var c,r=t.$(),n=d(r.value),i=L.modals.abbr,o=t.get(),l=x(n||O[""]),a=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],s=q.abbr,f=/\(.*?\)/,u=0;for(u in a)c=a[u].match(/^(.*?)\((.*?)\)$/),q.abbr[c[1]]=d(c[2]);return s=q.abbr,n&&s[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+s[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],s[l]||i.placeholder,!s[n],function(e,t,r,i){r=T(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in s)if(T(s[u])===r){t.insert(u);break}t.unwrap("",f).unwrap("",f,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return z("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,r=t.$(),n=/(?:p|h\d+)\. +/;return(i=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=r.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),r.value||t.insert(O[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return z("bq. ")}},"pre,code":{click:function(e,t){return b("(^|\\n)$").test(t.$().before)?z("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,r=t.$(),n=r.value,i=r.before,o=r.after,l=b("(^|\\n)([\\t ]*)"+w+" (.*)$"),a=b("^(.*)"+w+" ","gm"),s=b("(^|\\n)([\\t ]*)"+$+" (.*)$"),f=b("^(.*)"+$+" ","gm"),u=O[""];return n?(n===u?t.select():f.test(n)?t.replace(f,"$1"+k+" "):a.test(n)?t.replace(a,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+k+" $2"),!1):i&&o?(c=s.test(i)?i.replace(s,"$1$2"+k+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+k+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(k+" ",-1).insert(u)[1](),!1)}},ol:{click:function(e,t){var c,r=t.$(),n=r.value,i=r.before,o=r.after,l=b("(^|\\n)([\\t ]*)"+w+" (.*)$"),a=b("^(.*)"+w+" ","gm"),s=b("(^|\\n)([\\t ]*)"+$+" (.*)$"),f=b("^(.*)"+$+" ","gm"),u=O[""];return n?(n===u?t.select():a.test(n)?t.replace(a,function(e,t,r){return t+y+" "}):f.test(n)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+y+" "+r}),!1):i&&o?(c=l.test(i)?i.replace(l,"$1$2"+y+" $3"):s.test(i)?i.replace(s,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+y+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(y+" ",-1).insert(u)[1](),!1)}},table:function(e,t){var f,u,c,r=q.tr,n=q.td,i=L.modals.table,o=L.placeholders.table,l=g(o[0],[1,1]),a=E.advance_table,s=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){u=h(v(p)||d,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,i){c=h(v(n)||i,r[0],r[1]);var p,d,m,k,y;for(p=0;c>p;++p){for(f="|",d=0;u>d;++d)f+="   "+g(o[1],[p+1,d+1])+" |";s.push(f)}for(s=s.join("\n"),f="|",m=0;u>m;++m)f+="_. "+g(o[0],[1,m+1])+" |";if(a){for(f+="\n|~.\n|",m=0;u>m;++m)f+="   "+g(o[2],[1,m+1])+" |";f+="\n|-."}s=f+"\n"+s,a&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),k=t.$(),y=k.start+k.value.indexOf(l),t.select(y,y+l.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(C.hr[0]+"\n\n",-1),!1}}}),c(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n="((?:"+w+"|"+$+")+ )",i=b("^"+n+".*$","gm").exec(r.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(b(n)),!1):(t.insert("\n"+i[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),n=r.value,i=r.before,l="(^|\\n)("+w+"){2,}",a="(^|\\n)("+$+"){2,}";return n===O[""]?(t.select(),!1):b(l+" $").test(i)?(t.replace(b(w+" $")," ",-1),!1):b(l).test(n)?(t.replace(b("^"+w+" *","gm"),""),!1):b(a+" $").test(i)?(t.replace(b($+" $")," ",-1),!1):b(a).test(n)?(t.replace(b("^"+$+" *","gm"),""),!1):o.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),n=r.value,i=r.before,l="(^|\\n)("+w+")+",a="(^|\\n)("+$+")+";return n===O[""]?(t.select(),!1):b(l+" $").test(i)?(t.replace(/ $/,k+" ",-1),!1):b(l).test(n)?(t.replace(/^(?!$)/gm,k),!1):b(a+" $").test(i)?(t.replace(/ $/,y+" ",-1),!1):b(a).test(n)?(t.replace(/^(?!$)/gm,y),!1):o.tools.indent.click(e,t)}}),i.update({},0)};
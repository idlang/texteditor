/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.5
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function d(e){return I(e.replace(/\s+/g," "))}function S(e){return R(d(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function h(e){return R(d(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function H(e){var c,t=n.$(),r=t.value,i=t.before,o=t.after,l=u(e),a=O("(^|\\n)"+l+"(.*)$"),s=O("^"+l,"gm"),f=m[""];return n[0](),r?O(l+"$").test(i)?n.unwrap(e,""):(n.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),s.test(r)?n.replace(s,""):n.replace(/(^|\n{2})/g,"$1"+e)):i&&o?(c=a.test(i)?i.replace(a,"$1$2"):i.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),n.set(c+o).select(c.length)):n.tidy("\n\n").insert(e,0).insert(f),n[1](),!1}var n=new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),r=n.ui,i=n.is,o=i.o,l=function(e){return!i.x(e)},s=(i.s,n._),f=s.edge,u=s.x,c=s.extend,A=s.format,E=s.i,O=s.pattern,R=s.replace,I=s.trim,L="*",p="#",N=u(L),T=u(p);n.update(c({languages:{tools:{sup:["Footnote",n.config.languages.tools.sub[1]]}}},t),0),n.type="Textile";var F=n.config,C=F.formats,b=F.languages,G=F.states,m=(F.tab,b.placeholders);return n.mark=function(e,t,r,i){o(e)||(e=[e]),l(r)||(r=" "),l(i)||(i="");var a=n.h,s=n[0]().$(),f=e[0]+i,c=i+(l(e[1])?e[1]:e[0]),A=s.value,E=u(f),R=u(c),I=O("^"+E+"([\\s\\S]*?)"+R+"$"),L=O(E+"$"),p=O("^"+R),N=s.before,T=s.after;return A?r=!1:n.insert(m[""]),n.toggle(t?!I.test(A):!L.test(N)&&!p.test(T),[function(e){e.unwrap(f,c,1).tidy(/<[^\/<>]+?>$/.test(N)?"":r,/^<\/[^<>]+?>/.test(T)?"":r).wrap(f,c,t)},function(e){e.unwrap(f,c,t)}])[1]()[a]()},c(r.tools,{b:{click:function(e,t){return t.i().mark(C.b[0]),!1}},i:{click:function(e,t){return t.i().mark(C.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var A,E,O,R,L,p,N,n=t.$(),i=n.before,o=n.value,l=n.after,a=t.get(),s=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^\[\S+?\]/gm)||[],u=b.modals.a,c=u.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(o))return t.tidy(" ").mark(['"$":',""],1),!1;for(N in f)N=" "+I(f[N]).replace(/^\[|\]$/g,""),G.a[N]=1;return A=G.a,r.prompt(["a[href]",u.title[0]],c,1,function(e,t,a){a=h(a),t[0](),A[a]?(t.trim(I(i)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+a],0,!1),R=f.indexOf("["+a+"]"),-1===R&&1!==A[a]&&(n=t.$(),i=n.before,L=n.start,p=n.end,t.set(i+n.value+I(n.after,1)+s+"["+(a||I(o)||m[""])+"]"+A[a][0]).select(L,p))):(E=a,r.prompt(["a[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){O=S(n),/^\![^\s]+?\!$/.test(o)?(O&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+O+")!"),t.insert(":"+E,1)):(o||t.insert(m[""]),t.i().trim(I(i)?" ":"",I(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(O?"("+O+")":"")+'":'+E))})),t[1]()}).record(),!1}},img:{click:function(e,t){var o,l,i=(t.$(),b.modals.img);return r.prompt(["img[src]",i.title[0]],i.placeholder[0],1,function(e,t,n){o=h(n),r.prompt(["img[title]",i.title[1]],i.placeholder[1],0,function(e,t,n){l=S(n),t.tidy("\n\n","").insert("!"+o+(l?"("+l+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(t,n){var A,i=n.$(),l=(i.before,i.after),a=b.modals.sup,s=n.get(),f=/^fn\d+\^?\. /.test(I(s).split("\n").pop())?"\n":"\n\n",u=s.match(/^fn\d+\^?\. /gm)||[],c=0;return c=u.length+1,r.prompt(["sup[id]",a.title],i.value||a.placeholder||c,0,function(t,n,r,i){r=I(r)||I(i)||c,A=u.indexOf("fn"+E(r)+". "),-1!==A?(c=s.indexOf(u[A])+2,n.select(c,c+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!I(l)||/^[\t ]*\n+[\t ]*/.test(l)?"\n\n":" ").insert("["+r+"]").set(I(n.get(),1)+f+"fn"+r+". ").focus(!0).insert(m[""])}),!1}},abbr:{click:function(e,t){var A,n=t.$(),i=I(n.value),o=b.modals.abbr,l=t.get(),a=d(i||m[""]),s=l.match(/\b[A-Z\d]+\(.*?\)/g)||[],f=G.abbr,u=/\(.*?\)/,c=0;for(c in s)A=s[c].match(/^(.*?)\((.*?)\)$/),G.abbr[A[1]]=I(A[2]);return f=G.abbr,i&&f[i]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+f[i]+")",1),!1):(r.prompt(["abbr[title]",o.title],f[a]||o.placeholder,!f[i],function(e,t,n,r){n=S(n||r),t[0](),i||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(c in f)if(S(f[c])===n){t.insert(c);break}t.unwrap("",u).unwrap("",u,1).i().tidy(" ").insert("("+n+")",1)[1]()}).record(),!1)}},p:{click:function(e,t){return H("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),n.value||t.insert(m[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return H("bq. ")}},"pre,code":{click:function(e,t){return O("(^|\\n)$").test(t.$().before)?H("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,l=O("(^|\\n)([\\t ]*)"+N+" (.*)$"),a=O("^(.*)"+N+" ","gm"),s=O("(^|\\n)([\\t ]*)"+T+" (.*)$"),f=O("^(.*)"+T+" ","gm"),u=m[""];return r?(r===u?t.select():f.test(r)?t.replace(f,"$1"+L+" "):a.test(r)?t.replace(a,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+L+" $2"),!1):i&&o?(c=s.test(i)?i.replace(s,"$1$2"+L+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+L+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(L+" ",0).insert(u)[1](),!1)}},ol:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,l=O("(^|\\n)([\\t ]*)"+N+" (.*)$"),a=O("^(.*)"+N+" ","gm"),s=O("(^|\\n)([\\t ]*)"+T+" (.*)$"),f=O("^(.*)"+T+" ","gm"),u=m[""];return r?(r===u?t.select():a.test(r)?t.replace(a,function(e,t,n){return t+p+" "}):f.test(r)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+p+" "+n}),!1):i&&o?(c=l.test(i)?i.replace(l,"$1$2"+p+" $3"):s.test(i)?i.replace(s,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+p+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(p+" ",0).insert(u)[1](),!1)}},table:function(e,t){var c,O,R,n=G.tr,i=G.td,o=b.modals.table,l=b.placeholders.table,a=A(l[0],[1,1]),s=F.advance_table,u=[];return t[0]().$().value===a?(t.select(),!1):(r.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,I,L){O=f(E(I)||L,i[0],i[1]),r.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,r,i){R=f(E(r)||i,n[0],n[1]);var o,I,p,N,T;for(o=0;R>o;++o){for(c="|",I=0;O>I;++I)c+="   "+A(l[1],[o+1,I+1])+" |";u.push(c)}for(u=u.join("\n"),c="|",p=0;O>p;++p)c+="_. "+A(l[0],[1,p+1])+" |";if(s){for(c+="\n|~.\n|",p=0;O>p;++p)c+="   "+A(l[2],[1,p+1])+" |";c+="\n|-."}u=c+"\n"+u,s&&(u="|^.\n"+u),t.tidy("\n\n").insert(u),N=t.$(),T=N.start+N.value.indexOf(a),t.select(T,T+a.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(C.hr[0]+"\n\n",0),!1}}}),c(r.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),r="((?:"+N+"|"+T+")+ )",i=O("^"+r+".*$","gm").exec(n.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(O(r)),!1):(t.insert("\n"+i[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),i=n.value,o=n.before,l="(^|\\n)("+N+"){2,}",a="(^|\\n)("+T+"){2,}";return i===m[""]?(t.select(),!1):O(l+" $").test(o)?(t.replace(O(N+" $")," ",0),!1):O(l).test(i)?(t.replace(O("^"+N+" *","gm"),""),!1):O(a+" $").test(o)?(t.replace(O(T+" $")," ",0),!1):O(a).test(i)?(t.replace(O("^"+T+" *","gm"),""),!1):r.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),i=n.value,o=n.before,l="(^|\\n)("+N+")+",a="(^|\\n)("+T+")+";return i===m[""]?(t.select(),!1):O(l+" $").test(o)?(t.replace(/ $/,L+" ",0),!1):O(l).test(i)?(t.replace(/^(?!$)/gm,L),!1):O(a+" $").test(o)?(t.replace(/ $/,p+" ",0),!1):O(a).test(i)?(t.replace(/^(?!$)/gm,p),!1):r.tools.indent.click(e,t)}}),n.update({},0)};
/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.3
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function w(e){return f(e.replace(/\s+/g," "))}function y(e){return b(w(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function x(e){return b(w(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function B(e){var f,t=r.$(),n=t.value,i=t.before,o=t.after,l=c(e),a=d("(^|\\n)"+l+"(.*)$"),u=d("^"+l,"gm"),s=C[""];return r[0](),n?d(l+"$").test(i)?r.unwrap(e,""):(r.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),u.test(n)?r.replace(u,""):r.replace(/(^|\n{2})/g,"$1"+e)):i&&o?(f=a.test(i)?i.replace(a,"$1$2"):i.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),r.set(f+o).select(f.length)):r.tidy("\n\n").insert(e,0).insert(s),r[1](),!1}var r=new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),n=r.ui,i=r.is,o=i.o,l=function(e){return!i.x(e)},u=(i.s,r._),s=u.extend,c=u.x,f=u.trim,p=u.edge,d=u.pattern,h=u.format,b=u.replace,m=u.i,g="*",v="#",k=c(g),$=c(v);r.update(s({languages:{tools:{sup:["Footnote",r.config.languages.tools.sub[1]]}}},t),0),r.type="Textile";var q=r.config,_=q.states,T=q.languages,E=q.formats,C=(q.tab,T.placeholders);return r.mark=function(e,t,n,i){o(e)||(e=[e]),l(n)||(n=" "),l(i)||(i="");var a=r[0]().$(),u=e[0]+i,s=i+(l(e[1])?e[1]:e[0]),f=a.value,p=c(u),h=c(s),b=d("^"+p+"([\\s\\S]*?)"+h+"$"),m=d(p+"$"),g=d("^"+h),v=a.before,k=a.after;return f?n=!1:r.insert(C[""]),r.toggle(t?!b.test(f):!m.test(v)&&!g.test(k),[function(e){e.unwrap(u,s,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(k)?"":n).wrap(u,s,t)[1]()},function(e){e.unwrap(u,s,t)[1]()}])},s(n.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var d,h,b,m,g,v,k,r=t.$(),i=r.before,o=r.value,l=r.after,a=t.get(),u=/^\[\S+?\]/.test(a.split("\n").pop())?"\n":"\n\n",s=a.match(/^\[\S+?\]/gm)||[],c=T.modals.a,p=c.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(o))return t.tidy(" ").mark(['"$":',""],1),!1;for(k in s)k=" "+f(s[k]).replace(/^\[|\]$/g,""),_.a[k]=1;return d=_.a,t.record().ui.prompt(["a[href]",c.title[0]],p,1,function(e,t,a){a=x(a),t[0](),d[a]?(t.trim(f(i)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(l)?!1:" ").mark(['"','":'+a],0,!1),m=s.indexOf("["+a+"]"),-1===m&&1!==d[a]&&(r=t.$(),i=r.before,g=r.start,v=r.end,t.set(i+r.value+f(r.after,1)+u+"["+(a||f(o)||C[""])+"]"+d[a][0]).select(g,v))):(h=a,n.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,r){b=y(r),/^\![^\s]+?\!$/.test(o)?(b&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+b+")!"),t.insert(":"+h,1)):(o||t.insert(C[""]),t.i().trim(f(i)?" ":"",f(l)?/^\n+(fn\d+\^?\. |\[)/.test(l)?"\n\n ":" ":"").wrap('"',(b?"("+b+")":"")+'":'+h))})),t[1]()}),!1}},img:{click:function(e,t){var o,l,i=(t.$(),T.modals.img);return n.prompt(["img[src]",i.title[0]],i.placeholder[0],1,function(e,t,r){o=x(r),n.prompt(["img[title]",i.title[1]],i.placeholder[1],0,function(e,t,r){l=y(r),t.tidy("\n\n","").insert("!"+o+(l?"("+l+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var p,r=t.$(),o=(r.before,r.after),l=T.modals.sup,a=t.get(),u=/^fn\d+\^?\. /.test(f(a).split("\n").pop())?"\n":"\n\n",s=a.match(/^fn\d+\^?\. /gm)||[],c=0;return c=s.length+1,n.prompt(["sup[id]",l.title],r.value||l.placeholder||c,0,function(e,t,r){r=f(r)||c,p=s.indexOf("fn"+r+". "),-1!==p?(c=a.indexOf(s[p])+2,t.select(c,c+r.length)):t.trim("",!f(o)||/^[\t ]*\n+[\t ]*/.test(o)?"\n\n":" ").insert("["+r+"]").set(f(t.get(),1)+u+"fn"+r+". ").focus(!0).insert(C[""])}),!1}},abbr:{click:function(e,t){var p,r=t.$(),n=f(r.value),i=T.modals.abbr,o=t.get(),l=w(n||C[""]),a=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],u=_.abbr,s=/\(.*?\)/,c=0;for(c in a)p=a[c].match(/^(.*?)\((.*?)\)$/),_.abbr[p[1]]=f(p[2]);return u=_.abbr,n&&u[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+u[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],u[l]||i.placeholder,!u[n],function(e,t,r,i){r=y(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(c in u)if(y(u[c])===r){t.insert(c);break}t.unwrap("",s).unwrap("",s,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return B("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,r=t.$(),n=/(?:p|h\d+)\. +/;return(i=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=r.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),r.value||t.insert(C[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return B("bq. ")}},"pre,code":{click:function(e,t){return d("(^|\\n)$").test(t.$().before)?B("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var f,r=t.$(),n=r.value,i=r.before,o=r.after,l=d("(^|\\n)([\\t ]*)"+k+" (.*)$"),a=d("^(.*)"+k+" ","gm"),u=d("(^|\\n)([\\t ]*)"+$+" (.*)$"),s=d("^(.*)"+$+" ","gm"),c=C[""];return n?(n===c?t.select():s.test(n)?t.replace(s,"$1"+g+" "):a.test(n)?t.replace(a,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+g+" $2"),!1):i&&o?(f=u.test(i)?i.replace(u,"$1$2"+g+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+g+" $3"),t.set(f+o).select(f.length),!1):(t[0]().tidy("\n\n").insert(g+" ",0).insert(c)[1](),!1)}},ol:{click:function(e,t){var f,r=t.$(),n=r.value,i=r.before,o=r.after,l=d("(^|\\n)([\\t ]*)"+k+" (.*)$"),a=d("^(.*)"+k+" ","gm"),u=d("(^|\\n)([\\t ]*)"+$+" (.*)$"),s=d("^(.*)"+$+" ","gm"),c=C[""];return n?(n===c?t.select():a.test(n)?t.replace(a,function(e,t,r){return t+v+" "}):s.test(n)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+v+" "+r}),!1):i&&o?(f=l.test(i)?i.replace(l,"$1$2"+v+" $3"):u.test(i)?i.replace(u,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(f+o).select(f.length),!1):(t[0]().tidy("\n\n").insert(v+" ",0).insert(c)[1](),!1)}},table:function(e,t){var c,f,d,r=_.tr,i=_.td,o=T.modals.table,l=T.placeholders.table,a=h(l[0],[1,1]),u=q.advance_table,s=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,b,g){f=p(m(b)||g,i[0],i[1]),n.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,n,i){d=p(m(n)||i,r[0],r[1]);var o,b,v,k,$;for(o=0;d>o;++o){for(c="|",b=0;f>b;++b)c+="   "+h(l[1],[o+1,b+1])+" |";s.push(c)}for(s=s.join("\n"),c="|",v=0;f>v;++v)c+="_. "+h(l[0],[1,v+1])+" |";if(u){for(c+="\n|~.\n|",v=0;f>v;++v)c+="   "+h(l[2],[1,v+1])+" |";c+="\n|-."}s=c+"\n"+s,u&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),k=t.$(),$=k.start+k.value.indexOf(a),t.select($,$+a.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",0),!1}}}),s(n.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n="((?:"+k+"|"+$+")+ )",i=d("^"+n+".*$","gm").exec(r.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(d(n)),!1):(t.insert("\n"+i[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),i=r.value,o=r.before,l="(^|\\n)("+k+"){2,}",a="(^|\\n)("+$+"){2,}";return i===C[""]?(t.select(),!1):d(l+" $").test(o)?(t.replace(d(k+" $")," ",0),!1):d(l).test(i)?(t.replace(d("^"+k+" *","gm"),""),!1):d(a+" $").test(o)?(t.replace(d($+" $")," ",0),!1):d(a).test(i)?(t.replace(d("^"+$+" *","gm"),""),!1):n.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),i=r.value,o=r.before,l="(^|\\n)("+k+")+",a="(^|\\n)("+$+")+";return i===C[""]?(t.select(),!1):d(l+" $").test(o)?(t.replace(/ $/,g+" ",0),!1):d(l).test(i)?(t.replace(/^(?!$)/gm,g),!1):d(a+" $").test(o)?(t.replace(/ $/,v+" ",0),!1):d(a).test(i)?(t.replace(/^(?!$)/gm,v),!1):n.tools.indent.click(e,t)}}),r.update({},0)};
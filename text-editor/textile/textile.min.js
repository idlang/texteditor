TE.Textile=TE.textile=function(e,t){function $(e){return k(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function v(e){return k(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function k(e){return h(e.replace(/\s+/g," "))}function U(e){var u,t=a.$(),n=t.value,r=t.before,i=t.after,l=p(e),s=g("(^|\\n)"+l+"(.*)$"),o=g("^"+l,"gm"),c=A[""];return a[0](),n?g(l+"$").test(r)?a.unwrap(e,""):(a.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),o.test(n)?a.replace(o,""):a.replace(/(^|\n{2})/g,"$1"+e)):r&&i?(u=s.test(r)?r.replace(s,"$1$2"):r.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),a.set(u+i).select(u.length)):a.tidy("\n\n").insert(e,-1).insert(c),a[1](),!1}var a=(window,document,new TE.HTML(e)),i=a.ui,l=a.is,s=l.o,o=function(e){return!l.x(e)},u=(l.s,a._),f=u.extend,p=u.x,h=u.trim,d=u.edge,g=u.pattern,b=u.format,m=u.i;a.update(f({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{},img:{}},languages:{tools:{sup:["Footnote",a.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],ul:["*"],ol:["#"],hr:["---","***"]}},t),0),a.type="textile";var y=a.config,w=y.states,E=y.languages,x=y.formats,A=(y.tab,E.placeholders);return a.mark=function(e,t,n,r){s(e)||(e=[e]),o(n)||(n=" "),o(r)||(r="");var i=a[0]().$(),l=e[0]+r,c=r+(o(e[1])?e[1]:e[0]),u=i.value,f=p(l),h=p(c),d=g("^"+f+"([\\s\\S]*?)"+h+"$"),b=g(f+"$"),m=g("^"+h),$=i.before,v=i.after;return u?n=!1:a.insert(A[""]),a.toggle(t?!d.test(u):!b.test($)&&!m.test(v),[function(e){e.unwrap(l,c,1).tidy(/<[^\/<>]+?>$/.test($)?"":n,/^<\/[^<>]+?>/.test(v)?"":n).wrap(l,c,t)[1]()},function(e){e.unwrap(l,c,t)[1]()}])},f(i.tools,{b:{click:function(e,t){return t.i().mark(x.b[0]),!1}},i:{click:function(e,t){return t.i().mark(x.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var f,p,d,g,b,m,k,n=t.$(),r=n.before,a=n.value,i=n.after,l=t.get(),s=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",o=l.match(/^\[\S+?\]/gm)||[],c=E.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(a))return t.tidy(" ").mark(['"$":',""],1),!1;for(k in o)k=" "+h(o[k]).replace(/^\[|\]$/g,""),w.a[k]=1;return f=w.a,t.record().ui.prompt(["a[href]",c.title[0]],u,1,function(e,t,l){l=v(l),t[0](),f[l]?(t.trim(h(r)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(i)?!1:" ").mark(['"','":'+l],0,!1),g=o.indexOf("["+l+"]"),-1===g&&1!==f[l]&&(n=t.$(),r=n.before,b=n.start,m=n.end,t.set(r+n.value+h(n.after,1)+s+"["+(l||h(a)||A[""])+"]"+f[l][0]).select(b,m))):(p=l,t.blur().ui.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){d=$(n),/^\![^\s]+?\!$/.test(a)?(d&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+d+")!"),t.insert(":"+p,1)):(a||t.insert(A[""]),t.i().trim(h(r)?" ":"",h(i)?/^\n+(fn\d+\^?\. |\[)/.test(i)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var a,i,r=(t.$(),E.modals.img);return t.ui.prompt(["img[src]",r.title[0]],r.placeholder[0],1,function(e,t,n){a=v(n),t.blur().ui.prompt(["img[title]",r.title[1]],r.placeholder[1],0,function(e,t,n){i=$(n),t.tidy("\n\n","").insert("!"+a+(i?"("+i+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,n=t.$(),a=(n.before,n.after),i=E.modals.sup,l=t.get(),s=/^fn\d+\^?\. /.test(h(l).split("\n").pop())?"\n":"\n\n",o=l.match(/^fn\d+\^?\. /gm)||[],c=0;return c=o.length+1,t.ui.prompt(["sup[id]",i.title],n.value||i.placeholder||c,0,function(e,t,n){n=h(n)||c,u=o.indexOf("fn"+n+". "),-1!==u?(c=l.indexOf(o[u])+2,t.select(c,c+n.length)):t.trim("",!h(a)||/^[\t ]*\n+[\t ]*/.test(a)?"\n\n":" ").insert("["+n+"]").set(h(t.get(),1)+s+"fn"+n+". ").focus(!0).insert(A[""])}),!1}},abbr:{click:function(e,t){var f,n=t.$(),r=h(n.value),a=E.modals.abbr,i=t.get(),l=k(r||A[""]),s=i.match(/\b[A-Z\d]+\(.*?\)/g)||[],o=w.abbr,c=/\(.*?\)/,u=0;for(u in s)f=s[u].match(/^(.*?)\((.*?)\)$/),w.abbr[f[1]]=h(f[2]);return o=w.abbr,r&&o[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+o[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",a.title],o[l]||a.placeholder,!o[r],function(e,t,n,a){n=$(n||a),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in o)if($(o[u])===n){t.insert(u);break}t.unwrap("",c).unwrap("",c,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{click:function(e,t){return U("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var a,i,n=t.$(),r=/(?:p|h\d+)\. +/;return(a=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(a=n.value.match(/^(?:p|h([1-6]))\. /)||[]),i=+(a[1]||0),t[0]().i(),n.value||t.insert(A[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>i?"h"+(i+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return U("bq. ")}},"pre,code":{click:function(e,t){return g("(^|\\n)$").test(t.$().before)?U("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var m,n=t.$(),r=n.value,a=n.before,i=n.after,l=x.ul[0],s=x.ol[0],o=p(l),c=p(s),u=g("(^|\\n)([\\t ]*)"+o+" (.*)$"),f=g("^(.*)"+o+" ","gm"),h=g("(^|\\n)([\\t ]*)"+c+" (.*)$"),d=g("^(.*)"+c+" ","gm"),b=A[""];return r?(r===b?t.select():d.test(r)?t.replace(d,"$1"+l+" "):f.test(r)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+l+" $2"),!1):a&&i?(m=h.test(a)?a.replace(h,"$1$2"+l+" $3"):u.test(a)?a.replace(u,"$1$2$3"):a.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+l+" $3"),t.set(m+i).select(m.length),!1):(t[0]().tidy("\n\n").insert(l+" ",-1).insert(b)[1](),!1)}},ol:{click:function(e,t){var m,n=t.$(),r=n.value,a=n.before,i=n.after,l=x.ul[0],s=x.ol[0],o=p(l),c=p(s),u=g("(^|\\n)([\\t ]*)"+o+" (.*)$"),f=g("^(.*)"+o+" ","gm"),h=g("(^|\\n)([\\t ]*)"+c+" (.*)$"),d=g("^(.*)"+c+" ","gm"),b=A[""];return r?(r===b?t.select():f.test(r)?t.replace(f,function(e,t,n){return t+s+" "}):d.test(r)?t.replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+s+" "+n}),!1):a&&i?(m=u.test(a)?a.replace(u,"$1$2"+s+" $3"):h.test(a)?a.replace(h,"$1$2$3"):a.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+s+" $3"),t.set(m+i).select(m.length),!1):(t[0]().tidy("\n\n").insert(s+" ",-1).insert(b)[1](),!1)}},table:function(e,t){var c,u,f,n=w.tr,r=w.td,a=E.modals.table,i=E.placeholders.table,l=b(i[0],[1,1]),s=y.advance_table,o=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",a.title[0]],a.placeholder[0],0,function(e,t,p,h){u=d(m(p)||h,r[0],r[1]),t.blur().ui.prompt(["table>tr",a.title[1]],a.placeholder[1],0,function(e,t,r,a){f=d(m(r)||a,n[0],n[1]);var p,h,$,v,k;for(p=0;f>p;++p){for(c="|",h=0;u>h;++h)c+="   "+b(i[1],[p+1,h+1])+" |";o.push(c)}for(o=o.join("\n"),c="|",$=0;u>$;++$)c+="_. "+b(i[0],[1,$+1])+" |";if(s){for(c+="\n|~.\n|",$=0;u>$;++$)c+="   "+b(i[2],[1,$+1])+" |";c+="\n|-."}o=c+"\n"+o,s&&(o="|^.\n"+o),t.tidy("\n\n").insert(o),v=t.$(),k=v.start+v.value.indexOf(l),t.select(k,k+l.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(x.hr[0]+"\n\n",-1),!1}}}),f(i.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),r=x.ul[0],a=x.ol[0],i=p(r),l=p(a),s="((?:"+i+"|"+l+")+ )",o=g("^"+s+".*$","gm").exec(n.before.split("\n").pop());return o?o[0]===o[1]?(t.outdent(g(s)),!1):(t.insert("\n"+o[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),r=n.value,a=n.before,l=x.ul[0],s=x.ol[0],o=p(l),c=p(s),u="(^|\\n)("+o+"){2,}",f="(^|\\n)("+c+"){2,}";return r===A[""]?(t.select(),!1):g(u+" $").test(a)?(t.replace(g(o+" $")," ",-1),!1):g(u).test(r)?(t.replace(g("^"+o+" *","gm"),""),!1):g(f+" $").test(a)?(t.replace(g(c+" $")," ",-1),!1):g(f).test(r)?(t.replace(g("^"+c+" *","gm"),""),!1):i.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),r=n.value,a=n.before,l=x.ul[0],s=x.ol[0],o=p(l),c=p(s),u="(^|\\n)("+o+")+",f="(^|\\n)("+c+")+";return r===A[""]?(t.select(),!1):g(u+" $").test(a)?(t.replace(/ $/,l+" ",-1),!1):g(u).test(r)?(t.replace(/^(?!$)/gm,l),!1):g(f+" $").test(a)?(t.replace(/ $/,s+" ",-1),!1):g(f).test(r)?(t.replace(/^(?!$)/gm,s),!1):i.tools.indent.click(e,t)}}),a.update({},0)};
/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=TE.textile=function(e,t){function v(e){return k(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function $(e){return k(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function k(e){return h(e.replace(/\s+/g," "))}function C(e){var c,t=i.$(),r=t.value,n=t.before,a=t.after,l=p(e),o=g("(^|\\n)"+l+"(.*)$"),s=g("^"+l,"gm"),u=T[""];return i[0](),r?g(l+"$").test(n)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),s.test(r)?i.replace(s,""):i.replace(/(^|\n{2})/g,"$1"+e)):n&&a?(c=o.test(n)?n.replace(o,"$1$2"):n.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(c+a).select(c.length)):i.tidy("\n\n").insert(e,-1).insert(u),i[1](),!1}var i=(window,document,new TE.HTML(e)),a=i.ui,l=i.is,o=l.o,s=function(e){return!l.x(e)},c=(l.s,i._),f=c.extend,p=c.x,h=c.trim,d=c.edge,g=c.pattern,b=c.format,m=c.i;i.update(f({tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{},img:{}},languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],ul:["*"],ol:["#"],hr:["---","***"]}},t),0),i.type="textile";var w=i.config,y=w.states,x=w.languages,E=w.formats,T=(w.tab,x.placeholders);return i.mark=function(e,t,r,n){o(e)||(e=[e]),s(r)||(r=" "),s(n)||(n="");var a=i[0]().$(),l=e[0]+n,u=n+(s(e[1])?e[1]:e[0]),c=a.value,f=p(l),h=p(u),d=g("^"+f+"([\\s\\S]*?)"+h+"$"),b=g(f+"$"),m=g("^"+h),v=a.before,$=a.after;return c?r=!1:i.insert(T[""]),i.toggle(t?!d.test(c):!b.test(v)&&!m.test($),[function(e){e.unwrap(l,u,1).tidy(/<[^\/<>]+?>$/.test(v)?"":r,/^<\/[^<>]+?>/.test($)?"":r).wrap(l,u,t)[1]()},function(e){e.unwrap(l,u,t)[1]()}])},f(a.tools,{b:{click:function(e,t){return t.i().mark(E.b[0]),!1}},i:{click:function(e,t){return t.i().mark(E.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var f,p,d,g,b,m,k,r=t.$(),n=r.before,i=r.value,a=r.after,l=t.get(),o=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",s=l.match(/^\[\S+?\]/gm)||[],u=x.modals.a,c=u.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(k in s)k=" "+h(s[k]).replace(/^\[|\]$/g,""),y.a[k]=1;return f=y.a,t.record().ui.prompt(["a[href]",u.title[0]],c,1,function(e,t,l){l=$(l),t[0](),f[l]?(t.trim(h(n)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(a)?!1:" ").mark(['"','":'+l],0,!1),g=s.indexOf("["+l+"]"),-1===g&&1!==f[l]&&(r=t.$(),n=r.before,b=r.start,m=r.end,t.set(n+r.value+h(r.after,1)+o+"["+(l||h(i)||T[""])+"]"+f[l][0]).select(b,m))):(p=l,t.blur().ui.prompt(["a[title]",u.title[1]],u.placeholder[1],0,function(e,t,r){d=v(r),/^\![^\s]+?\!$/.test(i)?(d&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+d+")!"),t.insert(":"+p,1)):(i||t.insert(T[""]),t.i().trim(h(n)?" ":"",h(a)?/^\n+(fn\d+\^?\. |\[)/.test(a)?"\n\n ":" ":"").wrap('"',(d?"("+d+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,a,n=(t.$(),x.modals.img);return t.ui.prompt(["img[src]",n.title[0]],n.placeholder[0],1,function(e,t,r){i=$(r),t.blur().ui.prompt(["img[title]",n.title[1]],n.placeholder[1],0,function(e,t,r){a=v(r),t.tidy("\n\n","").insert("!"+i+(a?"("+a+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var c,r=t.$(),i=(r.before,r.after),a=x.modals.sup,l=t.get(),o=/^fn\d+\^?\. /.test(h(l).split("\n").pop())?"\n":"\n\n",s=l.match(/^fn\d+\^?\. /gm)||[],u=0;return u=s.length+1,t.ui.prompt(["sup[id]",a.title],r.value||a.placeholder||u,0,function(e,t,r){r=h(r)||u,c=s.indexOf("fn"+r+". "),-1!==c?(u=l.indexOf(s[c])+2,t.select(u,u+r.length)):t.trim("",!h(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+r+"]").set(h(t.get(),1)+o+"fn"+r+". ").focus(!0).insert(T[""])}),!1}},abbr:{click:function(e,t){var f,r=t.$(),n=h(r.value),i=x.modals.abbr,a=t.get(),l=k(n||T[""]),o=a.match(/\b[A-Z\d]+\(.*?\)/g)||[],s=y.abbr,u=/\(.*?\)/,c=0;for(c in o)f=o[c].match(/^(.*?)\((.*?)\)$/),y.abbr[f[1]]=h(f[2]);return s=y.abbr,n&&s[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+s[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],s[l]||i.placeholder,!s[n],function(e,t,r,i){r=v(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(c in s)if(v(s[c])===r){t.insert(c);break}t.unwrap("",u).unwrap("",u,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return C("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,a,r=t.$(),n=/(?:p|h\d+)\. +/;return(i=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=r.value.match(/^(?:p|h([1-6]))\. /)||[]),a=+(i[1]||0),t[0]().i(),r.value||t.insert(T[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>a?"h"+(a+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return C("bq. ")}},"pre,code":{click:function(e,t){return g("(^|\\n)$").test(t.$().before)?C("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var m,r=t.$(),n=r.value,i=r.before,a=r.after,l=E.ul[0],o=E.ol[0],s=p(l),u=p(o),c=g("(^|\\n)([\\t ]*)"+s+" (.*)$"),f=g("^(.*)"+s+" ","gm"),h=g("(^|\\n)([\\t ]*)"+u+" (.*)$"),d=g("^(.*)"+u+" ","gm"),b=T[""];return n?(n===b?t.select():d.test(n)?t.replace(d,"$1"+l+" "):f.test(n)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+l+" $2"),!1):i&&a?(m=h.test(i)?i.replace(h,"$1$2"+l+" $3"):c.test(i)?i.replace(c,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+l+" $3"),t.set(m+a).select(m.length),!1):(t[0]().tidy("\n\n").insert(l+" ",-1).insert(b)[1](),!1)}},ol:{click:function(e,t){var m,r=t.$(),n=r.value,i=r.before,a=r.after,l=E.ul[0],o=E.ol[0],s=p(l),u=p(o),c=g("(^|\\n)([\\t ]*)"+s+" (.*)$"),f=g("^(.*)"+s+" ","gm"),h=g("(^|\\n)([\\t ]*)"+u+" (.*)$"),d=g("^(.*)"+u+" ","gm"),b=T[""];return n?(n===b?t.select():f.test(n)?t.replace(f,function(e,t,r){return t+o+" "}):d.test(n)?t.replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+o+" "+r}),!1):i&&a?(m=c.test(i)?i.replace(c,"$1$2"+o+" $3"):h.test(i)?i.replace(h,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+o+" $3"),t.set(m+a).select(m.length),!1):(t[0]().tidy("\n\n").insert(o+" ",-1).insert(b)[1](),!1)}},table:function(e,t){var u,c,f,r=y.tr,n=y.td,i=x.modals.table,a=x.placeholders.table,l=b(a[0],[1,1]),o=w.advance_table,s=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,h){c=d(m(p)||h,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,i){f=d(m(n)||i,r[0],r[1]);var p,h,v,$,k;for(p=0;f>p;++p){for(u="|",h=0;c>h;++h)u+="   "+b(a[1],[p+1,h+1])+" |";s.push(u)}for(s=s.join("\n"),u="|",v=0;c>v;++v)u+="_. "+b(a[0],[1,v+1])+" |";if(o){for(u+="\n|~.\n|",v=0;c>v;++v)u+="   "+b(a[2],[1,v+1])+" |";u+="\n|-."}s=u+"\n"+s,o&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),$=t.$(),k=$.start+$.value.indexOf(l),t.select(k,k+l.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(E.hr[0]+"\n\n",-1),!1}}}),f(a.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n=E.ul[0],i=E.ol[0],a=p(n),l=p(i),o="((?:"+a+"|"+l+")+ )",s=g("^"+o+".*$","gm").exec(r.before.split("\n").pop());return s?s[0]===s[1]?(t.outdent(g(o)),!1):(t.insert("\n"+s[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),n=r.value,i=r.before,l=E.ul[0],o=E.ol[0],s=p(l),u=p(o),c="(^|\\n)("+s+"){2,}",f="(^|\\n)("+u+"){2,}";return n===T[""]?(t.select(),!1):g(c+" $").test(i)?(t.replace(g(s+" $")," ",-1),!1):g(c).test(n)?(t.replace(g("^"+s+" *","gm"),""),!1):g(f+" $").test(i)?(t.replace(g(u+" $")," ",-1),!1):g(f).test(n)?(t.replace(g("^"+u+" *","gm"),""),!1):a.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),n=r.value,i=r.before,l=E.ul[0],o=E.ol[0],s=p(l),u=p(o),c="(^|\\n)("+s+")+",f="(^|\\n)("+u+")+";return n===T[""]?(t.select(),!1):g(c+" $").test(i)?(t.replace(/ $/,l+" ",-1),!1):g(c).test(n)?(t.replace(/^(?!$)/gm,l),!1):g(f+" $").test(i)?(t.replace(/ $/,o+" ",-1),!1):g(f).test(n)?(t.replace(/^(?!$)/gm,o),!1):a.tools.indent.click(e,t)}}),i.update({},0)};
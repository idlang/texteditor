/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.4
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function w(e){return u(e.replace(/\s+/g," "))}function y(e){return b(w(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function _(e){return b(w(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function I(e){var u,t=r.$(),n=t.value,l=t.before,a=t.after,i=f(e),s=h("(^|\\n)"+i+"(.*)$"),o=h("^"+i,"gm"),c=S[""];return r[0](),n?h(i+"$").test(l)?r.unwrap(e,""):(r.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),o.test(n)?r.replace(o,""):r.replace(/(^|\n{2})/g,"$1"+e)):l&&a?(u=s.test(l)?l.replace(s,"$1$2"):l.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),r.set(u+a).select(u.length)):r.tidy("\n\n").insert(e,0).insert(c),r[1](),!1}var r=new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),n=r.ui,l=r.is,a=l.o,i=function(e){return!l.x(e)},o=(l.s,r._),c=o.extend,f=o.x,u=o.trim,p=o.edge,h=o.pattern,d=o.format,b=o.replace,$=o.i,g="*",m="#",v=f(g),k=f(m);r.update(c({languages:{tools:{sup:["Footnote",r.config.languages.tools.sub[1]]}}},t),0),r.type="Textile";var q=r.config,x=q.states,T=q.languages,L=q.formats,S=(q.tab,T.placeholders);return r.mark=function(e,t,n,l){a(e)||(e=[e]),i(n)||(n=" "),i(l)||(l="");var s=r[0]().$(),o=e[0]+l,c=l+(i(e[1])?e[1]:e[0]),u=s.value,p=f(o),d=f(c),b=h("^"+p+"([\\s\\S]*?)"+d+"$"),$=h(p+"$"),g=h("^"+d),m=s.before,v=s.after;return u?n=!1:r.insert(S[""]),r.toggle(t?!b.test(u):!$.test(m)&&!g.test(v),[function(e){e.unwrap(o,c,1).tidy(/<[^\/<>]+?>$/.test(m)?"":n,/^<\/[^<>]+?>/.test(v)?"":n).wrap(o,c,t)[1]()},function(e){e.unwrap(o,c,t)[1]()}])},c(n.tools,{b:{click:function(e,t){return t.i().mark(L.b[0]),!1}},i:{click:function(e,t){return t.i().mark(L.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var h,d,b,$,g,m,v,r=t.$(),l=r.before,a=r.value,i=r.after,s=t.get(),o=/^\[\S+?\]/.test(s.split("\n").pop())?"\n":"\n\n",c=s.match(/^\[\S+?\]/gm)||[],f=T.modals.a,p=f.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(a))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in c)v=" "+u(c[v]).replace(/^\[|\]$/g,""),x.a[v]=1;return h=x.a,t.record().ui.prompt(["a[href]",f.title[0]],p,1,function(e,t,s){s=_(s),t[0](),h[s]?(t.trim(u(l)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(i)?!1:" ").mark(['"','":'+s],0,!1),$=c.indexOf("["+s+"]"),-1===$&&1!==h[s]&&(r=t.$(),l=r.before,g=r.start,m=r.end,t.set(l+r.value+u(r.after,1)+o+"["+(s||u(a)||S[""])+"]"+h[s][0]).select(g,m))):(d=s,n.prompt(["a[title]",f.title[1]],f.placeholder[1],0,function(e,t,r){b=y(r),/^\![^\s]+?\!$/.test(a)?(b&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+b+")!"),t.insert(":"+d,1)):(a||t.insert(S[""]),t.i().trim(u(l)?" ":"",u(i)?/^\n+(fn\d+\^?\. |\[)/.test(i)?"\n\n ":" ":"").wrap('"',(b?"("+b+")":"")+'":'+d))})),t[1]()}),!1}},img:{click:function(e,t){var a,i,l=(t.$(),T.modals.img);return n.prompt(["img[src]",l.title[0]],l.placeholder[0],1,function(e,t,r){a=_(r),n.prompt(["img[title]",l.title[1]],l.placeholder[1],0,function(e,t,r){i=y(r),t.tidy("\n\n","").insert("!"+a+(i?"("+i+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(t,r){var h,l=r.$(),i=(l.before,l.after),s=T.modals.sup,o=r.get(),c=/^fn\d+\^?\. /.test(u(o).split("\n").pop())?"\n":"\n\n",f=o.match(/^fn\d+\^?\. /gm)||[],p=0;return p=f.length+1,n.prompt(["sup[id]",s.title],l.value||s.placeholder||p,0,function(t,r,n,l){n=u(n)||u(l)||p,h=f.indexOf("fn"+$(n)+". "),-1!==h?(p=o.indexOf(f[h])+2,r.select(p,p+n.length),e.scrollTop=r.$(1).caret[0].y):r.trim("",!u(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+n+"]").set(u(r.get(),1)+c+"fn"+n+". ").focus(!0).insert(S[""])}),!1}},abbr:{click:function(e,t){var p,r=t.$(),n=u(r.value),l=T.modals.abbr,a=t.get(),i=w(n||S[""]),s=a.match(/\b[A-Z\d]+\(.*?\)/g)||[],o=x.abbr,c=/\(.*?\)/,f=0;for(f in s)p=s[f].match(/^(.*?)\((.*?)\)$/),x.abbr[p[1]]=u(p[2]);return o=x.abbr,n&&o[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+o[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",l.title],o[i]||l.placeholder,!o[n],function(e,t,r,l){r=y(r||l),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(f in o)if(y(o[f])===r){t.insert(f);break}t.unwrap("",c).unwrap("",c,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return I("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var l,a,r=t.$(),n=/(?:p|h\d+)\. +/;return(l=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(l=r.value.match(/^(?:p|h([1-6]))\. /)||[]),a=+(l[1]||0),t[0]().i(),r.value||t.insert(S[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>a?"h"+(a+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return I("bq. ")}},"pre,code":{click:function(e,t){return h("(^|\\n)$").test(t.$().before)?I("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var u,r=t.$(),n=r.value,l=r.before,a=r.after,i=h("(^|\\n)([\\t ]*)"+v+" (.*)$"),s=h("^(.*)"+v+" ","gm"),o=h("(^|\\n)([\\t ]*)"+k+" (.*)$"),c=h("^(.*)"+k+" ","gm"),f=S[""];return n?(n===f?t.select():c.test(n)?t.replace(c,"$1"+g+" "):s.test(n)?t.replace(s,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+g+" $2"),!1):l&&a?(u=o.test(l)?l.replace(o,"$1$2"+g+" $3"):i.test(l)?l.replace(i,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+g+" $3"),t.set(u+a).select(u.length),!1):(t[0]().tidy("\n\n").insert(g+" ",0).insert(f)[1](),!1)}},ol:{click:function(e,t){var u,r=t.$(),n=r.value,l=r.before,a=r.after,i=h("(^|\\n)([\\t ]*)"+v+" (.*)$"),s=h("^(.*)"+v+" ","gm"),o=h("(^|\\n)([\\t ]*)"+k+" (.*)$"),c=h("^(.*)"+k+" ","gm"),f=S[""];return n?(n===f?t.select():s.test(n)?t.replace(s,function(e,t,r){return t+m+" "}):c.test(n)?t.replace(c,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+m+" "+r}),!1):l&&a?(u=i.test(l)?l.replace(i,"$1$2"+m+" $3"):o.test(l)?l.replace(o,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+m+" $3"),t.set(u+a).select(u.length),!1):(t[0]().tidy("\n\n").insert(m+" ",0).insert(f)[1](),!1)}},table:function(e,t){var f,u,h,r=x.tr,l=x.td,a=T.modals.table,i=T.placeholders.table,s=d(i[0],[1,1]),o=q.advance_table,c=[];return t[0]().$().value===s?(t.select(),!1):(n.prompt(["table>td",a.title[0]],a.placeholder[0],0,function(e,t,b,g){u=p($(b)||g,l[0],l[1]),n.prompt(["table>tr",a.title[1]],a.placeholder[1],0,function(e,t,n,l){h=p($(n)||l,r[0],r[1]);var a,b,m,v,k;for(a=0;h>a;++a){for(f="|",b=0;u>b;++b)f+="   "+d(i[1],[a+1,b+1])+" |";c.push(f)}for(c=c.join("\n"),f="|",m=0;u>m;++m)f+="_. "+d(i[0],[1,m+1])+" |";if(o){for(f+="\n|~.\n|",m=0;u>m;++m)f+="   "+d(i[2],[1,m+1])+" |";f+="\n|-."}c=f+"\n"+c,o&&(c="|^.\n"+c),t.tidy("\n\n").insert(c),v=t.$(),k=v.start+v.value.indexOf(s),t.select(k,k+s.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(L.hr[0]+"\n\n",0),!1}}}),c(n.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n="((?:"+v+"|"+k+")+ )",l=h("^"+n+".*$","gm").exec(r.before.split("\n").pop());return l?l[0]===l[1]?(t.outdent(h(n)),!1):(t.insert("\n"+l[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),l=r.value,a=r.before,i="(^|\\n)("+v+"){2,}",s="(^|\\n)("+k+"){2,}";return l===S[""]?(t.select(),!1):h(i+" $").test(a)?(t.replace(h(v+" $")," ",0),!1):h(i).test(l)?(t.replace(h("^"+v+" *","gm"),""),!1):h(s+" $").test(a)?(t.replace(h(k+" $")," ",0),!1):h(s).test(l)?(t.replace(h("^"+k+" *","gm"),""),!1):n.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),l=r.value,a=r.before,i="(^|\\n)("+v+")+",s="(^|\\n)("+k+")+";return l===S[""]?(t.select(),!1):h(i+" $").test(a)?(t.replace(/ $/,g+" ",0),!1):h(i).test(l)?(t.replace(/^(?!$)/gm,g),!1):h(s+" $").test(a)?(t.replace(/ $/,m+" ",0),!1):h(s).test(l)?(t.replace(/^(?!$)/gm,m),!1):n.tools.indent.click(e,t)}}),r.update({},0)};
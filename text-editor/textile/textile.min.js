/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function $(e){return d(e.replace(/\s+/g," "))}function x(e){return $(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function T(e){return $(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function z(e){var u,t=i.$(),r=t.value,n=t.before,o=t.after,l=p(e),a=g("(^|\\n)"+l+"(.*)$"),s=g("^"+l,"gm"),f=O[""];return i[0](),r?g(l+"$").test(n)?i.unwrap(e,""):(i.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),s.test(r)?i.replace(s,""):i.replace(/(^|\n{2})/g,"$1"+e)):n&&o?(u=a.test(n)?n.replace(a,"$1$2"):n.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),i.set(u+o).select(u.length)):i.tidy("\n\n").insert(e,-1).insert(f),i[1](),!1}var i=(window,document,new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}})),o=i.ui,l=i.is,a=l.o,s=function(e){return!l.x(e)},u=(l.s,i._),c=u.extend,p=u.x,d=u.trim,h=u.edge,g=u.pattern,b=u.format,m=u.i,v="*",y="#",k=p(v),w=p(y);i.update(c({languages:{tools:{sup:["Footnote",i.config.languages.tools.sub[1]]}}},t),0),i.type="Textile";var E=i.config,_=E.states,q=E.languages,L=E.formats,O=(E.tab,q.placeholders);return i.mark=function(e,t,r,n){a(e)||(e=[e]),s(r)||(r=" "),s(n)||(n="");var o=i[0]().$(),l=e[0]+n,f=n+(s(e[1])?e[1]:e[0]),u=o.value,c=p(l),d=p(f),h=g("^"+c+"([\\s\\S]*?)"+d+"$"),b=g(c+"$"),m=g("^"+d),v=o.before,y=o.after;return u?r=!1:i.insert(O[""]),i.toggle(t?!h.test(u):!b.test(v)&&!m.test(y),[function(e){e.unwrap(l,f,1).tidy(/<[^\/<>]+?>$/.test(v)?"":r,/^<\/[^<>]+?>/.test(y)?"":r).wrap(l,f,t)[1]()},function(e){e.unwrap(l,f,t)[1]()}])},c(o.tools,{b:{click:function(e,t){return t.i().mark(L.b[0]),!1}},i:{click:function(e,t){return t.i().mark(L.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var c,p,h,g,b,m,v,r=t.$(),n=r.before,i=r.value,o=r.after,l=t.get(),a=/^\[\S+?\]/.test(l.split("\n").pop())?"\n":"\n\n",s=l.match(/^\[\S+?\]/gm)||[],f=q.modals.a,u=f.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(i))return t.tidy(" ").mark(['"$":',""],1),!1;for(v in s)v=" "+d(s[v]).replace(/^\[|\]$/g,""),_.a[v]=1;return c=_.a,t.record().ui.prompt(["a[href]",f.title[0]],u,1,function(e,t,l){l=T(l),t[0](),c[l]?(t.trim(d(n)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(o)?!1:" ").mark(['"','":'+l],0,!1),g=s.indexOf("["+l+"]"),-1===g&&1!==c[l]&&(r=t.$(),n=r.before,b=r.start,m=r.end,t.set(n+r.value+d(r.after,1)+a+"["+(l||d(i)||O[""])+"]"+c[l][0]).select(b,m))):(p=l,t.blur().ui.prompt(["a[title]",f.title[1]],f.placeholder[1],0,function(e,t,r){h=x(r),/^\![^\s]+?\!$/.test(i)?(h&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+h+")!"),t.insert(":"+p,1)):(i||t.insert(O[""]),t.i().trim(d(n)?" ":"",d(o)?/^\n+(fn\d+\^?\. |\[)/.test(o)?"\n\n ":" ":"").wrap('"',(h?"("+h+")":"")+'":'+p))})),t[1]()}),!1}},img:{click:function(e,t){var i,o,n=(t.$(),q.modals.img);return t.ui.prompt(["img[src]",n.title[0]],n.placeholder[0],1,function(e,t,r){i=T(r),t.blur().ui.prompt(["img[title]",n.title[1]],n.placeholder[1],0,function(e,t,r){o=x(r),t.tidy("\n\n","").insert("!"+i+(o?"("+o+")":"")+"!\n\n",-1)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(e,t){var u,r=t.$(),i=(r.before,r.after),o=q.modals.sup,l=t.get(),a=/^fn\d+\^?\. /.test(d(l).split("\n").pop())?"\n":"\n\n",s=l.match(/^fn\d+\^?\. /gm)||[],f=0;return f=s.length+1,t.ui.prompt(["sup[id]",o.title],r.value||o.placeholder||f,0,function(e,t,r){r=d(r)||f,u=s.indexOf("fn"+r+". "),-1!==u?(f=l.indexOf(s[u])+2,t.select(f,f+r.length)):t.trim("",!d(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("["+r+"]").set(d(t.get(),1)+a+"fn"+r+". ").focus(!0).insert(O[""])}),!1}},abbr:{click:function(e,t){var c,r=t.$(),n=d(r.value),i=q.modals.abbr,o=t.get(),l=$(n||O[""]),a=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],s=_.abbr,f=/\(.*?\)/,u=0;for(u in a)c=a[u].match(/^(.*?)\((.*?)\)$/),_.abbr[c[1]]=d(c[2]);return s=_.abbr,n&&s[n]&&"("!==r.after[0]?(t.i().tidy(" ").insert("("+s[n]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],s[l]||i.placeholder,!s[n],function(e,t,r,i){r=x(r||i),t[0](),n||t.insert(r.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(u in s)if(x(s[u])===r){t.insert(u);break}t.unwrap("",f).unwrap("",f,1).i().tidy(" ").insert("("+r+")",1)[1]()}),!1)}},p:{click:function(e,t){return z("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,r=t.$(),n=/(?:p|h\d+)\. +/;return(i=r.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=r.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),r.value||t.insert(O[""]),t.unwrap(n,"").unwrap(n,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return z("bq. ")}},"pre,code":{click:function(e,t){return g("(^|\\n)$").test(t.$().before)?z("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,r=t.$(),n=r.value,i=r.before,o=r.after,l=g("(^|\\n)([\\t ]*)"+k+" (.*)$"),a=g("^(.*)"+k+" ","gm"),s=g("(^|\\n)([\\t ]*)"+w+" (.*)$"),f=g("^(.*)"+w+" ","gm"),u=O[""];return n?(n===u?t.select():f.test(n)?t.replace(f,"$1"+v+" "):a.test(n)?t.replace(a,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+v+" $2"),!1):i&&o?(c=s.test(i)?i.replace(s,"$1$2"+v+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+v+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(v+" ",-1).insert(u)[1](),!1)}},ol:{click:function(e,t){var c,r=t.$(),n=r.value,i=r.before,o=r.after,l=g("(^|\\n)([\\t ]*)"+k+" (.*)$"),a=g("^(.*)"+k+" ","gm"),s=g("(^|\\n)([\\t ]*)"+w+" (.*)$"),f=g("^(.*)"+w+" ","gm"),u=O[""];return n?(n===u?t.select():a.test(n)?t.replace(a,function(e,t,r){return t+y+" "}):f.test(n)?t.replace(f,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return t+y+" "+r}),!1):i&&o?(c=l.test(i)?i.replace(l,"$1$2"+y+" $3"):s.test(i)?i.replace(s,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+y+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(y+" ",-1).insert(u)[1](),!1)}},table:function(e,t){var f,u,c,r=_.tr,n=_.td,i=q.modals.table,o=q.placeholders.table,l=b(o[0],[1,1]),a=E.advance_table,s=[];return t.$().value===l?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){u=h(m(p)||d,n[0],n[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,n,i){c=h(m(n)||i,r[0],r[1]);var p,d,v,y,k;for(p=0;c>p;++p){for(f="|",d=0;u>d;++d)f+="   "+b(o[1],[p+1,d+1])+" |";s.push(f)}for(s=s.join("\n"),f="|",v=0;u>v;++v)f+="_. "+b(o[0],[1,v+1])+" |";if(a){for(f+="\n|~.\n|",v=0;u>v;++v)f+="   "+b(o[2],[1,v+1])+" |";f+="\n|-."}s=f+"\n"+s,a&&(s="|^.\n"+s),t.tidy("\n\n").insert(s),y=t.$(),k=y.start+y.value.indexOf(l),t.select(k,k+l.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(L.hr[0]+"\n\n",-1),!1}}}),c(o.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var r=t.$(),n="((?:"+k+"|"+w+")+ )",i=g("^"+n+".*$","gm").exec(r.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(g(n)),!1):(t.insert("\n"+i[1],-1).scroll(!0),!1):void 0},"shift+tab":function(e,t){var r=t.$(),n=r.value,i=r.before,l="(^|\\n)("+k+"){2,}",a="(^|\\n)("+w+"){2,}";return n===O[""]?(t.select(),!1):g(l+" $").test(i)?(t.replace(g(k+" $")," ",-1),!1):g(l).test(n)?(t.replace(g("^"+k+" *","gm"),""),!1):g(a+" $").test(i)?(t.replace(g(w+" $")," ",-1),!1):g(a).test(n)?(t.replace(g("^"+w+" *","gm"),""),!1):o.tools.outdent.click(e,t)},tab:function(e,t){var r=t.$(),n=r.value,i=r.before,l="(^|\\n)("+k+")+",a="(^|\\n)("+w+")+";return n===O[""]?(t.select(),!1):g(l+" $").test(i)?(t.replace(/ $/,v+" ",-1),!1):g(l).test(n)?(t.replace(/^(?!$)/gm,v),!1):g(a+" $").test(i)?(t.replace(/ $/,y+" ",-1),!1):g(a).test(n)?(t.replace(/^(?!$)/gm,y),!1):o.tools.indent.click(e,t)}}),i.update({},0)};
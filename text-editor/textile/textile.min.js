/*!
 * ==========================================================
 *  TEXTILE TEXT EDITOR PLUGIN 1.2.4
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Textile=function(e,t){function x(e){return c(e.replace(/\s+/g," "))}function k(e){return v(x(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function $(e){return v(x(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}function O(e){var c,t=n.$(),r=t.value,i=t.before,o=t.after,f=s(e),u=p("(^|\\n)"+f+"(.*)$"),l=p("^"+f,"gm"),a=C[""];return n[0](),r?p(f+"$").test(i)?n.unwrap(e,""):(n.replace(/^[a-z\d]+\.\.?( |$)/gm,"").replace(/[\t ]*\n{2,}[\t ]*/g,"\n\n").tidy("\n\n"),l.test(r)?n.replace(l,""):n.replace(/(^|\n{2})/g,"$1"+e)):i&&o?(c=u.test(i)?i.replace(u,"$1$2"):i.replace(/(^|\n)([^\n]*)$/,"$1"+e+"$2"),n.set(c+o).select(c.length)):n.tidy("\n\n").insert(e,0).insert(a),n[1](),!1}var n=new TE.HTML(e,{tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",languages:{modals:{a:{title:["Link URL/Reference ID"]},sup:{title:"Footnote ID"}}},formats:{b:["*","**"],i:["_","__"],hr:["---","***"]}}),r=n.ui,i=n.is,o=i.o,f=function(e){return!i.x(e)},l=(i.s,n._),a=l.extend,s=l.x,c=l.trim,d=l.edge,p=l.pattern,h=l.format,v=l.replace,b=l.i,g="*",m="#",y=s(g),w=s(m);n.update(a({languages:{tools:{sup:["Footnote",n.config.languages.tools.sub[1]]}}},t),0),n.type="Textile";var E=n.config,T=E.states,_=E.languages,z=E.formats,C=(E.tab,_.placeholders);return n.mark=function(e,t,r,i){o(e)||(e=[e]),f(r)||(r=" "),f(i)||(i="");var u=n[0]().$(),l=e[0]+i,a=i+(f(e[1])?e[1]:e[0]),c=u.value,d=s(l),h=s(a),v=p("^"+d+"([\\s\\S]*?)"+h+"$"),b=p(d+"$"),g=p("^"+h),m=u.before,y=u.after;return c?r=!1:n.insert(C[""]),n.toggle(t?!v.test(c):!b.test(m)&&!g.test(y),[function(e){e.unwrap(l,a,1).tidy(/<[^\/<>]+?>$/.test(m)?"":r,/^<\/[^<>]+?>/.test(y)?"":r).wrap(l,a,t)[1]()},function(e){e.unwrap(l,a,t)[1]()}])},a(r.tools,{b:{click:function(e,t){return t.i().mark(z.b[0]),!1}},i:{click:function(e,t){return t.i().mark(z.i[0]),!1}},u:0,s:{click:function(e,t){return t.i().mark("-"),!1}},a:{click:function(e,t){var p,h,v,b,g,m,y,n=t.$(),i=n.before,o=n.value,f=n.after,u=t.get(),l=/^\[\S+?\]/.test(u.split("\n").pop())?"\n":"\n\n",a=u.match(/^\[\S+?\]/gm)||[],s=_.modals.a,d=s.placeholder[0];if(/^([a-z]+:\/\/\S+|"\$":[a-z]+:\/\/\S+)$/.test(o))return t.tidy(" ").mark(['"$":',""],1),!1;for(y in a)y=" "+c(a[y]).replace(/^\[|\]$/g,""),T.a[y]=1;return p=T.a,t.record().ui.prompt(["a[href]",s.title[0]],d,1,function(e,t,u){u=$(u),t[0](),p[u]?(t.trim(c(i)?" ":"",/^\n+(fn\d+\^?\. |\[)/.test(f)?!1:" ").mark(['"','":'+u],0,!1),b=a.indexOf("["+u+"]"),-1===b&&1!==p[u]&&(n=t.$(),i=n.before,g=n.start,m=n.end,t.set(i+n.value+c(n.after,1)+l+"["+(u||c(o)||C[""])+"]"+p[u][0]).select(g,m))):(h=u,r.prompt(["a[title]",s.title[1]],s.placeholder[1],0,function(e,t,n){v=k(n),/^\![^\s]+?\!$/.test(o)?(v&&t.replace(/\(.*?\)\!$/,"!").replace(/\!$/,"("+v+")!"),t.insert(":"+h,1)):(o||t.insert(C[""]),t.i().trim(c(i)?" ":"",c(f)?/^\n+(fn\d+\^?\. |\[)/.test(f)?"\n\n ":" ":"").wrap('"',(v?"("+v+")":"")+'":'+h))})),t[1]()}),!1}},img:{click:function(e,t){var o,f,i=(t.$(),_.modals.img);return r.prompt(["img[src]",i.title[0]],i.placeholder[0],1,function(e,t,n){o=$(n),r.prompt(["img[title]",i.title[1]],i.placeholder[1],0,function(e,t,n){f=k(n),t.tidy("\n\n","").insert("!"+o+(f?"("+f+")":"")+"!\n\n",0)})}),!1}},sub:0,sup:{i:"thumb-tack",click:function(t,n){var p,i=n.$(),f=(i.before,i.after),u=_.modals.sup,l=n.get(),a=/^fn\d+\^?\. /.test(c(l).split("\n").pop())?"\n":"\n\n",s=l.match(/^fn\d+\^?\. /gm)||[],d=0;return d=s.length+1,r.prompt(["sup[id]",u.title],i.value||u.placeholder||d,0,function(t,n,r,i){r=c(r)||c(i)||d,p=s.indexOf("fn"+b(r)+". "),-1!==p?(d=l.indexOf(s[p])+2,n.select(d,d+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim("",!c(f)||/^[\t ]*\n+[\t ]*/.test(f)?"\n\n":" ").insert("["+r+"]").set(c(n.get(),1)+a+"fn"+r+". ").focus(!0).insert(C[""])}),!1}},abbr:{click:function(e,t){var d,n=t.$(),r=c(n.value),i=_.modals.abbr,o=t.get(),f=x(r||C[""]),u=o.match(/\b[A-Z\d]+\(.*?\)/g)||[],l=T.abbr,a=/\(.*?\)/,s=0;for(s in u)d=u[s].match(/^(.*?)\((.*?)\)$/),T.abbr[d[1]]=c(d[2]);return l=T.abbr,r&&l[r]&&"("!==n.after[0]?(t.i().tidy(" ").insert("("+l[r]+")",1),!1):(t.record().ui.prompt(["abbr[title]",i.title],l[f]||i.placeholder,!l[r],function(e,t,n,i){n=k(n||i),t[0](),r||t.insert(n.replace(/[^a-z\d]/gi," ").replace(/([a-z\d])[^ ]* */gi,"$1").toUpperCase());for(s in l)if(k(l[s])===n){t.insert(s);break}t.unwrap("",a).unwrap("",a,1).i().tidy(" ").insert("("+n+")",1)[1]()}),!1)}},p:{click:function(e,t){return O("p. ")}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){var i,o,n=t.$(),r=/(?:p|h\d+)\. +/;return(i=n.before.match(/(?:^|\n)(?:p|h([1-6]))\. $/))||(i=n.value.match(/^(?:p|h([1-6]))\. /)||[]),o=+(i[1]||0),t[0]().i(),n.value||t.insert(C[""]),t.unwrap(r,"").unwrap(r,"",1).tidy("\n\n").wrap(6>o?"h"+(o+1)+". ":"p. ","",0,"\n\n"),t[1](),!1}},"blockquote,q":{click:function(e,t){return O("bq. ")}},"pre,code":{click:function(e,t){return p("(^|\\n)$").test(t.$().before)?O("bc..\n"):(t.mark("@"),!1)}},ul:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,f=p("(^|\\n)([\\t ]*)"+y+" (.*)$"),u=p("^(.*)"+y+" ","gm"),l=p("(^|\\n)([\\t ]*)"+w+" (.*)$"),a=p("^(.*)"+w+" ","gm"),s=C[""];return r?(r===s?t.select():a.test(r)?t.replace(a,"$1"+g+" "):u.test(r)?t.replace(u,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1"+g+" $2"),!1):i&&o?(c=l.test(i)?i.replace(l,"$1$2"+g+" $3"):f.test(i)?i.replace(f,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+g+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(g+" ",0).insert(s)[1](),!1)}},ol:{click:function(e,t){var c,n=t.$(),r=n.value,i=n.before,o=n.after,f=p("(^|\\n)([\\t ]*)"+y+" (.*)$"),u=p("^(.*)"+y+" ","gm"),l=p("(^|\\n)([\\t ]*)"+w+" (.*)$"),a=p("^(.*)"+w+" ","gm"),s=C[""];return r?(r===s?t.select():u.test(r)?t.replace(u,function(e,t,n){return t+m+" "}):a.test(r)?t.replace(a,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return t+m+" "+n}),!1):i&&o?(c=f.test(i)?i.replace(f,"$1$2"+m+" $3"):l.test(i)?i.replace(l,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2"+m+" $3"),t.set(c+o).select(c.length),!1):(t[0]().tidy("\n\n").insert(m+" ",0).insert(s)[1](),!1)}},table:function(e,t){var s,c,p,n=T.tr,i=T.td,o=_.modals.table,f=_.placeholders.table,u=h(f[0],[1,1]),l=E.advance_table,a=[];return t.$().value===u?(t.select(),!1):(t[0]().ui.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,v,g){c=d(b(v)||g,i[0],i[1]),r.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,r,i){p=d(b(r)||i,n[0],n[1]);var o,v,m,y,w;for(o=0;p>o;++o){for(s="|",v=0;c>v;++v)s+="   "+h(f[1],[o+1,v+1])+" |";a.push(s)}for(a=a.join("\n"),s="|",m=0;c>m;++m)s+="_. "+h(f[0],[1,m+1])+" |";if(l){for(s+="\n|~.\n|",m=0;c>m;++m)s+="   "+h(f[2],[1,m+1])+" |";s+="\n|-."}a=s+"\n"+a,l&&(a="|^.\n"+a),t.tidy("\n\n").insert(a),y=t.$(),w=y.start+y.value.indexOf(u),t.select(w,w+u.length)[1]()})}),!1)},hr:{click:function(e,t){return t.tidy("\n\n","").insert(z.hr[0]+"\n\n",0),!1}}}),a(r.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":0,enter:function(e,t){var n=t.$(),r="((?:"+y+"|"+w+")+ )",i=p("^"+r+".*$","gm").exec(n.before.split("\n").pop());return i?i[0]===i[1]?(t.outdent(p(r)),!1):(t.insert("\n"+i[1],0).scroll(!0),!1):void 0},"shift+tab":function(e,t){var n=t.$(),i=n.value,o=n.before,f="(^|\\n)("+y+"){2,}",u="(^|\\n)("+w+"){2,}";return i===C[""]?(t.select(),!1):p(f+" $").test(o)?(t.replace(p(y+" $")," ",0),!1):p(f).test(i)?(t.replace(p("^"+y+" *","gm"),""),!1):p(u+" $").test(o)?(t.replace(p(w+" $")," ",0),!1):p(u).test(i)?(t.replace(p("^"+w+" *","gm"),""),!1):r.tools.outdent.click(e,t)},tab:function(e,t){var n=t.$(),i=n.value,o=n.before,f="(^|\\n)("+y+")+",u="(^|\\n)("+w+")+";return i===C[""]?(t.select(),!1):p(f+" $").test(o)?(t.replace(/ $/,g+" ",0),!1):p(f).test(i)?(t.replace(/^(?!$)/gm,g),!1):p(u+" $").test(o)?(t.replace(/ $/,m+" ",0),!1):p(u).test(i)?(t.replace(/^(?!$)/gm,m),!1):r.tools.indent.click(e,t)}}),n.update({},0)};
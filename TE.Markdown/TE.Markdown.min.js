/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function r(e){return void 0!==e}function n(e){return"string"==typeof e}function o(e){return"object"==typeof e}function c(e,t){return RegExp(e,t)}function l(e){return e.replace(/^\s*|\s*$/g,"")}function a(e){return e.replace(/\s+$/,"")}function s(e,t,r){return t>e?t:e>r?r:e}function u(e){return f(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function f(e){return l(e.replace(/\s+/g," "))}var p="\u2193",h="\u2318",d=new TE.HTML(e),g=d.ui,m=d._.extend,v=(d._.each,d._.x),$=d._.format,b="\t";d.update(m({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:"Footnote ("+h+"+"+p+")"},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0),d.type="Markdown";var k=d.config,y=k.states,w=k.languages,_=k.formats,x=(k.classes,k.tab),E=w.placeholders,T=0,S=k.extra,C="( +["+v(_.ul).join("")+"] )";return S||(k["advance_pre,code"]=0),d.mark=function(e,t,n,i){o(e)||(e=[e]),r(n)||(n=" "),r(i)||(i="");var l=d[0]().$(),a=e[0]+i,s=i+(r(e[1])?e[1]:e[0]),u=l.value,f=v(a),p=v(s),h=c("^"+f+"([\\s\\S]*?)"+p+"$"),g=c(f+"$"),m=c("^"+p),$=l.before,b=l.after;return u?n=!1:d.insert(E[""]),d.toggle(t?!h.test(u):!g.test($)&&!m.test(b),[function(e){e.unwrap(a,s,1).tidy(/<[^\/<>]+?>$/.test($)?"":n,/^<\/[^<>]+?>/.test(b)?"":n).wrap(a,s,t)[1]()},function(e){e.unwrap(a,s,t)[1]()}])},m(g.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(_.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(_.i[0]),!1}},u:0,s:S?{i:"strikethrough",click:function(e,t){return t.i().mark(_.s),!1}}:0,a:{i:"link",click:function(e,t){var r,n,o,i,c,s,p,h=t.$(),d=h.before,g=h.value,m=h.after,v=t.get(),$=/^ {0,3}\[[^\^]+?\]:/.test(v.split("\n").pop())?"\n":"\n\n",b=v.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],k=w.modals.a,_=k.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(g))return t.tidy(" ").mark(["<",">"],1),!1;for(p in b)p=" "+l(b[p]).replace(/^\[|\]:$/g,""),y.a[p]=1;return r=y.a,t.record().ui.prompt(["a[href]",k.title[0]],_,0,function(e,t,p){var v=""===p;p=f(p),t[0](),r[p]?(t.trim(l(d)?" ":"",/^\n+ {0,3}\*?\[/.test(m)?!1:" ").mark(["[","]["+p+"]"],0,!1),i=b.indexOf(" ["+p+"]:"),-1===i&&1!==r[p]&&(h=t.$(),d=h.before,c=h.start,s=h.end,t.set(d+h.value+a(h.after)+$+" ["+(p||l(g)||E[""])+"]: "+(v?"":r[p][0]+(r[p][1]?' "'+r[p][1]+'"':""))).select(c,s),v&&t.focus(!0).insert(_))):(n=p,t.blur().ui.prompt(["a[title]",k.title[1]],k.placeholder[1],0,function(e,t,r){o=u(r),g||t.insert(E[""]),t.i().trim(l(d)?" ":"",l(m)?/^\n+ {0,3}\*?\[/.test(m)?"\n\n ":" ":"").wrap("[","]("+n+(o?' "'+o+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var r,n,o,c,a,s,p=t.$(),h=p.value,d=p.before,g=p.after,m=t.get(),v=/^ {0,3}\[[^\^]+?\]:/.test(m.split("\n").pop())?"\n":"\n\n",$=m.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],b=w.modals.img,k=/^\n* {0,3}\[.+?\]:/.test(g)?" ":"",_=l(g);for(i in $)i=" "+l($[i]).replace(/^\[|\]:$/g,""),!y.img[i]&&(y.img[i]=1);return r=y.img,t.ui.prompt(["img[src]",b.title[0]],b.placeholder[0],1,function(e,t,i){i=f(i),n=i,h||(h=n.split(/[\/\\\\]/).pop()),h=u(h),t[0]().trim(l(d)?"\n\n":"",k).insert(""),r[i]?(t.insert("!["+h+"]["+i+"]\n\n",-1),k&&t.select(t.$().start),c=$.indexOf(" ["+i+"]:"),-1===c&&(p=t.$(),d=p.before,a=p.start,s=p.end,t.set(d+p.value+p.after+(_?v:"")+" ["+i+"]: "+r[i][0]+(r[i][1]?' "'+r[i][1]+'"':"")).select(a,s))):t.blur().ui.prompt(["img[title]",b.title[1]],b.placeholder[1],0,function(e,t,r){o=u(r),t.insert("!["+h+"]("+n+(o?' "'+o+'"':"")+")\n\n",-1),k&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:S?{i:"thumb-tack",click:function(e,t){var r,n=t.$(),o=n.before,i=n.after,c=w.modals.sup,s=t.get(),u=/^ {0,3}\[\^.+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",f=s.match(/^ {0,3}\[\^.+?\]:/gm)||[],p=0;for(p in f)f[p]=" "+l(f[p]);return p=f.length+1,t.ui.prompt(["sup[id]",c.title],n.value||c.placeholder||p,0,function(e,t,n){n=l(n)||p,r=f.indexOf(" [^"+n+"]:"),-1!==r?(p=s.indexOf(f[r])+3,t.select(p,p+n.length)):t.trim(l(o)?" ":"",!l(i)||/^\n+ {0,3}\*?\[/.test(i)?"\n\n ":" ").insert("[^"+n+"]").set(a(t.get())+u+" [^"+n+"]: ").focus(!0).insert(E[""])}),!1}}:0,abbr:S?{i:"question",click:function(e,t){var r=t.$(),n=l(r.value),o=w.modals.abbr,i=t.get(),c=l(n||E[""]),s=/^ {0,3}\*\[.+?\]:/.test(i.split("\n").pop())?"\n":"\n\n",u=i.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=y.abbr,p=0;for(p in u)u[p]=" "+l(u[p]);return p=u.indexOf(" *["+c+"]:"),n&&-1!==p?(p=i.indexOf(u[p])+3,t.select(p,p+c.length),!1):(t.record().ui.prompt(["abbr[title]",o.title],f[c]||o.placeholder,!f[n],function(e,t,o,i){if(o=l(o),t.set(a(t.get())+(r.before||n?s:"")+" *["+c+"]: ").focus(!0).insert(o||i),c===E[""]){var u=t.$().start;t.select(u-3-c.length,u-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(E[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){T>5?T=0:T++;var r=t.$(),n=k["advance_h1,h2"],o="\\s?["+v(_.h1[0]+_.h2[0])+"]+\\s*",i=v(_.h1[1]),l=r.before.replace(c("["+i+"\\s]+$"),""),a=f(r.value).replace(c("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(c(o+"$"),"")||E[""],s=r.after.replace(c("^["+i+"\\s]+"),"").replace(c("^"+o),""),u=["",_.h1[n?0:1],_.h2[n?0:1],_.h3,_.h4,_.h5,_.h6];return t[0]().set(l+a+s).select(l.length,(l+a).length).tidy("\n\n"),0===T||(3>T&&n?t.wrap("","\n"+a.replace(/./g,u[T])):t.wrap(u[T]+" ",k["close_h1,h2,h3,h4,h5,h6"]?" "+u[T]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var r=t.$(),n=r.value,o=_.blockquote;return n===E[""]?(t.select(),!1):n?(t.tidy(c(o+" $").test(r.before)?!1:"\n\n")[c("^"+o).test(n)?"outdent":"indent"](o+" "),!1):(t[0]().tidy("\n\n").insert(o+" ",-1).insert(E[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var r=t.$(),o=r.before,i=r.value,l=k["advance_pre,code"],a=_.code,s=a[1]||a[0];s=s+s+s,!n(l)&&l?l=s:n(l)&&-1!==l.indexOf("%1")&&(l=$(l,[s]));var u="( {4,}|\\t"+(n(l)?"|"+v(l):"")+")";if(c("(^|\\n)"+u+"?$").test(o)){if(l)return t.mark([l,l.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(l=x===b?b:"    ",!i){t[0]().tidy("\n\n");var f=t.$().start,p=l+E[""];return t.insert(p).select(f+l.length,f+p.length)[1](),!1}return i===E[""]&&c(u+"$").test(o)?(t.select(r.start-l.length,r.end),!1):(t.tidy("\n\n")[c("^"+u).test(i)?"outdent":"indent"](l),!1)}return t.mark(a[0]),!1}},ul:{i:"list-ul",click:function(e,t){var r,n=t.$(),o=n.value,i=n.before,l=n.after,a=_.ul[0],s=_.ol,u=v(a),f=$(v(s),["\\d+"]),p=c("(^|\\n)([\\t ]*) "+u+" (.*)$"),h=c("^(.*) "+u+" ","gm"),d=c("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=c("^(.*) "+f+" ","gm");return o?(o===E[""]?t.select():g.test(o)?t.replace(g,"$1 "+a+" "):h.test(o)?t[0]().replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&l?(r=d.test(i)?i.replace(d,"$1$2 "+a+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(r+l).select(r.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert(E[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var r,n=t.$(),o=n.value,i=n.before,l=n.after,a=_.ul[0],s=_.ol,u=$(s,[1]),f=v(a),p=$(v(s),["\\d+"]),h=c("(^|\\n)([\\t ]*) "+f+" (.*)$"),d=c("^(.*) "+f+" ","gm"),g=c("(^|\\n)([\\t ]*) "+p+" (.*)$"),m=c("^(.*) "+p+" ","gm"),b=0;return o?(o===E[""]?t.select():d.test(o)?t.replace(d,function(e,t){return++b,t+" "+$(s,[b])+" "}):m.test(o)?t[0]().replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,r){return++b,t+" "+$(s,[b])+" "+r}),!1):i&&l?(r=h.test(i)?i.replace(h,"$1$2 "+u+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+u+" $3"),t.set(r+l).select(r.length),!1):(t[0]().tidy("\n\n").insert(" "+u+" ",-1).insert(E[""])[1](),!1)}},table:S?function(e,t){var r,n,o,i=y.tr,c=y.td,l=w.modals.table,a=w.placeholders.table,u=$(a[0],[1,1]),f=[];return t.$().value===u?(t.select(),!1):(t[0]().insert("").ui.prompt(["table>td",l.title[0]],l.placeholder[0],0,function(e,t,p,h){n=s(parseInt(p,10)||h,c[0],c[1]),t.blur().ui.prompt(["table>tr",l.title[1]],l.placeholder[1],0,function(e,t,c,l){o=s(parseInt(c,10)||l,i[0],i[1]);var p,h,d,g,m,v;for(p=0;o>p;++p){for(r="|",h=0;n>h;++h)r+=" "+$(a[1],[p+1,h+1])+" |";f.push(r)}for(f=f.join("\n"),r="|",d=0;n>d;++d)r+=" "+$(a[0],[d+1,d+1]).replace(/./g,"-")+" |";for(f=r+"\n"+f,r="|",g=0;n>g;++g)r+=" "+$(a[0],[1,g+1])+" |";f=r+"\n"+f,k.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f,1),m=t.$(),v=m.start+m.after.indexOf(u),t.select(v,v+u.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(_.hr[0]+"\n\n",-1),!1}}}),m(g.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var r=k.advance_br;return!n(r)&&r&&(r="  \n"),t.trim().insert(r||"\n",-1),!1},enter:function(e,t){var r=t.$(),n=_.blockquote,o=(_.ul[0],_.ol),i=$(v(o),["\\d+"]),a="(("+v(n)+" )+|"+C+"| +("+i+") )",s=c("^"+a+".*$","gm").exec(r.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(c(a)),!1;if(c("\\s*"+i+"\\s*").test(s[1])){var u=parseInt(l(s[1]),10);return t.insert("\n"+s[1].replace(/\d+/,u+1),-1).scroll("+1"),!1}return t.insert("\n"+s[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var r,n=t.$(),o=n.before,i=n.value,l=n.after,a=_.ol,s=v(a),u=$(s,["\\d+"]),f=v(_.blockquote),p=c("  "+C+"$"),h=c("   ( ?"+u+" )$"),d="("+f+" |"+C+"| +"+u+" )";if(i){if(i&&(r=i.match(c("(^|\\n)"+d,"g"))))return t.outdent(c(d)),!1}else{if(r=o.match(c(f+" $")))return t.outdent(r[0]),!1;if(r=o.match(p))return o=o.replace(p,"$1"),t.set(o+l).select(o.length),!1;if(r=o.match(h))return o=o.replace(h,"$1"),t.set(o+l).select(o.length),!1}return g.tools.outdent.click(e,t)},tab:function(e,t){var r,n=t.$(),o=n.before,i=n.value,l=n.after,a=_.ol,s=v(a),u=c(C+"$"),f=c(" ?"+$(s,["\\d+"])+" $");if(!i){if(r=o.match(c(v(_.blockquote)+" $")))return t.insert(r[0],-1),!1;if(r=o.match(u))return o=o.replace(u,"  $1"),t.set(o+l).select(o.length),!1;if(r=o.match(f))return o=o.replace(f,"    "+$(a,[1])+" "),t.set(o+l).select(o.length),!1}return g.tools.indent.click(e,t)}}),d};
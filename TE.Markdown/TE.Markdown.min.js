/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function o(e){return"function"==typeof e}function i(e){return"object"==typeof e}function l(e,t){return RegExp(e,t)}function a(e){return e.replace(/^\s*|\s*$/g,"")}function u(e){return c(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function c(e){return a(e.replace(/\s+/g," "))}var s="\u2026",f="\u2193",p="\u2318",d=new TE.HTML(e,{auto_p:0,auto_close:{"`":"`"},states:{a:{test:["../foo.html","Test Reference Link"]},img:{test:["../foo.jpg","Test Reference Image"]}},languages:{tools:{footnote:"Footnote ("+p+"+"+f+")",abbr:"Abbreviation ("+p+"+?)"},modals:{img:{title:["Image URL","Image Title"],placeholder:["http://","image title here"+s]},footnote:{title:"Footnote ID"},abbr:{title:"Abbreviation",placeholder:"meaning here"+s}}},enable_setext_header:1,enable_closed_atx_header:0,enable_fenced_code_block:1,enable_hard_break:1,formats:{b:"**",i:"_",s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:"`",ul:"-",ol:"%1.",hr:"---"}}),h=d.ui,g=d._.extend,b=d._.each,m=d._.x,v=d._.format,$="\t";TE.Markdown.__instance__.push(d);var k=d.config,y=k.states,w=k.languages,_=k.formats,x=(k.classes,k.tab),T=(k.suffix,w.others.placeholder),q=0,E="( +["+m(_.ul+"*+-")+"] )";return d.mark=function(e,t,r,o){i(e)||(e=[e]),n(r)||(r=" "),n(o)||(o="");var a=d[0]().$(),u=e[0]+o,c=o+(n(e[1])?e[1]:e[0]),s=a.value,f=m(u),p=m(c),h=l("^"+f+"([\\s\\S]*?)"+p+"$"),g=l(f+"$"),b=l("^"+p),v=a.before,$=a.after;return s?r=!1:d.insert(T),d.toggle(t?!h.test(s):!g.test(v)&&!b.test($),[function(e){e.unwrap(u,c,1).tidy(/<[^\/<>]+?>$/.test(v)?"":r,/^<\/[^<>]+?>/.test($)?"":r).wrap(u,c,t)[1]()},function(e){e.unwrap(u,c,t)[1]()}])},g(h.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(_.b),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(_.i),!1}},u:0,s:{i:"strikethrough",click:function(e,t){return t.i().mark(_.s),!1}},a:{i:"link",click:function(e,t){var n,r,o,i,l,a=t.$(),s=a.before,f=(a.value,a.after),p=t.get(),d=/^ \[[^\^]*?\]:/.test(p.split("\n").pop())?"\n":"\n\n",h=p.match(/^ \[[^\^]*?\]:/gm)||[],g=w.modals.a,b=y.a;return t.record().ui.prompt(g.title[0],g.placeholder[0],1,function(e,t,p){p=c(p),b[p]?(t.trim(s?" ":"",!1).mark(["[","]["+p+"]"],0,!f||/^\n/.test(f)?!1:" "),o=h.indexOf(" ["+p+"]:"),-1===o&&(a=t.$(),s=a.before,i=a.start,l=a.end,t.set(s+a.value+a.after+d+" ["+p+"]: "+b[p][0]+(b[p][1]?' "'+b[p][1]+'"':"")).select(i,l))):(n=p,t.blur().ui.prompt(g.title[1],g.placeholder[1],0,function(e,t,o){r=u(o),t.i().mark(["[","]("+n+(r?' "'+r+'"':"")+")"])}))}),!1}},img:{i:"image",click:function(e,t){var n,r,o,i,l,s=t.$(),f=s.value,p=s.before,d=s.after,h=t.get(),g=/^ \[[^\^]*?\]:/.test(h.split("\n").pop())?"\n":"\n\n",b=h.match(/^ \[[^\^]*?\]:/gm)||[],m=w.modals.img,v=y.img,$=/^\s* \*?\[.*?\]:/.test(d)?" ":"";return t.record().ui.prompt(m.title[0],m.placeholder[0],1,function(e,t,d){d=c(d),n=d,f||(f=n.split(/[\/\\\\]/).pop()),f=u(f),t[0]().trim(a(p)?"\n\n":"",$).insert(""),v[d]?(t.insert("!["+f+"]["+d+"]\n\n",-1),$&&t.select(t.$().start),o=b.indexOf(" ["+d+"]:"),-1===o&&(s=t.$(),p=s.before,i=s.start,l=s.end,t.set(p+s.value+s.after+g+" ["+d+"]: "+v[d][0]+(v[d][1]?' "'+v[d][1]+'"':"")).select(i,l))):t.blur().ui.prompt(m.title[1],m.placeholder[1],0,function(e,t,o){r=u(o),t.insert("!["+f+"]("+n+(r?' "'+r+'"':"")+")\n\n",-1),$&&t.select(t.$().start)}),t[1]()}),!1}},footnote:{i:"thumb-tack",click:function(e,t){var n,r=t.$(),o=r.before,i=r.after,l=w.modals.footnote,u=t.get(),c=/^ \[\^.*?\]:/.test(u.split("\n").pop())?"\n":"\n\n",s=u.match(/^ \[\^.*?\]:/gm)||[],f=s.length+1;return t.ui.prompt(l.title,r.value||l.placeholder||f,0,function(e,t,r){r=a(r)||f,n=s.indexOf(" [^"+r+"]:"),-1!==n?(f=u.indexOf(s[n])+3,t.select(f,f+r.length)):t.trim(o?" ":"",!i||/^\n/.test(i)?!1:" ").insert("[^"+r+"]").set(t.get().replace(/\s+$/g,"")+c+" [^"+r+"]: ").focus(!0).insert(T)}),!1}},abbr:{i:"question",click:function(e,t){var n=t.$(),r=w.modals.abbr,o=t.get(),i=n.value||T,l=/^ \*\[.*?\]:/.test(o.split("\n").pop())?"\n":"\n\n",u=o.match(/^ \*\[.*?\]:/gm)||[],c=u.indexOf(" *["+i+"]:");return n.value&&-1!==c?(c=o.indexOf(u[c])+3,t.select(c,c+i.length),!1):(t.ui.prompt(r.title,r.placeholder,0,function(e,t,r){if(r=a(r),t.set(t.get().replace(/\s+$/g,"")+(n.before||n.value?l:"")+" *["+i+"]: ").focus(!0).insert(r),i===T){var o=t.$().start;t.select(o-3-i.length,o-3)}}),!1)}},sub:0,sup:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(T),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){q>5?q=0:q++;var n=t.$(),r=k.enable_setext_header,o="\\s?["+m(_.h1[0]+_.h2[0])+"]+\\s*",i=n.before.replace(/[#\s]+$/,""),a=c(n.value).replace(/^[#\s]+|[#\s]+$/g,"").replace(l(o+"$"),"")||T,u=n.after.replace(/^[#\s]+/,"").replace(l("^"+o),""),s=["",_.h1[r?0:1],_.h2[r?0:1],_.h3,_.h4,_.h5,_.h6];return t[0]().set(i+a+u).select(i.length,(i+a).length).tidy("\n\n"),0===q||(3>q&&r?t.wrap("","\n"+a.replace(/./g,s[q])):t.wrap(s[q]+" ",k.enable_closed_atx_header?" "+s[q]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,o=_.blockquote;return r===T?(t.select(),!1):r?(t.tidy(l(o+" $").test(n.before)?!1:"\n\n")[l("^"+o).test(r)?"outdent":"indent"](o+" "),!1):(t[0]().tidy("\n\n").insert(o+" ",-1).insert(T)[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),o=n.value,i=k.enable_fenced_code_block,l=_.code;return!r(i)&&i&&(i="~~~"),/(^|\n)$/.test(n.before)?i?(t.mark([i,i.split(/\s+/)[0]],0,"\n\n","\n"),!1):(o||t.insert(T),t.tidy("\n\n")[/^(\t| {4})/.test(o)?"outdent":"indent"](x===$?$:"    "),!1):(t.mark(l),!1)}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,a=r.after,u=_.ul,c=_.ol,s=m(u),f=v(m(c),["\\d+"]),p=l("(^|\\n)([\\t ]*) "+s+" (.*)$"),d=l("^(.*) "+s+" ","gm"),h=l("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=l("^(.*) "+f+" ","gm");return o?(o===T?t.select():g.test(o)?t.replace(g,"$1 "+u+" "):d.test(o)?t[0]().replace(d,"$1"):t.replace(/^(\s*)(\S+)$/gm,"$1 "+u+" $2"),!1):i&&a?(n=h.test(i)?i.replace(h,"$1$2 "+u+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+u+" $3"),t.set(n+a).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+u+" ",-1).insert(T)[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,a=r.after,u=_.ul,c=_.ol,s=v(c,[1]),f=m(u),p=v(m(c),["\\d+"]),d=l("(^|\\n)([\\t ]*) "+f+" (.*)$"),h=l("^(.*) "+f+" ","gm"),g=l("(^|\\n)([\\t ]*) "+p+" (.*)$"),b=l("^(.*) "+p+" ","gm"),$=0;return o?(o===T?t.select():h.test(o)?t.replace(h,function(e,t){return++$,t+" "+v(c,[$])+" "}):b.test(o)?t[0]().replace(b,"$1"):t.replace(/^(\s*)(\S+)$/gm,function(e,t,n){return++$,t+" "+v(c,[$])+" "+n}),!1):i&&a?(n=d.test(i)?i.replace(d,"$1$2 "+s+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+a).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(T)[1](),!1)}},"align-left":0,"align-center":0,"align-right":0,"align-justify":0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(_.hr+"\n\n",-1),!1}}}),b(h.tools,function(e,t){var n=w.tools[t]||"";o(e)?h.tools[t]={title:n,click:e}:e.title||(e.title=n)}),g(h.keys,{"control+u":0,"control+arrowup":0,"control+arrowdown":"footnote","control+shift+?":"abbr","shift+enter":function(e,t){var n=k.enable_hard_break;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=_.blockquote,o=(_.ul,_.ol),i=v(m(o),["\\d+"]),u="(("+m(r)+" )+|"+E+"| +("+i+") )",c=l("^"+u+".*$","gm").exec(n.before.split("\n").pop());if(c){if(c[0]===c[1])return t.outdent(l(u)),!1;if(l("\\s*"+i+"\\s*").test(c[1])){var s=parseInt(a(c[1]),10);return t.insert("\n"+c[1].replace(/\d+/,s+1),-1).scroll("+1"),!1}return t.insert("\n"+c[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var n,r=t.$(),o=r.before,i=r.value,a=r.after,u=_.ol,c=m(u),s=v(c,["\\d+"]),f=m(_.blockquote),p=l("  "+E+"$"),d=l("   ( ?"+s+" )$"),g="("+f+" |"+E+"| +"+s+" )";if(i){if(i&&(n=i.match(l("(^|\\n)"+g,"g"))))return t.outdent(l(g)),!1}else{if(n=o.match(l(f+" $")))return t.outdent(n[0]),!1;if(n=o.match(p))return o=o.replace(p,"$1"),t.set(o+a).select(o.length),!1;if(n=o.match(d))return o=o.replace(d,"$1"),t.set(o+a).select(o.length),!1}return h.tools.outdent.click(e,t)},tab:function(e,t){var n,r=t.$(),o=r.before,i=r.value,a=r.after,u=_.ol,c=m(u),s=l(E+"$"),f=l(" ?"+v(c,["\\d+"])+" $");if(!i){if(n=o.match(l(m(_.blockquote)+" $")))return t.insert(n[0],-1),!1;if(n=o.match(s))return o=o.replace(s,"  $1"),t.set(o+a).select(o.length),!1;if(n=o.match(f))return o=o.replace(f,"    "+v(u,[1])+" "),t.set(o+a).select(o.length),!1}return h.tools.indent.click(e,t)}}),d.update(g({tools:"b i | a img | footnote abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | hr | undo redo"},t),0)},TE.Markdown.__instance__=[];
/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(t,e){function n(t){return void 0!==t}function s(t){return"string"==typeof t}function r(t){return"object"==typeof t}function a(t,e){return RegExp(t,e)}function h(t){return t.replace(/^\s*|\s*$/g,"")}function o(t){return t.replace(/\s+$/,"")}function l(t,e,n){return e>t?e:t>n?n:t}function _(t){return u(t).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function u(t){return h(t.replace(/\s+/g," "))}var c,p,d,g,f,m,b,k,w,y,v=new TE.HTML(t),T=v.ui,x=v._.extend,A=(v._.each,v._.x),$=v._.format,N="\t";return v.update(x({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",v.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},e),0),v.type="Markdown",c=v.config,p=c.states,d=c.languages,g=c.formats,f=c.classes,m=c.tab,b=d.placeholders,k=0,w=c.extra,y="( +["+A(g.ul).join("")+"] )",w||(c["advance_pre,code"]=0),v.mark=function(t,e,i,s){r(t)||(t=[t]),n(i)||(i=" "),n(s)||(s="");var h=v[0]().$(),o=t[0]+s,l=s+(n(t[1])?t[1]:t[0]),_=h.value,u=A(o),c=A(l),p=a("^"+u+"([\\s\\S]*?)"+c+"$"),d=a(u+"$"),g=a("^"+c),f=h.before,m=h.after;return _?i=!1:v.insert(b[""]),v.toggle(e?!p.test(_):!d.test(f)&&!g.test(m),[function(t){t.unwrap(o,l,1).tidy(/<[^\/<>]+?>$/.test(f)?"":i,/^<\/[^<>]+?>/.test(m)?"":i).wrap(o,l,e)[1]()},function(t){t.unwrap(o,l,e)[1]()}])},x(T.tools,{b:{i:"bold",click:function(t,e){return e.i().mark(g.b[0]),!1}},i:{i:"italic",click:function(t,e){return e.i().mark(g.i[0]),!1}},u:0,s:w?{i:"strikethrough",click:function(t,e){return e.i().mark(g.s),!1}}:0,a:{i:"link",click:function(t,e){var n,i,s,r,a,l,c,g=e.$(),f=g.before,m=g.value,k=g.after,w=e.get(),y=/^ {0,3}\[[^\^]+?\]:/.test(w.split("\n").pop())?"\n":"\n\n",v=w.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],T=d.modals.a,x=T.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(m))return e.tidy(" ").mark(["<",">"],1),!1;for(c in v)c=" "+h(v[c]).replace(/^\[|\]:$/g,""),p.a[c]=1;return n=p.a,e.record().ui.prompt(["a[href]",T.title[0]],x,0,function(t,e,c){var p=""===c;c=u(c),e[0](),n[c]?(e.trim(h(f)?" ":"",/^\n+ {0,3}\*?\[/.test(k)?!1:" ").mark(["[","]["+c+"]"],0,!1),r=v.indexOf(" ["+c+"]:"),-1===r&&1!==n[c]&&(g=e.$(),f=g.before,a=g.start,l=g.end,e.set(f+g.value+o(g.after)+y+" ["+(c||h(m)||b[""])+"]: "+(p?"":n[c][0]+(n[c][1]?' "'+n[c][1]+'"':""))).select(a,l),p&&e.focus(!0).insert(x))):(i=c,e.blur().ui.prompt(["a[title]",T.title[1]],T.placeholder[1],0,function(t,e,n){s=_(n),m||e.insert(b[""]),e.i().trim(h(f)?" ":"",h(k)?/^\n+ {0,3}\*?\[/.test(k)?"\n\n ":" ":"").wrap("[","]("+i+(s?' "'+s+'"':"")+")")})),e[1]()}),!1}},img:{i:"image",click:function(t,e){var n,s,r,a,o,l,c=e.$(),g=c.value,f=c.before,m=c.after,b=e.get(),k=/^ {0,3}\[[^\^]+?\]:/.test(b.split("\n").pop())?"\n":"\n\n",w=b.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],y=d.modals.img,v=/^\n* {0,3}\[.+?\]:/.test(m)?" ":"",T=h(m);for(i in w)i=" "+h(w[i]).replace(/^\[|\]:$/g,""),!p.img[i]&&(p.img[i]=1);return n=p.img,e.ui.prompt(["img[src]",y.title[0]],y.placeholder[0],1,function(t,e,i){i=u(i),s=i,g||(g=s.split(/[\/\\\\]/).pop()),g=_(g),e[0]().trim(h(f)?"\n\n":"",v),n[i]?(e.insert("").insert("!["+g+"]["+i+"]\n\n",-1),v&&e.select(e.$().start),a=w.indexOf(" ["+i+"]:"),-1===a&&(c=e.$(),f=c.before,o=c.start,l=c.end,e.set(f+c.value+c.after+(T?k:"")+" ["+i+"]: "+n[i][0]+(n[i][1]?' "'+n[i][1]+'"':"")).select(o,l))):e.blur().ui.prompt(["img[title]",y.title[1]],y.placeholder[1],0,function(t,e,n){r=_(n),e.insert("").insert("!["+g+"]("+s+(r?' "'+r+'"':"")+")\n\n",-1),v&&e.select(e.$().start)}),e[1]()}),!1}},sub:0,sup:w?{i:"thumb-tack",click:function(t,e){var n,i=e.$(),s=i.before,r=i.after,a=d.modals.sup,l=e.get(),_=/^ {0,3}\[\^.+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",u=l.match(/^ {0,3}\[\^.+?\]:/gm)||[],c=0;for(c in u)u[c]=" "+h(u[c]);return c=u.length+1,e.ui.prompt(["sup[id]",a.title],i.value||a.placeholder||c,0,function(t,e,i){i=h(i)||c,n=u.indexOf(" [^"+i+"]:"),-1!==n?(c=l.indexOf(u[n])+3,e.select(c,c+i.length)):e.trim(h(s)?" ":"",!h(r)||/^\n+ {0,3}\*?\[/.test(r)?"\n\n ":" ").insert("[^"+i+"]").set(o(e.get())+_+" [^"+i+"]: ").focus(!0).insert(b[""])}),!1}}:0,abbr:w?{i:"question",click:function(t,e){var n=e.$(),i=h(n.value),s=d.modals.abbr,r=e.get(),a=u(i||b[""]),l=/^ {0,3}\*\[.+?\]:/.test(r.split("\n").pop())?"\n":"\n\n",_=r.match(/^ {0,3}\*\[.+?\]:/gm)||[],c=p.abbr,g=0;for(g in _)_[g]=" "+h(_[g]);return g=_.indexOf(" *["+a+"]:"),i&&-1!==g?(g=r.indexOf(_[g])+3,e.select(g,g+a.length),!1):(e.record().ui.prompt(["abbr[title]",s.title],c[a]||s.placeholder,!c[i],function(t,e,s,r){if(s=h(s),e.set(o(e.get())+(n.before||i?l:"")+" *["+a+"]: ").focus(!0).insert(s||r),a===b[""]){var _=e.$().start;e.select(_-3-a.length,_-3)}}),!1)}}:0,p:{i:"paragraph",click:function(t,e){return e.tidy("\n\n").insert(b[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(t,e){k>5?k=0:k++;var n=e.$(),i=c["advance_h1,h2"],s="\\s?["+A(g.h1[0]+g.h2[0])+"]+\\s*",r=A(g.h1[1]),h=n.before.replace(a("["+r+"\\s]+$"),""),o=u(n.value).replace(a("^["+r+"\\s]+|["+r+"\\s]+$","g"),"").replace(a(s+"$"),"")||b[""],l=n.after.replace(a("^["+r+"\\s]+"),"").replace(a("^"+s),""),_=["",g.h1[i?0:1],g.h2[i?0:1],g.h3,g.h4,g.h5,g.h6];return e[0]().set(h+o+l).select(h.length,(h+o).length).tidy("\n\n"),0===k||(3>k&&i?e.wrap("","\n"+o.replace(/./g,_[k])):e.wrap(_[k]+" ",c["close_h1,h2,h3,h4,h5,h6"]?" "+_[k]:"")),e[1](),!1}},"blockquote,q":{i:"quote-left",click:function(t,e){var n=e.$(),i=n.value,s=g.blockquote;return i===b[""]?(e.select(),!1):i?(e.tidy(a(s+" $").test(n.before)?!1:"\n\n")[a("^"+s).test(i)?"outdent":"indent"](s+" "),!1):(e[0]().tidy("\n\n").insert(s+" ",-1).insert(b[""])[1](),!1)}},"pre,code":{i:"code",click:function(t,e){var n,i,r,h=e.$(),o=h.before,l=h.value,_=c["advance_pre,code"],u=g.code,p=u[1]||u[0];return p=p+p+p,!s(_)&&_?_=p:s(_)&&-1!==_.indexOf("%1")&&(_=$(_,[p])),n="( {4,}|\\t"+(s(_)?"|"+A(_):"")+")",a("(^|\\n)"+n+"?$").test(o)?_?(e.mark([_,_.split(/\s+/)[0]],0,"\n\n","\n"),!1):(_=m===N?N:"    ",l?l===b[""]&&a(n+"$").test(o)?(e.select(h.start-_.length,h.end),!1):(e.tidy("\n\n")[a("^"+n).test(l)?"outdent":"indent"](_),!1):(e[0]().tidy("\n\n"),i=e.$().start,r=_+b[""],e.insert(r).select(i+_.length,i+r.length)[1](),!1)):(e.mark(u[0]),!1)}},ul:{i:"list-ul",click:function(t,e){var n,i=e.$(),s=i.value,r=i.before,h=i.after,o=g.ul[0],l=g.ol,_=A(o),u=$(A(l),["\\d+"]),c=a("(^|\\n)([\\t ]*) "+_+" (.*)$"),p=a("^(.*) "+_+" ","gm"),d=a("(^|\\n)([\\t ]*) "+u+" (.*)$"),f=a("^(.*) "+u+" ","gm");return s?(s===b[""]?e.select():f.test(s)?e.replace(f,"$1 "+o+" "):p.test(s)?e[0]().replace(p,"$1"):e.replace(/^(\s*)(\S.*)$/gm,"$1 "+o+" $2"),!1):r&&h?(n=d.test(r)?r.replace(d,"$1$2 "+o+" $3"):c.test(r)?r.replace(c,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+o+" $3"),e.set(n+h).select(n.length),!1):(e[0]().tidy("\n\n").insert(" "+o+" ",-1).insert(b[""])[1](),!1)}},ol:{i:"list-ol",click:function(t,e){var n,i=e.$(),s=i.value,r=i.before,h=i.after,o=g.ul[0],l=g.ol,_=$(l,[1]),u=A(o),c=$(A(l),["\\d+"]),p=a("(^|\\n)([\\t ]*) "+u+" (.*)$"),d=a("^(.*) "+u+" ","gm"),f=a("(^|\\n)([\\t ]*) "+c+" (.*)$"),m=a("^(.*) "+c+" ","gm"),k=0;return s?(s===b[""]?e.select():d.test(s)?e.replace(d,function(t,e){return++k,e+" "+$(l,[k])+" "}):m.test(s)?e[0]().replace(m,"$1"):e.replace(/^(\s*)(\S.*)$/gm,function(t,e,n){return++k,e+" "+$(l,[k])+" "+n}),!1):r&&h?(n=p.test(r)?r.replace(p,"$1$2 "+_+" $3"):f.test(r)?r.replace(f,"$1$2$3"):r.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+_+" $3"),e.set(n+h).select(n.length),!1):(e[0]().tidy("\n\n").insert(" "+_+" ",-1).insert(b[""])[1](),!1)}},table:w?function(t,e){var n,i,s,r=p.tr,a=p.td,h=d.modals.table,o=d.placeholders.table,_=$(o[0],[1,1]),u=[];return e.$().value===_?(e.select(),!1):(e[0]().ui.prompt(["table>td",h.title[0]],h.placeholder[0],0,function(t,e,p,d){i=l(parseInt(p,10)||d,a[0],a[1]),e.blur().ui.prompt(["table>tr",h.title[1]],h.placeholder[1],0,function(t,e,a,h){s=l(parseInt(a,10)||h,r[0],r[1]);var p,d,g,f,m,b;for(p=0;s>p;++p){for(n="|",d=0;i>d;++d)n+=" "+$(o[1],[p+1,d+1])+" |";u.push(n)}for(u=u.join("\n"),n="|",g=0;i>g;++g)n+=" "+$(o[0],[g+1,g+1]).replace(/./g,"-")+" |";for(u=n+"\n"+u,n="|",f=0;i>f;++f)n+=" "+$(o[0],[1,f+1])+" |";u=n+"\n"+u,c.close_tr||(u=u.replace(/^\|\s*|\s*\|$/gm,"")),e.tidy("\n\n").insert("").insert(u,1),m=e.$(),b=m.start+m.after.indexOf(_),e.select(b,b+_.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(t,e){return e.tidy("\n\n","").insert(g.hr[0]+"\n\n",-1),!1}}}),x(T.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(t,e){var n=c.advance_br;return!s(n)&&n&&(n="  \n"),e.trim().insert(n||"\n",-1),!1},enter:function(t,e){var n,i=e.$(),s=g.blockquote,r=(g.ul[0],g.ol),o=$(A(r),["\\d+"]),l="(("+A(s)+" )+|"+y+"| +("+o+") )",_=a("^"+l+".*$","gm").exec(i.before.split("\n").pop());return _?_[0]===_[1]?(e.outdent(a(l)),!1):a("\\s*"+o+"\\s*").test(_[1])?(n=parseInt(h(_[1]),10),e.insert("\n"+_[1].replace(/\d+/,n+1),-1).scroll("+1"),!1):(e.insert("\n"+_[1],-1).scroll("+1"),!1):void 0},"shift+tab":function(t,e){var n,i=e.$(),s=i.before,r=i.value,h=i.after,o=g.ol,l=A(o),_=$(l,["\\d+"]),u=A(g.blockquote),c=a("  "+y+"$"),p=a("   ( ?"+_+" )$"),d="("+u+" |"+y+"| +"+_+" )";if(r){if(r&&(n=r.match(a("(^|\\n)"+d,"g"))))return e.outdent(a(d)),!1}else{if(n=s.match(a(u+" $")))return e.outdent(n[0]),!1;if(n=s.match(c))return s=s.replace(c,"$1"),e.set(s+h).select(s.length),!1;if(n=s.match(p))return s=s.replace(p,"$1"),e.set(s+h).select(s.length),!1}return T.tools.outdent.click(t,e)},tab:function(t,e){var n,i=e.$(),s=i.before,r=i.value,h=i.after,o=g.ol,l=A(o),_=a(y+"$"),u=a(" ?"+$(l,["\\d+"])+" $");if(!r){if(n=s.match(a(A(g.blockquote)+" $")))return e.insert(n[0],-1),!1;if(n=s.match(_))return s=s.replace(_,"  $1"),e.set(s+h).select(s.length),!1;if(n=s.match(u))return s=s.replace(u,"    "+$(o,[1])+" "),e.set(s+h).select(s.length),!1}return T.tools.indent.click(t,e)}}),v.update({},0)};
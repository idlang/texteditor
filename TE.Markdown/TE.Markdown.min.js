/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.3
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function h(e){return"undefined"!=typeof e}function v(e){return"string"==typeof e}function m(e){return"object"==typeof e}function k(e,t){return new RegExp(e,t)}function w(e){return e.replace(/^\s*|\s*$/g,"")}function $(e){return e.replace(/\s+$/,"")}function x(e,t,n){return t>e?t:e>n?n:e}function T(e){return _(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function E(e){return _(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function _(e){return w(e.replace(/\s+/g," "))}var o=(window,document,new TE.HTML(e)),f=o.ui,l=o._.extend,a=o._.x,u=o._.format,d="\t";o.update(l({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",o.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0),o.type="Markdown";var L=o.config,C=L.states,O=L.languages,M=L.formats,H=L.tab,z=O.placeholders,q=0,I=L.extra,j="( +["+a(M.ul).join("")+"] )";return I||(L["advance_pre,code"]=0),o.mark=function(e,t,n,r){m(e)||(e=[e]),h(n)||(n=" "),h(r)||(r="");var i=o[0]().$(),f=e[0]+r,l=r+(h(e[1])?e[1]:e[0]),u=i.value,s=a(f),c=a(l),p=k("^"+s+"([\\s\\S]*?)"+c+"$"),d=k(s+"$"),b=k("^"+c),v=i.before,g=i.after;return u?n=!1:o.insert(z[""]),o.toggle(t?!p.test(u):!d.test(v)&&!b.test(g),[function(e){e.unwrap(f,l,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(g)?"":n).wrap(f,l,t)[1]()},function(e){e.unwrap(f,l,t)[1]()}])},l(f.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(M.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(M.i[0]),!1}},u:0,s:I?{i:"strikethrough",click:function(e,t){return t.i().mark(M.s),!1}}:0,a:{i:"link",click:function(e,t){var c,p,d,h,b,v,g,n=t.$(),r=n.before,i=n.value,o=n.after,f=t.get(),l=/^ {0,3}\[[^\^]+?\]:/.test(f.split("\n").pop())?"\n":"\n\n",a=f.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=O.modals.a,s=u.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(g in a)g=" "+w(a[g]).replace(/^\[|\]:$/g,""),C.a[g]=1;return c=C.a,t.record().ui.prompt(["a[href]",u.title[0]],s,0,function(e,t,f){var g=""===f;f=E(f),t[0](),c[f]?(t.trim(w(r)?" ":"",/^\n+ {0,3}\*?\[/.test(o)?!1:" ").mark(["[","]["+f+"]"],0,!1),h=a.indexOf(" ["+f+"]:"),-1===h&&1!==c[f]&&(n=t.$(),r=n.before,b=n.start,v=n.end,t.set(r+n.value+$(n.after)+l+" ["+(f||w(i)||z[""])+"]: "+(g?"":c[f][0]+(c[f][1]?' "'+c[f][1]+'"':""))).select(b,v),g&&t.focus(!0).insert(s))):(p=f,t.blur().ui.prompt(["a[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){d=T(n),i||t.insert(z[""]),t.i().trim(w(r)?" ":"",w(o)?/^\n+ {0,3}\*?\[/.test(o)?"\n\n ":" ":"").wrap("[","]("+p+(d?' "'+d+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var d,h,b,v,g,m,n=t.$(),r=n.value,o=n.before,f=n.after,l=t.get(),a=/^ {0,3}\[[^\^]+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",u=l.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],s=O.modals.img,c=/^\n* {0,3}\[.+?\]:/.test(f)?" ":"",p=w(f);for(i in u)i=" "+w(u[i]).replace(/^\[|\]:$/g,""),!C.img[i]&&(C.img[i]=1);return d=C.img,t.ui.prompt(["img[src]",s.title[0]],s.placeholder[0],1,function(e,t,i){i=E(i),h=i,r||(r=h.split(/[\/\\\\]/).pop()),r=T(r),t[0]().trim(w(o)?"\n\n":"",c),d[i]?(t.insert("!["+r+"]["+i+"]\n\n",-1,1),c&&t.select(t.$().start),v=u.indexOf(" ["+i+"]:"),-1===v&&(n=t.$(),o=n.before,g=n.start,m=n.end,t.set(o+n.value+n.after+(p?a:"")+" ["+i+"]: "+d[i][0]+(d[i][1]?' "'+d[i][1]+'"':"")).select(g,m))):t.blur().ui.prompt(["img[title]",s.title[1]],s.placeholder[1],0,function(e,t,n){b=T(n),t.insert("!["+r+"]("+h+(b?' "'+b+'"':"")+")\n\n",-1,1),c&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:I?{i:"thumb-tack",click:function(e,t){var s,n=t.$(),r=n.before,i=n.after,o=O.modals.sup,f=t.get(),l=/^ {0,3}\[\^.+?\]:/.test(w(f).split("\n").pop())?"\n":"\n\n",a=f.match(/^ {0,3}\[\^.+?\]:/gm)||[],u=0;for(u in a)a[u]=" "+w(a[u]);return u=a.length+1,t.ui.prompt(["sup[id]",o.title],n.value||o.placeholder||u,0,function(e,t,n,o){n=w(n||o)||u,s=a.indexOf(" [^"+n+"]:"),-1!==s?(u=f.indexOf(a[s])+3,t.select(u,u+n.length)):t.trim(w(r)?" ":"",!w(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("[^"+n+"]").set($(t.get())+l+" [^"+n+"]: ").focus(!0).insert(z[""])}),!1}}:0,abbr:I?{i:"question",click:function(e,t){var n=t.$(),r=w(n.value),i=O.modals.abbr,o=t.get(),f=_(r||z[""]),l=/^ {0,3}\*\[.+?\]:/.test(o.split("\n").pop())?"\n":"\n\n",a=o.match(/^ {0,3}\*\[.+?\]:/gm)||[],u=C.abbr,s=0;for(s in a)a[s]=" "+w(a[s]);return s=a.indexOf(" *["+f+"]:"),r&&-1!==s?(s=o.indexOf(a[s])+3,t.select(s,s+f.length),!1):(t.record().ui.prompt(["abbr[title]",i.title],u[f]||i.placeholder,!u[r],function(e,t,i,o){if(i=T(i),t.set($(t.get())+(n.before||r?l:"")+" *["+f+"]: ").focus(!0).insert(i||o),f===z[""]){var a=t.$().start;t.select(a-3-f.length,a-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(z[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){q>5?q=0:q++;var n=t.$(),r=L["advance_h1,h2"],i="\\s?["+a(M.h1[0]+M.h2[0])+"]+\\s*",o=a(M.h1[1]),f=n.before.replace(k("["+o+"\\s]+$"),""),l=_(n.value).replace(k("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(k(i+"$"),"")||z[""],u=n.after.replace(k("^["+o+"\\s]+"),"").replace(k("^"+i),""),s=["",M.h1[r?0:1],M.h2[r?0:1],M.h3,M.h4,M.h5,M.h6];return t[0]().set(f+l+u).select(f.length,(f+l).length).tidy("\n\n"),0===q||(3>q&&r?t.wrap("","\n"+l.replace(/./g,s[q])):t.wrap(s[q]+" ",L["close_h1,h2,h3,h4,h5,h6"]?" "+s[q]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,i=M.blockquote;return r===z[""]?(t.select(),!1):r?(t.tidy(k(i+" $").test(n.before)?!1:"\n\n")[k("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(z[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),r=n.before,i=n.value,o=L["advance_pre,code"],f=M.code,l=f[1]||f[0];l=l+l+l,!v(o)&&o?o=l:v(o)&&-1!==o.indexOf("%1")&&(o=u(o,[l]));var s="( {4,}|\\t"+(v(o)?"|"+a(o):"")+")";if(k("(^|\\n)"+s+"?$").test(r)){if(o)return t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(o=H===d?d:"    ",!i){t[0]().tidy("\n\n");var c=t.$().start,p=o+z[""];return t.insert(p).select(c+o.length,c+p.length)[1](),!1}return i===z[""]&&k(s+"$").test(r)?(t.select(n.start-o.length,n.end),!1):(t.tidy("\n\n")[k("^"+s).test(i)?"outdent":"indent"](o),!1)}return t.mark(f[0]),!1}},ul:{i:"list-ul",click:function(e,t){var o,n=t.$(),r=n.value,i=n.before,f=n.after,l=M.ul[0],s=M.ol,c=a(l),p=u(a(s),["\\d+"]),d=k("(^|\\n)([\\t ]*) "+c+" (.*)$"),h=k("^(.*) "+c+" ","gm"),b=k("(^|\\n)([\\t ]*) "+p+" (.*)$"),v=k("^(.*) "+p+" ","gm");return r?(r===z[""]?t.select():v.test(r)?t.replace(v,"$1 "+l+" "):h.test(r)?t[0]().replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+l+" $2"),!1):i&&f?(o=b.test(i)?i.replace(b,"$1$2 "+l+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(o+f).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",-1).insert(z[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var o,n=t.$(),r=n.value,i=n.before,f=n.after,l=M.ul[0],s=M.ol,c=u(s,[1]),p=a(l),d=u(a(s),["\\d+"]),h=k("(^|\\n)([\\t ]*) "+p+" (.*)$"),b=k("^(.*) "+p+" ","gm"),v=k("(^|\\n)([\\t ]*) "+d+" (.*)$"),g=k("^(.*) "+d+" ","gm"),m=0;return r?(r===z[""]?t.select():b.test(r)?t.replace(b,function(e,t,n){return++m,t+" "+u(s,[m])+" "}):g.test(r)?t[0]().replace(g,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++m,t+" "+u(s,[m])+" "+n}),!1):i&&f?(o=h.test(i)?i.replace(h,"$1$2 "+c+" $3"):v.test(i)?i.replace(v,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+c+" $3"),t.set(o+f).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+c+" ",-1).insert(z[""])[1](),!1)}},table:I?function(e,t){var a,s,c,n=C.tr,r=C.td,i=O.modals.table,o=O.placeholders.table,f=u(o[0],[1,1]),l=[];return t.$().value===f?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){s=x(parseInt(p,10)||d,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=x(parseInt(r,10)||i,n[0],n[1]);var p,d,h,b,v,g;for(p=0;c>p;++p){for(a="|",d=0;s>d;++d)a+=" "+u(o[1],[p+1,d+1])+" |";l.push(a)}for(l=l.join("\n"),a="|",h=0;s>h;++h)a+=" "+u(o[0],[h+1,h+1]).replace(/./g,"-")+" |";for(l=a+"\n"+l,a="|",b=0;s>b;++b)a+=" "+u(o[0],[1,b+1])+" |";l=a+"\n"+l,L.close_tr||(l=l.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(l),v=t.$(),g=v.start+v.value.indexOf(f),t.select(g,g+f.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(M.hr[0]+"\n\n",-1),!1}}}),l(f.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=L.advance_br;return!v(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=M.blockquote,o=(M.ul[0],M.ol),f=u(a(o),["\\d+"]),l="(("+a(r)+" )+|"+j+"| +("+f+") )",s=k("^"+l+".*$","gm").exec(n.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(k(l)),!1;if(k("\\s*"+f+"\\s*").test(s[1])){var c=parseInt(w(s[1]),10);return t.insert("\n"+s[1].replace(/\d+/,c+1),-1).scroll("+1"),!1}return t.insert("\n"+s[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var v,n=t.$(),r=n.before,i=n.value,o=n.after,l=M.ol,s=a(l),c=u(s,["\\d+"]),p=a(M.blockquote),d=k("  "+j+"$"),h=k("   ( ?"+c+" )$"),b="("+p+" |"+j+"| +"+c+" )";if(i){if(i&&(v=i.match(k("(^|\\n)"+b,"g"))))return t.outdent(k(b)),!1}else{if(v=r.match(k(p+" $")))return t.outdent(v[0]),!1;if(v=r.match(d))return r=r.replace(d,"$1"),t.set(r+o).select(r.length),!1;if(v=r.match(h))return r=r.replace(h,"$1"),t.set(r+o).select(r.length),!1}return f.tools.outdent.click(e,t)},tab:function(e,t){var d,n=t.$(),r=n.before,i=n.value,o=n.after,l=M.ol,s=a(l),c=k(j+"$"),p=k(" ?"+u(s,["\\d+"])+" $");if(!i){if(d=r.match(k(a(M.blockquote)+" $")))return t.insert(d[0],-1),!1;if(d=r.match(c))return r=r.replace(c,"  $1"),t.set(r+o).select(r.length),!1;if(d=r.match(p))return r=r.replace(p,"    "+u(l,[1])+" "),t.set(r+o).select(r.length),!1}return f.tools.indent.click(e,t)}}),o.update({},0)};
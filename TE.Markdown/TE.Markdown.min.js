/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.4
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function h(e){return"undefined"!=typeof e}function $(e){return"string"==typeof e}function b(e){return"object"==typeof e}function k(e,t){return new RegExp(e,t)}function y(e){return e.replace(/^\s*|\s*$/g,"")}function w(e){return e.replace(/\s+$/,"")}function x(e,t,n){return t>e?t:e>n?n:e}function _(e){return parseInt(e,10)}function T(e){return q(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function S(e){return q(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function q(e){return y(e.replace(/\s+/g," "))}var l=(window,document,new TE.HTML(e)),a=l.ui,s=l._.extend,f=l._.x,o=l._.format,d="\t";l.update(s({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",l.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}},t),0),l.type="Markdown";var E=l.config,I=E.states,L=E.languages,O=E.formats,R=E.tab,z=L.placeholders,H=0,M=E.extra,D="( +["+f(O.ul).join("")+"] )";return M||(E["advance_pre,code"]=0),l.mark=function(e,t,n,r){b(e)||(e=[e]),h(n)||(n=" "),h(r)||(r="");var i=l[0]().$(),a=e[0]+r,s=r+(h(e[1])?e[1]:e[0]),o=i.value,u=f(a),c=f(s),p=k("^"+u+"([\\s\\S]*?)"+c+"$"),d=k(u+"$"),g=k("^"+c),$=i.before,m=i.after;return o?n=!1:l.insert(z[""]),l.toggle(t?!p.test(o):!d.test($)&&!g.test(m),[function(e){e.unwrap(a,s,1).tidy(/<[^\/<>]+?>$/.test($)?"":n,/^<\/[^<>]+?>/.test(m)?"":n).wrap(a,s,t)[1]()},function(e){e.unwrap(a,s,t)[1]()}])},s(a.tools,{b:{click:function(e,t){return t.i().mark(O.b[0]),!1}},i:{click:function(e,t){return t.i().mark(O.i[0]),!1}},u:0,s:M?{click:function(e,t){return t.i().mark(O.s),!1}}:0,a:{click:function(e,t){var c,p,d,h,g,$,m,n=t.$(),r=n.before,i=n.value,l=n.after,a=t.get(),s=/^ {0,3}\[[^\^]+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],o=L.modals.a,u=o.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(m in f)m=" "+y(f[m]).replace(/^\[|\]:$/g,""),I.a[m]=1;return c=I.a,t.record().ui.prompt(["a[href]",o.title[0]],u,0,function(e,t,a){var m=""===a;a=S(a),t[0](),c[a]?(t.trim(y(r)?" ":"",/^\n+ {0,3}\*?\[/.test(l)?!1:" ").mark(["[","]["+a+"]"],0,!1),h=f.indexOf(" ["+a+"]:"),-1===h&&1!==c[a]&&(n=t.$(),r=n.before,g=n.start,$=n.end,t.set(r+n.value+w(n.after)+s+" ["+(a||y(i)||z[""])+"]: "+(m?"":c[a][0]+(c[a][1]?' "'+c[a][1]+'"':""))).select(g,$),m&&t.focus(!0).insert(u))):(p=a,t.blur().ui.prompt(["a[title]",o.title[1]],o.placeholder[1],0,function(e,t,n){d=T(n),i||t.insert(z[""]),t.i().trim(y(r)?" ":"",y(l)?/^\n+ {0,3}\*?\[/.test(l)?"\n\n ":" ":"").wrap("[","]("+p+(d?' "'+d+'"':"")+")")})),t[1]()}),!1}},img:{click:function(e,t){var d,h,g,$,m,b,n=t.$(),r=n.value,l=n.before,a=n.after,s=t.get(),f=/^ {0,3}\[[^\^]+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",o=s.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=L.modals.img,c=/^\n* {0,3}\[.+?\]:/.test(a)?" ":"",p=y(a);for(i in o)i=" "+y(o[i]).replace(/^\[|\]:$/g,""),!I.img[i]&&(I.img[i]=1);return d=I.img,t.ui.prompt(["img[src]",u.title[0]],u.placeholder[0],1,function(e,t,i){i=S(i),h=i,r||(r=h.split(/[\/\\\\]/).pop()),r=T(r),t[0]().trim(y(l)?"\n\n":"",c),d[i]?(t.insert("!["+r+"]["+i+"]\n\n",-1,1),c&&t.select(t.$().start),$=o.indexOf(" ["+i+"]:"),-1===$&&(n=t.$(),l=n.before,m=n.start,b=n.end,t.set(l+n.value+n.after+(p?f:"")+" ["+i+"]: "+d[i][0]+(d[i][1]?' "'+d[i][1]+'"':"")).select(m,b))):t.blur().ui.prompt(["img[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){g=T(n),t.insert("!["+r+"]("+h+(g?' "'+g+'"':"")+")\n\n",-1,1),c&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:M?{i:"thumb-tack",click:function(e,t){var u,n=t.$(),r=n.before,i=n.after,l=L.modals.sup,a=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(y(a).split("\n").pop())?"\n":"\n\n",f=a.match(/^ {0,3}\[\^.+?\]:/gm)||[],o=0;for(o in f)f[o]=" "+y(f[o]);return o=f.length+1,t.ui.prompt(["sup[id]",l.title],n.value||l.placeholder||o,0,function(e,t,n,l){n=y(n||l)||o,u=f.indexOf(" [^"+n+"]:"),-1!==u?(o=a.indexOf(f[u])+3,t.select(o,o+n.length)):t.trim(y(r)?" ":"",!y(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("[^"+n+"]").set(w(t.get())+s+" [^"+n+"]: ").focus(!0).insert(z[""])}),!1}}:0,abbr:M?{click:function(e,t){var n=t.$(),r=y(n.value),i=L.modals.abbr,l=t.get(),a=q(r||z[""]),s=/^ {0,3}\*\[.+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",f=l.match(/^ {0,3}\*\[.+?\]:/gm)||[],o=I.abbr,u=0;for(u in f)f[u]=" "+y(f[u]);return u=f.indexOf(" *["+a+"]:"),r&&-1!==u?(u=l.indexOf(f[u])+3,t.select(u,u+a.length),!1):(t.record().ui.prompt(["abbr[title]",i.title],o[a]||i.placeholder,!o[r],function(e,t,i,l){if(i=T(i),t[0]().set(w(t.get())+(n.before||r?s:"")+" *["+a+"]: ").focus(!0).insert(i||l),a===z[""]){var f=t.$().start;t.select(f-3-a.length,f-3)}t[1]()}),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(z[""]),!1)}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){H>5?H=0:H++;var n=t.$(),r=E["advance_h1,h2"],i="\\s?["+f(O.h1[0]+O.h2[0])+"]+\\s*",l=f(O.h1[1]),a=n.before.replace(k("["+l+"\\s]+$"),""),s=q(n.value).replace(k("^["+l+"\\s]+|["+l+"\\s]+$","g"),"").replace(k(i+"$"),"")||z[""],o=n.after.replace(k("^["+l+"\\s]+"),"").replace(k("^"+i),""),u=["",O.h1[r?0:1],O.h2[r?0:1],O.h3,O.h4,O.h5,O.h6];return t[0]().set(a+s+o).select(a.length,(a+s).length).tidy("\n\n"),0===H||(3>H&&r?t.wrap("","\n"+s.replace(/./g,u[H])):t.wrap(u[H]+" ",E["close_h1,h2,h3,h4,h5,h6"]?" "+u[H]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,i=O.blockquote;return r===z[""]?(t.select(),!1):r?(t.tidy(k(i+" $").test(n.before)?!1:"\n\n")[k("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(z[""])[1](),!1)}},"pre,code":{click:function(e,t){var n=t.$(),r=n.before,i=n.value,l=E["advance_pre,code"],a=O.code,s=a[1]||a[0];s=s+s+s,!$(l)&&l?l=s:$(l)&&-1!==l.indexOf("%1")&&(l=o(l,[s]));var u="( {4,}|\\t"+($(l)?"|"+f(l):"")+")";if(k("(^|\\n)"+u+"?$").test(r)){if(l)return t.mark([l,l.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(l=R===d?d:"    ",!i){t[0]().tidy("\n\n");var c=t.$().start,p=l+z[""];return t.insert(p).select(c+l.length,c+p.length)[1](),!1}return i===z[""]&&k(u+"$").test(r)?(t.select(n.start-l.length,n.end),!1):(t.tidy("\n\n")[k("^"+u).test(i)?"outdent":"indent"](l),!1)}return t.mark(a[0]),!1}},ul:{click:function(e,t){var m,n=t.$(),r=n.value,i=n.before,l=n.after,a=O.ul[0],s=O.ol[0],u=f(a),c=o(f(s),["\\d+"]),p=k("(^|\\n)([\\t ]*) "+u+" (.*)$"),d=k("^(.*) "+u+" ","gm"),h=k("(^|\\n)([\\t ]*) "+c+" (.*)$"),g=k("^(.*) "+c+" ","gm"),$=z[""];return r?(r===$?t.select():g.test(r)?t.replace(g,"$1 "+a+" "):d.test(r)?t.replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&l?(m=h.test(i)?i.replace(h,"$1$2 "+a+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(m+l).select(m.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert($)[1](),!1)}},ol:{click:function(e,t){var v,n=t.$(),r=n.value,i=n.before,l=n.after,a=O.ul[0],s=O.ol[0],u=o(s,[1]),c=f(a),p=o(f(s),["\\d+"]),d=k("(^|\\n)([\\t ]*) "+c+" (.*)$"),h=k("^(.*) "+c+" ","gm"),g=k("(^|\\n)([\\t ]*) "+p+" (.*)$"),$=k("^(.*) "+p+" ","gm"),m=z[""],b=0;return r?(r===m?t.select():h.test(r)?t.replace(h,function(e,t,n){return++b,t+" "+o(s,[b])+" "}):$.test(r)?t.replace($,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++b,t+" "+o(s,[b])+" "+n}),!1):i&&l?(v=d.test(i)?i.replace(d,"$1$2 "+u+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+u+" $3"),t.set(v+l).select(v.length),!1):(t[0]().tidy("\n\n").insert(" "+u+" ",-1).insert(m)[1](),!1)}},table:M?function(e,t){var f,u,c,n=I.tr,r=I.td,i=L.modals.table,l=L.placeholders.table,a=o(l[0],[1,1]),s=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){u=x(_(p)||d,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=x(_(r)||i,n[0],n[1]);var p,d,h,g,$,m;for(p=0;c>p;++p){for(f="|",d=0;u>d;++d)f+=" "+o(l[1],[p+1,d+1])+" |";s.push(f)}for(s=s.join("\n"),f="|",h=0;u>h;++h)f+=" "+o(l[0],[h+1,h+1]).replace(/./g,"-")+" |";for(s=f+"\n"+s,f="|",g=0;u>g;++g)f+=" "+o(l[0],[1,g+1])+" |";s=f+"\n"+s,E.close_tr||(s=s.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(s),$=t.$(),m=$.start+$.value.indexOf(a),t.select(m,m+a.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(O.hr[0]+"\n\n",-1),!1}}}),s(a.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=E.advance_br;return!$(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1).scroll("+"),!1},enter:function(e,t){var n=t.$(),r=O.blockquote,l=(O.ul[0],O.ol[0]),a=o(f(l),["\\d+"]),s="(("+f(r)+" )+|"+D+"| +("+a+") )",u=k("^"+s+".*$","gm").exec(n.before.split("\n").pop());if(u){if(u[0]===u[1])return t.outdent(k(s)),!1;if(k("\\s*"+a+"\\s*").test(u[1])){var c=_(y(u[1]));return t.insert("\n"+u[1].replace(/\d+/,c+1),-1).scroll("+"),!1}return t.insert("\n"+u[1],-1).scroll("+"),!1}},"shift+tab":function(e,t){var $,n=t.$(),r=n.before,i=n.value,l=n.after,s=O.ol[0],u=f(s),c=o(u,["\\d+"]),p=f(O.blockquote),d=k("  "+D+"$"),h=k("   ( ?"+c+" )$"),g="("+p+" |"+D+"| +"+c+" )";if(i){if(i&&($=i.match(k("(^|\\n)"+g,"g"))))return t.outdent(k(g)),!1}else{if($=r.match(k(p+" $")))return t.outdent($[0]),!1;if($=r.match(d))return r=r.replace(d,"$1"),t.set(r+l).select(r.length),!1;if($=r.match(h))return r=r.replace(h,"$1"),t.set(r+l).select(r.length),!1}return a.tools.outdent.click(e,t)},tab:function(e,t){var d,n=t.$(),r=n.before,i=n.value,l=n.after,s=O.ol[0],u=f(s),c=k(D+"$"),p=k(" ?"+o(u,["\\d+"])+" $");if(!i){if(d=r.match(k(f(O.blockquote)+" $")))return t.insert(d[0],-1),!1;if(d=r.match(c))return r=r.replace(c,"  $1"),t.set(r+l).select(r.length),!1;if(d=r.match(p))return r=r.replace(p,"    "+o(s,[1])+" "),t.set(r+l).select(r.length),!1}return a.tools.indent.click(e,t)}}),l.update({},0)};
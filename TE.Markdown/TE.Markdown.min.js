/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.2
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function l(e){return"object"==typeof e}function a(e,t){return RegExp(e,t)}function o(e){return e.replace(/^\s*|\s*$/g,"")}function c(e){return e.replace(/\s+$/,"")}function s(e,t,n){return t>e?t:e>n?n:e}function u(e){return p(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function p(e){return o(e.replace(/\s+/g," "))}var f,h,d,$,g,m,b,v,k,_,y=new TE.HTML(e),w=y.ui,x=y._.extend,q=y._.x,O=y._.format,I="\t";return y.update(x({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",y.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0),y.type="Markdown",f=y.config,h=f.states,d=f.languages,$=f.formats,g=f.classes,m=f.tab,b=d.placeholders,v=0,k=f.extra,_="( +["+q($.ul).join("")+"] )",k||(f["advance_pre,code"]=0),y.mark=function(e,t,r,i){l(e)||(e=[e]),n(r)||(r=" "),n(i)||(i="");var o=y[0]().$(),c=e[0]+i,s=i+(n(e[1])?e[1]:e[0]),u=o.value,p=q(c),f=q(s),h=a("^"+p+"([\\s\\S]*?)"+f+"$"),d=a(p+"$"),$=a("^"+f),g=o.before,m=o.after;return u?r=!1:y.insert(b[""]),y.toggle(t?!h.test(u):!d.test(g)&&!$.test(m),[function(e){e.unwrap(c,s,1).tidy(/<[^\/<>]+?>$/.test(g)?"":r,/^<\/[^<>]+?>/.test(m)?"":r).wrap(c,s,t)[1]()},function(e){e.unwrap(c,s,t)[1]()}])},x(w.tools,{b:{i:"bold",click:function(e,t){return t.i().mark($.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark($.i[0]),!1}},u:0,s:k?{i:"strikethrough",click:function(e,t){return t.i().mark($.s),!1}}:0,a:{i:"link",click:function(e,t){var n,r,l,i,a,s,f,$=t.$(),g=$.before,m=$.value,v=$.after,k=t.get(),_=/^ {0,3}\[[^\^]+?\]:/.test(k.split("\n").pop())?"\n":"\n\n",y=k.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],w=d.modals.a,x=w.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(m))return t.tidy(" ").mark(["<",">"],1),!1;for(f in y)f=" "+o(y[f]).replace(/^\[|\]:$/g,""),h.a[f]=1;return n=h.a,t.record().ui.prompt(["a[href]",w.title[0]],x,0,function(e,t,f){var h=""===f;f=p(f),t[0](),n[f]?(t.trim(o(g)?" ":"",/^\n+ {0,3}\*?\[/.test(v)?!1:" ").mark(["[","]["+f+"]"],0,!1),i=y.indexOf(" ["+f+"]:"),-1===i&&1!==n[f]&&($=t.$(),g=$.before,a=$.start,s=$.end,t.set(g+$.value+c($.after)+_+" ["+(f||o(m)||b[""])+"]: "+(h?"":n[f][0]+(n[f][1]?' "'+n[f][1]+'"':""))).select(a,s),h&&t.focus(!0).insert(x))):(r=f,t.blur().ui.prompt(["a[title]",w.title[1]],w.placeholder[1],0,function(e,t,n){l=u(n),m||t.insert(b[""]),t.i().trim(o(g)?" ":"",o(v)?/^\n+ {0,3}\*?\[/.test(v)?"\n\n ":" ":"").wrap("[","]("+r+(l?' "'+l+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var n,r,l,a,c,s,f=t.$(),$=f.value,g=f.before,m=f.after,b=t.get(),v=/^ {0,3}\[[^\^]+?\]:/.test(b.split("\n").pop())?"\n":"\n\n",k=b.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],_=d.modals.img,y=/^\n* {0,3}\[.+?\]:/.test(m)?" ":"",w=o(m);for(i in k)i=" "+o(k[i]).replace(/^\[|\]:$/g,""),!h.img[i]&&(h.img[i]=1);return n=h.img,t.ui.prompt(["img[src]",_.title[0]],_.placeholder[0],1,function(e,t,i){i=p(i),r=i,$||($=r.split(/[\/\\\\]/).pop()),$=u($),t[0]().trim(o(g)?"\n\n":"",y),n[i]?(t.insert("!["+$+"]["+i+"]\n\n",-1,1),y&&t.select(t.$().start),a=k.indexOf(" ["+i+"]:"),-1===a&&(f=t.$(),g=f.before,c=f.start,s=f.end,t.set(g+f.value+f.after+(w?v:"")+" ["+i+"]: "+n[i][0]+(n[i][1]?' "'+n[i][1]+'"':"")).select(c,s))):t.blur().ui.prompt(["img[title]",_.title[1]],_.placeholder[1],0,function(e,t,n){l=u(n),t.insert("!["+$+"]("+r+(l?' "'+l+'"':"")+")\n\n",-1,1),y&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:k?{i:"thumb-tack",click:function(e,t){var n,r=t.$(),l=r.before,i=r.after,a=d.modals.sup,s=t.get(),u=/^ {0,3}\[\^.+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",p=s.match(/^ {0,3}\[\^.+?\]:/gm)||[],f=0;for(f in p)p[f]=" "+o(p[f]);return f=p.length+1,t.ui.prompt(["sup[id]",a.title],r.value||a.placeholder||f,0,function(e,t,r){r=o(r)||f,n=p.indexOf(" [^"+r+"]:"),-1!==n?(f=s.indexOf(p[n])+3,t.select(f,f+r.length)):t.trim(o(l)?" ":"",!o(i)||/^\n+ {0,3}\*?\[/.test(i)?"\n\n ":" ").insert("[^"+r+"]").set(c(t.get())+u+" [^"+r+"]: ").focus(!0).insert(b[""])}),!1}}:0,abbr:k?{i:"question",click:function(e,t){var n=t.$(),r=o(n.value),l=d.modals.abbr,i=t.get(),a=p(r||b[""]),s=/^ {0,3}\*\[.+?\]:/.test(i.split("\n").pop())?"\n":"\n\n",u=i.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=h.abbr,$=0;for($ in u)u[$]=" "+o(u[$]);return $=u.indexOf(" *["+a+"]:"),r&&-1!==$?($=i.indexOf(u[$])+3,t.select($,$+a.length),!1):(t.record().ui.prompt(["abbr[title]",l.title],f[a]||l.placeholder,!f[r],function(e,t,l,i){if(l=o(l),t.set(c(t.get())+(n.before||r?s:"")+" *["+a+"]: ").focus(!0).insert(l||i),a===b[""]){var u=t.$().start;t.select(u-3-a.length,u-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(b[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){v>5?v=0:v++;var n=t.$(),r=f["advance_h1,h2"],l="\\s?["+q($.h1[0]+$.h2[0])+"]+\\s*",i=q($.h1[1]),o=n.before.replace(a("["+i+"\\s]+$"),""),c=p(n.value).replace(a("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(a(l+"$"),"")||b[""],s=n.after.replace(a("^["+i+"\\s]+"),"").replace(a("^"+l),""),u=["",$.h1[r?0:1],$.h2[r?0:1],$.h3,$.h4,$.h5,$.h6];return t[0]().set(o+c+s).select(o.length,(o+c).length).tidy("\n\n"),0===v||(3>v&&r?t.wrap("","\n"+c.replace(/./g,u[v])):t.wrap(u[v]+" ",f["close_h1,h2,h3,h4,h5,h6"]?" "+u[v]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,l=$.blockquote;return r===b[""]?(t.select(),!1):r?(t.tidy(a(l+" $").test(n.before)?!1:"\n\n")[a("^"+l).test(r)?"outdent":"indent"](l+" "),!1):(t[0]().tidy("\n\n").insert(l+" ",-1).insert(b[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n,l,i,o=t.$(),c=o.before,s=o.value,u=f["advance_pre,code"],p=$.code,h=p[1]||p[0];return h=h+h+h,!r(u)&&u?u=h:r(u)&&-1!==u.indexOf("%1")&&(u=O(u,[h])),n="( {4,}|\\t"+(r(u)?"|"+q(u):"")+")",a("(^|\\n)"+n+"?$").test(c)?u?(t.mark([u,u.split(/\s+/)[0]],0,"\n\n","\n"),!1):(u=m===I?I:"    ",s?s===b[""]&&a(n+"$").test(c)?(t.select(o.start-u.length,o.end),!1):(t.tidy("\n\n")[a("^"+n).test(s)?"outdent":"indent"](u),!1):(t[0]().tidy("\n\n"),l=t.$().start,i=u+b[""],t.insert(i).select(l+u.length,l+i.length)[1](),!1)):(t.mark(p[0]),!1)}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),l=r.value,i=r.before,o=r.after,c=$.ul[0],s=$.ol,u=q(c),p=O(q(s),["\\d+"]),f=a("(^|\\n)([\\t ]*) "+u+" (.*)$"),h=a("^(.*) "+u+" ","gm"),d=a("(^|\\n)([\\t ]*) "+p+" (.*)$"),g=a("^(.*) "+p+" ","gm");return l?(l===b[""]?t.select():g.test(l)?t.replace(g,"$1 "+c+" "):h.test(l)?t[0]().replace(h,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+c+" $2"),!1):i&&o?(n=d.test(i)?i.replace(d,"$1$2 "+c+" $3"):f.test(i)?i.replace(f,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+c+" $3"),t.set(n+o).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+c+" ",-1).insert(b[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),l=r.value,i=r.before,o=r.after,c=$.ul[0],s=$.ol,u=O(s,[1]),p=q(c),f=O(q(s),["\\d+"]),h=a("(^|\\n)([\\t ]*) "+p+" (.*)$"),d=a("^(.*) "+p+" ","gm"),g=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),m=a("^(.*) "+f+" ","gm"),v=0;return l?(l===b[""]?t.select():d.test(l)?t.replace(d,function(e,t){return++v,t+" "+O(s,[v])+" "}):m.test(l)?t[0]().replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+O(s,[v])+" "+n}),!1):i&&o?(n=h.test(i)?i.replace(h,"$1$2 "+u+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+u+" $3"),t.set(n+o).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+u+" ",-1).insert(b[""])[1](),!1)}},table:k?function(e,t){var n,r,l,i=h.tr,a=h.td,o=d.modals.table,c=d.placeholders.table,u=O(c[0],[1,1]),p=[];return t.$().value===u?(t.select(),!1):(t[0]().ui.prompt(["table>td",o.title[0]],o.placeholder[0],0,function(e,t,h,d){r=s(parseInt(h,10)||d,a[0],a[1]),t.blur().ui.prompt(["table>tr",o.title[1]],o.placeholder[1],0,function(e,t,a,o){l=s(parseInt(a,10)||o,i[0],i[1]);var h,d,$,g,m,b;for(h=0;l>h;++h){for(n="|",d=0;r>d;++d)n+=" "+O(c[1],[h+1,d+1])+" |";p.push(n)}for(p=p.join("\n"),n="|",$=0;r>$;++$)n+=" "+O(c[0],[$+1,$+1]).replace(/./g,"-")+" |";for(p=n+"\n"+p,n="|",g=0;r>g;++g)n+=" "+O(c[0],[1,g+1])+" |";p=n+"\n"+p,f.close_tr||(p=p.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(p),m=t.$(),b=m.start+m.value.indexOf(u),t.select(b,b+u.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert($.hr[0]+"\n\n",-1),!1}}}),x(w.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=f.advance_br;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n,r=t.$(),l=$.blockquote,i=($.ul[0],$.ol),c=O(q(i),["\\d+"]),s="(("+q(l)+" )+|"+_+"| +("+c+") )",u=a("^"+s+".*$","gm").exec(r.before.split("\n").pop());return u?u[0]===u[1]?(t.outdent(a(s)),!1):a("\\s*"+c+"\\s*").test(u[1])?(n=parseInt(o(u[1]),10),t.insert("\n"+u[1].replace(/\d+/,n+1),-1).scroll("+1"),!1):(t.insert("\n"+u[1],-1).scroll("+1"),!1):void 0},"shift+tab":function(e,t){var n,r=t.$(),l=r.before,i=r.value,o=r.after,c=$.ol,s=q(c),u=O(s,["\\d+"]),p=q($.blockquote),f=a("  "+_+"$"),h=a("   ( ?"+u+" )$"),d="("+p+" |"+_+"| +"+u+" )";if(i){if(i&&(n=i.match(a("(^|\\n)"+d,"g"))))return t.outdent(a(d)),!1}else{if(n=l.match(a(p+" $")))return t.outdent(n[0]),!1;if(n=l.match(f))return l=l.replace(f,"$1"),t.set(l+o).select(l.length),!1;if(n=l.match(h))return l=l.replace(h,"$1"),t.set(l+o).select(l.length),!1}return w.tools.outdent.click(e,t)},tab:function(e,t){var n,r=t.$(),l=r.before,i=r.value,o=r.after,c=$.ol,s=q(c),u=a(_+"$"),p=a(" ?"+O(s,["\\d+"])+" $");if(!i){if(n=l.match(a(q($.blockquote)+" $")))return t.insert(n[0],-1),!1;if(n=l.match(u))return l=l.replace(u,"  $1"),t.set(l+o).select(l.length),!1;if(n=l.match(p))return l=l.replace(p,"    "+O(c,[1])+" "),t.set(l+o).select(l.length),!1}return w.tools.indent.click(e,t)}}),y.update({},0)};
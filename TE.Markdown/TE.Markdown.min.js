/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.0.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */

TE.Markdown = function(target, o) {

    var _u2026 = '\u2026', // horizontal ellipsis

        win = window,
        doc = document,
        editor = new TE.HTML(target, {
            auto_p: 0, // force to disable automatic paragraph feature in `TE.HTML`
            auto_close: {
                '`': '`'
            },
            languages: {
                modals: {
                    img: {
                        title: ['Image URL', 'Image Title'],
                        placeholder: ['http://', 'image title here' + _u2026]
                    }
                }
            },
            enable_setext_header: 1,
            enable_closed_atx_header: 1,
            enable_fenced_code_block: 0, // replace with `~~~` to enable fenced code block syntax in Markdown Extra
            enable_hard_break: '  \n', // press `Shift + Enter` to do a hard break
            formats: {
                b: '**',
                i: '_',
                s: '~~',
                h1: ['=', '#'],
                h2: ['-', '##'],
                h3: '###',
                h4: '####',
                h5: '#####',
                h6: '######',
                blockquote: '>',
                code: '`',
                ul: '-',
                ol: '%1.',
                hr: '---'
            }
        }),
        ui = editor.ui,
        extend = editor._.extend,
        each = editor._.each,
        esc = editor._.x,
        format = editor._.format,
        attrs = '(?:\\s[^<>]*?)?',
        attrs_capture = '(|\\s[^<>]*?)',
        content = '([\\s\\S]*?)';

    editor.update(extend({
        tools: 'b i | a img | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | hr | undo redo'
    }, o), 0);

    var config = editor.config,
        languages = config.languages,
        formats = config.formats,
        classes = config.classes,
        tab = config.tab,
        suffix = config.suffix,
        placeholder = languages.others.placeholder;

    function is_set(x) {
        return typeof x !== "undefined";
    }

    function is_node(x) {
        return x instanceof HTMLElement;
    }

    function is_function(x) {
        return typeof x === "function";
    }

    function is_object(x) {
        return typeof x === "object";
    }

    function pattern(a, b) {
        return new RegExp(a, b);
    }

    function trim(s) {
        return s.replace(/^\s*|\s*$/g, "");
    }

    function attr_value(s) {
        return s.replace(/<.*?>/g, "").replace(/"/g, '&quot;').replace(/'/g, '&apos;');
    }

    editor.mark = function(str, wrap, gap_1, gap_2) {
        if (!is_object(str)) str = [str];
        if (!is_set(gap_1)) gap_1 = ' ';
        if (!is_set(gap_2)) gap_2 = "";
        var s = editor[0]().$(),
            a = str[0] + gap_2,
            b = gap_2 + (str[1] || str[0]),
            A = esc(a),
            B = esc(b),
            m = pattern('^' + A + '([\\s\\S]*?)' + B + '$'),
            m_A = pattern(A + '$'),
            m_B = pattern('^' + B),
            before = s.before,
            after = s.after;
        if (!s.length) {
            editor.insert(placeholder);
        }
        return editor.toggle(
            // when ...
            wrap ? !m.test(s.value) : (!m_A.test(before) && !m_B.test(after)),
            // do ...
            [
                // first toggle
                function($) {
                    $.unwrap(a, b, 1).tidy(/<[^\/<>]+?>$/.test(before) ? "" : gap_1, /^<\/[^<>]+?>/.test(after) ? "" : gap_1).wrap(a, b, wrap)[1]();
                },
                // second toggle (the reset state)
                function($) {
                    $.unwrap(a, b, wrap)[1]();
                }
            ]
        );
    };

    extend(ui.tools, {
        b: {
            i: 'bold',
            click: function(e, $) {
                return $.mark(formats.b), false;
            }
        },
        i: {
            i: 'italic',
            click: function(e, $) {
                return $.mark(formats.i), false;
            }
        },
        s: {
            i: 'strikethrough',
            click: function(e, $) {
                return $.mark(formats.s), false;
            }
        },
        a: {
            i: 'link',
            click: function(e, $) {
                var a = formats.a,
                    i18n = languages.modals.a,
                    href, title;
                return $.record().ui.prompt(i18n.title[0], i18n.placeholder[0], 1, function(e, $, v) {
                    href = v;
                    $.blur().ui.prompt(i18n.title[1], i18n.placeholder[1], 0, function(e, $, v) {
                        title = attr_value(v);
                        if (!$.$().length) {
                            $.insert(placeholder);
                        }
                        $.mark(['[', '](' + href + (title ? ' "' + title + '"' : "") + ')']);
                    });
                }), false;
            }
        },
        img: {
            i: 'image',
            click: function(e, $) {
                var s = $.$(),
                    alt = s.value,
                    i18n = languages.modals.img,
                    src, title;
                return $.record().ui.prompt(i18n.title[0], i18n.placeholder[0], 1, function(e, $, v) {
                    src = v;
                    $.blur().ui.prompt(i18n.title[1], i18n.placeholder[1], 0, function(e, $, v) {
                        title = v;
                        if (!alt.length) {
                            alt = src.split(/[\/\\\\]/).pop();
                        }
                        alt = attr_value(alt);
                        $.tidy('\n\n', "").insert('![' + alt + '](' + src + (title ? ' "' + title + '"' : "") + ')\n\n', -1);
                    });
                }), false;
            }
        },
        p: {
            i: 'paragraph',
            click: function(e, $) {
                return $.tidy('\n\n').insert(placeholder), false;
            }
        },
        'p,h1,h2,h3,h4,h5,h6': {
            i: 'header',
            click: function(e, $) {
                var s = $.$(),
                    span = s.value.replace(/\s+/g, ' '),
                    setext = config.enable_setext_header,
                    setext_esc = esc(formats.h1[0] + formats.h2[0]),
                    H = [
                        "",
                        formats.h1[setext ? 0 : 1],
                        formats.h2[setext ? 0 : 1],
                        formats.h3,
                        formats.h4,
                        formats.h5,
                        formats.h6
                    ],
                    i = (s.value.match(pattern('^\\s*#+|[' + setext_esc + ']+\\s*$', 'g')) || s.before.match(/#+\s*$/) || s.after.match(pattern('^[' + setext_esc + ']+', 'g')) || [0]).reverse()[0];
                i = i ? (i[0] === formats.h1[0] ? 1 : (i[0] === formats.h2[0] ? 2 : i.length)) : 0;
                $[0]()
                    .insert(span)
                    .unwrap(/[#\s]+/, pattern('[#\\s' + setext_esc + ']*'))
                    .unwrap(/[#\s]+/, pattern('[#\\s' + setext_esc + ']*'), 1);
                if (i === 1) {
                    $.mark(["", '\n' + span.replace(/./g, H[1])]);
                } else if (i === 2) {
                    $.mark(["", '\n' + span.replace(/./g, H[2])]);
                } else {
                    $.mark([H[i] + ' ', ""]);
                }
                return $[1](), false;
            }
        },
        'blockquote,q': {
            i: 'quote-left',
            click: function(e, $) {
                var s = $.$(),
                    blockquote = formats.blockquote;
                if (s.value === placeholder) {
                    return $.select(), false;
                }
                if (!s.length) {
                    return $[0]().tidy('\n\n').wrap(blockquote + ' ', "").insert(placeholder)[1](), false;
                }
                return $.tidy('\n\n')[pattern('^' + blockquote).test(s.value) ? 'outdent' : 'indent'](blockquote + ' '), false;
            }
        },
        'pre,code': {
            i: 'code',
            click: function(e, $) {
                var s = $.$(),
                    pre = config.enable_fenced_code_block,
                    code = formats.code, attr;
                // block
                if (/(^|\n)$/.test(s.before)) {
                    if (pre) {
                        return $.mark([pre, pre.split(/\s+/)[0]], 0, '\n\n', '\n'), false;
                    }
                    if (!s.length) {
                        $.insert(placeholder);
                    }
                    return $.tidy('\n\n')[/^(\t| {4})/.test(s.value) ? 'outdent' : 'indent'](tab === '\t' ? '\t' : '    '), false;
                }
                // span
                return $.mark(code), false;
            }
        },
        ul: {
            i: 'list-ul',
            click: function(e, $) {}
        },
        ol: {
            i: 'list-ol',
            click: function(e, $) {}
        },
        hr: {
            i: 'ellipsis-h',
            click: function(e, $) {
                return $.tidy('\n\n', "").insert(formats.hr + '\n\n', -1), false;
            }
        }
    });

    each(ui.tools, function(v, i) {
        var title = languages.tools[i] || "";
        if (is_function(v)) {
            ui.tools[i] = {
                title: title,
                click: v
            }
        } else {
            if (!v.title) v.title = title;
        }
    });

    extend(ui.keys, {
        'shift+enter': function(e, $) {
            return $.trim().insert(config.enable_hard_break || '\n', -1), false;
        },
        'enter': function(e, $) {
            var s = $.$(),
                blockquote = formats.blockquote,
                ul = formats.ul,
                match = pattern('^((?:' + esc(blockquote) + ' *)+| *' + esc(ul) + ' *).*$', 'gm').exec(s.before);console.log(match)
            if (match) {
                return $.insert('\n' + match[1], -1), false;
            }
        }
    });

    return editor.update();

};
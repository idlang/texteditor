/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.4
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function c(e){return"undefined"!=typeof e}function d(e){return"string"==typeof e}function g(e){return"object"==typeof e}function m(e,t){return new RegExp(e,t)}function b(e){return e.replace(/^\s*|\s*$/g,"")}function v(e){return e.replace(/\s+$/,"")}function k(e,t,n){return t>e?t:e>n?n:e}function y(e){return parseInt(e,10)}function w(e){return _(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function x(e){return _(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function _(e){return b(e.replace(/\s+/g," "))}var l=(window,document,new TE.HTML(e)),a=l.ui,s=l._.extend,o=l._.x,f=l._.format,u="\t";l.update(s({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",l.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}},t),0),l.type="Markdown";var E=l.config,T=E.states,S=E.languages,I=E.formats,L=E.tab,C=S.placeholders,q=0,O=E.extra,z="( +["+o(I.ul).join("")+"] )";return O||(E["advance_pre,code"]=0),l.mark=function(e,t,n,r){g(e)||(e=[e]),c(n)||(n=" "),c(r)||(r="");var i=l[0]().$(),a=e[0]+r,s=r+(c(e[1])?e[1]:e[0]),f=i.value,u=o(a),p=o(s),d=m("^"+u+"([\\s\\S]*?)"+p+"$"),h=m(u+"$"),$=m("^"+p),b=i.before,v=i.after;return f?n=!1:l.insert(C[""]),l.toggle(t?!d.test(f):!h.test(b)&&!$.test(v),[function(e){e.unwrap(a,s,1).tidy(/<[^\/<>]+?>$/.test(b)?"":n,/^<\/[^<>]+?>/.test(v)?"":n).wrap(a,s,t)[1]()},function(e){e.unwrap(a,s,t)[1]()}])},s(a.tools,{b:{click:function(e,t){return t.i().mark(I.b[0]),!1}},i:{click:function(e,t){return t.i().mark(I.i[0]),!1}},u:0,s:O?{click:function(e,t){return t.i().mark(I.s),!1}}:0,a:{click:function(e,t){var c,p,d,h,g,$,m,n=t.$(),r=n.before,i=n.value,l=n.after,a=t.get(),s=/^ {0,3}\[[^\^]+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",o=a.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],f=S.modals.a,u=f.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(m in o)m=" "+b(o[m]).replace(/^\[|\]:$/g,""),T.a[m]=1;return c=T.a,t.record().ui.prompt(["a[href]",f.title[0]],u,0,function(e,t,a){var m=""===a;a=x(a),t[0](),c[a]?(t.trim(b(r)?" ":"",/^\n+ {0,3}\*?\[/.test(l)?!1:" ").mark(["[","]["+a+"]"],0,!1),h=o.indexOf(" ["+a+"]:"),-1===h&&1!==c[a]&&(n=t.$(),r=n.before,g=n.start,$=n.end,t.set(r+n.value+v(n.after)+s+" ["+(a||b(i)||C[""])+"]: "+(m?"":c[a][0]+(c[a][1]?' "'+c[a][1]+'"':""))).select(g,$),m&&t.focus(!0).insert(u))):(p=a,t.blur().ui.prompt(["a[title]",f.title[1]],f.placeholder[1],0,function(e,t,n){d=w(n),i||t.insert(C[""]),t.i().trim(b(r)?" ":"",b(l)?/^\n+ {0,3}\*?\[/.test(l)?"\n\n ":" ":"").wrap("[","]("+p+(d?' "'+d+'"':"")+")")})),t[1]()}),!1}},img:{click:function(e,t){var d,h,g,$,m,v,n=t.$(),r=n.value,l=n.before,a=n.after,s=t.get(),o=/^ {0,3}\[[^\^]+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",f=s.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=S.modals.img,c=/^\n* {0,3}\[.+?\]:/.test(a)?" ":"",p=b(a);for(i in f)i=" "+b(f[i]).replace(/^\[|\]:$/g,""),!T.img[i]&&(T.img[i]=1);return d=T.img,t.ui.prompt(["img[src]",u.title[0]],u.placeholder[0],1,function(e,t,i){i=x(i),h=i,r||(r=h.split(/[\/\\\\]/).pop()),r=w(r),t[0]().trim(b(l)?"\n\n":"",c),d[i]?(t.insert("!["+r+"]["+i+"]\n\n",-1,1),c&&t.select(t.$().start),$=f.indexOf(" ["+i+"]:"),-1===$&&(n=t.$(),l=n.before,m=n.start,v=n.end,t.set(l+n.value+n.after+(p?o:"")+" ["+i+"]: "+d[i][0]+(d[i][1]?' "'+d[i][1]+'"':"")).select(m,v))):t.blur().ui.prompt(["img[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){g=w(n),t.insert("!["+r+"]("+h+(g?' "'+g+'"':"")+")\n\n",-1,1),c&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:O?{i:"thumb-tack",click:function(e,t){var u,n=t.$(),r=n.before,i=n.after,l=S.modals.sup,a=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(b(a).split("\n").pop())?"\n":"\n\n",o=a.match(/^ {0,3}\[\^.+?\]:/gm)||[],f=0;for(f in o)o[f]=" "+b(o[f]);return f=o.length+1,t.ui.prompt(["sup[id]",l.title],n.value||l.placeholder||f,0,function(e,t,n,l){n=b(n||l)||f,u=o.indexOf(" [^"+n+"]:"),-1!==u?(f=a.indexOf(o[u])+3,t.select(f,f+n.length)):t.trim(b(r)?" ":"",!b(i)||/^[\t ]*\n+[\t ]*/.test(i)?"\n\n":" ").insert("[^"+n+"]").set(v(t.get())+s+" [^"+n+"]: ").focus(!0).insert(C[""])}),!1}}:0,abbr:O?{click:function(e,t){var n=t.$(),r=b(n.value),i=S.modals.abbr,l=t.get(),a=_(r||C[""]),s=/^ {0,3}\*\[.+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",o=l.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=T.abbr,u=0;for(u in o)o[u]=" "+b(o[u]);return u=o.indexOf(" *["+a+"]:"),r&&-1!==u?(u=l.indexOf(o[u])+3,t.select(u,u+a.length),!1):(t.record().ui.prompt(["abbr[title]",i.title],f[a]||i.placeholder,!f[r],function(e,t,i,l){if(i=w(i),t[0]().set(v(t.get())+(n.before||r?s:"")+" *["+a+"]: ").focus(!0).insert(i||l),a===C[""]){var o=t.$().start;t.select(o-3-a.length,o-3)}t[1]()}),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(C[""]),!1)}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){q>5?q=0:q++;var n=t.$(),r=E["advance_h1,h2"],i="\\s?["+o(I.h1[0]+I.h2[0])+"]+\\s*",l=o(I.h1[1]),a=n.before.replace(m("["+l+"\\s]+$"),""),s=_(n.value).replace(m("^["+l+"\\s]+|["+l+"\\s]+$","g"),"").replace(m(i+"$"),"")||C[""],f=n.after.replace(m("^["+l+"\\s]+"),"").replace(m("^"+i),""),u=["",I.h1[r?0:1],I.h2[r?0:1],I.h3,I.h4,I.h5,I.h6];return t[0]().set(a+s+f).select(a.length,(a+s).length).tidy("\n\n"),0===q||(3>q&&r?t.wrap("","\n"+s.replace(/./g,u[q])):t.wrap(u[q]+" ",E["close_h1,h2,h3,h4,h5,h6"]?" "+u[q]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,i=I.blockquote;return r===C[""]?(t.select(),!1):r?(t.tidy(m(i+" $").test(n.before)?!1:"\n\n")[m("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(C[""])[1](),!1)}},"pre,code":{click:function(e,t){var n=t.$(),r=n.before,i=n.value,l=E["advance_pre,code"],a=I.code,s=a[1]||a[0];s=s+s+s,!d(l)&&l?l=s:d(l)&&-1!==l.indexOf("%1")&&(l=f(l,[s]));var c="( {4,}|\\t"+(d(l)?"|"+o(l):"")+")";if(m("(^|\\n)"+c+"?$").test(r)){if(l)return t.mark([l,l.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(l=L===u?u:"    ",!i){t[0]().tidy("\n\n");var p=t.$().start,h=l+C[""];return t.insert(h).select(p+l.length,p+h.length)[1](),!1}return i===C[""]&&m(c+"$").test(r)?(t.select(n.start-l.length,n.end),!1):(t.tidy("\n\n")[m("^"+c).test(i)?"outdent":"indent"](l),!1)}return t.mark(a[0]),!1}},ul:{click:function(e,t){var b,n=t.$(),r=n.value,i=n.before,l=n.after,a=I.ul[0],s=I.ol[0],u=o(a),c=f(o(s),["\\d+"]),p=m("(^|\\n)([\\t ]*) "+u+" (.*)$"),d=m("^(.*) "+u+" ","gm"),h=m("(^|\\n)([\\t ]*) "+c+" (.*)$"),g=m("^(.*) "+c+" ","gm"),$=C[""];return r?(r===$?t.select():g.test(r)?t.replace(g,"$1 "+a+" "):d.test(r)?t.replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&l?(b=h.test(i)?i.replace(h,"$1$2 "+a+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(b+l).select(b.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert($)[1](),!1)}},ol:{click:function(e,t){var k,n=t.$(),r=n.value,i=n.before,l=n.after,a=I.ul[0],s=I.ol[0],u=f(s,[1]),c=o(a),p=f(o(s),["\\d+"]),d=m("(^|\\n)([\\t ]*) "+c+" (.*)$"),h=m("^(.*) "+c+" ","gm"),g=m("(^|\\n)([\\t ]*) "+p+" (.*)$"),$=m("^(.*) "+p+" ","gm"),b=C[""],v=0;return r?(r===b?t.select():h.test(r)?t.replace(h,function(e,t,n){return++v,t+" "+f(s,[v])+" "}):$.test(r)?t.replace($,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+f(s,[v])+" "+n}),!1):i&&l?(k=d.test(i)?i.replace(d,"$1$2 "+u+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+u+" $3"),t.set(k+l).select(k.length),!1):(t[0]().tidy("\n\n").insert(" "+u+" ",-1).insert(b)[1](),!1)}},table:O?function(e,t){var o,u,c,n=T.tr,r=T.td,i=S.modals.table,l=S.placeholders.table,a=f(l[0],[1,1]),s=[];return t.$().value===a?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,p,d){u=k(y(p)||d,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,i){c=k(y(r)||i,n[0],n[1]);var p,d,h,g,$,m;for(p=0;c>p;++p){for(o="|",d=0;u>d;++d)o+=" "+f(l[1],[p+1,d+1])+" |";s.push(o)}for(s=s.join("\n"),o="|",h=0;u>h;++h)o+=" "+f(l[0],[h+1,h+1]).replace(/./g,"-")+" |";for(s=o+"\n"+s,o="|",g=0;u>g;++g)o+=" "+f(l[0],[1,g+1])+" |";s=o+"\n"+s,E.close_tr||(s=s.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(s),$=t.$(),m=$.start+$.value.indexOf(a),t.select(m,m+a.length)[1]()})}),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(I.hr[0]+"\n\n",-1),!1}}}),s(a.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=E.advance_br;return!d(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1).scroll(!0),!1},enter:function(e,t){var n=t.$(),r=I.blockquote,l=(I.ul[0],I.ol[0]),a=f(o(l),["\\d+"]),s="(("+o(r)+" )+|"+z+"| +("+a+") )",u=m("^"+s+".*$","gm").exec(n.before.split("\n").pop());if(u){if(u[0]===u[1])return t.outdent(m(s)),!1;if(m("\\s*"+a+"\\s*").test(u[1])){var c=y(b(u[1]));return t.insert("\n"+u[1].replace(/\d+/,c+1),-1).scroll(!0),!1}return t.insert("\n"+u[1],-1).scroll(!0),!1}},"shift+tab":function(e,t){var $,n=t.$(),r=n.before,i=n.value,l=n.after,s=I.ol[0],u=o(s),c=f(u,["\\d+"]),p=o(I.blockquote),d=m("  "+z+"$"),h=m("   ( ?"+c+" )$"),g="("+p+" |"+z+"| +"+c+" )";if(i){if(i&&($=i.match(m("(^|\\n)"+g,"g"))))return t.outdent(m(g)),!1}else{if($=r.match(m(p+" $")))return t.outdent($[0]),!1;if($=r.match(d))return r=r.replace(d,"$1"),t.set(r+l).select(r.length),!1;if($=r.match(h))return r=r.replace(h,"$1"),t.set(r+l).select(r.length),!1}return a.tools.outdent.click(e,t)},tab:function(e,t){var g,n=t.$(),r=n.before,i=n.value,l=n.after,s=I.ol[0],u=I.blockquote,c=o(s),p=o(u),d=m(z+"$"),h=m(" ?"+f(c,["\\d+"])+" $");if(i){if(m("^"+p+" ").test(i))return t.indent(u+" "),!1}else{if(g=r.match(m(p+" $")))return t.insert(g[0],-1),!1;if(g=r.match(d))return r=r.replace(d,"  $1"),t.set(r+l).select(r.length),!1;if(g=r.match(h))return r=r.replace(h,"    "+f(s,[1])+" "),t.set(r+l).select(r.length),!1}return a.tools.indent.click(e,t)}}),l.update({},0)};
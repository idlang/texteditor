/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function o(e){return"object"==typeof e}function a(e,t){return RegExp(e,t)}function u(e){return e.replace(/^\s*|\s*$/g,"")}function l(e){return e.replace(/\s+$/,"")}function c(e,t,n){return t>e?t:e>n?n:e}function s(e){return f(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function f(e){return u(e.replace(/\s+/g," "))}var p,d,h,b,g,m,v,y,k,$,w=new TE.HTML(e),x=w.ui,T=w._.extend,_=(w._.each,w._.x),E=w._.format,L="\t";return w.update(T({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",w.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0),w.type="Markdown",p=w.config,d=p.states,h=p.languages,b=p.formats,g=p.classes,m=p.tab,v=h.placeholders,y=0,k=p.extra,$="( +["+_(b.ul).join("")+"] )",k||(p["advance_pre,code"]=0),w.mark=function(e,t,r,i){o(e)||(e=[e]),n(r)||(r=" "),n(i)||(i="");var u=w[0]().$(),l=e[0]+i,c=i+(n(e[1])?e[1]:e[0]),s=u.value,f=_(l),p=_(c),d=a("^"+f+"([\\s\\S]*?)"+p+"$"),h=a(f+"$"),b=a("^"+p),g=u.before,m=u.after;return s?r=!1:w.insert(v[""]),w.toggle(t?!d.test(s):!h.test(g)&&!b.test(m),[function(e){e.unwrap(l,c,1).tidy(/<[^\/<>]+?>$/.test(g)?"":r,/^<\/[^<>]+?>/.test(m)?"":r).wrap(l,c,t)[1]()},function(e){e.unwrap(l,c,t)[1]()}])},T(x.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(b.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(b.i[0]),!1}},u:0,s:k?{i:"strikethrough",click:function(e,t){return t.i().mark(b.s),!1}}:0,a:{i:"link",click:function(e,t){var n,r,o,i,a,c,p,b=t.$(),g=b.before,m=b.value,y=b.after,k=t.get(),$=/^ {0,3}\[[^\^]+?\]:/.test(k.split("\n").pop())?"\n":"\n\n",w=k.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],x=h.modals.a,T=x.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(m))return t.tidy(" ").mark(["<",">"],1),!1;for(p in w)p=" "+u(w[p]).replace(/^\[|\]:$/g,""),d.a[p]=1;return n=d.a,t.record().ui.prompt(["a[href]",x.title[0]],T,0,function(e,t,p){var d=""===p;p=f(p),t[0](),n[p]?(t.trim(u(g)?" ":"",/^\n+ {0,3}\*?\[/.test(y)?!1:" ").mark(["[","]["+p+"]"],0,!1),i=w.indexOf(" ["+p+"]:"),-1===i&&1!==n[p]&&(b=t.$(),g=b.before,a=b.start,c=b.end,t.set(g+b.value+l(b.after)+$+" ["+(p||u(m)||v[""])+"]: "+(d?"":n[p][0]+(n[p][1]?' "'+n[p][1]+'"':""))).select(a,c),d&&t.focus(!0).insert(T))):(r=p,t.blur().ui.prompt(["a[title]",x.title[1]],x.placeholder[1],0,function(e,t,n){o=s(n),m||t.insert(v[""]),t.i().trim(u(g)?" ":"",u(y)?/^\n+ {0,3}\*?\[/.test(y)?"\n\n ":" ":"").wrap("[","]("+r+(o?' "'+o+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var n,r,o,a,l,c,p=t.$(),b=p.value,g=p.before,m=p.after,v=t.get(),y=/^ {0,3}\[[^\^]+?\]:/.test(v.split("\n").pop())?"\n":"\n\n",k=v.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],$=h.modals.img,w=/^\n* {0,3}\[.+?\]:/.test(m)?" ":"",x=u(m);for(i in k)i=" "+u(k[i]).replace(/^\[|\]:$/g,""),!d.img[i]&&(d.img[i]=1);return n=d.img,t.ui.prompt(["img[src]",$.title[0]],$.placeholder[0],1,function(e,t,i){i=f(i),r=i,b||(b=r.split(/[\/\\\\]/).pop()),b=s(b),t[0]().trim(u(g)?"\n\n":"",w).insert(""),n[i]?(t.insert("!["+b+"]["+i+"]\n\n",-1),w&&t.select(t.$().start),a=k.indexOf(" ["+i+"]:"),-1===a&&(p=t.$(),g=p.before,l=p.start,c=p.end,t.set(g+p.value+p.after+(x?y:"")+" ["+i+"]: "+n[i][0]+(n[i][1]?' "'+n[i][1]+'"':"")).select(l,c))):t.blur().ui.prompt(["img[title]",$.title[1]],$.placeholder[1],0,function(e,t,n){o=s(n),t.insert("!["+b+"]("+r+(o?' "'+o+'"':"")+")\n\n",-1),w&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:k?{i:"thumb-tack",click:function(e,t){var n,r=t.$(),o=r.before,i=r.after,a=h.modals.sup,c=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(c.split("\n").pop())?"\n":"\n\n",f=c.match(/^ {0,3}\[\^.+?\]:/gm)||[],p=0;for(p in f)f[p]=" "+u(f[p]);return p=f.length+1,t.ui.prompt(["sup[id]",a.title],r.value||a.placeholder||p,0,function(e,t,r){r=u(r)||p,n=f.indexOf(" [^"+r+"]:"),-1!==n?(p=c.indexOf(f[n])+3,t.select(p,p+r.length)):t.trim(u(o)?" ":"",!u(i)||/^\n+ {0,3}\*?\[/.test(i)?"\n\n ":" ").insert("[^"+r+"]").set(l(t.get())+s+" [^"+r+"]: ").focus(!0).insert(v[""])}),!1}}:0,abbr:k?{i:"question",click:function(e,t){var n=t.$(),r=u(n.value),o=h.modals.abbr,i=t.get(),a=u(r||v[""]),c=/^ {0,3}\*\[.+?\]:/.test(i.split("\n").pop())?"\n":"\n\n",s=i.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=d.abbr,p=0;for(p in s)s[p]=" "+u(s[p]);return p=s.indexOf(" *["+a+"]:"),r&&-1!==p?(p=i.indexOf(s[p])+3,t.select(p,p+a.length),!1):(t.record().ui.prompt(["abbr[title]",o.title],f[a]||o.placeholder,!f[r],function(e,t,o,i){if(o=u(o),t.set(l(t.get())+(n.before||r?c:"")+" *["+a+"]: ").focus(!0).insert(o||i),a===v[""]){var s=t.$().start;t.select(s-3-a.length,s-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(v[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){y>5?y=0:y++;var n=t.$(),r=p["advance_h1,h2"],o="\\s?["+_(b.h1[0]+b.h2[0])+"]+\\s*",i=_(b.h1[1]),u=n.before.replace(a("["+i+"\\s]+$"),""),l=f(n.value).replace(a("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(a(o+"$"),"")||v[""],c=n.after.replace(a("^["+i+"\\s]+"),"").replace(a("^"+o),""),s=["",b.h1[r?0:1],b.h2[r?0:1],b.h3,b.h4,b.h5,b.h6];return t[0]().set(u+l+c).select(u.length,(u+l).length).tidy("\n\n"),0===y||(3>y&&r?t.wrap("","\n"+l.replace(/./g,s[y])):t.wrap(s[y]+" ",p["close_h1,h2,h3,h4,h5,h6"]?" "+s[y]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,o=b.blockquote;return r===v[""]?(t.select(),!1):r?(t.tidy(a(o+" $").test(n.before)?!1:"\n\n")[a("^"+o).test(r)?"outdent":"indent"](o+" "),!1):(t[0]().tidy("\n\n").insert(o+" ",-1).insert(v[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n,o,i,u=t.$(),l=u.before,c=u.value,s=p["advance_pre,code"],f=b.code,d=f[1]||f[0];return d=d+d+d,!r(s)&&s?s=d:r(s)&&-1!==s.indexOf("%1")&&(s=E(s,[d])),n="( {4,}|\\t"+(r(s)?"|"+_(s):"")+")",a("(^|\\n)"+n+"?$").test(l)?s?(t.mark([s,s.split(/\s+/)[0]],0,"\n\n","\n"),!1):(s=m===L?L:"    ",c?c===v[""]&&a(n+"$").test(l)?(t.select(u.start-s.length,u.end),!1):(t.tidy("\n\n")[a("^"+n).test(c)?"outdent":"indent"](s),!1):(t[0]().tidy("\n\n"),o=t.$().start,i=s+v[""],t.insert(i).select(o+s.length,o+i.length)[1](),!1)):(t.mark(f[0]),!1)}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,u=r.after,l=b.ul[0],c=b.ol,s=_(l),f=E(_(c),["\\d+"]),p=a("(^|\\n)([\\t ]*) "+s+" (.*)$"),d=a("^(.*) "+s+" ","gm"),h=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=a("^(.*) "+f+" ","gm");return o?(o===v[""]?t.select():g.test(o)?t.replace(g,"$1 "+l+" "):d.test(o)?t[0]().replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+l+" $2"),!1):i&&u?(n=h.test(i)?i.replace(h,"$1$2 "+l+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(n+u).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",-1).insert(v[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,u=r.after,l=b.ul[0],c=b.ol,s=E(c,[1]),f=_(l),p=E(_(c),["\\d+"]),d=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),h=a("^(.*) "+f+" ","gm"),g=a("(^|\\n)([\\t ]*) "+p+" (.*)$"),m=a("^(.*) "+p+" ","gm"),y=0;return o?(o===v[""]?t.select():h.test(o)?t.replace(h,function(e,t){return++y,t+" "+E(c,[y])+" "}):m.test(o)?t[0]().replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++y,t+" "+E(c,[y])+" "+n}),!1):i&&u?(n=d.test(i)?i.replace(d,"$1$2 "+s+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+u).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(v[""])[1](),!1)}},table:k?function(e,t){var n,r,o,i=d.tr,a=d.td,u=h.modals.table,l=h.placeholders.table,s=E(l[0],[1,1]),f=[];return t.$().value===s?(t.select(),!1):(t[0]().insert("").ui.prompt(["table>td",u.title[0]],u.placeholder[0],0,function(e,t,d,h){r=c(parseInt(d,10)||h,a[0],a[1]),t.blur().ui.prompt(["table>tr",u.title[1]],u.placeholder[1],0,function(e,t,a,u){o=c(parseInt(a,10)||u,i[0],i[1]);var d,h,b,g,m,v;for(d=0;o>d;++d){for(n="|",h=0;r>h;++h)n+=" "+E(l[1],[d+1,h+1])+" |";f.push(n)}for(f=f.join("\n"),n="|",b=0;r>b;++b)n+=" "+E(l[0],[b+1,b+1]).replace(/./g,"-")+" |";for(f=n+"\n"+f,n="|",g=0;r>g;++g)n+=" "+E(l[0],[1,g+1])+" |";f=n+"\n"+f,p.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f,1),m=t.$(),v=m.start+m.after.indexOf(s),t.select(v,v+s.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(b.hr[0]+"\n\n",-1),!1}}}),T(x.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=p.advance_br;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n,r=t.$(),o=b.blockquote,i=(b.ul[0],b.ol),l=E(_(i),["\\d+"]),c="(("+_(o)+" )+|"+$+"| +("+l+") )",s=a("^"+c+".*$","gm").exec(r.before.split("\n").pop());return s?s[0]===s[1]?(t.outdent(a(c)),!1):a("\\s*"+l+"\\s*").test(s[1])?(n=parseInt(u(s[1]),10),t.insert("\n"+s[1].replace(/\d+/,n+1),-1).scroll("+1"),!1):(t.insert("\n"+s[1],-1).scroll("+1"),!1):void 0},"shift+tab":function(e,t){var n,r=t.$(),o=r.before,i=r.value,u=r.after,l=b.ol,c=_(l),s=E(c,["\\d+"]),f=_(b.blockquote),p=a("  "+$+"$"),d=a("   ( ?"+s+" )$"),h="("+f+" |"+$+"| +"+s+" )";if(i){if(i&&(n=i.match(a("(^|\\n)"+h,"g"))))return t.outdent(a(h)),!1}else{if(n=o.match(a(f+" $")))return t.outdent(n[0]),!1;if(n=o.match(p))return o=o.replace(p,"$1"),t.set(o+u).select(o.length),!1;if(n=o.match(d))return o=o.replace(d,"$1"),t.set(o+u).select(o.length),!1}return x.tools.outdent.click(e,t)},tab:function(e,t){var n,r=t.$(),o=r.before,i=r.value,u=r.after,l=b.ol,c=_(l),s=a($+"$"),f=a(" ?"+E(c,["\\d+"])+" $");if(!i){if(n=o.match(a(_(b.blockquote)+" $")))return t.insert(n[0],-1),!1;if(n=o.match(s))return o=o.replace(s,"  $1"),t.set(o+u).select(o.length),!1;if(n=o.match(f))return o=o.replace(f,"    "+E(l,[1])+" "),t.set(o+u).select(o.length),!1}return x.tools.indent.click(e,t)}}),w.update({},0)};
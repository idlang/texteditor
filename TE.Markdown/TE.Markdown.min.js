/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.0.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function o(e){return"function"==typeof e}function i(e){return"object"==typeof e}function u(e,t){return RegExp(e,t)}function c(e){return e.replace(/^\s*|\s*$/g,"")}function l(e){return e.replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}var a="\u2026",s="\u2193",f="\u2318",d=new TE.HTML(e,{auto_p:0,auto_close:{"`":"`"},languages:{tools:{footnote:"Footnote ("+f+"+"+s+")"},modals:{img:{title:["Image URL","Image Title"],placeholder:["http://","image title here"+a]},footnote:{title:"Footnote ID"}}},enable_setext_header:1,enable_closed_atx_header:0,enable_fenced_code_block:0,enable_hard_break:1,formats:{b:"**",i:"_",s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:"`",ul:"-",ol:"%1.",hr:"---"}}),p=d.ui,h=d._.extend,g=d._.each,v=d._.x,b=d._.format;TE.Markdown.__instance__.push(d);var m=d.config,y=m.languages,$=m.formats,w=(m.classes,m.tab),k=(m.suffix,y.others.placeholder),x=0;return d.mark=function(e,t,r,o){i(e)||(e=[e]),n(r)||(r=" "),n(o)||(o="");var c=d[0]().$(),l=e[0]+o,a=o+(n(e[1])?e[1]:e[0]),s=v(l),f=v(a),p=u("^"+s+"([\\s\\S]*?)"+f+"$"),h=u(s+"$"),g=u("^"+f),b=c.before,m=c.after;return c.length||d.insert(k),d.toggle(t?!p.test(c.value):!h.test(b)&&!g.test(m),[function(e){e.unwrap(l,a,1).tidy(/<[^\/<>]+?>$/.test(b)?"":r,/^<\/[^<>]+?>/.test(m)?"":r).wrap(l,a,t)[1]()},function(e){e.unwrap(l,a,t)[1]()}])},h(p.tools,{b:{i:"bold",click:function(e,t){return t.mark($.b),!1}},i:{i:"italic",click:function(e,t){return t.mark($.i),!1}},u:0,s:{i:"strikethrough",click:function(e,t){return t.mark($.s),!1}},a:{i:"link",click:function(e,t){var n,r,o=($.a,y.modals.a);return t.record().ui.prompt(o.title[0],o.placeholder[0],1,function(e,t,i){n=i,t.blur().ui.prompt(o.title[1],o.placeholder[1],0,function(e,t,o){r=l(o),t.$().length||t.insert(k),t.mark(["[","]("+n+(r?' "'+r+'"':"")+")"])})}),!1}},img:{i:"image",click:function(e,t){var n,r,o=t.$(),i=o.value,u=y.modals.img;return t.record().ui.prompt(u.title[0],u.placeholder[0],1,function(e,t,o){n=o,t.blur().ui.prompt(u.title[1],u.placeholder[1],0,function(e,t,o){r=o,i.length||(i=n.split(/[\/\\\\]/).pop()),i=l(i),t.tidy("\n\n","").insert("!["+i+"]("+n+(r?' "'+r+'"':"")+")\n\n",-1)})}),!1}},footnote:{i:"thumb-tack",click:function(e,t){var n=t.$(),r=y.modals.footnote,o=t.get(),i=/^ \[\^.*?\]:/.test(o.split("\n").pop())?"\n":"\n\n",u=o.match(/^ \[\^.*?\]:/gm)||[],c=u.length+1;if(n.before.length)return t.ui.prompt(r.title,r.placeholder||c,1,function(e,t,r){var l=u.indexOf(" [^"+r+"]:");-1!==l?(c=o.indexOf(u[l])+3,t.select(c,c+r.length)):t.trim(" ",!n.after.length||/^\n/.test(n.after)?!1:" ").insert("[^"+r+"]").set(t.get()+i+" [^"+r+"]: ").focus(!0).insert(k)}),!1}},sub:0,sup:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(k),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){x>5?x=0:x++;var n=t.$(),r=m.enable_setext_header,o=v($.h1[0]+$.h2[0]),i=n.before.replace(/[#\s]+$/,""),c=n.length?n.value.replace(/\s+/g," ").replace(/^[#\s]+|[#\s]+$/g,"").replace(u("^\\s?["+o+"]+\\s*"),""):k,l=n.after.replace(/^[#\s]+/,"").replace(u("^\\s?["+o+"]+\\s*"),""),a=["",$.h1[r?0:1],$.h2[r?0:1],$.h3,$.h4,$.h5,$.h6];return t[0]().set(i+c+l).select(i.length,(i+c).length).tidy("\n\n"),0===x||(3>x&&r?t.wrap("","\n"+c.replace(/./g,a[x])):t.wrap(a[x]+" ",m.enable_closed_atx_header?" "+a[x]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=$.blockquote;return n.value===k?(t.select(),!1):n.length?(t.tidy("\n\n")[u("^"+r).test(n.value)?"outdent":"indent"](r+" "),!1):(t[0]().tidy("\n\n").insert(r+" ",-1).insert(k)[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),o=m.enable_fenced_code_block,i=$.code;return!r(o)&&o&&(o="~~~"),/(^|\n)$/.test(n.before)?o?(t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1):(n.length||t.insert(k),t.tidy("\n\n")[/^(\t| {4})/.test(n.value)?"outdent":"indent"]("\t"===w?"\t":"    "),!1):(t.mark(i),!1)}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,c=r.after,l=$.ul,a=$.ol,s=v(l),f=b(v(a),["\\d+"]),d=u("(^|\\n)([\\t ]*) "+s+" (.*)$"),p=u("^(.*) "+s+" ","gm"),h=u("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=u("^(.*) "+f+" ","gm");return r.length?(o===k?t.select():g.test(o)?t.replace(g,"$1 "+l+" "):p.test(o)?t[0]().replace(p,"$1"):t.replace(/^(\s*)(\S+)$/gm,"$1 "+l+" $2"),!1):i.length&&c.length?(n=h.test(i)?i.replace(h,"$1$2 "+l+" $3"):d.test(i)?i.replace(d,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+l+" $3"),t.set(n+c).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+l+" ",-1).insert(k)[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,c=r.after,l=$.ul,a=$.ol,s=b(a,[1]),f=v(l),d=b(v(a),["\\d+"]),p=u("(^|\\n)([\\t ]*) "+f+" (.*)$"),h=u("^(.*) "+f+" ","gm"),g=u("(^|\\n)([\\t ]*) "+d+" (.*)$"),m=u("^(.*) "+d+" ","gm"),y=0;return r.length?(o===k?t.select():h.test(o)?t.replace(h,function(e,t){return++y,t+" "+b(a,[y])+" "}):m.test(o)?t[0]().replace(m,"$1"):t.replace(/^(\s*)(\S+)$/gm,function(e,t,n){return++y,t+" "+b(a,[y])+" "+n}),!1):i.length&&c.length?(n=p.test(i)?i.replace(p,"$1$2 "+s+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+c).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(k)[1](),!1)}},"align-left":0,"align-center":0,"align-right":0,"align-justify":0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert($.hr+"\n\n",-1),!1}}}),g(p.tools,function(e,t){var n=y.tools[t]||"";o(e)?p.tools[t]={title:n,click:e}:e.title||(e.title=n)}),h(p.keys,{"control+u":0,"control+arrowup":0,"control+arrowdown":"footnote","shift+enter":function(e,t){var n=m.enable_hard_break;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=$.blockquote,o=$.ul,i=$.ol,l=b(v(i),["\\d+"]),a="((?:"+v(r)+" *)+| +(?:"+v(o)+"|"+l+") )",s=u("^"+a+".*$","gm").exec(n.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(u(a)),!1;if(u("\\s*"+l+"\\s*").test(s[1])){var f=parseInt(c(s[1]),10);return t.insert("\n"+s[1].replace(/\d+/,f+1),-1).scroll("+1"),!1}return t.insert("\n"+s[1],-1).scroll("+1"),!1}}}),d.update(h({tools:"b i u | a img footnote | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | hr | undo redo"},t),0)},TE.Markdown.__instance__=[];
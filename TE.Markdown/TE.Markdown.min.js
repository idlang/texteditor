/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function o(e){return"object"==typeof e}function a(e,t){return RegExp(e,t)}function l(e){return e.replace(/^\s*|\s*$/g,"")}function c(e){return e.replace(/\s+$/,"")}function u(e,t,n){return t>e?t:e>n?n:e}function s(e){return f(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function f(e){return l(e.replace(/\s+/g," "))}var p=new TE.HTML(e),d=p.ui,h=p._.extend,b=(p._.each,p._.x),g=p._.format,m="\t";p.update(h({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote"]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0),p.type="Markdown";var $=p.config,v=$.states,k=$.languages,y=$.formats,w=($.classes,$.tab),x=k.placeholders,_=0,T=$.extra,q="( +["+b(y.ul).join("")+"] )";return T||($["advance_pre,code"]=0),p.mark=function(e,t,r,i){o(e)||(e=[e]),n(r)||(r=" "),n(i)||(i="");var l=p[0]().$(),c=e[0]+i,u=i+(n(e[1])?e[1]:e[0]),s=l.value,f=b(c),d=b(u),h=a("^"+f+"([\\s\\S]*?)"+d+"$"),g=a(f+"$"),m=a("^"+d),$=l.before,v=l.after;return s?r=!1:p.insert(x[""]),p.toggle(t?!h.test(s):!g.test($)&&!m.test(v),[function(e){e.unwrap(c,u,1).tidy(/<[^\/<>]+?>$/.test($)?"":r,/^<\/[^<>]+?>/.test(v)?"":r).wrap(c,u,t)[1]()},function(e){e.unwrap(c,u,t)[1]()}])},h(d.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(y.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(y.i[0]),!1}},u:0,s:T?{i:"strikethrough",click:function(e,t){return t.i().mark(y.s),!1}}:0,a:{i:"link",click:function(e,t){var n,r,i,o,a,u,p,d=t.$(),h=d.before,b=d.value,g=d.after,m=t.get(),$=/^ {0,3}\[[^\^]+?\]:/.test(m.split("\n").pop())?"\n":"\n\n",y=m.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],w=k.modals.a,_=w.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(b))return t.tidy(" ").mark(["<",">"],1),!1;for(p in y)p=" "+l(y[p]).replace(/^\[|\]:$/g,""),v.a[p]=1;return n=v.a,t.record().ui.prompt(["a[href]",w.title[0]],_,0,function(e,t,p){var m=""===p;p=f(p),t[0](),n[p]?(t.trim(l(h)?" ":"",/^\n+ {0,3}\*?\[/.test(g)?!1:" ").mark(["[","]["+p+"]"],0,!1),o=y.indexOf(" ["+p+"]:"),-1===o&&1!==n[p]&&(d=t.$(),h=d.before,a=d.start,u=d.end,t.set(h+d.value+c(d.after)+$+" ["+(p||l(b)||x[""])+"]: "+(m?"":n[p][0]+(n[p][1]?' "'+n[p][1]+'"':""))).select(a,u),m&&t.focus(!0).insert(_))):(r=p,t.blur().ui.prompt(["a[title]",w.title[1]],w.placeholder[1],0,function(e,t,n){i=s(n),b||t.insert(x[""]),t.i().trim(l(h)?" ":"",l(g)?/^\n+ {0,3}\*?\[/.test(g)?"\n\n ":" ":"").wrap("[","]("+r+(i?' "'+i+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var n,r,o,a,c,u,p=t.$(),d=p.value,h=p.before,b=p.after,g=t.get(),m=/^ {0,3}\[[^\^]+?\]:/.test(g.split("\n").pop())?"\n":"\n\n",$=g.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],y=k.modals.img,w=/^\n* {0,3}\[.+?\]:/.test(b)?" ":"",x=l(b);for(i in $)i=" "+l($[i]).replace(/^\[|\]:$/g,""),!v.img[i]&&(v.img[i]=1);return n=v.img,t.ui.prompt(["img[src]",y.title[0]],y.placeholder[0],1,function(e,t,i){i=f(i),r=i,d||(d=r.split(/[\/\\\\]/).pop()),d=s(d),t[0]().trim(l(h)?"\n\n":"",w).insert(""),n[i]?(t.insert("!["+d+"]["+i+"]\n\n",-1),w&&t.select(t.$().start),a=$.indexOf(" ["+i+"]:"),-1===a&&(p=t.$(),h=p.before,c=p.start,u=p.end,t.set(h+p.value+p.after+(x?m:"")+" ["+i+"]: "+n[i][0]+(n[i][1]?' "'+n[i][1]+'"':"")).select(c,u))):t.blur().ui.prompt(["img[title]",y.title[1]],y.placeholder[1],0,function(e,t,n){o=s(n),t.insert("!["+d+"]("+r+(o?' "'+o+'"':"")+")\n\n",-1),w&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:T?{i:"thumb-tack",click:function(e,t){var n,r=t.$(),i=r.before,o=r.after,a=k.modals.sup,u=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(u.split("\n").pop())?"\n":"\n\n",f=u.match(/^ {0,3}\[\^.+?\]:/gm)||[],p=0;for(p in f)f[p]=" "+l(f[p]);return p=f.length+1,t.ui.prompt(["sup[id]",a.title],r.value||a.placeholder||p,0,function(e,t,r){r=l(r)||p,n=f.indexOf(" [^"+r+"]:"),-1!==n?(p=u.indexOf(f[n])+3,t.select(p,p+r.length)):t.trim(l(i)?" ":"",!l(o)||/^\n+ {0,3}\*?\[/.test(o)?"\n\n ":" ").insert("[^"+r+"]").set(c(t.get())+s+" [^"+r+"]: ").focus(!0).insert(x[""])}),!1}}:0,abbr:T?{i:"question",click:function(e,t){var n=t.$(),r=l(n.value),i=k.modals.abbr,o=t.get(),a=l(r||x[""]),u=/^ {0,3}\*\[.+?\]:/.test(o.split("\n").pop())?"\n":"\n\n",s=o.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=v.abbr,p=0;for(p in s)s[p]=" "+l(s[p]);return p=s.indexOf(" *["+a+"]:"),r&&-1!==p?(p=o.indexOf(s[p])+3,t.select(p,p+a.length),!1):(t.record().ui.prompt(["abbr[title]",i.title],f[a]||i.placeholder,!f[r],function(e,t,i,o){if(i=l(i),t.set(c(t.get())+(n.before||r?u:"")+" *["+a+"]: ").focus(!0).insert(i||o),a===x[""]){var s=t.$().start;t.select(s-3-a.length,s-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(x[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){_>5?_=0:_++;var n=t.$(),r=$["advance_h1,h2"],i="\\s?["+b(y.h1[0]+y.h2[0])+"]+\\s*",o=b(y.h1[1]),l=n.before.replace(a("["+o+"\\s]+$"),""),c=f(n.value).replace(a("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(a(i+"$"),"")||x[""],u=n.after.replace(a("^["+o+"\\s]+"),"").replace(a("^"+i),""),s=["",y.h1[r?0:1],y.h2[r?0:1],y.h3,y.h4,y.h5,y.h6];return t[0]().set(l+c+u).select(l.length,(l+c).length).tidy("\n\n"),0===_||(3>_&&r?t.wrap("","\n"+c.replace(/./g,s[_])):t.wrap(s[_]+" ",$["close_h1,h2,h3,h4,h5,h6"]?" "+s[_]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,i=y.blockquote;return r===x[""]?(t.select(),!1):r?(t.tidy(a(i+" $").test(n.before)?!1:"\n\n")[a("^"+i).test(r)?"outdent":"indent"](i+" "),!1):(t[0]().tidy("\n\n").insert(i+" ",-1).insert(x[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),i=n.before,o=n.value,l=$["advance_pre,code"],c=y.code,u=c[1]||c[0];u=u+u+u,!r(l)&&l?l=u:r(l)&&-1!==l.indexOf("%1")&&(l=g(l,[u]));var s="( {4,}|\\t"+(r(l)?"|"+b(l):"")+")";if(a("(^|\\n)"+s+"?$").test(i)){if(l)return t.mark([l,l.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(l=w===m?m:"    ",!o){t[0]().tidy("\n\n");var f=t.$().start,p=l+x[""];return t.insert(p).select(f+l.length,f+p.length)[1](),!1}return o===x[""]&&a(s+"$").test(i)?(t.select(n.start-l.length,n.end),!1):(t.tidy("\n\n")[a("^"+s).test(o)?"outdent":"indent"](l),!1)}return t.mark(c[0]),!1}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),i=r.value,o=r.before,l=r.after,c=y.ul[0],u=y.ol,s=b(c),f=g(b(u),["\\d+"]),p=a("(^|\\n)([\\t ]*) "+s+" (.*)$"),d=a("^(.*) "+s+" ","gm"),h=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),m=a("^(.*) "+f+" ","gm");return i?(i===x[""]?t.select():m.test(i)?t.replace(m,"$1 "+c+" "):d.test(i)?t[0]().replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+c+" $2"),!1):o&&l?(n=h.test(o)?o.replace(h,"$1$2 "+c+" $3"):p.test(o)?o.replace(p,"$1$2$3"):o.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+c+" $3"),t.set(n+l).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+c+" ",-1).insert(x[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),i=r.value,o=r.before,l=r.after,c=y.ul[0],u=y.ol,s=g(u,[1]),f=b(c),p=g(b(u),["\\d+"]),d=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),h=a("^(.*) "+f+" ","gm"),m=a("(^|\\n)([\\t ]*) "+p+" (.*)$"),$=a("^(.*) "+p+" ","gm"),v=0;return i?(i===x[""]?t.select():h.test(i)?t.replace(h,function(e,t){return++v,t+" "+g(u,[v])+" "}):$.test(i)?t[0]().replace($,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+g(u,[v])+" "+n}),!1):o&&l?(n=d.test(o)?o.replace(d,"$1$2 "+s+" $3"):m.test(o)?o.replace(m,"$1$2$3"):o.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+l).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(x[""])[1](),!1)}},table:T?function(e,t){var n,r,i,o=v.tr,a=v.td,l=k.modals.table,c=k.placeholders.table,s=g(c[0],[1,1]),f=[];return t.$().value===s?(t.select(),!1):(t[0]().insert("").ui.prompt(["table>td",l.title[0]],l.placeholder[0],0,function(e,t,p,d){r=u(parseInt(p,10)||d,a[0],a[1]),t.blur().ui.prompt(["table>tr",l.title[1]],l.placeholder[1],0,function(e,t,a,l){i=u(parseInt(a,10)||l,o[0],o[1]);var p,d,h,b,m,v;for(p=0;i>p;++p){for(n="|",d=0;r>d;++d)n+=" "+g(c[1],[p+1,d+1])+" |";f.push(n)}for(f=f.join("\n"),n="|",h=0;r>h;++h)n+=" "+g(c[0],[h+1,h+1]).replace(/./g,"-")+" |";for(f=n+"\n"+f,n="|",b=0;r>b;++b)n+=" "+g(c[0],[1,b+1])+" |";f=n+"\n"+f,$.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f,1),m=t.$(),v=m.start+m.after.indexOf(s),t.select(v,v+s.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(y.hr[0]+"\n\n",-1),!1}}}),h(d.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=$.advance_br;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=y.blockquote,i=(y.ul[0],y.ol),o=g(b(i),["\\d+"]),c="(("+b(r)+" )+|"+q+"| +("+o+") )",u=a("^"+c+".*$","gm").exec(n.before.split("\n").pop());if(u){if(u[0]===u[1])return t.outdent(a(c)),!1;if(a("\\s*"+o+"\\s*").test(u[1])){var s=parseInt(l(u[1]),10);return t.insert("\n"+u[1].replace(/\d+/,s+1),-1).scroll("+1"),!1}return t.insert("\n"+u[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var n,r=t.$(),i=r.before,o=r.value,l=r.after,c=y.ol,u=b(c),s=g(u,["\\d+"]),f=b(y.blockquote),p=a("  "+q+"$"),h=a("   ( ?"+s+" )$"),m="("+f+" |"+q+"| +"+s+" )";if(o){if(o&&(n=o.match(a("(^|\\n)"+m,"g"))))return t.outdent(a(m)),!1}else{if(n=i.match(a(f+" $")))return t.outdent(n[0]),!1;if(n=i.match(p))return i=i.replace(p,"$1"),t.set(i+l).select(i.length),!1;if(n=i.match(h))return i=i.replace(h,"$1"),t.set(i+l).select(i.length),!1}return d.tools.outdent.click(e,t)},tab:function(e,t){var n,r=t.$(),i=r.before,o=r.value,l=r.after,c=y.ol,u=b(c),s=a(q+"$"),f=a(" ?"+g(u,["\\d+"])+" $");if(!o){if(n=i.match(a(b(y.blockquote)+" $")))return t.insert(n[0],-1),!1;if(n=i.match(s))return i=i.replace(s,"  $1"),t.set(i+l).select(i.length),!1;if(n=i.match(f))return i=i.replace(f,"    "+g(c,[1])+" "),t.set(i+l).select(i.length),!1}return d.tools.indent.click(e,t)}}),p.update({},0)};
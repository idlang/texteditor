/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function o(e){return"object"==typeof e}function u(e,t){return RegExp(e,t)}function c(e){return e.replace(/^\s*|\s*$/g,"")}function a(e){return e.replace(/\s+$/,"")}function l(e,t,n){return t>e?t:e>n?n:e}function s(e){return f(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function f(e){return c(e.replace(/\s+/g," "))}var p="\u2193",d="\u2318",h=new TE.HTML(e),g=h.ui,v=h._.extend,m=(h._.each,h._.x),b=h._.format,y="\t";h.update(v({type:"Markdown",extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:"Footnote ("+d+"+"+p+")"},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0);var $=h.config,k=$.states,w=$.languages,x=$.formats,_=($.classes,$.tab),T=w.placeholders,E=0,C=$.extra,L="( +["+m(x.ul).join("")+"] )";return C||($["advance_pre,code"]=0),h.mark=function(e,t,r,i){o(e)||(e=[e]),n(r)||(r=" "),n(i)||(i="");var c=h[0]().$(),a=e[0]+i,l=i+(n(e[1])?e[1]:e[0]),s=c.value,f=m(a),p=m(l),d=u("^"+f+"([\\s\\S]*?)"+p+"$"),g=u(f+"$"),v=u("^"+p),b=c.before,y=c.after;return s?r=!1:h.insert(T[""]),h.toggle(t?!d.test(s):!g.test(b)&&!v.test(y),[function(e){e.unwrap(a,l,1).tidy(/<[^\/<>]+?>$/.test(b)?"":r,/^<\/[^<>]+?>/.test(y)?"":r).wrap(a,l,t)[1]()},function(e){e.unwrap(a,l,t)[1]()}])},v(g.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(x.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(x.i[0]),!1}},u:0,s:C?{i:"strikethrough",click:function(e,t){return t.i().mark(x.s),!1}}:0,a:{i:"link",click:function(e,t){var n,r,o,i,u,l,p,d=t.$(),h=d.before,g=d.value,v=d.after,m=t.get(),b=/^ {0,3}\[[^\^]+?\]:/.test(m.split("\n").pop())?"\n":"\n\n",y=m.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],$=w.modals.a,x=$.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(g))return t.tidy(" ").mark(["<",">"],1),!1;for(p in y)p=" "+c(y[p]).replace(/^\[|\]:$/g,""),k.a[p]=1;return n=k.a,t.record().ui.prompt(["a[href]",$.title[0]],x,0,function(e,t,p){var m=""===p;p=f(p),t[0](),n[p]?(t.trim(c(h)?" ":"",/^\n+ {0,3}\*?\[/.test(v)?!1:" ").mark(["[","]["+p+"]"],0,!1),i=y.indexOf(" ["+p+"]:"),-1===i&&1!==n[p]&&(d=t.$(),h=d.before,u=d.start,l=d.end,t.set(h+d.value+a(d.after)+b+" ["+(p||c(g)||T[""])+"]: "+(m?"":n[p][0]+(n[p][1]?' "'+n[p][1]+'"':""))).select(u,l),m&&t.focus(!0).insert(x))):(r=p,t.blur().ui.prompt(["a[title]",$.title[1]],$.placeholder[1],0,function(e,t,n){o=s(n),g||t.insert(T[""]),t.i().trim(c(h)?" ":"",c(v)?/^\n+ {0,3}\*?\[/.test(v)?"\n\n ":" ":"").wrap("[","]("+r+(o?' "'+o+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var n,r,o,u,a,l,p=t.$(),d=p.value,h=p.before,g=p.after,v=t.get(),m=/^ {0,3}\[[^\^]+?\]:/.test(v.split("\n").pop())?"\n":"\n\n",b=v.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],y=w.modals.img,$=/^\n* {0,3}\[.+?\]:/.test(g)?" ":"",x=c(g);for(i in b)i=" "+c(b[i]).replace(/^\[|\]:$/g,""),!k.img[i]&&(k.img[i]=1);return n=k.img,t.ui.prompt(["img[src]",y.title[0]],y.placeholder[0],1,function(e,t,i){i=f(i),r=i,d||(d=r.split(/[\/\\\\]/).pop()),d=s(d),t[0]().trim(c(h)?"\n\n":"",$).insert(""),n[i]?(t.insert("!["+d+"]["+i+"]\n\n",-1),$&&t.select(t.$().start),u=b.indexOf(" ["+i+"]:"),-1===u&&(p=t.$(),h=p.before,a=p.start,l=p.end,t.set(h+p.value+p.after+(x?m:"")+" ["+i+"]: "+n[i][0]+(n[i][1]?' "'+n[i][1]+'"':"")).select(a,l))):t.blur().ui.prompt(["img[title]",y.title[1]],y.placeholder[1],0,function(e,t,n){o=s(n),t.insert("!["+d+"]("+r+(o?' "'+o+'"':"")+")\n\n",-1),$&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:C?{i:"thumb-tack",click:function(e,t){var n,r=t.$(),o=r.before,i=r.after,u=w.modals.sup,l=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(l.split("\n").pop())?"\n":"\n\n",f=l.match(/^ {0,3}\[\^.+?\]:/gm)||[],p=0;for(p in f)f[p]=" "+c(f[p]);return p=f.length+1,t.ui.prompt(["sup[id]",u.title],r.value||u.placeholder||p,0,function(e,t,r){r=c(r)||p,n=f.indexOf(" [^"+r+"]:"),-1!==n?(p=l.indexOf(f[n])+3,t.select(p,p+r.length)):t.trim(c(o)?" ":"",!c(i)||/^\n+ {0,3}\*?\[/.test(i)?"\n\n ":" ").insert("[^"+r+"]").set(a(t.get())+s+" [^"+r+"]: ").focus(!0).insert(T[""])}),!1}}:0,abbr:C?{i:"question",click:function(e,t){var n=t.$(),r=c(n.value),o=w.modals.abbr,i=t.get(),u=c(r||T[""]),l=/^ {0,3}\*\[.+?\]:/.test(i.split("\n").pop())?"\n":"\n\n",s=i.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=k.abbr,p=0;for(p in s)s[p]=" "+c(s[p]);return p=s.indexOf(" *["+u+"]:"),r&&-1!==p?(p=i.indexOf(s[p])+3,t.select(p,p+u.length),!1):(t.record().ui.prompt(["abbr[title]",o.title],f[u]||o.placeholder,!f[r],function(e,t,o,i){if(o=c(o),t.set(a(t.get())+(n.before||r?l:"")+" *["+u+"]: ").focus(!0).insert(o||i),u===T[""]){var s=t.$().start;t.select(s-3-u.length,s-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(T[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){E>5?E=0:E++;var n=t.$(),r=$["advance_h1,h2"],o="\\s?["+m(x.h1[0]+x.h2[0])+"]+\\s*",i=m(x.h1[1]),c=n.before.replace(u("["+i+"\\s]+$"),""),a=f(n.value).replace(u("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(u(o+"$"),"")||T[""],l=n.after.replace(u("^["+i+"\\s]+"),"").replace(u("^"+o),""),s=["",x.h1[r?0:1],x.h2[r?0:1],x.h3,x.h4,x.h5,x.h6];return t[0]().set(c+a+l).select(c.length,(c+a).length).tidy("\n\n"),0===E||(3>E&&r?t.wrap("","\n"+a.replace(/./g,s[E])):t.wrap(s[E]+" ",$["close_h1,h2,h3,h4,h5,h6"]?" "+s[E]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,o=x.blockquote;return r===T[""]?(t.select(),!1):r?(t.tidy(u(o+" $").test(n.before)?!1:"\n\n")[u("^"+o).test(r)?"outdent":"indent"](o+" "),!1):(t[0]().tidy("\n\n").insert(o+" ",-1).insert(T[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),o=n.before,i=n.value,c=$["advance_pre,code"],a=x.code,l=a[1]||a[0];l=l+l+l,!r(c)&&c?c=l:r(c)&&-1!==c.indexOf("%1")&&(c=b(c,[l]));var s="( {4,}|\\t"+(r(c)?"|"+m(c):"")+")";if(u("(^|\\n)"+s+"?$").test(o)){if(c)return t.mark([c,c.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(c=_===y?y:"    ",!i){t[0]().tidy("\n\n");var f=t.$().start,p=c+T[""];return t.insert(p).select(f+c.length,f+p.length)[1](),!1}return i===T[""]&&u(s+"$").test(o)?(t.select(n.start-c.length,n.end),!1):(t.tidy("\n\n")[u("^"+s).test(i)?"outdent":"indent"](c),!1)}return t.mark(a[0]),!1}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,c=r.after,a=x.ul[0],l=x.ol,s=m(a),f=b(m(l),["\\d+"]),p=u("(^|\\n)([\\t ]*) "+s+" (.*)$"),d=u("^(.*) "+s+" ","gm"),h=u("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=u("^(.*) "+f+" ","gm");return o?(o===T[""]?t.select():g.test(o)?t.replace(g,"$1 "+a+" "):d.test(o)?t[0]().replace(d,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+a+" $2"),!1):i&&c?(n=h.test(i)?i.replace(h,"$1$2 "+a+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(n+c).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert(T[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,c=r.after,a=x.ul[0],l=x.ol,s=b(l,[1]),f=m(a),p=b(m(l),["\\d+"]),d=u("(^|\\n)([\\t ]*) "+f+" (.*)$"),h=u("^(.*) "+f+" ","gm"),g=u("(^|\\n)([\\t ]*) "+p+" (.*)$"),v=u("^(.*) "+p+" ","gm"),y=0;return o?(o===T[""]?t.select():h.test(o)?t.replace(h,function(e,t){return++y,t+" "+b(l,[y])+" "}):v.test(o)?t[0]().replace(v,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++y,t+" "+b(l,[y])+" "+n}),!1):i&&c?(n=d.test(i)?i.replace(d,"$1$2 "+s+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+c).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(T[""])[1](),!1)}},table:C?function(e,t){var n,r,o,i=k.tr,u=k.td,c=w.modals.table,a=w.placeholders.table,s=b(a[0],[1,1]),f=[];return t.$().value===s?(t.select(),!1):(t[0]().insert("").ui.prompt(["table>td",c.title[0]],c.placeholder[0],0,function(e,t,p,d){r=l(parseInt(p,10)||d,u[0],u[1]),t.blur().ui.prompt(["table>tr",c.title[1]],c.placeholder[1],0,function(e,t,u,c){o=l(parseInt(u,10)||c,i[0],i[1]);var p,d,h,g,v,m;for(p=0;o>p;++p){for(n="|",d=0;r>d;++d)n+=" "+b(a[1],[p+1,d+1])+" |";f.push(n)}for(f=f.join("\n"),n="|",h=0;r>h;++h)n+=" "+b(a[0],[h+1,h+1]).replace(/./g,"-")+" |";for(f=n+"\n"+f,n="|",g=0;r>g;++g)n+=" "+b(a[0],[1,g+1])+" |";f=n+"\n"+f,$.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f,1),v=t.$(),m=v.start+v.after.indexOf(s),t.select(m,m+s.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(x.hr[0]+"\n\n",-1),!1}}}),v(g.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=$.advance_br;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=x.blockquote,o=(x.ul[0],x.ol),i=b(m(o),["\\d+"]),a="(("+m(r)+" )+|"+L+"| +("+i+") )",l=u("^"+a+".*$","gm").exec(n.before.split("\n").pop());if(l){if(l[0]===l[1])return t.outdent(u(a)),!1;if(u("\\s*"+i+"\\s*").test(l[1])){var s=parseInt(c(l[1]),10);return t.insert("\n"+l[1].replace(/\d+/,s+1),-1).scroll("+1"),!1}return t.insert("\n"+l[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var n,r=t.$(),o=r.before,i=r.value,c=r.after,a=x.ol,l=m(a),s=b(l,["\\d+"]),f=m(x.blockquote),p=u("  "+L+"$"),d=u("   ( ?"+s+" )$"),h="("+f+" |"+L+"| +"+s+" )";if(i){if(i&&(n=i.match(u("(^|\\n)"+h,"g"))))return t.outdent(u(h)),!1}else{if(n=o.match(u(f+" $")))return t.outdent(n[0]),!1;if(n=o.match(p))return o=o.replace(p,"$1"),t.set(o+c).select(o.length),!1;if(n=o.match(d))return o=o.replace(d,"$1"),t.set(o+c).select(o.length),!1}return g.tools.outdent.click(e,t)},tab:function(e,t){var n,r=t.$(),o=r.before,i=r.value,c=r.after,a=x.ol,l=m(a),s=u(L+"$"),f=u(" ?"+b(l,["\\d+"])+" $");if(!i){if(n=o.match(u(m(x.blockquote)+" $")))return t.insert(n[0],-1),!1;if(n=o.match(s))return o=o.replace(s,"  $1"),t.set(o+c).select(o.length),!1;if(n=o.match(f))return o=o.replace(f,"    "+b(a,[1])+" "),t.set(o+c).select(o.length),!1}return g.tools.indent.click(e,t)}}),h};
/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.2
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function m(e){return"undefined"!=typeof e}function E(e){return"string"==typeof e}function b(e){return"object"==typeof e}function C(e,t){return new RegExp(e,t)}function I(e){return e.replace(/^\s*|\s*$/g,"")}function y(e){return e.replace(/\s+$/,"")}function O(e,t,n){return t>e?t:e>n?n:e}function D(e){return R(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function R(e){return I(e.replace(/\s+/g," "))}var o=(window,document,new TE.HTML(e)),r=o.ui,s=o._.extend,c=(o._.each,o._.x),u=o._.format,p="	";o.update(s({extra:0,auto_p:0,auto_close:{"`":"`"},tools:"b i s | a img | sup abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{sup:["Footnote",o.config.languages.tools.sub[1]]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},sup:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:["-","+","*"],ol:"%1.",hr:["---","+++","***"]}},t),0),o.type="Markdown";var _=o.config,k=_.states,w=_.languages,x=_.formats,K=(_.classes,_.tab),N=w.placeholders,A=0,L=_.extra,$="( +["+c(x.ul).join("")+"] )";return L||(_["advance_pre,code"]=0),o.mark=function(e,t,n,i){b(e)||(e=[e]),m(n)||(n=" "),m(i)||(i="");var a=o[0]().$(),r=e[0]+i,s=i+(m(e[1])?e[1]:e[0]),l=a.value,u=c(r),d=c(s),f=C("^"+u+"([\\s\\S]*?)"+d+"$"),h=C(u+"$"),p=C("^"+d),g=a.before,E=a.after;return l?n=!1:o.insert(N[""]),o.toggle(t?!f.test(l):!h.test(g)&&!p.test(E),[function(e){e.unwrap(r,s,1).tidy(/<[^\/<>]+?>$/.test(g)?"":n,/^<\/[^<>]+?>/.test(E)?"":n).wrap(r,s,t)[1]()},function(e){e.unwrap(r,s,t)[1]()}])},s(r.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(x.b[0]),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(x.i[0]),!1}},u:0,s:L?{i:"strikethrough",click:function(e,t){return t.i().mark(x.s),!1}}:0,a:{i:"link",click:function(e,t){var d,f,h,p,m,g,E,n=t.$(),i=n.before,a=n.value,o=n.after,r=t.get(),s=/^ {0,3}\[[^\^]+?\]:/.test(r.split("\n").pop())?"\n":"\n\n",l=r.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=w.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(a))return t.tidy(" ").mark(["<",">"],1),!1;for(E in l)E=" "+I(l[E]).replace(/^\[|\]:$/g,""),k.a[E]=1;return d=k.a,t.record().ui.prompt(["a[href]",c.title[0]],u,0,function(e,t,r){var E=""===r;r=R(r),t[0](),d[r]?(t.trim(I(i)?" ":"",/^\n+ {0,3}\*?\[/.test(o)?!1:" ").mark(["[","]["+r+"]"],0,!1),p=l.indexOf(" ["+r+"]:"),-1===p&&1!==d[r]&&(n=t.$(),i=n.before,m=n.start,g=n.end,t.set(i+n.value+y(n.after)+s+" ["+(r||I(a)||N[""])+"]: "+(E?"":d[r][0]+(d[r][1]?' "'+d[r][1]+'"':""))).select(m,g),E&&t.focus(!0).insert(u))):(f=r,t.blur().ui.prompt(["a[title]",c.title[1]],c.placeholder[1],0,function(e,t,n){h=D(n),a||t.insert(N[""]),t.i().trim(I(i)?" ":"",I(o)?/^\n+ {0,3}\*?\[/.test(o)?"\n\n ":" ":"").wrap("[","]("+f+(h?' "'+h+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var h,p,m,g,E,v,n=t.$(),a=n.value,o=n.before,r=n.after,s=t.get(),l=/^ {0,3}\[[^\^]+?\]:/.test(s.split("\n").pop())?"\n":"\n\n",c=s.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=w.modals.img,d=/^\n* {0,3}\[.+?\]:/.test(r)?" ":"",f=I(r);for(i in c)i=" "+I(c[i]).replace(/^\[|\]:$/g,""),!k.img[i]&&(k.img[i]=1);return h=k.img,t.ui.prompt(["img[src]",u.title[0]],u.placeholder[0],1,function(e,t,i){i=R(i),p=i,a||(a=p.split(/[\/\\\\]/).pop()),a=D(a),t[0]().trim(I(o)?"\n\n":"",d),h[i]?(t.insert("!["+a+"]["+i+"]\n\n",-1,1),d&&t.select(t.$().start),g=c.indexOf(" ["+i+"]:"),-1===g&&(n=t.$(),o=n.before,E=n.start,v=n.end,t.set(o+n.value+n.after+(f?l:"")+" ["+i+"]: "+h[i][0]+(h[i][1]?' "'+h[i][1]+'"':"")).select(E,v))):t.blur().ui.prompt(["img[title]",u.title[1]],u.placeholder[1],0,function(e,t,n){m=D(n),t.insert("!["+a+"]("+p+(m?' "'+m+'"':"")+")\n\n",-1,1),d&&t.select(t.$().start)}),t[1]()}),!1}},sub:0,sup:L?{i:"thumb-tack",click:function(e,t){var u,n=t.$(),i=n.before,a=n.after,o=w.modals.sup,r=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(r.split("\n").pop())?"\n":"\n\n",l=r.match(/^ {0,3}\[\^.+?\]:/gm)||[],c=0;for(c in l)l[c]=" "+I(l[c]);return c=l.length+1,t.ui.prompt(["sup[id]",o.title],n.value||o.placeholder||c,0,function(e,t,n){n=I(n)||c,u=l.indexOf(" [^"+n+"]:"),-1!==u?(c=r.indexOf(l[u])+3,t.select(c,c+n.length)):t.trim(I(i)?" ":"",!I(a)||/^\n+ {0,3}\*?\[/.test(a)?"\n\n ":" ").insert("[^"+n+"]").set(y(t.get())+s+" [^"+n+"]: ").focus(!0).insert(N[""])}),!1}}:0,abbr:L?{i:"question",click:function(e,t){var n=t.$(),i=I(n.value),a=w.modals.abbr,o=t.get(),r=R(i||N[""]),s=/^ {0,3}\*\[.+?\]:/.test(o.split("\n").pop())?"\n":"\n\n",l=o.match(/^ {0,3}\*\[.+?\]:/gm)||[],c=k.abbr,u=0;for(u in l)l[u]=" "+I(l[u]);return u=l.indexOf(" *["+r+"]:"),i&&-1!==u?(u=o.indexOf(l[u])+3,t.select(u,u+r.length),!1):(t.record().ui.prompt(["abbr[title]",a.title],c[r]||a.placeholder,!c[i],function(e,t,a,o){if(a=I(a),t.set(y(t.get())+(n.before||i?s:"")+" *["+r+"]: ").focus(!0).insert(a||o),r===N[""]){var l=t.$().start;t.select(l-3-r.length,l-3)}}),!1)}}:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(N[""]),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){A>5?A=0:A++;var n=t.$(),i=_["advance_h1,h2"],a="\\s?["+c(x.h1[0]+x.h2[0])+"]+\\s*",o=c(x.h1[1]),r=n.before.replace(C("["+o+"\\s]+$"),""),s=R(n.value).replace(C("^["+o+"\\s]+|["+o+"\\s]+$","g"),"").replace(C(a+"$"),"")||N[""],l=n.after.replace(C("^["+o+"\\s]+"),"").replace(C("^"+a),""),u=["",x.h1[i?0:1],x.h2[i?0:1],x.h3,x.h4,x.h5,x.h6];return t[0]().set(r+s+l).select(r.length,(r+s).length).tidy("\n\n"),0===A||(3>A&&i?t.wrap("","\n"+s.replace(/./g,u[A])):t.wrap(u[A]+" ",_["close_h1,h2,h3,h4,h5,h6"]?" "+u[A]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),i=n.value,a=x.blockquote;return i===N[""]?(t.select(),!1):i?(t.tidy(C(a+" $").test(n.before)?!1:"\n\n")[C("^"+a).test(i)?"outdent":"indent"](a+" "),!1):(t[0]().tidy("\n\n").insert(a+" ",-1).insert(N[""])[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),i=n.before,a=n.value,o=_["advance_pre,code"],r=x.code,s=r[1]||r[0];s=s+s+s,!E(o)&&o?o=s:E(o)&&-1!==o.indexOf("%1")&&(o=u(o,[s]));var l="( {4,}|\\t"+(E(o)?"|"+c(o):"")+")";if(C("(^|\\n)"+l+"?$").test(i)){if(o)return t.mark([o,o.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(o=K===p?p:"    ",!a){t[0]().tidy("\n\n");var d=t.$().start,f=o+N[""];return t.insert(f).select(d+o.length,d+f.length)[1](),!1}return a===N[""]&&C(l+"$").test(i)?(t.select(n.start-o.length,n.end),!1):(t.tidy("\n\n")[C("^"+l).test(a)?"outdent":"indent"](o),!1)}return t.mark(r[0]),!1}},ul:{i:"list-ul",click:function(e,t){var o,n=t.$(),i=n.value,a=n.before,r=n.after,s=x.ul[0],l=x.ol,d=c(s),f=u(c(l),["\\d+"]),h=C("(^|\\n)([\\t ]*) "+d+" (.*)$"),p=C("^(.*) "+d+" ","gm"),m=C("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=C("^(.*) "+f+" ","gm");return i?(i===N[""]?t.select():g.test(i)?t.replace(g,"$1 "+s+" "):p.test(i)?t[0]().replace(p,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+s+" $2"),!1):a&&r?(o=m.test(a)?a.replace(m,"$1$2 "+s+" $3"):h.test(a)?a.replace(h,"$1$2$3"):a.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(o+r).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(N[""])[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var o,n=t.$(),i=n.value,a=n.before,r=n.after,s=x.ul[0],l=x.ol,d=u(l,[1]),f=c(s),h=u(c(l),["\\d+"]),p=C("(^|\\n)([\\t ]*) "+f+" (.*)$"),m=C("^(.*) "+f+" ","gm"),g=C("(^|\\n)([\\t ]*) "+h+" (.*)$"),E=C("^(.*) "+h+" ","gm"),v=0;return i?(i===N[""]?t.select():m.test(i)?t.replace(m,function(e,t,n){return++v,t+" "+u(l,[v])+" "}):E.test(i)?t[0]().replace(E,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+u(l,[v])+" "+n}),!1):a&&r?(o=p.test(a)?a.replace(p,"$1$2 "+d+" $3"):g.test(a)?a.replace(g,"$1$2$3"):a.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+d+" $3"),t.set(o+r).select(o.length),!1):(t[0]().tidy("\n\n").insert(" "+d+" ",-1).insert(N[""])[1](),!1)}},table:L?function(e,t){var l,c,d,n=k.tr,i=k.td,a=w.modals.table,o=w.placeholders.table,r=u(o[0],[1,1]),s=[];return t.$().value===r?(t.select(),!1):(t[0]().ui.prompt(["table>td",a.title[0]],a.placeholder[0],0,function(e,t,f,h){c=O(parseInt(f,10)||h,i[0],i[1]),t.blur().ui.prompt(["table>tr",a.title[1]],a.placeholder[1],0,function(e,t,i,a){d=O(parseInt(i,10)||a,n[0],n[1]);var f,h,p,m,g,E;for(f=0;d>f;++f){for(l="|",h=0;c>h;++h)l+=" "+u(o[1],[f+1,h+1])+" |";s.push(l)}for(s=s.join("\n"),l="|",p=0;c>p;++p)l+=" "+u(o[0],[p+1,p+1]).replace(/./g,"-")+" |";for(s=l+"\n"+s,l="|",m=0;c>m;++m)l+=" "+u(o[0],[1,m+1])+" |";s=l+"\n"+s,_.close_tr||(s=s.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(s),g=t.$(),E=g.start+g.value.indexOf(r),t.select(E,E+r.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(x.hr[0]+"\n\n",-1),!1}}}),s(r.keys,{"control+u":0,"control+arrowup":"sup","control+arrowdown":"sup","control+shift+?":"abbr","shift+enter":function(e,t){var n=_.advance_br;return!E(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),i=x.blockquote,o=(x.ul[0],x.ol),r=u(c(o),["\\d+"]),s="(("+c(i)+" )+|"+$+"| +("+r+") )",l=C("^"+s+".*$","gm").exec(n.before.split("\n").pop());if(l){if(l[0]===l[1])return t.outdent(C(s)),!1;if(C("\\s*"+r+"\\s*").test(l[1])){var d=parseInt(I(l[1]),10);return t.insert("\n"+l[1].replace(/\d+/,d+1),-1).scroll("+1"),!1}return t.insert("\n"+l[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var g,n=t.$(),i=n.before,a=n.value,o=n.after,s=x.ol,l=c(s),d=u(l,["\\d+"]),f=c(x.blockquote),h=C("  "+$+"$"),p=C("   ( ?"+d+" )$"),m="("+f+" |"+$+"| +"+d+" )";if(a){if(a&&(g=a.match(C("(^|\\n)"+m,"g"))))return t.outdent(C(m)),!1}else{if(g=i.match(C(f+" $")))return t.outdent(g[0]),!1;if(g=i.match(h))return i=i.replace(h,"$1"),t.set(i+o).select(i.length),!1;if(g=i.match(p))return i=i.replace(p,"$1"),t.set(i+o).select(i.length),!1}return r.tools.outdent.click(e,t)},tab:function(e,t){var h,n=t.$(),i=n.before,a=n.value,o=n.after,s=x.ol,l=c(s),d=C($+"$"),f=C(" ?"+u(l,["\\d+"])+" $");if(!a){if(h=i.match(C(c(x.blockquote)+" $")))return t.insert(h[0],-1),!1;if(h=i.match(d))return i=i.replace(d,"  $1"),t.set(i+o).select(i.length),!1;if(h=i.match(f))return i=i.replace(f,"    "+u(s,[1])+" "),t.set(i+o).select(i.length),!1}return r.tools.indent.click(e,t)}}),o.update({},0)};
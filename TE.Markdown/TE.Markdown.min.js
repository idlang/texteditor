/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.1.1
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function o(e){return"function"==typeof e}function l(e){return"object"==typeof e}function a(e,t){return RegExp(e,t)}function c(e){return e.replace(/^\s*|\s*$/g,"")}function u(e){return e.replace(/\s+$/,"")}function s(e,t,n){return t>e?t:e>n?n:e}function f(e){return p(e).replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function p(e){return c(e.replace(/\s+/g," "))}var d="\u2026",h="\u2193",g="\u2318",b=new TE.HTML(e,{extra:0,auto_p:0,auto_close:{"`":"`"},states:{a:{"":!0},img:{},abbr:{}},languages:{tools:{footnote:"Footnote ("+g+"+"+h+")",abbr:"Abbreviation ("+g+"+?)"},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},footnote:{title:"Footnote ID"},abbr:{title:"Abbreviation",placeholder:"meaning here"+d}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:"**",i:"_",s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:["`","~"],ul:"-",ol:"%1.",hr:"---"}}),m=b.ui,v=b._.extend,$=b._.each,k=b._.x,y=b._.format,w="\t";b.type="Markdown";var x=v(b.config,t),_=x.states,T=x.languages,E=x.formats,q=(x.classes,x.tab),L=(x.suffix,T.placeholders[""]),C=0,O=x.extra,I="( +["+k(E.ul+"*+-")+"] )";return O||(x["advance_pre,code"]=0),b.mark=function(e,t,r,o){l(e)||(e=[e]),n(r)||(r=" "),n(o)||(o="");var i=b[0]().$(),c=e[0]+o,u=o+(n(e[1])?e[1]:e[0]),s=i.value,f=k(c),p=k(u),d=a("^"+f+"([\\s\\S]*?)"+p+"$"),h=a(f+"$"),g=a("^"+p),m=i.before,v=i.after;return s?r=!1:b.insert(L),b.toggle(t?!d.test(s):!h.test(m)&&!g.test(v),[function(e){e.unwrap(c,u,1).tidy(/<[^\/<>]+?>$/.test(m)?"":r,/^<\/[^<>]+?>/.test(v)?"":r).wrap(c,u,t)[1]()},function(e){e.unwrap(c,u,t)[1]()}])},v(m.tools,{b:{i:"bold",click:function(e,t){return t.i().mark(E.b),!1}},i:{i:"italic",click:function(e,t){return t.i().mark(E.i),!1}},u:0,s:O?{i:"strikethrough",click:function(e,t){return t.i().mark(E.s),!1}}:0,a:{i:"link",click:function(e,t){var n,r,o,i,l,a,s,d=t.$(),h=d.before,g=d.value,b=d.after,m=t.get(),v=/^ {0,3}\[[^\^]+?\]:/.test(m.split("\n").pop())?"\n":"\n\n",$=m.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],k=T.modals.a;if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(g))return t.tidy(" ").mark(["<",">"],1),!1;for(s in $)s=" "+c($[s]).replace(/^\[|\]:$/g,""),_.a[s]=1;return n=_.a,t.record().ui.prompt(k.title[0],k.placeholder[0],0,function(e,t,s){s=p(s),t[0](),n[s]?(t.trim(c(h)?" ":"",/^\n+ {0,3}\*?\[/.test(b)?!1:" ").mark(["[","]["+s+"]"],0,!1),i=$.indexOf(" ["+s+"]:"),-1===i&&1!==n[s]&&(d=t.$(),h=d.before,l=d.start,a=d.end,t.set(h+d.value+u(d.after)+v+" ["+(s||c(g))+"]: "+(n[s]!==!0?n[s][0]+(n[s][1]?' "'+n[s][1]+'"':""):"")).select(l,a),s||t.focus(!0).insert(k.placeholder[0]))):(r=s,t.blur().ui.prompt(k.title[1],k.placeholder[1],0,function(e,t,n){o=f(n),g||t.insert(L),t.i().trim(c(h)?" ":"",c(b)?/^\n+ {0,3}\*?\[/.test(b)?"\n\n ":" ":"").wrap("[","]("+r+(o?' "'+o+'"':"")+")")})),t[1]()}),!1}},img:{i:"image",click:function(e,t){var n,r,o,l,a,u,s=t.$(),d=s.value,h=s.before,g=s.after,b=t.get(),m=/^ {0,3}\[[^\^]+?\]:/.test(b.split("\n").pop())?"\n":"\n\n",v=b.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],$=T.modals.img,k=/^\n* {0,3}\[.+?\]:/.test(g)?" ":"",y=c(g);for(i in v)i=" "+c(v[i]).replace(/^\[|\]:$/g,""),!_.img[i]&&(_.img[i]=1);return n=_.img,t.ui.prompt($.title[0],$.placeholder[0],1,function(e,t,i){i=p(i),r=i,d||(d=r.split(/[\/\\\\]/).pop()),d=f(d),t[0]().trim(c(h)?"\n\n":"",k).insert(""),n[i]?(t.insert("!["+d+"]["+i+"]\n\n",-1),k&&t.select(t.$().start),l=v.indexOf(" ["+i+"]:"),-1===l&&(s=t.$(),h=s.before,a=s.start,u=s.end,t.set(h+s.value+s.after+(y?m:"")+" ["+i+"]: "+n[i][0]+(n[i][1]?' "'+n[i][1]+'"':"")).select(a,u))):t.blur().ui.prompt($.title[1],$.placeholder[1],0,function(e,t,n){o=f(n),t.insert("!["+d+"]("+r+(o?' "'+o+'"':"")+")\n\n",-1),k&&t.select(t.$().start)}),t[1]()}),!1}},footnote:O?{i:"thumb-tack",click:function(e,t){var n,r=t.$(),o=r.before,i=r.after,l=T.modals.footnote,a=t.get(),s=/^ {0,3}\[\^.+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",f=a.match(/^ {0,3}\[\^.+?\]:/gm)||[],p=0;for(p in f)f[p]=" "+c(f[p]);return p=f.length+1,t.ui.prompt(l.title,r.value||l.placeholder||p,0,function(e,t,r){r=c(r)||p,n=f.indexOf(" [^"+r+"]:"),-1!==n?(p=a.indexOf(f[n])+3,t.select(p,p+r.length)):t.trim(c(o)?" ":"",!c(i)||/^\n+ {0,3}\*?\[/.test(i)?"\n\n ":" ").insert("[^"+r+"]").set(u(t.get())+s+" [^"+r+"]: ").focus(!0).insert(L)}),!1}}:0,abbr:O?{i:"question",click:function(e,t){var n=t.$(),r=n.value,o=T.modals.abbr,i=t.get(),l=r||L,a=/^ {0,3}\*\[.+?\]:/.test(i.split("\n").pop())?"\n":"\n\n",s=i.match(/^ {0,3}\*\[.+?\]:/gm)||[],f=_.abbr,p=0;for(p in s)s[p]=" "+c(s[p]);return p=s.indexOf(" *["+l+"]:"),r&&-1!==p?(p=i.indexOf(s[p])+3,t.select(p,p+l.length),!1):(t.record().ui.prompt(o.title,f[l]||o.placeholder,!f[r],function(e,t,o){if(o=c(o),t.set(u(t.get())+(n.before||r?a:"")+" *["+l+"]: ").focus(!0).insert(o),l===L){var i=t.$().start;t.select(i-3-l.length,i-3)}}),!1)}}:0,sub:0,sup:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(L),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){C>5?C=0:C++;var n=t.$(),r=x["advance_h1,h2"],o="\\s?["+k(E.h1[0]+E.h2[0])+"]+\\s*",i=k(E.h1[1]),l=n.before.replace(a("["+i+"\\s]+$"),""),c=p(n.value).replace(a("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(a(o+"$"),"")||L,u=n.after.replace(a("^["+i+"\\s]+"),"").replace(a("^"+o),""),s=["",E.h1[r?0:1],E.h2[r?0:1],E.h3,E.h4,E.h5,E.h6];return t[0]().set(l+c+u).select(l.length,(l+c).length).tidy("\n\n"),0===C||(3>C&&r?t.wrap("","\n"+c.replace(/./g,s[C])):t.wrap(s[C]+" ",x["close_h1,h2,h3,h4,h5,h6"]?" "+s[C]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,o=E.blockquote;return r===L?(t.select(),!1):r?(t.tidy(a(o+" $").test(n.before)?!1:"\n\n")[a("^"+o).test(r)?"outdent":"indent"](o+" "),!1):(t[0]().tidy("\n\n").insert(o+" ",-1).insert(L)[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),o=n.before,i=n.value,l=x["advance_pre,code"],c=E.code,u=c[1]||c[0];u=u+u+u,!r(l)&&l?l=u:r(l)&&-1!==l.indexOf("%1")&&(l=y(l,[u]));var s="( {4,}|\\t"+(r(l)?"|"+k(l):"")+")";if(a("(^|\\n)"+s+"?$").test(o)){if(l)return t.mark([l,l.split(/\s+/)[0]],0,"\n\n","\n"),!1;if(l=q===w?w:"    ",!i){t[0]().tidy("\n\n");var f=t.$().start,p=l+L;return t.insert(p).select(f+l.length,f+p.length)[1](),!1}return i===L&&a(s+"$").test(o)?(t.select(n.start-l.length,n.end),!1):(t.tidy("\n\n")[a("^"+s).test(i)?"outdent":"indent"](l),!1)}return t.mark(c[0]),!1}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,l=r.after,c=E.ul,u=E.ol,s=k(c),f=y(k(u),["\\d+"]),p=a("(^|\\n)([\\t ]*) "+s+" (.*)$"),d=a("^(.*) "+s+" ","gm"),h=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),g=a("^(.*) "+f+" ","gm");return o?(o===L?t.select():g.test(o)?t.replace(g,"$1 "+c+" "):d.test(o)?t[0]().replace(d,"$1"):t.replace(/^(\s*)(\S+)$/gm,"$1 "+c+" $2"),!1):i&&l?(n=h.test(i)?i.replace(h,"$1$2 "+c+" $3"):p.test(i)?i.replace(p,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+c+" $3"),t.set(n+l).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+c+" ",-1).insert(L)[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),o=r.value,i=r.before,l=r.after,c=E.ul,u=E.ol,s=y(u,[1]),f=k(c),p=y(k(u),["\\d+"]),d=a("(^|\\n)([\\t ]*) "+f+" (.*)$"),h=a("^(.*) "+f+" ","gm"),g=a("(^|\\n)([\\t ]*) "+p+" (.*)$"),b=a("^(.*) "+p+" ","gm"),m=0;return o?(o===L?t.select():h.test(o)?t.replace(h,function(e,t){return++m,t+" "+y(u,[m])+" "}):b.test(o)?t[0]().replace(b,"$1"):t.replace(/^(\s*)(\S+)$/gm,function(e,t,n){return++m,t+" "+y(u,[m])+" "+n}),!1):i&&l?(n=d.test(i)?i.replace(d,"$1$2 "+s+" $3"):g.test(i)?i.replace(g,"$1$2$3"):i.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+l).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(L)[1](),!1)}},table:O?function(e,t){var n,r,o,i=_.tr,l=_.td,a=T.modals.table,c=T.placeholders.table,u=y(c[0],[1,1]),f=[];return t.$().value===u?(t.select(),!1):(t[0]().insert("").ui.prompt(a.title[0],a.placeholder[0],0,function(e,t,p,d){r=s(parseInt(p,10)||d,l[0],l[1]),t.blur().ui.prompt(a.title[1],a.placeholder[1],0,function(e,t,l,a){o=s(parseInt(l,10)||a,i[0],i[1]);var p,d,h,g,b,m;for(p=0;o>p;++p){for(n="|",d=0;r>d;++d)n+=" "+y(c[1],[p+1,d+1])+" |";f.push(n)}for(f=f.join("\n"),n="|",h=0;o>h;++h)n+=" "+y(c[0],[h+1,h+1]).replace(/./g,"-")+" |";for(f=n+"\n"+f,n="|",g=0;o>g;++g)n+=" "+y(c[0],[1,g+1])+" |";f=n+"\n"+f,x.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f,1),b=t.$(),m=b.start+b.after.indexOf(u),t.select(m,m+u.length)[1]()})}),!1)}:0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(E.hr+"\n\n",-1),!1}}}),$(m.tools,function(e,t){var n=T.tools[t]||"";o(e)?m.tools[t]={title:n,click:e}:e.title||(e.title=n)}),v(m.keys,{"control+u":0,"control+arrowup":0,"control+arrowdown":"footnote","control+shift+?":"abbr","shift+enter":function(e,t){var n=x.advance_br;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=E.blockquote,o=(E.ul,E.ol),i=y(k(o),["\\d+"]),l="(("+k(r)+" )+|"+I+"| +("+i+") )",u=a("^"+l+".*$","gm").exec(n.before.split("\n").pop());if(u){if(u[0]===u[1])return t.outdent(a(l)),!1;if(a("\\s*"+i+"\\s*").test(u[1])){var s=parseInt(c(u[1]),10);return t.insert("\n"+u[1].replace(/\d+/,s+1),-1).scroll("+1"),!1}return t.insert("\n"+u[1],-1).scroll("+1"),!1}},"shift+tab":function(e,t){var n,r=t.$(),o=r.before,i=r.value,l=r.after,c=E.ol,u=k(c),s=y(u,["\\d+"]),f=k(E.blockquote),p=a("  "+I+"$"),d=a("   ( ?"+s+" )$"),h="("+f+" |"+I+"| +"+s+" )";if(i){if(i&&(n=i.match(a("(^|\\n)"+h,"g"))))return t.outdent(a(h)),!1}else{if(n=o.match(a(f+" $")))return t.outdent(n[0]),!1;if(n=o.match(p))return o=o.replace(p,"$1"),t.set(o+l).select(o.length),!1;if(n=o.match(d))return o=o.replace(d,"$1"),t.set(o+l).select(o.length),!1}return m.tools.outdent.click(e,t)},tab:function(e,t){var n,r=t.$(),o=r.before,i=r.value,l=r.after,c=E.ol,u=k(c),s=a(I+"$"),f=a(" ?"+y(u,["\\d+"])+" $");if(!i){if(n=o.match(a(k(E.blockquote)+" $")))return t.insert(n[0],-1),!1;if(n=o.match(s))return o=o.replace(s,"  $1"),t.set(o+l).select(o.length),!1;if(n=o.match(f))return o=o.replace(f,"    "+y(c,[1])+" "),t.set(o+l).select(o.length),!1}return m.tools.indent.click(e,t)}}),b.update(v({tools:"b i s | a img | footnote abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo"},t),0)};
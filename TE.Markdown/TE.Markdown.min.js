/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.0.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.Markdown=function(e,t){function n(e){return void 0!==e}function r(e){return"string"==typeof e}function l(e){return"function"==typeof e}function o(e){return"object"==typeof e}function i(e,t){return RegExp(e,t)}function c(e){return e.replace(/^\s*|\s*$/g,"")}function a(e){return e.replace(/<.*?>/g,"").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}var u="\u2026",s="\u2193",h="\u2318",f=new TE.HTML(e,{auto_p:0,auto_close:{"`":"`"},languages:{tools:{footnote:"Footnote ("+h+"+"+s+")"},modals:{img:{title:["Image URL","Image Title"],placeholder:["http://","image title here"+u]},footnote:{title:"Footnote ID"}}},enable_setext_header:1,enable_closed_atx_header:0,enable_fenced_code_block:0,enable_hard_break:1,formats:{b:"**",i:"_",s:"~~",h1:["=","#"],h2:["-","##"],h3:"###",h4:"####",h5:"#####",h6:"######",blockquote:">",code:"`",ul:"-",ol:"%1.",hr:"---"}}),p=f.ui,d=f._.extend,g=f._.each,$=f._.x,m=f._.format;TE.Markdown.__instance__.push(f);var k=f.config,b=k.languages,_=k.formats,v=(k.classes,k.tab),y=(k.suffix,b.others.placeholder),w=0;return f.mark=function(e,t,r,l){o(e)||(e=[e]),n(r)||(r=" "),n(l)||(l="");var c=f[0]().$(),a=e[0]+l,u=l+(n(e[1])?e[1]:e[0]),s=$(a),h=$(u),p=i("^"+s+"([\\s\\S]*?)"+h+"$"),d=i(s+"$"),g=i("^"+h),m=c.before,k=c.after;return c.length||f.insert(y),f.toggle(t?!p.test(c.value):!d.test(m)&&!g.test(k),[function(e){e.unwrap(a,u,1).tidy(/<[^\/<>]+?>$/.test(m)?"":r,/^<\/[^<>]+?>/.test(k)?"":r).wrap(a,u,t)[1]()},function(e){e.unwrap(a,u,t)[1]()}])},d(p.tools,{b:{i:"bold",click:function(e,t){return t.mark(_.b),!1}},i:{i:"italic",click:function(e,t){return t.mark(_.i),!1}},u:0,s:{i:"strikethrough",click:function(e,t){return t.mark(_.s),!1}},a:{i:"link",click:function(e,t){var n,r,l=(_.a,b.modals.a);return t.record().ui.prompt(l.title[0],l.placeholder[0],1,function(e,t,o){n=o,t.blur().ui.prompt(l.title[1],l.placeholder[1],0,function(e,t,l){r=a(l),t.$().length||t.insert(y),t.mark(["[","]("+n+(r?' "'+r+'"':"")+")"])})}),!1}},img:{i:"image",click:function(e,t){var n,r,l=t.$(),o=l.value,i=b.modals.img;return t.record().ui.prompt(i.title[0],i.placeholder[0],1,function(e,t,l){n=l,t.blur().ui.prompt(i.title[1],i.placeholder[1],0,function(e,t,l){r=l,o.length||(o=n.split(/[\/\\\\]/).pop()),o=a(o),t.tidy("\n\n","").insert("!["+o+"]("+n+(r?' "'+r+'"':"")+")\n\n",-1)})}),!1}},footnote:{i:"thumb-tack",click:function(e,t){var n=t.$(),r=b.modals.footnote,l=t.get(),o=/^ \[\^.*?\]:/.test(l.split("\n").pop())?"\n":"\n\n",i=l.match(/^ \[\^.*?\]:/gm)||[],c=i.length+1;if(n.before.length)return t.ui.prompt(r.title,r.placeholder||c,1,function(e,t,r){var a=i.indexOf(" [^"+r+"]:");-1!==a?(c=l.indexOf(i[a])+3,t.select(c,c+r.length)):t.trim(" ",!n.after.length||/^\n/.test(n.after)?!1:" ").insert("[^"+r+"]").set(t.get()+o+" [^"+r+"]: ").focus(!0).insert(y)}),!1}},sub:0,sup:0,p:{i:"paragraph",click:function(e,t){return t.tidy("\n\n").insert(y),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){w>5?w=0:w++;var n=t.$(),r=k.enable_setext_header,l=$(_.h1[0]+_.h2[0]),o=n.before.replace(/[#\s]+$/,""),c=n.length?n.value.replace(/\s+/g," ").replace(/^[#\s]+|[#\s]+$/g,"").replace(i("\\s?["+l+"]+\\s*$"),""):y,a=n.after.replace(/^[#\s]+/,"").replace(i("^\\s?["+l+"]+\\s*"),""),u=["",_.h1[r?0:1],_.h2[r?0:1],_.h3,_.h4,_.h5,_.h6];return t[0]().set(o+c+a).select(o.length,(o+c).length).tidy("\n\n"),0===w||(3>w&&r?t.wrap("","\n"+c.replace(/./g,u[w])):t.wrap(u[w]+" ",k.enable_closed_atx_header?" "+u[w]:"")),t[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=_.blockquote;return n.value===y?(t.select(),!1):n.length?(t.tidy("\n\n")[i("^"+r).test(n.value)?"outdent":"indent"](r+" "),!1):(t[0]().tidy("\n\n").insert(r+" ",-1).insert(y)[1](),!1)}},"pre,code":{i:"code",click:function(e,t){var n=t.$(),l=k.enable_fenced_code_block,o=_.code;return!r(l)&&l&&(l="~~~"),/(^|\n)$/.test(n.before)?l?(t.mark([l,l.split(/\s+/)[0]],0,"\n\n","\n"),!1):(n.length||t.insert(y),t.tidy("\n\n")[/^(\t| {4})/.test(n.value)?"outdent":"indent"]("\t"===v?"\t":"    "),!1):(t.mark(o),!1)}},ul:{i:"list-ul",click:function(e,t){var n,r=t.$(),l=r.value,o=r.before,c=r.after,a=_.ul,u=_.ol,s=$(a),h=m($(u),["\\d+"]),f=i("(^|\\n)([\\t ]*) "+s+" (.*)$"),p=i("^(.*) "+s+" ","gm"),d=i("(^|\\n)([\\t ]*) "+h+" (.*)$"),g=i("^(.*) "+h+" ","gm");return r.length?(l===y?t.select():g.test(l)?t.replace(g,"$1 "+a+" "):p.test(l)?t[0]().replace(p,"$1"):t.replace(/^(\s*)(\S+)$/gm,"$1 "+a+" $2"),!1):o.length&&c.length?(n=d.test(o)?o.replace(d,"$1$2 "+a+" $3"):f.test(o)?o.replace(f,"$1$2$3"):o.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+a+" $3"),t.set(n+c).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+a+" ",-1).insert(y)[1](),!1)}},ol:{i:"list-ol",click:function(e,t){var n,r=t.$(),l=r.value,o=r.before,c=r.after,a=_.ul,u=_.ol,s=m(u,[1]),h=$(a),f=m($(u),["\\d+"]),p=i("(^|\\n)([\\t ]*) "+h+" (.*)$"),d=i("^(.*) "+h+" ","gm"),g=i("(^|\\n)([\\t ]*) "+f+" (.*)$"),k=i("^(.*) "+f+" ","gm"),b=0;return r.length?(l===y?t.select():d.test(l)?t.replace(d,function(e,t){return++b,t+" "+m(u,[b])+" "}):k.test(l)?t[0]().replace(k,"$1"):t.replace(/^(\s*)(\S+)$/gm,function(e,t,n){return++b,t+" "+m(u,[b])+" "+n}),!1):o.length&&c.length?(n=p.test(o)?o.replace(p,"$1$2 "+s+" $3"):g.test(o)?o.replace(g,"$1$2$3"):o.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(n+c).select(n.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",-1).insert(y)[1](),!1)}},"align-left":0,"align-center":0,"align-right":0,"align-justify":0,hr:{i:"ellipsis-h",click:function(e,t){return t.tidy("\n\n","").insert(_.hr+"\n\n",-1),!1}}}),g(p.tools,function(e,t){var n=b.tools[t]||"";l(e)?p.tools[t]={title:n,click:e}:e.title||(e.title=n)}),d(p.keys,{"control+u":0,"control+arrowup":0,"control+arrowdown":"footnote","shift+enter":function(e,t){var n=k.enable_hard_break;return!r(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",-1),!1},enter:function(e,t){var n=t.$(),r=_.blockquote,l=_.ul,o=_.ol,a=m($(o),["\\d+"]),u="((?:"+$(r)+" *)+| +(?:"+$(l)+"|"+a+") )",s=i("^"+u+".*$","gm").exec(n.before.split("\n").pop());if(s){if(s[0]===s[1])return t.outdent(i(u)),!1;if(i("\\s*"+a+"\\s*").test(s[1])){var h=parseInt(c(s[1]),10);return t.insert("\n"+s[1].replace(/\d+/,h+1),-1).scroll("+1"),!1}return t.insert("\n"+s[1],-1).scroll("+1"),!1}}}),f.update(d({tools:"b i u | a img footnote | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | hr | undo redo"},t),0)},TE.Markdown.__instance__=[];
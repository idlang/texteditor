/*!
 * ==========================================================
 *  USER INTERFACE MODULE FOR TEXT EDITOR PLUGIN 0.0.9
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.prototype.create=function(e){function t(e){return e instanceof HTMLElement}function r(e){return void 0!==e}function n(e){return"function"==typeof e}function o(e){return"string"==typeof e}function u(e){return"object"==typeof e}function i(e){return"number"==typeof e}function c(e,t,n){return r(e)?r(t)?(r(vt[e])||(vt[e]={}),r(n)||(n=Object.keys(vt[e]).length),vt[e][n]=t,pt):vt[e]:vt}function a(e,t){return r(e)?r(t)&&r(vt[e])?(delete vt[e][t],pt):(vt[e]={},pt):(vt={},pt)}function l(e,t,n){if(!r(vt[e]))return pt;if(r(n))r(vt[e][n])&&vt[e][n].apply(pt,t);else for(var o in vt[e])vt[e][o].apply(pt,t);return pt}function s(e){return e&&e.preventDefault(),!1}function f(e,t,r){return t?(t.addEventListener(e,r,!1),c("on:"+e,r,z(t)),pt):void 0}function d(e,t,r){return t?(t.removeEventListener(e,r,!1),a("on:"+e,z(t)),pt):void 0}function p(e,t,r){return l("on:"+e,t,z(r)),pt}function h(e,t,r){e=y(e).split(/\s+/);for(var n=0,o=e.length;o>n;++n)f(e[n],t,r);return pt}function g(e,t,r){e=y(e).split(/\s+/);for(var n=0,o=e.length;o>n;++n)d(e[n],t,r);return pt}function v(e,t,r){e=y(e).split(/\s+/);for(var n=0,o=e.length;o>n;++n)p(e[n],t,r);return pt}function m(e,t){ft.setTimeout(e,t)}function b(e){ft.clearTimeout(e)}function y(e){return e.replace(/^\s*|\s*$/g,"")}function w(e,t,n){return r(t)&&t>e?t:r(n)&&e>n?n:e}function x(e,t){return e.replace(/%(\d+)/g,function(e,n){return--n,r(t[n])?t[n]:e})}function $(e){return y(e.toLowerCase().replace(/[^ \/a-z\d-]/g,"-").replace(/([ -])+/g,"$1").replace(/^-|-$/g,""))}function k(e,t){return RegExp(e,t)}function E(e,t){var r=t.touches?t.touches[0].pageX:t.pageX,n=t.touches?t.touches[0].pageY:t.pageY,o=T(e);return{x:r-o.l,y:n-o.t}}function T(e){for(var t=e.offsetLeft,r=e.offsetTop;e=e.offsetParent;)t+=e.offsetLeft,r+=e.offsetTop;return{l:t,t:r}}function C(e){return{w:e.offsetWidth,h:e.offsetHeight}}function S(e,t){for(;(e=e.parentElement)&&e!==t;);return e}function _(e){var t=pt.get();if(!R(tr)&&t.length){-1===t.indexOf("</html>")&&(t='<!DOCTYPE html><html dir="'+$t.dir+'"><head><meta charset="utf-8"><style>'+$t.css+"</style></head><body>"+t+"</body></html>");var r=M("iframe",!1,{"class":At+"-portal",src:"data:text/html,"+encodeURIComponent(t)});pt.ui.overlay(r,1,function(){l("enter.overlay.preview",[e,pt,t,tr.firstChild])})}else et();return s(e)}function z(e){var t=e.id;return t||(t=At+"-dom:"+(new Date).getTime(),e.id=t),t}function M(e,i,c){if(e=o(e)?dt.createElement(e):e,u(c)){var a,l;for(l in c)a=c[l],"style"===l?o(a)?e.setAttribute(l,a):null===a?e.removeAttribute(l):e=L(e,a):n(a)?e[l]=a:null===a?e.removeAttribute(l):e.setAttribute(l,u(a)?a.join(" "):""+a)}if(t(i))e.appendChild(i);else if(u(i)){var a,l;for(l in i)a=i[l],t(a)?e.appendChild(a):a!==!1&&(e.innerHTML=a)}else r(i)&&i!==!1&&(e.innerHTML=i);return e}function L(e,t){e=M(e);for(var r in t)e.style[r.replace(/\-([a-z])/g,function(e,t){return t.toUpperCase()})]=t[r];return e}function K(e,t){return k("(^|\\s)"+t+"(\\s|$)").test(e.className)}function W(e,t){K(e,t)||(e.className=y(e.className+" "+t))}function j(e,t){e.className=y(e.className.replace(k("(^|\\s)"+t+"(\\s|$)"),"$1$2"))}function H(e,t){e.innerHTML=t}function N(e,t){if(t!==!1){var r,n=e.children;for(r in n)N(n[r])}H(e,"")}function R(e,t){return 1===arguments.length?e.parentNode||!1:e&&t.parentNode===e?t.parentNode:!1}function I(e,t){e.parentNode.insertBefore(t,e)}function Y(e,t){e.appendChild(t)}function D(e,t){var r=R(e);if(r){if(t!==!1)for(var n=e.firstChild;n;)D(n);r.removeChild(e)}}function P(e){N(M(e,!1,{style:""})),D(e)}function A(e,t,r){return M(t||"div",r,{"class":e})}function O(){if(Xt._word&&Xt._words){var e=(Jt.value||"").replace(/<[^<>]+?>/g,""),t=(e.match(/(\w+)/g)||[]).length;H(ir,x(Xt["_word"+(1===t?"":"s")],[t]))}}function U(){N(Gt,!1);var e,t,i,c,a,s,f=o($t.tools)?y($t.tools).split(/\s+/):$t.tools,d=At+"-button",p=At+"-separator";$t.tools=f;for(a in f)s=f[a],pt.ui.tools[s]&&(t=pt.ui.tools[s],n(t)&&(pt.ui.tools[s].click=t),"|"!==(i=t.i||s)&&(i=$(i)),c="|"!==i,Dt=A(c?d:p,c?"a":"span"),c&&(e=d+":"+$(s).replace(/\s/g,""),Dt.href="",Dt.id=e,Dt.tabIndex=-1,Dt.setAttribute("data-tool-id",s),i='<i class="'+x(Pt.i,[i])+" "+e+'"></i>',r(t.active)?t.active||W(Dt,"x"):t.active=1,t.text&&(i=x(t.text,[i]),W(Dt,"text")),H(Dt,i),t.title&&(Dt.title=t.title),u(t.attributes)&&M(Dt,!1,t.attributes),h(Lt,Dt,q)),Y(Gt,Dt));l("update.tools",[pt])}function X(){pt.ui.keys=function(){var e,t=Object.keys(pt.ui.keys).sort().reverse(),r={};for(e=0,len=t.length;len>e;++e)r[t[e]]=pt.ui.keys[t[e]];return r}(),V(1),l("update.keys",[pt])}function B(e){O(),l("on:change",[e,pt])}function F(e){function t(e){return e.replace(/\+/g,"\n").replace(/\n\n/g,"\n+").split("\n")}var r,n,u,i,c,a=pt.$(),l=a.before.slice(-1),f=a.after[0],d=a.length,p=e.TE.key,h=pt.ui.keys,g=TE.keys_alt,v=(a.before.match(/(?:^|\n)([\t ]*).*$/)||[""]).pop(),b=p();sr[p()]=1,m(function(){pt.record()},1);for(r in h){var y=0;u=t(r);for(n in u)n=u[n],sr[g[n]||n]&&++y;u=u.length,y===u&&Object.keys(sr).length===u&&(o(h[r])&&(h[r]=pt.ui.tools[h[r]].click),i=h[r](e,pt),i===!1&&s(e))}if(It&&!d&&"backspace"===b&&k(yt(Rt)+"$").test(a.before))return pt.outdent(Rt),s(e);if(Yt)for(r in Yt)if(c=Yt[r]){if(f===b)return"\\"===l?(pt.insert(b,-1),s(e)):(pt.select(a.end+1),s(e));if(r===b)return pt.wrap(r,c),s(e);if(l===r&&f===c){if("backspace"===b&&a.before.slice(-2)!=="\\"+r)return pt.unwrap(r,c),s(e);if("enter"===b&&It)return pt.tidy("\n"+v+Rt,"\n"+v),s(e)}}}function V(e){u(e)?delete sr[e.TE.key()]:sr={}}function Z(e){/^focus|blur$/.test(e.type)&&V(1),b(fr),fr=m(B,1e3)}function q(e){pt.ui.exit(0,0,0);var t=this.getAttribute("data-tool-id"),r=pt.ui.tools;return lr=e.currentTarget||e.target,r[t]&&r[t].click&&r[t].active?(r[t].click(e,pt,t),l("on:change",[e,pt,t])):pt.select(),s(e)}function G(e){return pr=Qt,dr=C(qt),s(e)}function J(e){pr===Qt&&L(Jt,{height:E(Zt,e).y-dr.h+"px"})}function Q(){pr=0}function et(){pt.ui.exit(1)}function tt(){e=C(rr),vr=e.w,mr=e.h,e=C(tr),br=e.w,yr=e.h}function rt(){v(Lt,[],tr)}function nt(t){pr=t.target,e=E(rr,t),hr=e.x,gr=e.y,tt()}function ot(t){var r,n,o=wr.header,u=wr.resize;pr===o||S(pr,o)===o?(e=E(Zt,t),r=e.x-hr,n=e.y-gr,L(rr,{left:(vr>br?r:w(r,0,br-vr))+"px",top:(mr>yr?n:w(n,0,yr-mr))+"px"})):pr===u&&(e=E(rr,t),L(rr,{width:e.x+"px",height:e.y+"px"}))}function ut(){pr=0}function it(e,t,r){return{header:e,body:t,footer:r}}function ct(e){var t=lr,r=e&&e.target||0;(!r||r!==t&&S(r,t)!==t)&&(lr=0,P(nr),g(Lt,gt,ct),pt.ui.exit(1))}var at="\u2318",lt="\u2026",st="\u2325",ft=window,dt=document,pt=this,ht=dt.documentElement,gt=(dt.head,dt.body),vt={},mt=pt.target,bt=function(){},yt=pt._.x,wt=pt._.extend,xt=pt._.css,$t=wt({tab:"  ",dir:"ltr",keys:1,tools:"indent outdent | undo redo",attributes:{spellcheck:"false"},css:"html,body{background:#fff;color:#000}",auto_tab:1,auto_close:{'"':'"',"'":"'","(":")","{":"}","[":"]","<":">"},languages:{tools:{undo:"Undo ("+at+"+Z)",redo:"Redo ("+at+"+Y)",preview:"Preview ("+at+"+"+st+"+V)"},buttons:{okay:"OK",cancel:"Cancel",yes:"Yes",no:"No",enter:"Enter",exit:"Exit",open:"Open",close:"Close",ignore:"Ignore"},others:{placeholder:"text here"+lt,preview:"Preview",_word:"%1 Word",_words:"%1 Words"}},classes:{editor:"text-editor",i:"fa fa-%1"}},e),kt="keydown",Et="keyup",Tt="copy",Ct="cut",St="paste",_t="mousedown touchstart",zt="mouseup touchend",Mt="mousemove touchmove",Lt="click",Kt="focus",Wt="blur",jt="input",Ht=Wt+" "+Tt+" "+Ct+" "+Kt+" "+jt+" "+kt+" "+St,Nt=$t.languages,Rt=$t.tab,It=$t.auto_tab,Yt=$t.auto_close;pt.ui={},pt.tidy=function(e,t){var n=pt.$(),o=n.before.length?e:"",u=n.after.length?r(t)?t:e:"";return pt.trim(o,u)},pt.format=function(e,t,n,o){r(n)||(n=" "),r(o)||(o="");var u=pt[0]().$(),i="<"+e+">"+o,c=o+"</"+e.split(" ")[0]+">",a=yt(i),l=yt(c),s=k("^"+a+"([\\s\\S]*?)"+l+"$"),f=k(a+"$"),d=k("^"+l),p=u.before,h=u.after;return u.length||pt.insert(Xt.placeholder),pt.toggle(t?!s.test(u.value):!f.test(p)&&!d.test(h),[function(e){e.unwrap(i,c,1).tidy(/<[^\/<>]+?>$/.test(p)?"":n,/^<\/[^<>]+?>/.test(h)?"":n).wrap(i,c,t)[1]()},function(e){e.unwrap(i,c,t)[1]()}])};var Dt,Pt=$t.classes,At=Pt.editor,Ot=Nt.tools,Ut=Nt.buttons,Xt=Nt.others,Bt=At+"-textarea "+At+"-content",Ft=A(At),Vt=A(At+"-header"),Zt=A(At+"-body"),qt=A(At+"-footer"),Gt=A(At+"-tool"),Jt=M(mt,!1,$t.attributes),Qt=A(At+"-resize s"),er=A(At+"-description"),tr=A(At+"-overlay"),rr=M("div"),nr=M("div"),or=M("div"),ur=A("left","span"),ir=A("right","span"),cr=A(At+"-preview","a"),ar=0,lr=0;cr.href="",cr.title=Ot.preview,h(Lt,cr,_);var sr={},fr=null;pt.create=function(e,t){u(e)&&($t=wt($t,e)),W(Jt,Bt);var r=R(Jt);return r&&"p"===r.tagName.toLowerCase()?(I(r,Ft),ar=r,D(r,!1)):I(Jt,Ft),Ft.dir=$t.dir,Y(Ft,Vt),Y(Ft,Zt),Y(Ft,qt),Y(Ft,Qt),Y(Zt,Jt),$t.tools&&(Y(Vt,Gt),Y(qt,er),Y(er,ur),Y(er,ir)),h(kt,Jt,F),h(Et,Jt,V),h(Ht,Jt,Z),h(_t,Qt,G),h(Mt,gt,J),h(zt,gt,Q),Xt.preview&&(Y(ur,cr),H(cr,Xt.preview)),B(),U(),X(),0!==t?l("create",[pt]):pt},pt.update=function(e,t){return K(Jt,Bt)&&pt.destroy(0),(0!==t?l("update",[pt]):pt).create(e,0)},pt.destroy=function(e){return K(Jt,Bt)?(pt.ui.exit(0,0,0),j(Jt,Bt),u($t.tools)&&($t.tools=$t.tools.join(" ")),$t.keys&&(g(kt,Jt,F),g(Et,Jt,V)),g(_t,Qt,G),g(Mt,gt,J),g(zt,gt,Q),g(Ht,Jt,Z),ar?(I(Ft,ar),Y(ar,Jt),ar=0):I(Ft,Jt),P(Ft),0!==e?l("destroy",[pt]):pt):pt};var e,dr,pr=0,hr=0,gr=0,vr=0,mr=0,br=0,yr=0,wr={};pt.ui.exit=function(e,t,r){var n,o={overlay:function(){g(Lt,tr,et),P(tr)},modal:function(){g(_t,Zt,nt),g(Mt,Zt,ot),g(zt,gt,ut),g(Lt,wr.x,rt),P(rr)},drop:function(){P(nr)},bubble:function(){P(or)}};if(t)if(u(t))for(n in t)n=t[n],o[n]&&o[n](),0!==r&&l("exit."+n,[pt]);else o[t]&&o[t](),0!==r&&l("exit."+n,[pt]);else for(n in o)o[n]();return e&&pt.select(),0!==r&&l("exit",[pt]),pt},pt.ui.overlay=function(e,r,o){return pt.ui.exit(0,"bubble",0),V(1),Y(Zt,M(tr,e.length||t(e)?A(At+"-overlay-content","div",e):"")),r&&h(Lt,tr,et),n(o)?o(tr):M(tr,o),l("enter.overlay",[pt])},pt.ui.modal=function(){pt.ui.exit(0,0,0);var e,t=arguments,o=t[0],i=t[1],c=t[2],a=At+"-modal";u(o)&&(o="default",i=t[0],c=t[1]),M(rr,!1,{"class":a+" "+o}),r(i.body)&&(i.body=M("div",i.body,{"class":a+"-content "+o}));for(e in i)a[1]=e,wr[e]=A(a+"-"+x(e,a)+" "+o,0,i[e]);wr.x=A(At+"-x "+o),wr.resize=A(At+"-resize se "+o),N(rr),Y(Zt,M(rr,wr,{style:""})),pt.ui.overlay("",1),tt();var f=yr/2-mr/2,d=br/2-vr/2;return L(rr,{top:f+"px",left:d+"px"}),h(Lt,wr.x,rt),h(_t,wr.header,s),h(_t,wr.resize,s),h(_t,Zt,nt),h(Mt,Zt,ot),h(zt,gt,ut),n(c)&&(wr.overlay=tr,wr.modal=rr,c(wr)),l("enter.modal."+o,[pt]),l("enter.modal",[pt]),pt};var xr={"class":At+"-button"};return pt.ui.alert=function(e,t,r,n){var o=M("button",Ut.okay,xr);return r=r||bt,h(Lt,o,function(e){return r(e,pt),rt(),s(e)}),h(kt,o,function(e){var t=e.TE.key;return t(/^escape|enter$/)?v(Lt,[e,pt],o):void 0}),m(function(){o.focus()},1),pt.ui.modal("alert",it(e,t,o),n)},pt.ui.confirm=function(e,t,r,o,u){function i(e){return n(r)&&r(e,pt),rt(),s(e)}function c(e){return n(o)&&o(e,pt),rt(),s(e)}var a,l=M("button",Ut.okay,xr),f=M("button",Ut.cancel,xr);return h(Lt,l,i),h(Lt,f,c),h(kt,l,function(e){return a=e.TE.key,a("arrowright")?(f.focus(),s(e)):a("arrowleft")?s(e):a("enter")?(i(e),s(e)):a("escape")?(rt(),s(e)):void 0}),h(kt,f,function(e){return a=e.TE.key,a("arrowright")?s(e):a("arrowleft")?(l.focus(),s(e)):a("enter")?(c(e),s(e)):a("escape")?(rt(),s(e)):void 0}),m(function(){f.focus()},1),pt.ui.modal("confirm",it(e,t,[l,f]),u)},pt.ui.prompt=function(e,t,r,n,o){function u(){p.focus(),p.select()}function i(e){return!r||y(p.value).length&&p.value!==t?(c(e),n(e,pt,p.value)):(u(),a(e))}function c(e){return rt(),s(e)}function a(e){return s(e)}var l,f=M("button",Ut.okay,xr),d=M("button",Ut.cancel,xr),p=M("input",!1,{type:"text",value:t,placeholder:t,"class":At+"-input block"});return n=n||bt,h(kt,p,function(e){return l=e.TE.key,l("enter")?i(e):l("escape")?c(e):l("arrowup")?a(e):l("arrowdown")?(f.focus(),s(e)):void 0}),h(kt,f,function(e){return l=e.TE.key,l("enter")?i(e):l("escape")?c(e):l("arrowup")?(p.focus(),s(e)):l("arrowright")?(d.focus(),s(e)):l(/^arrow(down|left)$/)?a(e):void 0}),h(kt,d,function(e){return l=e.TE.key,l(/^enter|escape$/)?c(e):l("arrowup")?(p.focus(),s(e)):l(/^arrow(right|down)$/)?a(e):l("arrowleft")?(f.focus(),s(e)):void 0}),h(Lt,f,i),h(Lt,d,c),m(u,.4),pt.ui.modal("prompt",it(e,p,[f,d]),o)},pt.ui.drop=function(){pt.ui.exit(0,0,0);var e=arguments,t=e[0],r=e[1];1===e.length&&(t="default",r=e[0]),Y(gt,M(nr,!1,{"class":At+"-drop "+t})),n(r)?r(nr):M(nr,r);var o,u=C(ht),i=C(nr),c=u.w/2-i.w/2,a=u.h/2-i.h/2;return lr&&(o=T(lr),c=o.l,a=o.t+C(lr).h),L(nr,{left:w(c,0,u.w-i.w)+"px",top:w(a,0,u.h-i.h)+"px"}),h(Lt,gt,ct),l("enter.drop."+t,[pt]),l("enter.drop",[pt]),pt},pt.ui.bubble=function(){pt.ui.exit(0,0,0);var e,t,r,o=arguments,u=o[0],i=o[1],c=pt.$(1),a=T(Jt),s=parseInt(xt(Jt,"line-height"),10);return 1===o.length&&(u="default",i=o[0]),n(i)?i(or):M(or,i),Y(gt,M(or,!1,{"class":At+"-bubble "+u})),e=c.caret[0].x+a.l,t=c.caret[1].y+a.t+s-Jt.scrollTop,r=C(or),L(or,{left:w(e,a.l,a.l+C(Zt).w-r.w)+"px",top:w(t,a.t,T(qt).t-r.h)+"px"}),l("enter.bubble."+u,[pt]),l("enter.bubble",[pt]),pt},pt.ui.tool=function(e,t,n){var o="";return $t.tools=$t.tools.filter(function(t,r){return t===e?(o=r,!1):!0}),t===!1?delete pt.ui.tools[e]:(pt.ui.tools[e]=wt(pt.ui.tools[e]||{},t),r(n)||""===o||(n=o),i(n)?$t.tools.splice(n,0,e):$t.tools.push(e)),U(),pt},pt.ui.key=function(e,t){return $t.keys?(t===!1?delete pt.ui.keys[e]:pt.ui.keys[e]=t,X(),pt):pt},pt.ui.tools={"|":1,undo:{i:"undo",click:function(e,t){return t.undo(),!1}},redo:{i:"repeat",click:function(e,t){return t.redo(),!1}},indent:function(e,t){return t.indent(Rt),!1},outdent:function(e,t){return t.outdent(Rt),!1}},pt.ui.keys={"control+y":"redo","control+z":"undo","control+option+v":function(e){return _(e),!1},"shift+tab":It?"outdent":bt,tab:It?"indent":bt,escape:function(){return cr.focus(),!1}},pt.ui.parent=pt,pt.ui.dom={container:Ft,header:Vt,body:Zt,footer:qt,overlay:tr,modal:rr,drop:nr,bubble:or},pt.config=$t,wt(pt._,{time:function(){var e=new Date,t=e.getFullYear(),r=e.getMonth()+1,n=e.getDate(),o=e.getHours(),u=e.getMinutes(),i=e.getSeconds(),c=e.getMilliseconds();return 10>r&&(r="0"+r),10>n&&(n="0"+n),10>o&&(o="0"+o),10>u&&(u="0"+u),10>i&&(i="0"+i),10>c&&(c="0"+c),[""+t,""+r,""+n,""+o,""+u,""+i,""+c]},format:x,el:M,event:{set:h,reset:g,fire:v},hooks:vt,hook:{set:c,reset:a,fire:l}}),pt.ui};
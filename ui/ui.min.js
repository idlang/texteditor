/*!
 * ==========================================================
 *  USER INTERFACE MODULE FOR TEXT EDITOR PLUGIN 0.0.9
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.prototype.create=function(e){function t(e){return e instanceof HTMLElement}function n(e){return void 0!==e}function r(e){return"function"==typeof e}function o(e){return"string"==typeof e}function u(e){return"object"==typeof e}function i(e){return"number"==typeof e}function a(e,t,r){return n(e)?n(t)?(n(yt[e])||(yt[e]={}),n(r)||(r=Object.keys(yt[e]).length),yt[e][r]=t,pt):yt[e]:yt}function c(e,t){return n(e)?n(t)&&n(yt[e])?(delete yt[e][t],pt):(yt[e]={},pt):(yt={},pt)}function s(e,t,r){if(!n(yt[e]))return pt;if(n(r))n(yt[e][r])&&yt[e][r].apply(pt,t);else for(var o in yt[e])yt[e][o].apply(pt,t);return pt}function f(e){return e&&e.preventDefault(),!1}function l(e,t,n){return t?(t.addEventListener(e,n,!1),a("on:"+e,n,L(t)),pt):void 0}function d(e,t,n){return t?(t.removeEventListener(e,n,!1),c("on:"+e,L(t)),pt):void 0}function p(e,t,n){return s("on:"+e,t,L(n)),pt}function v(e,t,n){e=m(e).split(/\s+/);for(var r=0,o=e.length;o>r;++r)l(e[r],t,n);return pt}function h(e,t,n){e=m(e).split(/\s+/);for(var r=0,o=e.length;o>r;++r)d(e[r],t,n);return pt}function y(e,t,n){e=m(e).split(/\s+/);for(var r=0,o=e.length;o>r;++r)p(e[r],t,n);return pt}function g(e,t){lt.setTimeout(e,t)}function b(e){lt.clearTimeout(e)}function m(e){return e.replace(/^\s*|\s*$/g,"")}function w(e,t,r){return n(t)&&t>e?t:n(r)&&e>r?r:e}function x(e,t){return e.replace(/%(\d+)/g,function(e,r){return--r,n(t[r])?t[r]:e})}function k(e){return m(e.toLowerCase().replace(/[^ \/a-z\d-]/g,"-").replace(/([ -])+/g,"$1").replace(/^-|-$/g,""))}function T(e,t){return RegExp(e,t)}function $(e,t){var n=t.touches?t.touches[0].pageX:t.pageX,r=t.touches?t.touches[0].pageY:t.pageY,o=E(e);return{x:n-o.l,y:r-o.t}}function E(e){for(var t=e.offsetLeft,n=e.offsetTop;e=e.offsetParent;)t+=e.offsetLeft,n+=e.offsetTop;return{l:t,t:n}}function C(e){return{w:e.offsetWidth,h:e.offsetHeight}}function _(e,t){for(;(e=e.parentElement)&&e!==t;);return e}function N(e){var t=pt.get();if(!D(tn)&&t.length){-1===t.indexOf("</html>")&&(t='<!DOCTYPE html><html dir="'+kt.dir+'"><head><meta charset="utf-8"><style>'+kt.css+"</style></head><body>"+t+"</body></html>");var n=z("iframe",!1,{"class":Wt+"-portal",src:"data:text/html,"+encodeURIComponent(t)});pt.ui.overlay(n,1,function(){s("enter.overlay.preview",[e,pt,t,tn.firstChild])})}else et();return f(e)}function L(e){var t=e.id;return t||(t=Wt+"-dom:"+(new Date).getTime(),e.id=t),t}function z(e,i,a){if(e=o(e)?dt.createElement(e):e,u(a)){var c,s;for(s in a)c=a[s],"style"===s?o(c)?e.setAttribute(s,c):null===c?e.removeAttribute(s):e=M(e,c):r(c)?e[s]=c:null===c?e.removeAttribute(s):e.setAttribute(s,u(c)?c.join(" "):""+c)}if(t(i))e.appendChild(i);else if(u(i)){var c,s;for(s in i)c=i[s],t(c)?e.appendChild(c):c!==!1&&(e.innerHTML=c)}else n(i)&&i!==!1&&(e.innerHTML=i);return e}function M(e,t){e=z(e);for(var n in t)e.style[n.replace(/\-([a-z])/g,function(e,t){return t.toUpperCase()})]=t[n];return e}function O(e,t){return T("(^|\\s)"+t+"(\\s|$)").test(e.className)}function j(e,t){O(e,t)||(e.className=m(e.className+" "+t))}function A(e,t){e.className=m(e.className.replace(T("(^|\\s)"+t+"(\\s|$)"),"$1$2"))}function H(e,t){e.innerHTML=t}function Y(e,t){if(t!==!1){var n,r=e.children;for(n in r)Y(r[n])}H(e,"")}function D(e,t){return 1===arguments.length?e.parentNode||!1:e&&t.parentNode===e?t.parentNode:!1}function I(e,t){e.parentNode.insertBefore(t,e)}function P(e,t){e.appendChild(t)}function R(e,t){var n=D(e);if(n){if(t!==!1)for(var r=e.firstChild;r;)R(r);n.removeChild(e)}}function U(e){Y(z(e,!1,{style:""})),R(e)}function W(e,t,n){return z(t||"div",n,{"class":e})}function S(){var e=(Jt.value||"").replace(/<[^<>]+?>/g,""),t=(e.match(/(\w+)/g)||[]).length;H(an,x(Bt["_word"+(1===t?"":"s")],[t]))}function X(){Y(Gt,!1);var e,t,i,a,c,f,l=o(kt.tools)?m(kt.tools).split(/\s+/):kt.tools,d=Wt+"-button",p=Wt+"-separator";kt.tools=l;for(c in l)f=l[c],pt.ui.tools[f]&&(t=pt.ui.tools[f],r(t)&&(pt.ui.tools[f].click=t),"|"!==(i=t.i||f)&&(i=k(i)),a="|"!==i,Rt=W(a?d:p,a?"a":"span"),a&&(e=d+":"+k(f).replace(/\s/g,""),Rt.href="",Rt.id=e,Rt.tabIndex=-1,Rt.setAttribute("data-tool-id",f),i='<i class="'+x(Ut.i,[i])+" "+e+'"></i>',n(t.active)?t.active||j(Rt,"x"):t.active=1,t.text&&(i=x(t.text,[i]),j(Rt,"text")),H(Rt,i),t.title&&(Rt.title=t.title),u(t.attributes)&&z(Rt,!1,t.attributes),v(Mt,Rt,q)),P(Gt,Rt));s("update.tools",[pt])}function B(){pt.ui.keys=function(){var e,t=Object.keys(pt.ui.keys).sort().reverse(),n={};for(e=0,len=t.length;len>e;++e)n[t[e]]=pt.ui.keys[t[e]];return n}(),V(1),s("update.keys",[pt])}function F(e){S(),s("on:change",[e,pt])}function K(e){function t(e){return e.replace(/\+/g,"\n").replace(/\n\n/g,"\n+").split("\n")}var n,r,u,i,a,c=pt.$(),s=c.before.slice(-1),l=c.after[0],d=c.length,p=e.TE.key,v=pt.ui.keys,h=TE.keys_alt,y=(c.before.match(/(?:^|\n)([\t ]*).*$/)||[""]).pop(),b=p();ln[p()]=1,g(function(){pt.record()},1);for(n in v){var m=0;u=t(n);for(r in u)r=u[r],ln[h[r]||r]&&++m;u=u.length,m===u&&Object.keys(ln).length===u&&(o(v[n])&&(v[n]=pt.ui.tools[v[n]].click),i=v[n](e,pt),i===!1&&f(e))}if(It&&!d&&"backspace"===b&&T(mt(Dt)+"$").test(c.before))return pt.outdent(Dt),f(e);if(Pt)for(n in Pt)if(a=Pt[n]){if(l===b)return"\\"===s?(pt.insert(b,-1),f(e)):(pt.select(c.end+1),f(e));if(n===b)return pt.wrap(n,a),f(e);if(s===n&&l===a){if("backspace"===b&&c.before.slice(-2)!=="\\"+n)return pt.unwrap(n,a),f(e);if("enter"===b&&It)return pt.tidy("\n"+y+Dt,"\n"+y),f(e)}}}function V(e){u(e)?delete ln[e.TE.key()]:ln={}}function Z(e){/^focus|blur$/.test(e.type)&&V(1),b(dn),dn=g(F,1e3)}function q(e){pt.ui.exit(0,0,0);var t=this.getAttribute("data-tool-id"),n=pt.ui.tools;return fn=e.currentTarget||e.target,n[t]&&n[t].click&&n[t].active?(n[t].click(e,pt,t),s("on:change",[e,pt,t])):pt.select(),f(e)}function G(e){return vn=Qt,pn=C(qt),f(e)}function J(e){vn===Qt&&M(Jt,{height:$(Zt,e).y-pn.h+"px"})}function Q(){vn=0}function et(){pt.ui.exit(1)}function tt(){e=C(nn),gn=e.w,bn=e.h,e=C(tn),mn=e.w,wn=e.h}function nt(){y(Mt,[],tn)}function rt(t){vn=t.target,e=$(nn,t),hn=e.x,yn=e.y,tt()}function ot(t){var n,r,o=xn.header,u=xn.resize;vn===o||_(vn,o)===o?(e=$(Zt,t),n=e.x-hn,r=e.y-yn,M(nn,{left:(gn>mn?n:w(n,0,mn-gn))+"px",top:(bn>wn?r:w(r,0,wn-bn))+"px"})):vn===u&&(e=$(nn,t),M(nn,{width:e.x+"px",height:e.y+"px"}))}function ut(){vn=0}function it(e,t,n){return{header:e,body:t,footer:n}}function at(e){var t=fn,n=e&&e.target||0;(!n||n!==t&&_(n,t)!==t)&&(fn=0,U(rn),h(Mt,ht,at),pt.ui.exit(1))}var ct="\u2318",st="\u2026",ft="\u2325",lt=window,dt=document,pt=this,vt=dt.documentElement,ht=(dt.head,dt.body),yt={},gt=pt.target,bt=function(){},mt=pt._.x,wt=pt._.extend,xt=pt._.css,kt=wt({tab:"  ",dir:"ltr",keys:1,tools:"indent outdent | undo redo",css:"html,body{background:#fff;color:#000}",auto_tab:1,auto_close:{'"':'"',"'":"'","(":")","{":"}","[":"]","<":">"},languages:{tools:{undo:"Undo ("+ct+"+Z)",redo:"Redo ("+ct+"+Y)",preview:"Preview ("+ct+"+"+ft+"+V)"},buttons:{okay:"OK",cancel:"Cancel",yes:"Yes",no:"No",enter:"Enter",exit:"Exit",open:"Open",close:"Close",ignore:"Ignore"},others:{placeholder:"text here"+st,preview:"Preview",_word:"%1 Word",_words:"%1 Words"}},classes:{editor:"text-editor",i:"fa fa-%1"}},e),Tt="keydown",$t="keyup",Et="copy",Ct="cut",_t="paste",Nt="mousedown touchstart",Lt="mouseup touchend",zt="mousemove touchmove",Mt="click",Ot="focus",jt="blur",At="input",Ht=jt+" "+Et+" "+Ct+" "+Ot+" "+At+" "+Tt+" "+_t,Yt=kt.languages,Dt=kt.tab,It=kt.auto_tab,Pt=kt.auto_close;pt.ui={},pt.tidy=function(e,t){var r=pt.$(),o=r.before.length?e:"",u=r.after.length?n(t)?t:e:"";return pt.trim(o,u)},pt.format=function(e,t,r,o){n(r)||(r=" "),n(o)||(o="");var u=pt[0]().$(),i="<"+e+">"+o,a=o+"</"+e.split(" ")[0]+">",c=mt(i),s=mt(a),f=T("^"+c+"([\\s\\S]*?)"+s+"$"),l=T(c+"$"),d=T("^"+s),p=r,v=r,h=u.before,y=u.after;return/<[^\/<>]+?>$/.test(h)&&(p=""),/^<\/[^<>]+?>/.test(y)&&(v=""),u.length||pt.insert(Bt.placeholder),pt.toggle(t?!f.test(u.value):!l.test(h)&&!d.test(y),[function(e){e.unwrap(i,a,1).tidy(p,v).wrap(i,a,t)[1]()},function(e){e.unwrap(i,a,t)[1]()}])};var Rt,Ut=kt.classes,Wt=Ut.editor,St=Yt.tools,Xt=Yt.buttons,Bt=Yt.others,Ft=Wt+"-textarea "+Wt+"-content",Kt=W(Wt),Vt=W(Wt+"-header"),Zt=W(Wt+"-body"),qt=W(Wt+"-footer"),Gt=W(Wt+"-tool"),Jt=gt,Qt=W(Wt+"-resize s"),en=W(Wt+"-description"),tn=W(Wt+"-overlay"),nn=z("div"),rn=z("div"),on=z("div"),un=W("left","span"),an=W("right","span"),cn=W(Wt+"-preview","a"),sn=0,fn=0;cn.href="",cn.title=St.preview,v(Mt,cn,N);var ln={},dn=null;pt.create=function(e,t){u(e)&&(kt=wt(kt,e)),j(Jt,Ft);var n=D(Jt);return n&&"p"===n.tagName.toLowerCase()?(I(n,Kt),sn=n,R(n,!1)):I(Jt,Kt),Kt.dir=kt.dir,P(Kt,Vt),P(Kt,Zt),P(Kt,qt),P(Kt,Qt),P(Zt,Jt),kt.tools&&(P(Vt,Gt),P(qt,en),P(en,un),P(en,an)),kt.keys&&(v(Tt,Jt,K),v($t,Jt,V)),v(Ht,Jt,Z),v(Nt,Qt,G),v(zt,ht,J),v(Lt,ht,Q),P(un,cn),H(cn,Bt.preview),F(),X(),B(),0!==t?s("create",[pt]):pt},pt.update=function(e,t){return O(Jt,Ft)&&pt.destroy(0),(0!==t?s("update",[pt]):pt).create(e,0)},pt.destroy=function(e){return O(Jt,Ft)?(pt.ui.exit(0,0,0),A(Jt,Ft),kt.tools=kt.tools.join(" "),kt.keys&&(h(Tt,Jt,K),h($t,Jt,V)),h(Nt,Qt,G),h(zt,ht,J),h(Lt,ht,Q),h(Ht,Jt,Z),sn?(I(Kt,sn),P(sn,Jt),sn=0):I(Kt,Jt),U(Kt),0!==e?s("destroy",[pt]):pt):pt};var e,pn,vn=0,hn=0,yn=0,gn=0,bn=0,mn=0,wn=0,xn={};pt.ui.exit=function(e,t,n){var r,o={overlay:function(){h(Mt,tn,et),U(tn)},modal:function(){h(Nt,Zt,rt),h(zt,Zt,ot),h(Lt,ht,ut),h(Mt,xn.x,nt),U(nn)},drop:function(){U(rn)},bubble:function(){U(on)}};if(t)if(u(t))for(r in t)r=t[r],o[r]&&o[r](),0!==n&&s("exit."+r,[pt]);else o[t]&&o[t](),0!==n&&s("exit."+r,[pt]);else for(r in o)o[r]();return e&&pt.select(),0!==n&&s("exit",[pt]),pt},pt.ui.overlay=function(e,n,o){return pt.ui.exit(0,"bubble",0),V(1),P(Zt,z(tn,e.length||t(e)?W(Wt+"-overlay-content","div",e):"")),n&&v(Mt,tn,et),r(o)?o(tn):z(tn,o),s("enter.overlay",[pt])},pt.ui.modal=function(){pt.ui.exit(0,0,0);var e,t=arguments,o=t[0],i=t[1],a=t[2],c=Wt+"-modal";u(o)&&(o="default",i=t[0],a=t[1]),z(nn,!1,{"class":c+" "+o}),n(i.body)&&(i.body=z("div",i.body,{"class":c+"-content "+o}));for(e in i)c[1]=e,xn[e]=W(c+"-"+x(e,c)+" "+o,0,i[e]);xn.x=W(Wt+"-x "+o),xn.resize=W(Wt+"-resize se "+o),Y(nn),P(Zt,z(nn,xn,{style:""})),pt.ui.overlay("",1),tt();var l=wn/2-bn/2,d=mn/2-gn/2;return M(nn,{top:l+"px",left:d+"px"}),v(Mt,xn.x,nt),v(Nt,xn.header,f),v(Nt,xn.resize,f),v(Nt,Zt,rt),v(zt,Zt,ot),v(Lt,ht,ut),r(a)&&(xn.overlay=tn,xn.modal=nn,a(xn)),s("enter.modal."+o,[pt]),s("enter.modal",[pt]),pt};var kn={"class":Wt+"-button"};return pt.ui.alert=function(e,t,n,r){var o=z("button",Xt.okay,kn);return n=n||bt,v(Mt,o,function(e){return n(e,pt),nt(),f(e)}),v(Tt,o,function(e){var t=e.TE.key;return t(/^escape|enter$/)?y(Mt,[e,pt],o):void 0}),g(function(){o.focus()},1),pt.ui.modal("alert",it(e,t,o),r)},pt.ui.confirm=function(e,t,n,o,u){function i(e){return r(n)&&n(e,pt),nt(),f(e)}function a(e){return r(o)&&o(e,pt),nt(),f(e)}var c,s=z("button",Xt.okay,kn),l=z("button",Xt.cancel,kn);return v(Mt,s,i),v(Mt,l,a),v(Tt,s,function(e){return c=e.TE.key,c("arrowright")?(l.focus(),f(e)):c("arrowleft")?f(e):c("enter")?(i(e),f(e)):c("escape")?(nt(),f(e)):void 0}),v(Tt,l,function(e){return c=e.TE.key,c("arrowright")?f(e):c("arrowleft")?(s.focus(),f(e)):c("enter")?(a(e),f(e)):c("escape")?(nt(),f(e)):void 0}),g(function(){l.focus()},1),pt.ui.modal("confirm",it(e,t,[s,l]),u)},pt.ui.prompt=function(e,t,n,r,o){function u(){p.focus(),p.select()}function i(e){return!n||m(p.value).length&&p.value!==t?(a(e),r(e,pt,p.value)):(u(),c(e))}function a(e){return nt(),f(e)}function c(e){return f(e)}var s,l=z("button",Xt.okay,kn),d=z("button",Xt.cancel,kn),p=z("input",!1,{type:"text",value:t,placeholder:t,"class":Wt+"-input block"});return r=r||bt,v(Tt,p,function(e){return s=e.TE.key,s("enter")?i(e):s("escape")?a(e):s("arrowup")?c(e):s("arrowdown")?(l.focus(),f(e)):void 0}),v(Tt,l,function(e){return s=e.TE.key,s("enter")?i(e):s("escape")?a(e):s("arrowup")?(p.focus(),f(e)):s("arrowright")?(d.focus(),f(e)):s(/^arrow(down|left)$/)?c(e):void 0}),v(Tt,d,function(e){return s=e.TE.key,s(/^enter|escape$/)?a(e):s("arrowup")?(p.focus(),f(e)):s(/^arrow(right|down)$/)?c(e):s("arrowleft")?(l.focus(),f(e)):void 0}),v(Mt,l,i),v(Mt,d,a),g(u,.4),pt.ui.modal("prompt",it(e,p,[l,d]),o)},pt.ui.drop=function(){pt.ui.exit(0,0,0);var e=arguments,t=e[0],n=e[1];1===e.length&&(t="default",n=e[0]),P(ht,z(rn,!1,{"class":Wt+"-drop "+t})),r(n)?n(rn):z(rn,n);var o,u=C(vt),i=C(rn),a=u.w/2-i.w/2,c=u.h/2-i.h/2;return fn&&(o=E(fn),a=o.l,c=o.t+C(fn).h),M(rn,{left:w(a,0,u.w-i.w)+"px",top:w(c,0,u.h-i.h)+"px"}),v(Mt,ht,at),s("enter.drop."+t,[pt]),s("enter.drop",[pt]),pt},pt.ui.bubble=function(){pt.ui.exit(0,0,0);var e,t,n,o=arguments,u=o[0],i=o[1],a=pt.$(1),c=E(Jt),f=parseInt(xt(Jt,"line-height"),10);return 1===o.length&&(u="default",i=o[0]),r(i)?i(on):z(on,i),P(ht,z(on,!1,{"class":Wt+"-bubble "+u})),e=a.caret[0].x+c.l,t=a.caret[1].y+c.t+f-Jt.scrollTop,n=C(on),M(on,{left:w(e,c.l,c.l+C(Zt).w-n.w)+"px",top:w(t,c.t,E(qt).t-n.h)+"px"}),s("enter.bubble."+u,[pt]),s("enter.bubble",[pt]),pt},pt.ui.tool=function(e,t,r){var o="";return kt.tools=kt.tools.filter(function(t,n){return t===e?(o=n,!1):!0}),t===!1?delete pt.ui.tools[e]:(pt.ui.tools[e]=wt(pt.ui.tools[e]||{},t),n(r)||""===o||(r=o),i(r)?kt.tools.splice(r,0,e):kt.tools.push(e)),X(),pt},pt.ui.key=function(e,t){return t===!1?delete pt.ui.keys[e]:pt.ui.keys[e]=t,B(),pt},pt.ui.tools={"|":1,undo:{i:"undo",click:function(e,t){return t.undo(),!1}},redo:{i:"repeat",click:function(e,t){return t.redo(),!1}},indent:function(e,t){return t.indent(Dt),!1},outdent:function(e,t){return t.outdent(Dt),!1}},pt.ui.keys={"control+y":"redo","control+z":"undo","control+option+v":function(e){return N(e),!1},"shift+tab":It?"outdent":bt,tab:It?"indent":bt,escape:function(){return cn.focus(),!1}},pt.ui.parent=pt,pt.ui.dom={container:Kt,header:Vt,body:Zt,footer:qt,overlay:tn,modal:nn,drop:rn,bubble:on},pt.config=kt,wt(pt._,{time:function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate(),o=e.getHours(),u=e.getMinutes(),i=e.getSeconds(),a=e.getMilliseconds();return 10>n&&(n="0"+n),10>r&&(r="0"+r),10>o&&(o="0"+o),10>u&&(u="0"+u),10>i&&(i="0"+i),10>a&&(a="0"+a),[""+t,""+n,""+r,""+o,""+u,""+i,""+a]},format:x,el:z,event:{set:v,reset:h,fire:y},hooks:yt,hook:{set:a,reset:c,fire:s}}),pt.ui};
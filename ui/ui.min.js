/*!
 * ==========================================================
 *  USER INTERFACE MODULE FOR TEXT EDITOR PLUGIN 1.1.0
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.prototype.create=function(e){function t(e){return e instanceof HTMLElement}function n(e){return void 0!==e}function r(e){return"function"==typeof e}function o(e){return"string"==typeof e}function i(e){return"object"==typeof e}function u(e){return"number"==typeof e}function a(e,t,r){return n(e)?n(t)?(n(vt[e])||(vt[e]={}),n(r)||(r=Object.keys(vt[e]).length),vt[e][r]=t,dt):vt[e]:vt}function l(e,t){return n(e)?n(t)&&n(vt[e])?(delete vt[e][t],dt):(vt[e]={},dt):(vt={},dt)}function c(e,t,r){if(!n(vt[e]))return dt;if(n(r))n(vt[e][r])&&vt[e][r].apply(dt,t);else for(var o in vt[e])vt[e][o].apply(dt,t);return dt}function s(e){return e&&e.preventDefault(),!1}function f(e,t,n){return t?(t.addEventListener(e,n,!1),a("on:"+e,n,q(t)),dt):void 0}function p(e,t,n){return t?(t.removeEventListener(e,n,!1),l("on:"+e,q(t)),dt):void 0}function d(e,t,n){return c("on:"+e,t,q(n)),dt}function h(e,t,n){e=y(e).split(/\s+/);for(var r=0,o=e.length;o>r;++r)f(e[r],t,n);return dt}function g(e,t,n){e=y(e).split(/\s+/);for(var r=0,o=e.length;o>r;++r)p(e[r],t,n);return dt}function v(e,t,n){e=y(e).split(/\s+/);for(var r=0,o=e.length;o>r;++r)d(e[r],t,n);return dt}function b(e,t){ft.setTimeout(e,t)}function m(e){ft.clearTimeout(e)}function y(e){return e.replace(/^\s*|\s*$/g,"")}function k(e,t,r){return n(t)&&t>e?t:n(r)&&e>r?r:e}function $(e,t){return e.replace(/%(\d+)/g,function(e,r){return--r,n(t[r])?t[r]:e})}function w(e){return y(e.toLowerCase().replace(/[^ \/a-z\d-]/g,"-").replace(/([ -])+/g,"$1").replace(/^-|-$/g,""))}function x(e,t){return RegExp(e,t)}function _(e,t){var n=t.touches?t.touches[0].pageX:t.pageX,r=t.touches?t.touches[0].pageY:t.pageY,o=T(e);return{x:n-o.l,y:r-o.t}}function T(e){for(var t=e.offsetLeft,n=e.offsetTop;e=e.offsetParent;)t+=e.offsetLeft,n+=e.offsetTop;return{l:t,t:n}}function E(e){return{w:e.offsetWidth,h:e.offsetHeight}}function L(e,t){for(;(e=e.parentElement)&&e!==t;);return e}function C(e){var t,n=dt.get();if(!z(nn)&&n){-1===n.indexOf("</html>")&&(t='<!DOCTYPE html><html dir="'+wt.dir+'"><head><meta charset="utf-8"><style>'+wt.css+"</style></head><body>"+n+"</body></html>");var r=j("iframe",!1,{"class":Pt+"-portal",src:"data:text/html,"+encodeURIComponent(t)});dt.ui.overlay(r,1,function(){c("enter.overlay.preview",[e,dt,[n,t],nn.firstChild])})}else et();return s(e)}function q(e){var t=e.id;return t||(t=Pt+"-dom:"+(new Date).getTime(),e.id=t),t}function j(e,u,a){if(e=o(e)?pt.createElement(e):e,i(a)){var l,c;for(c in a)l=a[c],"style"===c?o(l)?e.setAttribute(c,l):null===l?e.removeAttribute(c):e=O(e,l):r(l)?e[c]=l:null===l?e.removeAttribute(c):e.setAttribute(c,i(l)?l.join(" "):""+l)}if(t(u))e.appendChild(u);else if(i(u)){var l,c;for(c in u)l=u[c],t(l)?e.appendChild(l):l!==!1&&(e.innerHTML=l)}else n(u)&&u!==!1&&(e.innerHTML=u);return e}function O(e,t){e=j(e);for(var n in t)e.style[n.replace(/\-([a-z])/g,function(e,t){return t.toUpperCase()})]=t[n];return e}function M(e,t){return x("(^|\\s)"+t+"(\\s|$)").test(e.className)}function A(e,t){M(e,t)||(e.className=y(e.className+" "+t))}function H(e,t){e.className=y(e.className.replace(x("(^|\\s)"+t+"(\\s|$)"),"$1$2"))}function N(e,t){e.innerHTML=t}function I(e,t){if(t!==!1){var n,r=e.children;for(n in r)I(r[n])}N(e,"")}function z(e,t){return 1===arguments.length?e.parentNode||!1:e&&t.parentNode===e?t.parentNode:!1}function R(e,t){e.parentNode.insertBefore(t,e)}function U(e,t){e.appendChild(t)}function Y(e,t){var n=z(e);if(n){if(t!==!1)for(var r=e.firstChild;r;)Y(r);n.removeChild(e)}}function S(e){I(j(e,!1,{style:""})),Y(e)}function D(e,t,n){return j(t||"div",n,{"class":e})}function P(){if(Ft._word&&Ft._words){var e=(Jt.value||"").replace(/<[^<>]+?>/g,""),t=(e.match(/(\w+)/g)||[]).length;N(ln,$(Ft["_word"+(1===t?"":"s")],[t]))}}function B(){I(Gt,!1);var e,t,u,a,l,s,f=o(wt.tools)?y(wt.tools).split(/\s+/):wt.tools,p=Pt+"-button",d=Pt+"-separator";wt.tools=f;for(l in f)s=f[l],dt.ui.tools[s]&&(t=dt.ui.tools[s],r(t)&&(dt.ui.tools[s].click=t),"|"!==(u=t.i||s)&&(u=w(u)),a="|"!==u,St=D(a?p:d,a?"a":"span"),a&&(e=p+":"+w(s).replace(/\s/g,""),St.href="",St.id=e,St.tabIndex=-1,St.setAttribute(Yt,s),u='<i class="'+$(Dt.i,[u])+" "+e+'"></i>',n(t.active)?t.active||A(St,"x"):t.active=1,t.text&&(u=$('<span class="'+Pt+'-text">'+t.text+"</span>",[u]),A(St,"text")),N(St,u),t.title&&(St.title=t.title),i(t.attributes)&&j(St,!1,t.attributes),h(Ot,St,V)),U(Gt,St));c("update.tools",[dt])}function W(){dt.ui.keys=function(){var e,t=Object.keys(dt.ui.keys).sort().reverse(),n={};for(e=0,len=t.length;len>e;++e)n[t[e]]=dt.ui.keys[t[e]];return n}(),K(1),c("update.keys",[dt])}function F(e){P(),c("on:change",[e,dt])}function X(e){function t(e){return e.replace(/\+/g,"\n").replace(/\n\n/g,"\n+").split("\n")}var n,r,i,u,a,l=dt.$(),c=l.before.slice(-1),f=l.after[0],p=l.length,d=e.TE.key,h=dt.ui.keys,g=TE.keys_alt,v=(l.before.match(/(?:^|\n)([\t ]*).*$/)||[""]).pop(),m=d();pn[d()]=1,b(function(){dt.record()},1);for(n in h){var y=0;i=t(n);for(r in i)r=i[r],pn[g[r]||r]&&++y;i=i.length,y===i&&Object.keys(pn).length===i&&(o(h[n])&&(h[n]=dt.ui.tools[h[n]].click),u=h[n]&&h[n](e,dt),u===!1&&s(e))}if(Rt&&!p){if("backspace"===m&&x(yt(zt)+"$").test(l.before))return dt.outdent(zt),s(e);if("enter"===m&&x("(^|\\n)("+yt(zt)+")+$").test(l.before))return dt.insert("\n"+v,-1),s(e)}if(Ut)for(n in Ut)if(a=Ut[n]){if(f===m)return"\\"===c?(dt.insert(m,-1),s(e)):(dt.select(l.end+1),s(e));if(n===m)return dt.wrap(n,a),s(e);if(c===n&&f===a){if("backspace"===m&&l.before.slice(-2)!=="\\"+n)return dt.unwrap(n,a),s(e);if("enter"===m&&Rt)return dt.tidy("\n"+v+zt,"\n"+v),s(e)}}}function K(e){i(e)?delete pn[e.TE.key()]:pn={}}function Q(e){/^focus|blur$/.test(e.type)&&K(1),m(dn),dn=b(F,1e3)}function V(e){dt.ui.exit(0,0,0);var t=this.getAttribute(Yt),n=dt.ui.tools;return fn=e.currentTarget||e.target,n[t]&&n[t].click&&n[t].active?(n[t].click(e,dt,t),c("on:change",[e,dt,t])):dt.select(),s(e)}function Z(e){return gn=en,hn=E(Zt),s(e)}function G(e){gn===en&&O(Jt,{height:_(Vt,e).y-hn.h+"px"})}function J(){gn=0}function et(){dt.ui.exit(1)}function tt(){e=E(rn),mn=e.w,yn=e.h,e=E(nn),kn=e.w,$n=e.h}function nt(){v(Ot,[],nn)}function rt(t){gn=t.target,e=_(rn,t),vn=e.x,bn=e.y,tt()}function ot(t){var n,r,o=wn.header,i=wn.resize;gn===o||L(gn,o)===o?(e=_(Vt,t),n=e.x-vn,r=e.y-bn,O(rn,{left:(mn>kn?n:k(n,0,kn-mn))+"px",top:(yn>$n?r:k(r,0,$n-yn))+"px"})):gn===i&&(e=_(rn,t),O(rn,{width:e.x+"px",height:e.y+"px"}))}function it(){gn=0}function ut(e,t,n){return{header:e,body:t,footer:n}}function at(e){var t=fn,n=e&&e.target||0;(!n||n!==t&&L(n,t)!==t)&&(fn=0,S(on),g(Ot,gt,at),dt.ui.exit(1))}var lt="\u2318",ct="\u2026",st="\u2325",ft=window,pt=document,dt=this,ht=pt.documentElement,gt=(pt.head,pt.body),vt={},bt=dt.target,mt=function(){},yt=dt._.x,kt=dt._.extend,$t=dt._.css,wt=kt({tab:"  ",dir:"ltr",keys:1,tools:"indent outdent | undo redo",attributes:{spellcheck:"false"},css:"html,body{background:#fff;color:#000}",auto_tab:1,auto_close:{'"':'"',"'":"'","(":")","{":"}","[":"]","<":">"},languages:{tools:{undo:"Undo ("+lt+"+Z)",redo:"Redo ("+lt+"+Y)",preview:"Preview ("+lt+"+"+st+"+V)"},buttons:{okay:"OK",cancel:"Cancel",yes:"Yes",no:"No",enter:"Enter",exit:"Exit",open:"Open",close:"Close",ignore:"Ignore"},others:{placeholder:"text here"+ct,preview:"Preview",_word:"%1 Word",_words:"%1 Words"}},classes:{editor:"text-editor",i:"fa fa-%1"}},e),xt="keydown",_t="keyup",Tt="copy",Et="cut",Lt="paste",Ct="mousedown touchstart",qt="mouseup touchend",jt="mousemove touchmove",Ot="click",Mt="focus",At="blur",Ht="input",Nt=At+" "+Tt+" "+Et+" "+Mt+" "+Ht+" "+xt+" "+Lt,It=wt.languages,zt=wt.tab,Rt=wt.auto_tab,Ut=wt.auto_close,Yt="data-tool-id";dt.ui={},dt.tidy=function(e,t){var r=dt.$(),o=r.before?e:"",i=r.after?n(t)?t:e:"";return dt.trim(o,i)},dt.i=function(){return editor.replace(/\s+/g," ")},dt.format=function(e,t,r,o){n(r)||(r=" "),n(o)||(o="");var i=dt[0]().$(),u="<"+e+">"+o,a=o+"</"+e.split(" ")[0]+">",l=yt(u),c=yt(a),s=x("^"+l+"([\\s\\S]*?)"+c+"$"),f=x(l+"$"),p=x("^"+c),d=i.before,h=i.after;return i.length?r=!1:dt.insert(Ft.placeholder),dt.toggle(t?!s.test(i.value):!f.test(d)&&!p.test(h),[function(e){e.unwrap(u,a,1).tidy(/<[^\/<>]+?>$/.test(d)?"":r,/^<\/[^<>]+?>/.test(h)?"":r).wrap(u,a,t)[1]()},function(e){e.unwrap(u,a,t)[1]()}])};var St,Dt=wt.classes,Pt=Dt.editor,Bt=It.tools,Wt=It.buttons,Ft=It.others,Xt=Pt+"-textarea "+Pt+"-content",Kt=D(Pt),Qt=D(Pt+"-header"),Vt=D(Pt+"-body"),Zt=D(Pt+"-footer"),Gt=D(Pt+"-tool"),Jt=j(bt,!1,wt.attributes),en=D(Pt+"-resize s"),tn=D(Pt+"-description"),nn=D(Pt+"-overlay"),rn=j("div"),on=j("div"),un=j("div"),an=D("left","span"),ln=D("right","span"),cn=D(Pt+"-preview","a"),sn=0,fn=0;cn.href="",cn.title=Bt.preview,h(Ot,cn,C);var pn={},dn=null;dt.create=function(e,t){i(e)&&(wt=kt(wt,e)),A(Jt,Xt);var n=z(Jt);return n&&"p"===n.tagName.toLowerCase()?(R(n,Kt),sn=n,Y(n,!1)):R(Jt,Kt),Kt.dir=wt.dir,U(Kt,Qt),U(Kt,Vt),U(Kt,Zt),U(Kt,en),U(Vt,Jt),wt.tools&&(U(Qt,Gt),U(Zt,tn),U(tn,an),U(tn,ln)),h(xt,Jt,X),h(_t,Jt,K),h(Nt,Jt,Q),h(Ct,en,Z),h(jt,gt,G),h(qt,gt,J),Ft.preview&&(U(an,cn),N(cn,Ft.preview)),F(),B(),W(),0!==t?c("create",[dt]):dt},dt.update=function(e,t){return M(Jt,Xt)&&dt.destroy(0),(0!==t?c("update",[dt]):dt).create(e,0)},dt.destroy=function(e){return M(Jt,Xt)?(dt.ui.exit(0,0,0),H(Jt,Xt),i(wt.tools)&&(wt.tools=wt.tools.join(" ")),wt.keys&&(g(xt,Jt,X),g(_t,Jt,K)),g(Ct,en,Z),g(jt,gt,G),g(qt,gt,J),g(Nt,Jt,Q),sn?(R(Kt,sn),U(sn,Jt),sn=0):R(Kt,Jt),S(Kt),0!==e?c("destroy",[dt]):dt):dt};var e,hn,gn=0,vn=0,bn=0,mn=0,yn=0,kn=0,$n=0,wn={};dt.ui.exit=function(e,t,n){var r,o={overlay:function(){g(Ot,nn,et),S(nn)},modal:function(){g(Ct,Vt,rt),g(jt,Vt,ot),g(qt,gt,it),g(Ot,wn.x,nt),S(rn)},drop:function(){S(on)},bubble:function(){S(un)}};if(t)if(i(t))for(r in t)r=t[r],o[r]&&o[r](),0!==n&&c("exit."+r,[dt]);else o[t]&&o[t](),0!==n&&c("exit."+r,[dt]);else for(r in o)o[r]();return e&&dt.select(),0!==n&&c("exit",[dt]),dt},dt.ui.overlay=function(e,n,o){return dt.ui.exit(0,"bubble",0),K(1),U(Vt,j(nn,e.length||t(e)?D(Pt+"-overlay-content","div",e):"")),n&&h(Ot,nn,et),r(o)?o(nn):j(nn,o),c("enter.overlay",[dt])},dt.ui.modal=function(){dt.ui.exit(0,0,0);var e,t=arguments,o=t[0],u=t[1],a=t[2],l=Pt+"-modal";i(o)&&(o="default",u=t[0],a=t[1]),j(rn,!1,{"class":l+" "+o}),n(u.body)&&(u.body=j("div",u.body,{"class":l+"-content "+o}));for(e in u)l[1]=e,wn[e]=D(l+"-"+$(e,l)+" "+o,0,u[e]);wn.x=D(Pt+"-x "+o),wn.resize=D(Pt+"-resize se "+o),I(rn),U(Vt,j(rn,wn,{style:""})),dt.ui.overlay("",1),tt();var f=$n/2-yn/2,p=kn/2-mn/2;return O(rn,{top:f+"px",left:p+"px"}),h(Ot,wn.x,nt),h(Ct,wn.header,s),h(Ct,wn.resize,s),h(Ct,Vt,rt),h(jt,Vt,ot),h(qt,gt,it),r(a)&&(wn.overlay=nn,wn.modal=rn,a(wn)),c("enter.modal."+o,[dt]),c("enter.modal",[dt]),dt};var xn={"class":Pt+"-button"};return dt.ui.alert=function(e,t,n,r){var o=j("button",Wt.okay,xn);return n=n||mt,h(Ot,o,function(e){return n(e,dt),nt(),s(e)}),h(xt,o,function(e){var t=e.TE.key;return t(/^escape|enter$/)?v(Ot,[e,dt],o):void 0}),b(function(){o.focus()},1),dt.ui.modal("alert",ut(e,t,o),r)},dt.ui.confirm=function(e,t,n,o,i){function u(e){return r(n)&&n(e,dt),nt(),s(e)}function a(e){return r(o)&&o(e,dt),nt(),s(e)}var l,c=j("button",Wt.okay,xn),f=j("button",Wt.cancel,xn);return h(Ot,c,u),h(Ot,f,a),h(xt,c,function(e){return l=e.TE.key,l("arrowright")?(f.focus(),s(e)):l("arrowleft")?s(e):l("enter")?(u(e),s(e)):l("escape")?(nt(),s(e)):void 0}),h(xt,f,function(e){return l=e.TE.key,l("arrowright")?s(e):l("arrowleft")?(c.focus(),s(e)):l("enter")?(a(e),s(e)):l("escape")?(nt(),s(e)):void 0}),b(function(){f.focus()},1),dt.ui.modal("confirm",ut(e,t,[c,f]),i)},dt.ui.prompt=function(e,t,n,o,i,u){function a(){k.focus(),"placeholder"in k&&k.select()}function l(e){return g=k.value,!n||y(g)&&g!==t?(c(e),o(e,dt,g)):(a(),f(e))}function c(e){return nt(),s(e)}function f(e){return s(e)}var p,d,g,v=j("button",Wt.okay,xn),m=j("button",Wt.cancel,xn),k=j("input",!1,{type:"text",value:t,placeholder:t,"class":Pt+"-input block"}),$=[];if(r(i)&&(u=i,i=0),1===i)k=j("textarea",t,{placeholder:t.split("\n")[0],"class":Pt+"-textarea block"});else if(2===i){for(d in t)$.push(j("option",t[d],{value:d,selected:d===n||null}));k=j("select",$,{"class":Pt+"-select block"})}return o=o||mt,h(xt,k,function(e){return p=e.TE.key,p("enter")?l(e):p("escape")||p("backspace")&&!this.value?c(e):p("arrowup")?f(e):p("arrowdown")?(v.focus(),s(e)):void 0}),h(xt,v,function(e){return p=e.TE.key,p("enter")?l(e):p("escape")?c(e):p("arrowup")?(k.focus(),s(e)):p("arrowright")?(m.focus(),s(e)):p(/^arrow(down|left)$/)?f(e):void 0}),h(xt,m,function(e){return p=e.TE.key,p(/^enter|escape$/)?c(e):p("arrowup")?(k.focus(),s(e)):p(/^arrow(right|down)$/)?f(e):p("arrowleft")?(v.focus(),s(e)):void 0}),h(Ot,v,l),h(Ot,m,c),b(a,.4),dt.ui.modal("prompt",ut(e,k,[v,m]),u)},dt.ui.drop=function(){dt.ui.exit(0,0,0);var e=arguments,t=e[0],n=e[1];1===e.length&&(t="default",n=e[0]),U(gt,j(on,!1,{"class":Pt+"-drop "+t})),r(n)?n(on):j(on,n);var o,i=E(ht),u=E(on),a=i.w/2-u.w/2,l=i.h/2-u.h/2;return fn&&(o=T(fn),a=o.l,l=o.t+E(fn).h),O(on,{left:k(a,0,i.w-u.w)+"px",top:k(l,0,i.h-u.h)+"px"}),h(Ot,gt,at),c("enter.drop."+t,[dt]),c("enter.drop",[dt]),dt},dt.ui.menu=function(e,t,n,r){if(t===!1)return dt.ui.tool(e,t);var i='<span class="'+Pt+'-current menu">%1</span>';return dt.ui.tool(e,{text:$(i,[t]),click:function(){var e,t,r,u,a={"class":Pt+"-button"};dt.ui.drop("menu",function(l){I(l);for(t in n)a[Yt]=t,e=j("span",t,a),n[t]&&h(Ot,e,function(e){return u=n[this.getAttribute(Yt)],o(u)&&(u=dt.ui.tools[u].click),r=u&&u(e,dt),fn&&N(fn.firstChild||fn,$(i,[this.innerHTML])),r===!1?s(e):void 0}),U(l,e)})}},r),c("update.menus",[dt]),dt},dt.ui.bubble=function(){dt.ui.exit(0,0,0);var e,t,n,o=arguments,i=o[0],u=o[1],a=dt.$(1),l=T(Jt),s=parseInt($t(Jt,"line-height"),10);return 1===o.length&&(i="default",u=o[0]),r(u)?u(un):j(un,u),U(gt,j(un,!1,{"class":Pt+"-bubble "+i})),e=a.caret[0].x+l.l,t=a.caret[1].y+l.t+s-Jt.scrollTop,n=E(un),O(un,{left:k(e,l.l,l.l+E(Vt).w-n.w)+"px",top:k(t,l.t,T(Zt).t-n.h)+"px"}),c("enter.bubble."+i,[dt]),c("enter.bubble",[dt]),dt},dt.ui.tool=function(e,t,r){var o="";return wt.tools=wt.tools.filter(function(t,n){return t===e?(o=n,!1):!0}),t===!1?delete dt.ui.tools[e]:(dt.ui.tools[e]=kt(dt.ui.tools[e]||{},t),n(r)||""===o||(r=o),u(r)?wt.tools.splice(r,0,e):wt.tools.push(e)),B(),dt},dt.ui.key=function(e,t){return wt.keys?(t===!1?delete dt.ui.keys[e]:dt.ui.keys[e]=t,W(),dt):dt},dt.ui.tools={"|":1,undo:{i:"undo",click:function(e,t){return t.undo(),!1}},redo:{i:"repeat",click:function(e,t){return t.redo(),!1}},indent:function(e,t){return t.indent(zt),!1},outdent:function(e,t){return t.outdent(zt),!1}},dt.ui.keys={"control+y":"redo","control+z":"undo","control+option+v":function(e){return C(e),!1},"shift+tab":Rt?"outdent":0,tab:Rt?"indent":0,escape:function(){return cn.focus(),!1}},dt.ui.parent=dt,dt.ui.dom={container:Kt,header:Qt,body:Vt,footer:Zt,overlay:nn,modal:rn,drop:on,bubble:un},dt.config=wt,kt(dt._,{time:function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate(),o=e.getHours(),i=e.getMinutes(),u=e.getSeconds(),a=e.getMilliseconds();return 10>n&&(n="0"+n),10>r&&(r="0"+r),10>o&&(o="0"+o),10>i&&(i="0"+i),10>u&&(u="0"+u),10>a&&(a="0"+a),[""+t,""+n,""+r,""+o,""+i,""+u,""+a]},format:$,el:j,event:{set:h,reset:g,fire:v},hooks:vt,hook:{set:a,reset:l,fire:c}}),dt.ui};
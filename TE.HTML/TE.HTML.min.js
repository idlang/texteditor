TE.HTML=function(e,t){function A(e,t){return new RegExp(e,t)}function q(e){return e.replace(/^\s*|\s*$/g,"")}function S(e,t,n){return t>e?t:e>n?n:e}function D(e){return e.split(/\s+/)[0]}function R(e){var t=e.match(/(?:^|\n)([\t ]*).*$/);return t&&t[1]||""}function Y(e,t,n){var d,r=p.$(),i=r.value,o=r.before,f=k[t],l=k[n]||n,u=D(f),a=D(l),s=R(o),c=C[""];return M=f,p[0](),i&&i!==c?(p.tidy("\n\n","").replace(/[\t ]*\n[\t ]*/g,"</"+a+">\n"+$+"<"+l+">").wrap("<"+f+">\n"+$+"<"+l+">","</"+a+">\n</"+u+">\n\n",1).replace(A("\\n"+$+"<"+l+">\\s*<\\/"+a+">\\n","g"),"\n</"+u+">\n\n<"+f+">\n").select(p.$().end),O&&b.tools.p.click(e,p),p[1](),!1):void((d=o.match(A("(?:^|\\n)[\\t ]+<(\\/?)(?:"+D(k.ul)+"|"+D(k.ol)+")"+E+">\\s*$")))?p.insert("\n"+s+(d[1]?"":$),-1):(d=o.match(A("<"+a+_+">.*?$")))?A("<\\/"+a+">\\s*$").test(o)?p.tidy("\n"+s,!1).insert(c).wrap("<"+a+d[1]+">","</"+a+">"):/>\s*$/.test(o)?p.insert(c).wrap("\n"+s+$+"<"+f+">\n"+s+$+$+"<"+a+d[1]+">","</"+a+">\n"+s+$+"</"+u+">\n"+s):p.insert("</"+a+">\n"+s+"<"+a+d[1]+">",-1).insert(c):A("<\\/"+a+">\\s*$").test(o)?p.insert(c).wrap("\n"+s+"<"+l+">","</"+a+">"):p.tidy("\n\n").insert(c).wrap("<"+f+">\n"+$+"<"+l+">","</"+a+">\n</"+u+">"))}function P(e,t){return!t.get(0)&&O&&b.tools.p.click(e,t),t}function U(e){return W(e).replace(/<.*?>/g,"").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/\(/g,"&#40;").replace(/\)/g,"&#41;")}function F(e){return W(e).replace(/<.*?>/g,"").replace(/\s/g,"%20").replace(/"/g,"%22").replace(/\(/g,"%28").replace(/\)/g,"%29")}function W(e){return q(e.replace(/\s+/g," "))}var M,n="–",r="…",i="↑",o="↓",f="↵",l="⌘",u="✘",a="⇧",s=window,p=(document,new TE(e)),d=p._.extend,h=p._.each,v=p._.x,b=p.ui(d({suffix:">",auto_encode_html:1,auto_p:1,tools:"clear | b i u s | sub sup | abbr | a img | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{tr:[1,20],td:[1,20],abbr:{}},languages:{tools:{clear:["Clear Format",u],b:["Bold",l+"+B"],i:["Italic",l+"+I"],u:["Underline",l+"+U"],s:["Strike",l+"+"+u],a:["Link",l+"+L"],img:["Image",l+"+G"],sub:["Subscript",l+"+"+o],sup:["Superscript",l+"+"+i],abbr:["Abbreviation",l+"+"+a+"+?"],p:["Paragraph",l+"+"+f],"p,h1,h2,h3,h4,h5,h6":["H1 "+n+" H6",l+"+H"],"blockquote,q":["Quote",l+"+Q"],"pre,code":["Code",l+"+K"],ul:["Unordered List",l+"+-"],ol:["Ordered List",l+"++"],table:["Table",l+"+T"],hr:["Horizontal Rule",l+"+R"]},modals:{a:{title:["Link URL","Link Title"],placeholder:["http://","link title here"+r]},img:{title:["Image URL","Image Title","Image Caption"],placeholder:["http://","image title here"+r,"image caption here"+r]},abbr:{title:"Abbreviation",placeholder:"meaning here"+r},table:{title:["Number of Columns","Number of Rows","Table Caption"],placeholder:["3","3","table caption here"+r]}},placeholders:{table:["Table Head %1.%2","Table Data %1.%2","Table Foot %1.%2"]}},classes:{},advance_a:1,advance_img:1,advance_table:1,formats:{b:"strong",i:"em",u:"u",s:'del datetime="%1-%2-%3"',a:"a",figure:"figure",figcaption:"figcaption",img:"img",sub:"sub",sup:"sup",abbr:"abbr",p:"p",br:"br",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",h6:"h6",blockquote:"blockquote",q:"q",pre:"pre",code:"code",ul:"ul",ol:"ol",li:"li",table:'table border="1"',caption:"caption",thead:"thead",tbody:"tbody",tfoot:"tfoot",tr:"tr",th:"th",td:"td",hr:"hr"}},t)),g=p._.format,m=p.config,y=m.states,w=m.languages,k=m.formats,$=(m.classes,m.tab),T=m.suffix,E="(?:\\s[^<>]*?)?",_="(|\\s[^<>]*?)",L="([\\s\\S]*?)",C=w.placeholders,O=m.auto_p;return p.type="HTML",d(b.tools,{clear:{i:"eraser",click:function(e,t){var n=t[0]().$(),r=n.value;return/<[^<>]+?>/.test(r)||">"===n.before.slice(-1)||"<"===n.after[0]?t.replace(/<[^<>]+?>/g,"").unwrap(/<[^\/<>]+?>/,/<\/[^<>]+?>/):t.insert(""),t[1](),!!n.after}},b:{i:"bold",click:function(e,t){return P(e,t).i().format(k.b),!1}},i:{i:"italic",click:function(e,t){return P(e,t).i().format(k.i),!1}},u:{i:"underline",click:function(e,t){return P(e,t).i().format(k.u),!1}},s:{i:"strikethrough",click:function(e,t){return P(e,t).i().format(g(k.s,t._.time())),!1}},a:{i:"link",click:function(e,t){var i,o,n=k.a,r=w.modals.a;return t.record().ui.prompt(["a[href]",r.title[0]],r.placeholder[0],1,function(e,t,f){f=F(f),i=f;var u,a,l=s.location.host;-1!==i.indexOf("://")&&(u=1),""!==l&&-1!==i.indexOf("://"+l)&&(u=0),/^([.\/?&#]|javascript:)/.test(i)&&(u=0),t.blur().ui.prompt(["a[title]",r.title[1]],r.placeholder[1],0,function(e,t,r){o=U(r),P(e,t).$().length||t.insert(C[""]),a=m.advance_a&&u?' rel="nofollow" target="_blank"':"",t.i().format(n+' href="'+i+'"'+(o?' title="'+o+'"':"")+a)})}),!1}},img:{i:"image",click:function(e,t){var a,s,n=t.$(),r=k.img,i=k.figure,o=k.figcaption,f=n.value,l=w.modals.img,u=m.advance_img;return t.ui.prompt(["img[src]",l.title[0]],l.placeholder[0],1,function(e,t,n){n=F(n),a=n,t.blur().ui.prompt(["img[title]",l.title[u?2:1]],l.placeholder[u?2:1],0,function(e,t,n){s=U(n),f||(f=a.split(/[\/\\\\]/).pop()),f=U(f),t[0](),u&&s?(t.tidy("\n\n","").insert("<"+i+">\n"+$+"<"+r+' alt="'+f+'" src="'+a+'"'+T+"\n"+$+"<"+o+">"+s+"</"+D(o)+">\n</"+D(i)+">\n\n",-1,1),O&&b.tools.p.click(e,p)):P(e,t).tidy(/<[^\/<>]+?>\s*$/.test(t.$().before)?"":" ","").insert("<"+r+' alt="'+f+'" src="'+a+'"'+(s?' title="'+s+'"':"")+T+" ",-1,1),t[1]()})}),!1}},sub:{i:"subscript",click:function(e,t){var n=k.sub,r=k.sup,i=D(r);return P(e,t)[0]().unwrap(A("<"+i+E+">"),"</"+i+">").i().format(n)[1](),!1}},sup:{i:"superscript",click:function(e,t){var n=k.sub,r=k.sup,i=D(n);return P(e,t)[0]().unwrap(A("<"+i+E+">"),"</"+i+">").i().format(r)[1](),!1}},abbr:{i:"question",click:function(e,t){var d,h,n=t.$(),r=q(n.value),i=w.modals.abbr,o=t.get(),f=q(r||C[""]),l=k.abbr,u=D(l),a="<"+v(l)+_+">",s="<"+v(l)+E+">",c="<\\/"+u+">",p=A(a+L+c);return o.replace(p,function(e,t,n){(n=q(n))&&(y.abbr[n]=(t.match(/\s+title="\s*(.*?)\s*"/i)||["",""])[1])}),d=y.abbr,r&&d[r]?(t.i().format(l+' title="'+d[r]+'"'),!1):(t.record().ui.prompt(["abbr[title]",i.title],d[f]||i.placeholder,!d[r],function(e,t,n,r){n=U(n||r),t[0]();for(h in d)if(U(d[h])===n){t.insert(h);break}P(e,t).unwrap(A(s),A(c)).unwrap(A(s),A(c),1).i().format(l+' title="'+n+'"')[1]()}),!1)}},p:{i:"paragraph",click:function(e,t){var n=t.$(),r=n.value,i=k.p,o=k.br,f=D(i),l=D(o),u=n.before,a=n.after,s=R(u),c=C[""];if(t[0](),r&&-1!==r.indexOf("\n")){var p=A("^(?:\\s*<"+f+E+">\\s*)+"+L+"(?:\\s*<\\/"+f+">\\s*)+$");p.test(n.value)?t.replace(p,"$1").replace(A("\\s*<\\/"+f+">\\s*<"+f+E+">\\s*","g"),"\n\n").replace(A("\\s*<"+l+E+">\\s*","g"),"\n"):t.replace(/\n/g,"\n<"+o+T+"\n").replace(A("(\\s*<"+l+E+T+"\\s*){2,}","g"),"</"+f+">\n<"+i+">").wrap("<"+i+">","</"+f+">",1).replace(A("(<"+f+E+">)+","g"),"$1").replace(A("(<\\/"+f+">)+","g"),"$1").tidy("\n")}else A("^\\s*<\\/"+f+">").test(a)?A("<"+f+E+">\\s*$").test(u)?t.unwrap(A("\\s*<"+f+E+">\\s*"),A("\\s*<\\/"+f+">")).replace(c,"").tidy("\n","\n"+s):(match=u.match(A("<"+f+_+">.*?$")))&&t.wrap("</"+f+">\n"+s+"<"+f+match[1]+">","").insert(c):t.format(i,0,"\n\n");return t[1](),!1}},"p,h1,h2,h3,h4,h5,h6":{i:"header",click:function(e,t){var n=t.$(),r=[k.p,k.h1,k.h2,k.h3,k.h4,k.h5,k.h6],i=[];h(r,function(e,t){i[t]=D(e)});var f=(v(r).join("|"),v(i).join("|")),l="\\s*<("+f+")"+_+">\\s*",u=A("\\s*<(?:"+f+")"+E+">\\s*"),a=A("\\s*<\\/(?:"+f+")>\\s*"),s=n.value.match(A("^"+l));s||(s=n.before.match(A(l+"$"))||[]);var c=s[2]||"",p=+(s[1]||"h0").slice(1);return t[0]().unwrap(u,a).unwrap(u,a,1).i().tidy("\n\n").format(p>5?i[0]+c:i[p+1]+c,0,"\n\n")[1](),!1}},"blockquote,q":{i:"quote-left",click:function(e,t){var n=t.$(),r=n.value,i=k.blockquote,o=k.q,f=k.p,l=D(f),u="<"+l+E+">";if(A("(^|\\n|"+u+")$").test(n.before)){if(O&&(n.value===C[""]||A("("+u+")$").test(n.before)))return t.select(),!1;t[0]().format(i,0,"\n\n","\n"),O&&(!r||t.match(/^[^<\n]*?[^>]$/)?t.wrap($+"<"+f+">","</"+l+">"):t[A("((^|\\n)"+$+")+").test(n.value)?"outdent":"indent"]($)),t[1]()}else t.i().format(o);return!1}},"pre,code":{i:"code",click:function(e,t){function h(e){return i?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}function v(e){return i?e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"):e}var n=t.$(),r=n.value,i=m.auto_encode_html,o=k.pre,f=k.code,l=D(o),u=D(f),a="<"+l+E+">\\s*<"+u+E+">\\s*",s="\\s*<\\/"+u+">\\s*<\\/"+l+">",c=A(a+"\\s*$"),p=A("^\\s*"+s),d=A("^"+L+"$");return A("(^|\\n|"+a+")$").test(n.before)?c.test(n.before)&&p.test(n.after)?t[0]().unwrap(A(c),A(p)).replace(d,v)[1]():t[0]().tidy("\n\n").wrap("<"+o+"><"+f+">","</"+u+"></"+l+">").insert(r||C[""]).replace(d,h)[1]():t[0]().format(f).loss().replace(d,function(e){return W(A("^<\\/"+u+">").test(t.$().after)?h(e):v(e))})[1](),!1}},ul:{i:"list-ul",click:function(e,t){var n=k.ol,r=k.ul,i=D(n),o=D(r),f="("+v(o)+"|"+v(i)+")";return t.match(A("<"+f+E+">"+L+"<\\/"+f+">"))?t[0]().replace(A("<"+i+_+">","g"),"<"+o+"$1>").replace(A("</"+i+">","g"),"</"+o+">")[1]():Y(e,r,k.li),!1}},ol:{i:"list-ol",click:function(e,t){var n=k.ol,r=k.ul,i=D(n),o=D(r),f="("+v(o)+"|"+v(i)+")";return t.match(A("<"+f+E+">"+L+"<\\/"+f+">"))?t[0]().replace(A("<"+o+_+">","g"),"<"+i+"$1>").replace(A("</"+o+">","g"),"</"+i+">")[1]():Y(e,n,k.li),!1}},table:function(e,t){var H,z,N,j,n=y.tr,r=y.td,i=w.modals.table,o=w.placeholders.table,f=q(g(o[0],[1,1])),l=m.advance_table?$:"",u=k.table,a=k.caption,s=k.thead,c=k.tbody,p=k.tfoot,d=k.tr,h=k.th,v=k.td,b=D(u),x=D(a),T=D(s),E=D(c),_=D(p),L=D(d),C=D(h),O=D(v),M=[];return t.$().value===f?(t.select(),!1):(t[0]().ui.prompt(["table>td",i.title[0]],i.placeholder[0],0,function(e,t,m,y){z=S(parseInt(m,10)||y,r[0],r[1]),t.blur().ui.prompt(["table>tr",i.title[1]],i.placeholder[1],0,function(e,t,r,m){N=S(parseInt(r,10)||m,n[0],n[1]),t.blur().ui.prompt(["table>caption",i.title[2]],i.placeholder[2],0,function(e,t,n){var i,m,y,k,I,r="";for(j=W(n),i=0;N>i;++i){for(H=l+$+"<"+d+">\n",m=0;z>m;++m)H+=l+$+$+"<"+v+">"+q(g(o[1],[i+1,m+1]))+"</"+O+">\n";H+=l+$+"</"+L+">",M.push(H)}for(M=M.join("\n"),H=$+(l?"<"+s+">\n"+$+$+"<"+d+">":"<"+L+">")+"\n",y=0;z>y;++y)H+=l+$+$+"<"+h+">"+q(g(o[0],[1,y+1]))+"</"+C+">\n";if(l){for(r+=$+"<"+p+">\n",r+=$+$+"<"+d+">\n",y=0;z>y;++y)r+=$+$+$+"<"+v+">"+q(g(o[2],[1,y+1]))+"</"+O+">\n";r+=$+$+"</"+d+">\n",r+=$+"</"+_+">\n"}H+=l+$+"</"+L+">"+(l?"\n"+$+"</"+T+">\n"+r+$+"<"+c+">":"")+"\n",M=H+M+(l?"\n"+$+"</"+E+">":"")+"\n",t.tidy("\n\n").insert("<"+u+">\n"+(j?$+"<"+a+">"+j+"</"+x+">\n":"")+M+"</"+b+">",0),k=t.$(),I=k.start+k.value.indexOf(f),t.select(I,I+f.length)[1]()})})}),!1)},hr:{i:"ellipsis-h",click:function(e,t){var n=R(t.$().before);return t.tidy("\n\n","").insert(n+"<"+k.hr+T+"\n\n",-1),!1}}}),m.keys&&d(b.keys,{"delete":"clear","control+delete":"s","control+b":"b","control+i":"i","control+u":"u","control+l":"a","control+g":"img","control+arrowdown":"sub","control+arrowup":"sup","control+shift+?":"abbr","control+enter":"p","shift+enter":function(e,t){var n=R(t.$().before);return t.tidy("\n","").insert(n+"<"+k.br+T+"\n",-1),!1},enter:function(e,t){var c,p,n=t.$(),r=n.value,i=t.get(),o=k.p,f=k.li,l=D(o),u=D(f),s=(R(n.before),C[""]);if(!r||r===s){if(match=n.after.match(A("^\\s*<\\/("+l+"|"+u+")>")))c=match[1],b.tools["li"===c?M:c].click(e,t);else{if(!(O&&q(i)&&n.end===i.length&&/^\s*[^<\n]*?[^>]\s*$/.test(i)))return;i="<"+o+">"+i+"</"+l+">\n<"+o+">",p=s+"</"+l+">",t.set(i+p).select(i.length,(i+s).length)}return!1}},tab:function(e,t){var n=t.$(),r=k.li,i=D(r),o=R(n.before);return A("<\\/"+r+">").test(n.after)?(t[0]().wrap("\n"+o+$+"<"+(k[M]||M)+">\n"+o+$+$+"<"+r+">","</"+i+">\n"+o+$+"</"+M+">\n"+o).insert(C[""])[1](),!1):t.ui.tools.indent.click(e,t)},backspace:function(e,t){var i,n=t.$(),r=n.value,o=n.before,f=n.after,l="<[^<>]+?>";return!r&&A(l+"$").test(o)?(i=o.split("<").pop().match(/^([^\/\s]+).*?>$/),i=i&&i[1]||0,i&&A("^\\s*<\\/"+i+">").test(f)?t.unwrap(A("<"+i+E+">"),A("\\s*<\\/"+i+">")):t.outdent(A(l)),!1):void 0},"control+h":"p,h1,h2,h3,h4,h5,h6","control+q":"blockquote,q","control+k":"pre,code","control+-":"ul","control++":"ol","control+=":"ol","control+shift++":"ol","control+t":"table","control+r":"hr"}),p.update({},0)};